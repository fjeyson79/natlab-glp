<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GLP Vision</title>
<style>
/* =====================================================
   GLP VISION ‚Äî Read-only console
   ===================================================== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1e293b; }

/* --- Top Bar --- */
.gv-topbar {
    display: flex; align-items: center; gap: 14px;
    padding: 12px 24px; background: #fff;
    border-bottom: 1px solid #e4e7eb;
}
.gv-topbar-title { font-size: 16px; font-weight: 700; color: #1a365d; }
.gv-topbar-spacer { flex: 1; }
.gv-topbar-user { font-size: 13px; color: #5a6578; }
.gv-topbar-role {
    font-size: 10px; font-weight: 700; letter-spacing: 0.5px;
    padding: 2px 8px; border-radius: 10px;
    background: #eef2ff; color: #1a365d; text-transform: capitalize;
}
.gv-topbar-back {
    font-size: 13px; color: #2d5a87; text-decoration: none; font-weight: 600;
}
.gv-topbar-back:hover { text-decoration: underline; }

/* --- Main Container (3-col grid) --- */
.gv-container {
    display: grid; grid-template-columns: 220px 380px 1fr;
    height: calc(100vh - 53px); gap: 0;
    background: #f0f2f5; overflow: hidden;
}

/* --- Sidebar --- */
.gv-sidebar {
    background: #fff; border-right: 1px solid #e4e7eb;
    overflow-y: auto; padding: 0;
}
.gv-sidebar-section { padding: 14px 16px 8px; }
.gv-sidebar-section:not(:last-child) { border-bottom: 1px solid #f0f2f5; }
.gv-micro-title {
    font-size: 10px; font-weight: 700; letter-spacing: 1.6px;
    text-transform: uppercase; color: #8c95a1; margin-bottom: 8px;
}
.gv-status-bucket {
    display: flex; align-items: center; justify-content: space-between;
    padding: 6px 10px; border-radius: 6px; cursor: pointer;
    font-size: 13px; color: #374151; transition: background 0.15s;
}
.gv-status-bucket:hover { background: #f5f7fa; }
.gv-status-bucket.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
.gv-count {
    background: #e8ecf1; color: #5a6578; font-size: 11px; font-weight: 600;
    padding: 1px 7px; border-radius: 10px;
}
.gv-year-item {
    padding: 5px 10px; border-radius: 6px; cursor: pointer;
    font-size: 12px; color: #5a6578; transition: background 0.15s;
}
.gv-year-item:hover { background: #f5f7fa; }
.gv-year-item.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
.gv-scope-item {
    display: flex; align-items: center; gap: 10px;
    padding: 7px 10px; border-radius: 8px; cursor: pointer;
    font-size: 13px; color: #374151; transition: background 0.15s;
}
.gv-scope-item:hover { background: #f5f7fa; }
.gv-scope-item.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
.gv-scope-avatar {
    width: 28px; height: 28px; border-radius: 50%;
    background: #2d5a87; color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; flex-shrink: 0;
}
.gv-scope-name { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

/* --- Finder --- */
.gv-finder {
    background: #fafbfc; border-right: 1px solid #e4e7eb;
    display: flex; flex-direction: column; overflow: hidden;
}
.gv-search-area { padding: 12px 12px 0; }
.gv-search-input {
    width: 100%; padding: 10px 14px;
    border: 1.5px solid #d1d5db; border-radius: 10px;
    font-size: 14px; background: #fff; outline: none;
}
.gv-search-input:focus { border-color: #2d5a87; box-shadow: 0 0 0 3px rgba(45,90,135,0.1); }
.gv-scope-pills { display: flex; gap: 6px; padding: 10px 12px 0; }
.gv-scope-pill {
    padding: 4px 12px; border-radius: 14px; font-size: 11px; font-weight: 600;
    cursor: pointer; border: 1.5px solid #d1d5db; background: #fff; color: #5a6578;
    transition: all 0.15s;
}
.gv-scope-pill.active { background: #1a365d; color: #fff; border-color: #1a365d; }
.gv-filter-row {
    display: flex; flex-wrap: wrap; gap: 5px; padding: 8px 12px;
    align-items: center;
}
.gv-chip {
    padding: 3px 10px; border-radius: 12px; font-size: 11px; cursor: pointer;
    border: 1px solid #e4e7eb; background: #fff; color: #5a6578;
    transition: all 0.15s;
}
.gv-chip.active { background: #eef2ff; border-color: #2d5a87; color: #1a365d; font-weight: 600; }
.gv-results { flex: 1; overflow-y: auto; padding: 8px 12px; }
.gv-result-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 10px 12px; border-radius: 10px; cursor: pointer;
    transition: background 0.15s, box-shadow 0.15s; border: 1px solid transparent;
}
.gv-result-item:hover { background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-color: #e4e7eb; }
.gv-result-item.active { background: #fff; border-color: #2d5a87; box-shadow: 0 2px 8px rgba(45,90,135,0.1); }
.gv-result-icon {
    width: 32px; height: 32px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 700; flex-shrink: 0; color: #fff;
}
.gv-result-icon.data { background: #2d5a87; }
.gv-result-icon.sop { background: #6366f1; }
.gv-result-icon.pres { background: #0891b2; }
.gv-result-info { flex: 1; min-width: 0; }
.gv-result-title {
    font-size: 13px; font-weight: 600; color: #1e293b;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.gv-result-sub {
    font-size: 11px; color: #8c95a1; margin-top: 2px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.gv-result-meta { display: flex; align-items: center; gap: 6px; margin-top: 4px; }
.gv-badge {
    font-size: 9px; font-weight: 600; padding: 1px 6px; border-radius: 4px;
    text-transform: uppercase; letter-spacing: 0.5px;
}
.gv-badge.pending { background: #fff3cd; color: #856404; }
.gv-badge.approved { background: #d4edda; color: #155724; }
.gv-badge.revision { background: #f8d7da; color: #721c24; }
.gv-assoc-count {
    font-size: 9px; font-weight: 600; padding: 1px 5px; border-radius: 4px;
    background: #eef2ff; color: #4338ca;
}
.gv-empty-state {
    display: flex; align-items: center; justify-content: center;
    height: 100%; color: #9ca3af; font-size: 14px; text-align: center; padding: 20px;
}

/* --- Viewer --- */
.gv-viewer {
    display: flex; flex-direction: column; background: #f8f9fa; padding: 0;
}
.gv-viewer-toolbar {
    background: #fff; padding: 12px 16px;
    border-bottom: 1px solid #e4e7eb;
    display: flex; align-items: center; gap: 10px; flex-shrink: 0;
}
.gv-viewer-filename {
    font-size: 13px; font-weight: 600; color: #1a365d;
    flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.gv-toolbar-btn {
    padding: 5px 14px; border-radius: 6px; font-size: 12px; font-weight: 600;
    border: 1px solid #d1d5db; background: #fff; color: #374151;
    cursor: pointer; transition: background 0.15s;
}
.gv-toolbar-btn:hover { background: #f5f7fa; }
.gv-toolbar-btn.pres-btn { background: #1a365d; color: #fff; border-color: #1a365d; }
.gv-toolbar-btn.pres-btn:hover { background: #2d5a87; }

.gv-icon-btn {
    font-size: 18px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 6px 8px;
    transition: transform 0.15s ease, opacity 0.15s ease;
}

.gv-icon-btn:hover {
    transform: scale(1.15);
    opacity: 0.8;
}
.gv-viewer-empty {
    flex: 1; display: flex; align-items: center; justify-content: center;
    color: #9ca3af; font-size: 14px;
}
.gv-viewer-pdf { flex: 1; width: 100%; border: 0; display: none; }

/* --- Intel Panel (Associations) --- */
.gv-intel-panel {
    border-top: 1px solid #e4e7eb; background: #fafbfc;
    padding: 0; flex-shrink: 0; display: none;
}
.gv-intel-strip {
    display: flex; align-items: center; gap: 8px;
    padding: 6px 16px; height: 36px; box-sizing: border-box;
    border-bottom: 1px solid #f0f2f5;
}
.gv-intel-strip:last-child { border-bottom: none; }
.gv-intel-strip-label {
    font-size: 10px; font-weight: 700; letter-spacing: 1px;
    text-transform: uppercase; color: #8c95a1; white-space: nowrap; flex-shrink: 0;
}
.gv-intel-chips {
    display: flex; align-items: center; gap: 5px; flex: 1; min-width: 0; overflow: hidden;
}
.gv-assoc-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 2px 8px; border-radius: 4px; font-size: 11px; color: #374151;
    background: #fff; border: 1px solid #e4e7eb;
    white-space: nowrap; max-width: 220px; overflow: hidden; text-overflow: ellipsis;
    cursor: default; position: relative;
}
.gv-assoc-chip.operational { border-left: 3px solid #2563eb; }
.gv-assoc-chip.governance { border-left: 3px solid #7c2d3e; }
.gv-assoc-chip.heuristic { border-style: dashed; opacity: 0.7; cursor: pointer; }
.gv-assoc-chip-remove {
    font-size: 12px; color: #d1d5db; cursor: pointer; margin-left: 2px;
}
.gv-assoc-chip-remove:hover { color: #ef4444; }
.gv-assoc-chip-score { font-size: 9px; color: #9ca3af; }
.gv-intel-link-btn {
    font-size: 10px; font-weight: 600; color: #2d5a87; cursor: pointer;
    border: none; background: none; padding: 2px 6px; border-radius: 4px;
    white-space: nowrap; flex-shrink: 0;
}
.gv-intel-link-btn:hover { background: #eef2ff; }

/* --- Tooltip --- */
.gv-tooltip {
    position: absolute; bottom: calc(100% + 4px); left: 50%; transform: translateX(-50%);
    background: #1e293b; color: #fff; padding: 3px 8px; border-radius: 4px;
    font-size: 10px; white-space: nowrap; pointer-events: none;
    opacity: 0; transition: opacity 0.15s; z-index: 10;
}
.gv-assoc-chip:hover .gv-tooltip { opacity: 1; }

/* --- Modal --- */
.gv-modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4);
    z-index: 1000; align-items: center; justify-content: center;
}
.gv-modal-overlay.active { display: flex; }
.gv-modal {
    background: #fff; border-radius: 14px; width: 520px; max-height: 80vh;
    display: flex; flex-direction: column; box-shadow: 0 20px 60px rgba(0,0,0,0.15);
}
.gv-modal-header {
    padding: 16px 20px; border-bottom: 1px solid #e4e7eb;
    font-size: 15px; font-weight: 700; color: #1a365d;
    display: flex; align-items: center; justify-content: space-between;
}
.gv-modal-close {
    font-size: 20px; cursor: pointer; color: #9ca3af; border: none; background: none; line-height: 1;
}
.gv-modal-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
.gv-modal-search {
    width: 100%; padding: 8px 12px; border: 1px solid #d1d5db;
    border-radius: 8px; font-size: 13px; margin-bottom: 12px; outline: none;
}
.gv-modal-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 10px;
    border-radius: 8px; cursor: pointer; font-size: 12px; color: #374151;
    transition: background 0.15s;
}
.gv-modal-item:hover { background: #f5f7fa; }
.gv-modal-item.linked { opacity: 0.4; cursor: default; }

/* --- Presentation Mode --- */
#gvPresOverlay {
    position: fixed; inset: 0; background: #000; z-index: 100001; display: none;
    align-items: center; justify-content: center; flex-direction: column;
}
#gvPresOverlay.active { display: flex; }
#gvPresCanvas {
    max-width: 100vw; max-height: 100vh; display: block;
}
#gvPresPageIndicator {
    position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%);
    color: rgba(255,255,255,0.35); font-size: 13px; font-weight: 600;
    pointer-events: none; z-index: 100002;
}
#gvPresPointerBtn {
    position: fixed; bottom: 16px; right: 16px; z-index: 100002;
    width: 36px; height: 36px; border-radius: 50%;
    background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25);
    color: rgba(255,255,255,0.6); font-size: 16px; cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.15s;
}
#gvPresPointerBtn:hover { background: rgba(255,255,255,0.25); }
#gvPresPointerBtn.active { background: rgba(255,255,255,0.35); color: #fff; }
.gv-pres-pointer { cursor: crosshair !important; }

/* --- Responsive --- */
@media (max-width: 1200px) {
    .gv-container { grid-template-columns: 1fr; }
    .gv-sidebar { display: none; }
    .gv-finder { border-right: none; }
    .gv-viewer { min-height: 500px; }
}
</style>
</head>
<body>

<!-- Top Bar -->
<div class="gv-topbar">
    <div class="gv-topbar-back">üëÅÔ∏è GLP Vision</div>
    
    <span class="gv-topbar-spacer"></span>
    <span class="gv-topbar-user" id="gvUserName"></span>
    <span class="gv-topbar-role" id="gvUserRole"></span>
</div>

<!-- Main 3-column layout -->
<div class="gv-container">

    <!-- Sidebar -->
    <div class="gv-sidebar" id="gvSidebar">
        <div class="gv-sidebar-section">
            <div class="gv-micro-title">STATUS</div>
            <div id="gvStatusBuckets"></div>
        </div>
        <div class="gv-sidebar-section">
            <div class="gv-micro-title">YEAR</div>
            <div id="gvYearList"></div>
        </div>
        <div class="gv-sidebar-section">
            <div class="gv-micro-title">SCOPE</div>
            <div id="gvScopeList"></div>
        </div>
    </div>

    <!-- Finder -->
    <div class="gv-finder">
        <div class="gv-search-area">
            <input type="text" class="gv-search-input" id="gvSearchInput" placeholder="Search files..." oninput="gvApplyFilters()">
        </div>
        <div class="gv-scope-pills">
            <span class="gv-scope-pill active" data-scope="DATA" onclick="gvSetScope(this)">DATA</span>
            <span class="gv-scope-pill" data-scope="PRESENTATION" onclick="gvSetScope(this)">PRES</span>
            <span class="gv-scope-pill" data-scope="SOP" onclick="gvSetScope(this)">SOP</span>
            <span class="gv-scope-pill" data-scope="" onclick="gvSetScope(this)">ALL</span>
        </div>
        <div class="gv-filter-row">
            <span class="gv-chip active" data-filter="status" data-val="" onclick="gvSetChip('status','')">All</span>
            <span class="gv-chip" data-filter="status" data-val="PENDING" onclick="gvSetChip('status','PENDING')">Pending</span>
            <span class="gv-chip" data-filter="status" data-val="APPROVED" onclick="gvSetChip('status','APPROVED')">Approved</span>
            <span class="gv-chip" data-filter="status" data-val="REVISION_NEEDED" onclick="gvSetChip('status','REVISION_NEEDED')">Revision</span>
        </div>
        <div class="gv-filter-row">
            <span class="gv-chip active" data-filter="time" data-val="" onclick="gvSetChip('time','')">All Time</span>
            <span class="gv-chip" data-filter="time" data-val="7" onclick="gvSetChip('time','7')">7d</span>
            <span class="gv-chip" data-filter="time" data-val="30" onclick="gvSetChip('time','30')">30d</span>
            <span class="gv-chip" data-filter="time" data-val="90" onclick="gvSetChip('time','90')">90d</span>
            <span class="gv-chip" data-filter="time" data-val="365" onclick="gvSetChip('time','365')">Year</span>
            <span style="margin-left:auto;"></span>
            <span class="gv-chip active" data-filter="sort" data-val="newest" onclick="gvSetChip('sort','newest')">Newest</span>
            <span class="gv-chip" data-filter="sort" data-val="oldest" onclick="gvSetChip('sort','oldest')">Oldest</span>
            <span class="gv-chip" data-filter="sort" data-val="name" onclick="gvSetChip('sort','name')">Name</span>
        </div>
        <div class="gv-results" id="gvResults">
            <div class="gv-empty-state">Loading files...</div>
        </div>
    </div>

    <!-- Viewer -->
    <div class="gv-viewer">
        <div class="gv-viewer-toolbar" id="gvToolbar">
            <span class="gv-viewer-filename" id="gvViewerFilename">No file selected</span>
        </div>
        <div class="gv-viewer-empty" id="gvViewerEmpty">Select a file to preview</div>
        <iframe class="gv-viewer-pdf" id="gvViewerPdf"></iframe>

        <!-- Intel Panel (Associations) -->
        <div class="gv-intel-panel" id="gvIntelPanel">
            <div class="gv-intel-strip">
                <span class="gv-intel-strip-label" id="gvSopLabel">SOPs (0)</span>
                <div class="gv-intel-chips" id="gvIntelSops"></div>
                <button class="gv-intel-link-btn" id="gvSopLinkBtn" onclick="gvOpenLinkModal('SOP')" style="display:none;">+</button>
            </div>
            <div class="gv-intel-strip">
                <span class="gv-intel-strip-label" id="gvPresLabel">PRES (0)</span>
                <div class="gv-intel-chips" id="gvIntelPres"></div>
                <button class="gv-intel-link-btn" id="gvPresLinkBtn" onclick="gvOpenLinkModal('PRESENTATION')" style="display:none;">+</button>
            </div>
        </div>
    </div>
</div>

<!-- Link Modal -->
<div class="gv-modal-overlay" id="gvLinkModal">
    <div class="gv-modal">
        <div class="gv-modal-header">
            <span id="gvLinkModalTitle">Link File</span>
            <button class="gv-modal-close" onclick="gvCloseLinkModal()">&times;</button>
        </div>
        <div class="gv-modal-body">
            <input type="text" class="gv-modal-search" id="gvLinkSearch" placeholder="Search files..." oninput="gvFilterLinkCandidates()">
            <div id="gvLinkCandidates"></div>
        </div>
    </div>
</div>

<!-- Presentation Mode Overlay -->
<div id="gvPresOverlay">
    <canvas id="gvPresCanvas"></canvas>
    <div id="gvPresPageIndicator"></div>
    <button id="gvPresPointerBtn" onclick="gvTogglePointer()" title="Toggle pointer (P)">&#9678;</button>
</div>

<script>
// =====================================================
// GLP VISION ‚Äî Client-side logic
// =====================================================

let gvUser = null;
let gvAllFiles = [];
let gvFilteredFiles = [];
let gvSelectedFileId = null;
let gvCurrentFileScope = 'DATA';
let gvFilters = { status: '', year: '', search: '', time: '', sort: 'newest', scopeResearcher: null };
let gvAssociationsCache = {};
let gvLinkModalType = '';
let gvIsOwnerView = true; // true when viewing own files

// Presentation mode state
let gvPresDoc = null;
let gvPresPage = 1;
let gvPresTotal = 0;
let gvPresPointerActive = false;

// =====================================================
// INIT
// =====================================================

async function gvInit() {
    try {
        const resp = await fetch('/api/di/vision/me', { credentials: 'include' });
        if (resp.status === 401) { window.location.href = '/access.html'; return; }
        const data = await resp.json();
        if (!data.success) { window.location.href = '/access.html'; return; }
        gvUser = data.user;

        document.getElementById('gvUserName').textContent = gvUser.name || gvUser.researcher_id;
        document.getElementById('gvUserRole').textContent = gvUser.role || 'Researcher';

        gvRenderScopeList();
        await gvLoadFiles();
    } catch (err) {
        console.error('[GV] Init error:', err);
        window.location.href = '/access.html';
    }
}

// =====================================================
// SCOPE LIST (Sidebar)
// =====================================================

function gvRenderScopeList() {
    const container = document.getElementById('gvScopeList');
    let html = `<div class="gv-scope-item active" onclick="gvSetScopeFilter(null)">
        <div class="gv-scope-avatar">${gvGetInitials(gvUser.name || gvUser.researcher_id)}</div>
        <span class="gv-scope-name">My Files</span>
    </div>`;

    if (gvUser.role === 'supervisor' && gvUser.assigned_researchers) {
        gvUser.assigned_researchers.forEach(r => {
            html += `<div class="gv-scope-item" onclick="gvSetScopeFilter('${r.researcher_id}')">
                <div class="gv-scope-avatar">${gvGetInitials(r.name || r.researcher_id)}</div>
                <span class="gv-scope-name">${gvFormatName(r.name || r.researcher_id)}</span>
            </div>`;
        });
    }
    container.innerHTML = html;
}

async function gvSetScopeFilter(researcherId) {
    gvFilters.scopeResearcher = researcherId;
    gvIsOwnerView = !researcherId;

    // Update active state
    document.querySelectorAll('.gv-scope-item').forEach((el, i) => {
        if (!researcherId && i === 0) el.classList.add('active');
        else if (researcherId && el.onclick && el.onclick.toString().includes(researcherId)) el.classList.add('active');
        else el.classList.remove('active');
    });

    await gvLoadFiles();
}

// =====================================================
// LOAD FILES
// =====================================================

async function gvLoadFiles() {
    try {
        let url = '/api/di/vision/files?scope=my';
        if (gvFilters.scopeResearcher) {
            url = `/api/di/vision/files?scope=researcher&researcher_id=${encodeURIComponent(gvFilters.scopeResearcher)}`;
        }
        const resp = await fetch(url, { credentials: 'include' });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            console.error('[GV] Load files error:', err);
            gvAllFiles = [];
        } else {
            const data = await resp.json();
            gvAllFiles = data.files || [];
        }
        gvAssociationsCache = {};
        gvRenderSidebar();
        gvApplyFilters();
    } catch (err) {
        console.error('[GV] Load files error:', err);
        gvAllFiles = [];
        gvApplyFilters();
    }
}

// =====================================================
// SIDEBAR RENDERING
// =====================================================

function gvRenderSidebar() {
    // Status buckets
    const counts = { all: 0, PENDING: 0, APPROVED: 0, REVISION_NEEDED: 0 };
    gvAllFiles.forEach(f => {
        counts.all++;
        if (counts[f.status] !== undefined) counts[f.status]++;
    });

    const statusContainer = document.getElementById('gvStatusBuckets');
    statusContainer.innerHTML = [
        { label: 'All', val: '', count: counts.all },
        { label: 'Pending', val: 'PENDING', count: counts.PENDING },
        { label: 'Approved', val: 'APPROVED', count: counts.APPROVED },
        { label: 'Revision', val: 'REVISION_NEEDED', count: counts.REVISION_NEEDED }
    ].map(b => `<div class="gv-status-bucket${gvFilters.status === b.val ? ' active' : ''}"
        onclick="gvSetSidebarFilter('status','${b.val}')">
        <span>${b.label}</span><span class="gv-count">${b.count}</span>
    </div>`).join('');

    // Year list
    const years = new Set();
    gvAllFiles.forEach(f => {
        const d = new Date(f.created_at);
        if (!isNaN(d)) years.add(d.getFullYear());
    });
    const sortedYears = [...years].sort((a, b) => b - a);

    const yearContainer = document.getElementById('gvYearList');
    yearContainer.innerHTML = `<div class="gv-year-item${gvFilters.year === '' ? ' active' : ''}"
        onclick="gvSetSidebarFilter('year','')">All Years</div>` +
        sortedYears.map(y => `<div class="gv-year-item${gvFilters.year === String(y) ? ' active' : ''}"
            onclick="gvSetSidebarFilter('year','${y}')">${y}</div>`).join('');
}

function gvSetSidebarFilter(key, val) {
    gvFilters[key] = val;
    gvRenderSidebar();
    gvApplyFilters();
}

// =====================================================
// FILTER & RENDER
// =====================================================

function gvApplyFilters() {
    const search = document.getElementById('gvSearchInput').value.toLowerCase().trim();
    gvFilters.search = search;

    gvFilteredFiles = gvAllFiles.filter(f => {
        if (gvCurrentFileScope && f.file_type !== gvCurrentFileScope) return false;
        if (gvFilters.status && f.status !== gvFilters.status) return false;
        if (gvFilters.year) {
            const fy = new Date(f.created_at).getFullYear();
            if (String(fy) !== gvFilters.year) return false;
        }
        if (gvFilters.time) {
            const days = parseInt(gvFilters.time);
            const age = (Date.now() - new Date(f.created_at).getTime()) / (1000 * 60 * 60 * 24);
            if (age > days) return false;
        }
        if (search && !f.original_filename.toLowerCase().includes(search)) return false;
        return true;
    });

    // Sort
    if (gvFilters.sort === 'newest') gvFilteredFiles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    else if (gvFilters.sort === 'oldest') gvFilteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    else if (gvFilters.sort === 'name') gvFilteredFiles.sort((a, b) => a.original_filename.localeCompare(b.original_filename));

    gvRenderResults();
}

function gvRenderResults() {
    const container = document.getElementById('gvResults');
    if (gvFilteredFiles.length === 0) {
        container.innerHTML = '<div class="gv-empty-state">No files match the current filters</div>';
        return;
    }

    container.innerHTML = gvFilteredFiles.map(f => {
        const ft = (f.file_type || 'DATA').toUpperCase();
        const ftClass = ft === 'PRESENTATION' ? 'pres' : ft.toLowerCase();
        const ftLabel = ft === 'PRESENTATION' ? 'PRES' : ft;
        const date = new Date(f.created_at);
        const dateStr = date.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });

        let statusBadge = '';
        if (f.status === 'PENDING') statusBadge = '<span class="gv-badge pending">PENDING</span>';
        else if (f.status === 'APPROVED') statusBadge = '<span class="gv-badge approved">APPROVED</span>';
        else if (f.status === 'REVISION_NEEDED') statusBadge = '<span class="gv-badge revision">REVISION</span>';

        const sopCount = f.linked_sop_count || 0;
        const presCount = f.linked_pres_count || 0;
        let assocBadges = '';
        if (sopCount > 0) assocBadges += `<span class="gv-assoc-count">SOP ${sopCount}</span>`;
        if (presCount > 0) assocBadges += `<span class="gv-assoc-count">PRES ${presCount}</span>`;

        return `<div class="gv-result-item${gvSelectedFileId === f.submission_id ? ' active' : ''}"
            onclick="gvSelectFile('${f.submission_id}')">
            <div class="gv-result-icon ${ftClass}">${ftLabel}</div>
            <div class="gv-result-info">
                <div class="gv-result-title" title="${gvEsc(f.original_filename)}">${gvEsc(gvTruncate(f.original_filename, 50))}</div>
                <div class="gv-result-sub">${dateStr}</div>
                <div class="gv-result-meta">${statusBadge}${assocBadges}</div>
            </div>
        </div>`;
    }).join('');
}

// =====================================================
// FILE SELECTION & VIEWING
// =====================================================

function gvSelectFile(fileId) {
    gvSelectedFileId = fileId;
    const file = gvAllFiles.find(f => f.submission_id === fileId);
    if (!file) return;

    // Update active state in list
    document.querySelectorAll('.gv-result-item').forEach(el => el.classList.remove('active'));
    const clicked = [...document.querySelectorAll('.gv-result-item')].find(el => el.onclick.toString().includes(fileId));
    if (clicked) clicked.classList.add('active');

    // Toolbar
    const toolbar = document.getElementById('gvToolbar');
    let statusBadge = '';
    if (file.status === 'PENDING') statusBadge = '<span class="gv-badge pending" style="margin-left:8px;">PENDING</span>';
    else if (file.status === 'APPROVED') statusBadge = '<span class="gv-badge approved" style="margin-left:8px;">APPROVED</span>';
    else if (file.status === 'REVISION_NEEDED') statusBadge = '<span class="gv-badge revision" style="margin-left:8px;">REVISION</span>';

    toolbar.innerHTML = `
        <span class="gv-viewer-filename" title="${gvEsc(file.original_filename)}">${gvEsc(gvTruncate(file.original_filename, 40))}</span>
        ${statusBadge}
        <span style="flex:1;"></span>
        <button class="gv-icon-btn" onclick="gvEnterPresentation()" title="Presentation mode">üé¨</button>
        <a class="gv-icon-btn" href="/api/di/download/${fileId}?download=true" target="_blank" title="Download">‚¨áÔ∏è</a>
    `;

    // PDF viewer
    const viewerEmpty = document.getElementById('gvViewerEmpty');
    const viewerPdf = document.getElementById('gvViewerPdf');
    const fileUrl = `/api/di/download/${fileId}`;
    const pdfSrc = `/pdfjs/web/viewer.html?file=${encodeURIComponent(fileUrl)}#pagemode=none&zoom=page-width`;

    viewerEmpty.style.display = 'none';
    viewerPdf.style.display = 'block';
    viewerPdf.src = pdfSrc;

    // Inject CSS to hide PDF.js chrome after load
    viewerPdf.onload = function() {
        try {
            const doc = viewerPdf.contentDocument;
            if (doc) {
                const style = doc.createElement('style');
                style.textContent = `
                    #toolbarContainer, #sidebarContainer, #sidebarContent,
                    #toolbarSidebar, #toolbarViewerMiddle, #toolbarViewerRight,
                    #secondaryToolbar, #loadingBar, #viewerContainer .toolbar,
                    #outerContainer > .toolbar { display: none !important; }
                    #viewerContainer { top: 0 !important; }
                    #mainContainer { min-width: 0 !important; }
                    #outerContainer { background: #f8f9fa; }
                `;
                doc.head.appendChild(style);
            }
        } catch (e) { /* cross-origin fallback ‚Äî ignore */ }
    };

    // Load associations
    gvLoadAssociations(fileId);
}

// =====================================================
// ASSOCIATIONS
// =====================================================

async function gvLoadAssociations(fileId) {
    const panel = document.getElementById('gvIntelPanel');
    const sopContainer = document.getElementById('gvIntelSops');
    const presContainer = document.getElementById('gvIntelPres');
    const sopLabel = document.getElementById('gvSopLabel');
    const presLabel = document.getElementById('gvPresLabel');
    const sopLinkBtn = document.getElementById('gvSopLinkBtn');
    const presLinkBtn = document.getElementById('gvPresLinkBtn');

    panel.style.display = 'block';
    sopContainer.innerHTML = '';
    presContainer.innerHTML = '';

    // Show link buttons only for own files
    sopLinkBtn.style.display = gvIsOwnerView ? '' : 'none';
    presLinkBtn.style.display = gvIsOwnerView ? '' : 'none';

    try {
        const resp = await fetch(`/api/di/vision/associations/${fileId}`, { credentials: 'include' });
        if (!resp.ok) { panel.style.display = 'none'; return; }
        const data = await resp.json();
        gvAssociationsCache[fileId] = data;

        const manualSops = (data.manual || []).filter(m => m.link_type === 'SOP');
        const manualPres = (data.manual || []).filter(m => m.link_type === 'PRESENTATION');
        const heuristicSops = data.heuristic_sops || [];
        const heuristicPres = data.heuristic_presentations || [];

        sopLabel.textContent = `SOPs (${manualSops.length})`;
        presLabel.textContent = `PRES (${manualPres.length})`;

        gvRenderIntelStrip(sopContainer, manualSops, heuristicSops, 'SOP');
        gvRenderIntelStrip(presContainer, manualPres, heuristicPres, 'PRESENTATION');
    } catch (err) {
        console.error('[GV] Load associations error:', err);
        panel.style.display = 'none';
    }
}

function gvRenderIntelStrip(container, manual, heuristic, type) {
    let html = '';

    manual.forEach(m => {
        const role = (m.created_by_role || 'pi').toLowerCase();
        const layerClass = role === 'pi' ? 'governance' : 'operational';
        const roleLabel = role === 'pi' ? 'PI' : role.charAt(0).toUpperCase() + role.slice(1);
        const canRemove = gvIsOwnerView && role !== 'pi' && m.created_by === (gvUser && gvUser.researcher_id);
        const removeBtn = canRemove ? `<span class="gv-assoc-chip-remove" onclick="event.stopPropagation();gvUnlinkFile('${m.id}')">&times;</span>` : '';

        html += `<span class="gv-assoc-chip ${layerClass}" title="${gvEsc(m.original_filename)}">
            <span class="gv-tooltip">Linked by ${roleLabel}</span>
            ${gvEsc(gvTruncate(m.original_filename || '', 30))}${removeBtn}
        </span>`;
    });

    if (gvIsOwnerView) {
        heuristic.slice(0, 2).forEach(h => {
            html += `<span class="gv-assoc-chip heuristic" onclick="gvQuickLink('${h.submission_id}','${type}')"
                title="${gvEsc(h.filename || h.original_filename)}">
                ${gvEsc(gvTruncate(h.filename || h.original_filename || '', 25))}
                <span class="gv-assoc-chip-score">${h.score}</span>
            </span>`;
        });
    }

    container.innerHTML = html;
}

async function gvQuickLink(targetId, type) {
    if (!gvSelectedFileId) return;
    try {
        const resp = await fetch('/api/di/vision/associations', {
            method: 'POST', credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_id: gvSelectedFileId, target_id: targetId, link_type: type })
        });
        if (resp.ok) await gvLoadAssociations(gvSelectedFileId);
    } catch (err) { console.error('[GV] Quick link error:', err); }
}

async function gvUnlinkFile(assocId) {
    try {
        const resp = await fetch(`/api/di/vision/associations/${assocId}`, {
            method: 'DELETE', credentials: 'include'
        });
        if (resp.ok && gvSelectedFileId) await gvLoadAssociations(gvSelectedFileId);
    } catch (err) { console.error('[GV] Unlink error:', err); }
}

// =====================================================
// LINK MODAL
// =====================================================

function gvOpenLinkModal(type) {
    gvLinkModalType = type;
    document.getElementById('gvLinkModalTitle').textContent = `Link ${type === 'SOP' ? 'SOP' : 'Presentation'}`;
    document.getElementById('gvLinkSearch').value = '';
    document.getElementById('gvLinkModal').classList.add('active');
    gvRenderLinkCandidates();
}

function gvCloseLinkModal() {
    document.getElementById('gvLinkModal').classList.remove('active');
}

function gvFilterLinkCandidates() { gvRenderLinkCandidates(); }

function gvRenderLinkCandidates() {
    const search = document.getElementById('gvLinkSearch').value.toLowerCase().trim();
    const container = document.getElementById('gvLinkCandidates');
    const targetType = gvLinkModalType;

    // Get existing linked IDs
    const cached = gvAssociationsCache[gvSelectedFileId];
    const linkedIds = new Set();
    if (cached && cached.manual) cached.manual.filter(m => m.link_type === targetType).forEach(m => linkedIds.add(m.target_id));

    const candidates = gvAllFiles.filter(f => {
        if (f.submission_id === gvSelectedFileId) return false;
        if (f.file_type !== targetType) return false;
        if (f.status === 'DISCARDED') return false;
        if (search && !f.original_filename.toLowerCase().includes(search)) return false;
        return true;
    });

    if (candidates.length === 0) {
        container.innerHTML = '<div style="padding:12px;color:#9ca3af;font-size:13px;">No matching files found</div>';
        return;
    }

    container.innerHTML = candidates.slice(0, 30).map(f => {
        const isLinked = linkedIds.has(f.submission_id);
        const date = new Date(f.created_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
        return `<div class="gv-modal-item${isLinked ? ' linked' : ''}"
            ${isLinked ? '' : `onclick="gvLinkFromModal('${f.submission_id}')"`}>
            <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${gvEsc(f.original_filename)}</span>
            <span style="font-size:10px;color:#9ca3af;">${date}</span>
            ${isLinked ? '<span style="font-size:10px;color:#6366f1;">linked</span>' : ''}
        </div>`;
    }).join('');
}

async function gvLinkFromModal(targetId) {
    if (!gvSelectedFileId) return;
    try {
        const resp = await fetch('/api/di/vision/associations', {
            method: 'POST', credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ source_id: gvSelectedFileId, target_id: targetId, link_type: gvLinkModalType })
        });
        if (resp.ok) {
            await gvLoadAssociations(gvSelectedFileId);
            gvRenderLinkCandidates();
        }
    } catch (err) { console.error('[GV] Link from modal error:', err); }
}

// =====================================================
// SCOPE PILLS & CHIPS
// =====================================================

function gvSetScope(el) {
    gvCurrentFileScope = el.dataset.scope;
    document.querySelectorAll('.gv-scope-pill').forEach(p => p.classList.remove('active'));
    el.classList.add('active');
    gvApplyFilters();
}

function gvSetChip(key, val) {
    gvFilters[key] = val;
    document.querySelectorAll(`.gv-chip[data-filter="${key}"]`).forEach(c => {
        c.classList.toggle('active', c.dataset.val === val);
    });
    gvApplyFilters();
}

// =====================================================
// PRESENTATION MODE
// =====================================================

async function gvEnterPresentation() {
    if (!gvSelectedFileId) return;
    const fileUrl = `/api/di/download/${gvSelectedFileId}`;

    const overlay = document.getElementById('gvPresOverlay');
    const canvas = document.getElementById('gvPresCanvas');
    const indicator = document.getElementById('gvPresPageIndicator');

    overlay.classList.add('active');
    gvPresPage = 1;
    gvPresPointerActive = false;
    document.getElementById('gvPresPointerBtn').classList.remove('active');
    canvas.classList.remove('gv-pres-pointer');

    try {
        // Request fullscreen
        if (overlay.requestFullscreen) overlay.requestFullscreen();
        else if (overlay.webkitRequestFullscreen) overlay.webkitRequestFullscreen();

        // Load PDF with pdf.js
        const pdfjsLib = await gvGetPdfLib();
        gvPresDoc = await pdfjsLib.getDocument(fileUrl).promise;
        gvPresTotal = gvPresDoc.numPages;
        indicator.textContent = `${gvPresPage} / ${gvPresTotal}`;
        await gvPresRenderPage();
    } catch (err) {
        console.error('[GV] Presentation load error:', err);
        gvExitPresentation();
    }

    document.addEventListener('keydown', gvPresKeyHandler);
    document.addEventListener('fullscreenchange', gvPresFullscreenChange);
    document.addEventListener('webkitfullscreenchange', gvPresFullscreenChange);
}

function gvPresFullscreenChange() {
    if (!document.fullscreenElement && !document.webkitFullscreenElement) {
        // Fullscreen exited via browser ‚Äî close presentation
        gvExitPresentation();
    }
}

async function gvPresRenderPage() {
    if (!gvPresDoc) return;
    const canvas = document.getElementById('gvPresCanvas');
    const ctx = canvas.getContext('2d');
    const page = await gvPresDoc.getPage(gvPresPage);

    // Scale to viewport width
    const vw = window.innerWidth;
    const vh = window.innerHeight;
    const unscaledViewport = page.getViewport({ scale: 1 });
    const scaleW = vw / unscaledViewport.width;
    const scaleH = vh / unscaledViewport.height;
    const scale = Math.min(scaleW, scaleH);
    const viewport = page.getViewport({ scale });

    canvas.width = viewport.width;
    canvas.height = viewport.height;
    canvas.style.width = viewport.width + 'px';
    canvas.style.height = viewport.height + 'px';

    await page.render({ canvasContext: ctx, viewport }).promise;

    document.getElementById('gvPresPageIndicator').textContent = `${gvPresPage} / ${gvPresTotal}`;
}

function gvPresKeyHandler(e) {
    if (!document.getElementById('gvPresOverlay').classList.contains('active')) return;

    switch (e.key) {
        case 'ArrowRight':
        case ' ':
            if (e.shiftKey && e.key === ' ') { gvPresNav(-1); } else { gvPresNav(1); }
            e.preventDefault(); break;
        case 'ArrowLeft':
            gvPresNav(-1); e.preventDefault(); break;
        case 'Home':
            gvPresPage = 1; gvPresRenderPage(); e.preventDefault(); break;
        case 'End':
            gvPresPage = gvPresTotal; gvPresRenderPage(); e.preventDefault(); break;
        case 'Escape':
            gvExitPresentation(); e.preventDefault(); break;
        case 'p': case 'P':
            gvTogglePointer(); e.preventDefault(); break;
    }
}

function gvPresNav(dir) {
    const next = gvPresPage + dir;
    if (next >= 1 && next <= gvPresTotal) {
        gvPresPage = next;
        gvPresRenderPage();
    }
}

function gvTogglePointer() {
    gvPresPointerActive = !gvPresPointerActive;
    const canvas = document.getElementById('gvPresCanvas');
    const btn = document.getElementById('gvPresPointerBtn');
    canvas.classList.toggle('gv-pres-pointer', gvPresPointerActive);
    btn.classList.toggle('active', gvPresPointerActive);
}

function gvExitPresentation() {
    const overlay = document.getElementById('gvPresOverlay');
    overlay.classList.remove('active');
    document.removeEventListener('keydown', gvPresKeyHandler);
    document.removeEventListener('fullscreenchange', gvPresFullscreenChange);
    document.removeEventListener('webkitfullscreenchange', gvPresFullscreenChange);

    if (document.fullscreenElement || document.webkitFullscreenElement) {
        if (document.exitFullscreen) document.exitFullscreen();
        else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
    }

    gvPresDoc = null;
    gvPresPointerActive = false;
}

// Lazy-load pdf.js library
let _pdfjsLib = null;
async function gvGetPdfLib() {
    if (_pdfjsLib) return _pdfjsLib;
    _pdfjsLib = await import('/pdfjs/build/pdf.mjs');
    _pdfjsLib.GlobalWorkerOptions.workerSrc = '/pdfjs/build/pdf.worker.mjs';
    return _pdfjsLib;
}

// =====================================================
// HELPERS
// =====================================================

function gvGetInitials(name) {
    if (!name) return '?';
    const parts = name.trim().split(/\s+/);
    if (parts.length === 1) return parts[0].charAt(0).toUpperCase();
    return (parts[0].charAt(0) + parts[parts.length - 1].charAt(0)).toUpperCase();
}

function gvFormatName(name) {
    if (!name) return '';
    const parts = name.trim().split(/\s+/);
    if (parts.length <= 1) return name;
    return parts[0] + ' ' + parts[parts.length - 1].charAt(0) + '.';
}

function gvTruncate(str, max) {
    if (!str || str.length <= max) return str || '';
    return str.substring(0, max - 1) + '\u2026';
}

function gvEsc(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
}

// =====================================================
// BOOT
// =====================================================

gvInit();
</script>
</body>
</html>
