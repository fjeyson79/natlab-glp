<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI Dashboard: NATLAB GLP Portal</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 20px; }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
        }
        .pi-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: #1a365d; background: #f8f9fa; }
        .tab-btn.active {
            color: #1a365d;
            border-bottom-color: #1a365d;
        }
        .tab-btn .badge {
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        /* Tab Content */
        .tab-content { display: none; padding: 20px; max-width: 1600px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* Panels */
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 {
            font-size: 16px;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel-header .icon { font-size: 20px; }
        .panel-content { padding: 20px; }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #1a365d;
        }
        .stat-card .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        .stat-card.pending .stat-value { color: #ffc107; }
        .stat-card.approved .stat-value { color: #28a745; }
        .stat-card.revision .stat-value { color: #dc3545; }

        /* Grid Layouts */
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .upload-column { max-width: 500px; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a87;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover { border-color: #2d5a87; background: #f8f9fa; }
        .file-upload.has-file { border-color: #28a745; background: #f0fff4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload-text { color: #666; font-size: 13px; }
        .file-upload-text strong { color: #2d5a87; }
        .file-name { margin-top: 8px; color: #28a745; font-weight: bold; font-size: 13px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #2d5a87; color: white; }
        .btn-primary:hover { background: #1a365d; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-full { width: 100%; }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        .data-table tr:hover { background: #f8f9fa; }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-revision { background: #f8d7da; color: #721c24; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #e2e3e5; color: #6c757d; }

        /* Type Badges */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .type-badge.pdf { background: #fee; color: #c00; }
        .type-badge.excel { background: #efe; color: #060; }
        .type-badge.word { background: #eef; color: #00c; }
        .type-badge.powerpoint { background: #fef3e0; color: #e65100; }
        .type-badge.sop { background: #e3f2fd; color: #1565c0; }
        .type-badge.data { background: #fff3e0; color: #e65100; }

        /* Role Badge */
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .role-badge.pi { background: #ffc107; color: #333; }
        .role-badge.supervisor { background: #17a2b8; color: white; }
        .role-badge.researcher { background: #e0e0e0; color: #333; }

        /* Actions */
        .actions { display: flex; gap: 5px; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 6px;
            margin-bottom: 15px;
            align-items: center;
        }
        .bulk-actions.hidden { display: none; }
        .bulk-actions span { font-size: 13px; color: #1a365d; font-weight: bold; }

        /* Tree View */
        .directory-tree { font-size: 13px; }
        .tree-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tree-item:hover { background: #f0f2f5; }
        .tree-item .icon { font-size: 16px; }
        .tree-folder { font-weight: bold; color: #1a365d; }
        .tree-file { color: #333; padding-left: 20px; }
        .tree-children { margin-left: 20px; border-left: 1px solid #e0e0e0; }
        .tree-children.collapsed { display: none; }
        .file-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .file-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Loading */
        .loading { text-align: center; padding: 30px; color: #666; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2d5a87;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Review Summary */
        .ai-summary {
            font-size: 12px;
            color: #666;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ai-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        .ai-score.high { background: #d4edda; color: #155724; }
        .ai-score.medium { background: #fff3cd; color: #856404; }
        .ai-score.low { background: #f8d7da; color: #721c24; }

        /* Responsive */
        @media (max-width: 1200px) {
            .two-column { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .tab-nav { overflow-x: auto; }
        }
        @media (max-width: 768px) {
            .tab-btn { padding: 12px 15px; font-size: 12px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group select, .filter-group input { width: 100%; }
        }
    
.download-mode-option.half-width {
  width: 48%;
  display: inline-flex;
  margin: 1%;
}
</style>
</head>
<body>
    <div class="header">
        <h1>NATLAB GLP Data Integrity Portal</h1>
        <div class="header-info">
            <span class="pi-badge">PRINCIPAL INVESTIGATOR</span>
            <span class="user-badge" id="userName">Loading...</span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="dashboard">Dashboard <span class="badge" id="pendingBadge" style="display:none;">0</span></button>
        <button class="tab-btn" data-tab="lab-files">Laboratory Files</button>
        <button class="tab-btn" data-tab="group-docs">Group Documents</button>
        <button class="tab-btn" data-tab="user-mgmt">User Management</button>
        <button class="tab-btn" data-tab="reports">Reports</button>
        <button class="tab-btn" data-tab="backup">Backup</button>
        <button class="tab-btn" data-tab="purchases-inventory">Purchases &amp; Inventory <span class="badge" id="invSubmittedBadge" style="display:none;">0</span></button>
    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div class="tab-content active" id="tab-dashboard">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value" id="statApproved">-</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card revision">
                <div class="stat-value" id="statRevision">-</div>
                <div class="stat-label">Revision Needed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total Submissions</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Pending Approvals -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending Approvals</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPendingApprovals()">Refresh</button>
                </div>
                <div class="panel-content" style="max-height: 500px; overflow-y: auto;">
                    <div id="pendingApprovalsContainer">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Upload -->
            <div class="panel upload-column">
                <div class="panel-header">
                    <h2><span class="icon">&#128194;</span> Quick Upload</h2>
                </div>
                <div class="panel-content">
                    <div id="uploadMessage" class="message"></div>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="uploadResearcher">Upload for Researcher</label>
                            <select id="uploadResearcher" required>
                                <option value="">Select researcher...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fileType">File Type</label>
                            <select id="fileType" required>
                                <option value="">Select file type...</option>
                                <option value="SOP">SOP (Standard Operating Procedure)</option>
                                <option value="DATA">DATA (Research Data)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>File</label>
                            <div class="file-upload" id="fileUploadArea">
                                <input type="file" id="fileInput" accept=".pdf" required>
                                <p class="file-upload-text">
                                    <strong>Click to select a file</strong><br>
                                    or drag and drop here
                                </p>
                                <p class="file-name" id="fileName"></p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="uploadBtn">Upload File</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LABORATORY FILES TAB ==================== -->
    <div class="tab-content" id="tab-lab-files">
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128193;</span> Laboratory Files</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadLabFiles()">Refresh</button>
            </div>
            <div class="panel-content">
                <!-- Filters -->
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="filterStatus" onchange="applyFilters()">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REVISION_NEEDED">Revision Needed</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Year</label>
                        <select id="filterYear" onchange="applyFilters()">
                            <option value="">All Years</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Researcher</label>
                        <select id="filterResearcher" onchange="applyFilters()">
                            <option value="">All Researchers</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Search</label>
                        <input type="text" id="filterSearch" placeholder="Search filename..." oninput="applyFilters()">
                    </div>
                </div>

                <!-- Bulk Actions -->
                <div id="labBulkActions" class="bulk-actions hidden">
                    <span id="labSelectedCount">0 selected</span>
                    <button class="btn btn-sm btn-secondary" onclick="selectAllLabFiles()">Select All</button>
                    <button class="btn btn-sm btn-warning" onclick="clearLabSelection()">Clear</button>
                    <button class="btn btn-sm btn-success" onclick="bulkDownloadLab()">Download Selected</button>
                    <button class="btn btn-sm btn-danger" onclick="bulkDeleteLab()">Delete Selected</button>
                </div>

                <!-- Tree View -->
                <div id="labFilesTree" class="directory-tree">
                    <div class="loading"><div class="spinner"></div>Loading files...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== GROUP DOCUMENTS TAB ==================== -->
    <div class="tab-content" id="tab-group-docs">
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128218;</span> Group Documents</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadGroupDocuments()">Refresh</button>
            </div>
            <div class="panel-content">
                <!-- Upload Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="font-size: 14px; color: #1a365d; margin-bottom: 15px;">Upload New Document</h3>
                    <div id="groupDocMessage" class="message"></div>
                    <form id="groupDocForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="docTitle">Title *</label>
                                <input type="text" id="docTitle" required placeholder="Document title">
                            </div>
                            <div class="form-group">
                                <label for="docCategory">Category *</label>
                                <select id="docCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="SOP">SOP (Standard Operating Procedure)</option>
                                    <option value="Guidelines">Guidelines</option>
                                    <option value="Templates">Templates</option>
                                    <option value="Training">Training Materials</option>
                                    <option value="Forms">Forms</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="docDescription">Description (optional)</label>
                                <textarea id="docDescription" placeholder="Brief description of the document"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>File * (PDF, Word, Excel, PowerPoint)</label>
                                <div class="file-upload" id="groupDocUploadArea" style="padding: 15px;">
                                    <input type="file" id="groupDocFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                                    <p class="file-upload-text" style="margin: 0;">
                                        <strong>Click to select</strong> or drag and drop
                                    </p>
                                    <p class="file-name" id="groupDocFileName" style="margin: 5px 0 0 0;"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Permissions</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="docCanDownload" checked>
                                    <label for="docCanDownload">Allow researchers to download</label>
                                </div>
                                <p style="font-size: 11px; color: #666; margin-top: 5px;">If unchecked, researchers can only view online</p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="groupDocSubmitBtn">Upload Document</button>
                    </form>
                </div>

                <!-- Documents Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Download</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="groupDocsTableBody">
                        <tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== USER MANAGEMENT TAB ==================== -->
    <div class="tab-content" id="tab-user-mgmt">
        <div class="two-column">
            <!-- Add User Form -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128100;</span> Add New User</h2>
                </div>
                <div class="panel-content">
                    <div id="addUserMessage" class="message"></div>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName">Full Name *</label>
                            <input type="text" id="newUserName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Institution Email *</label>
                            <input type="email" id="newUserEmail" required placeholder="john.doe@liu.se">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserAffiliation">Affiliation *</label>
                                <select id="newUserAffiliation" required>
                                    <option value="">Select...</option>
                                    <option value="LiU">LiU</option>
                                    <option value="UNAV">UNAV</option>
                                    <option value="EXTERNAL">External</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newUserRole">Role *</label>
                                <select id="newUserRole" required>
                                    <option value="researcher">Researcher</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="pi">Principal Investigator</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="addUserBtn">Add User</button>
                    </form>
                </div>
            </div>

            <!-- User Info -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128712;</span> User Management Info</h2>
                </div>
                <div class="panel-content">
                    <div class="message info show">
                        <strong>Deactivation Policy:</strong><br><br>
                        When a user is deactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>They cannot log in or use the system</li>
                            <li>All their historical data remains intact</li>
                            <li>Their submissions are preserved</li>
                        </ul>
                        <br>
                        When reactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>All previous data, roles, and submissions are restored</li>
                            <li>They can log in again with the same credentials</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delegation Section -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> Supervisor Delegation</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadDelegationData()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="delegationMessage" class="message"></div>
                <div class="form-row">
                    <!-- Promote/Demote -->
                    <div class="form-group">
                        <label>Promote/Demote Researcher</label>
                        <select id="promoteSelect" style="margin-bottom:8px;">
                            <option value="">Select a researcher...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-success" onclick="promoteToSupervisor()">Promote to Supervisor</button>
                            <button class="btn btn-sm btn-warning" onclick="demoteToResearcher()">Demote to Researcher</button>
                        </div>
                    </div>
                    <!-- Assign Researchers -->
                    <div class="form-group">
                        <label>Assign Researcher to Supervisor</label>
                        <select id="supervisorSelect" style="margin-bottom:8px;">
                            <option value="">Select supervisor...</option>
                        </select>
                        <select id="assignResearcherSelect" style="margin-bottom:8px;">
                            <option value="">Select researcher to assign...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-primary" onclick="assignResearcher()">Assign</button>
                            <button class="btn btn-sm btn-danger" onclick="unassignResearcher()">Unassign</button>
                        </div>
                    </div>
                </div>
                <!-- Assignments Table -->
                <div style="margin-top:15px;">
                    <label>Current Assignments</label>
                    <table class="data-table" id="assignmentsTable">
                        <thead>
                            <tr><th>Supervisor</th><th>Researcher</th><th>Assigned</th><th>Action</th></tr>
                        </thead>
                        <tbody id="assignmentsTableBody">
                            <tr><td colspan="4" style="text-align:center;color:#666;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> All Users</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllUsers()">Refresh</button>
            </div>
            <div class="panel-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Researcher ID</th>
                            <th>Affiliation</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Submissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== REPORTS TAB ==================== -->
    <div class="tab-content" id="tab-reports">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="reportTotalSubmissions">-</div>
                <div class="stat-label">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reportTotalResearchers">-</div>
                <div class="stat-label">Active Researchers</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value" id="reportApprovalRate">-</div>
                <div class="stat-label">Approval Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reportThisMonth">-</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Submissions by Status -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128202;</span> Submissions by Status</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table" id="statusBreakdownTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="statusBreakdownBody">
                            <tr><td colspan="3"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Submissions by Researcher -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128100;</span> Top Researchers</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Submissions</th>
                                <th>Approved</th>
                            </tr>
                        </thead>
                        <tbody id="researcherBreakdownBody">
                            <tr><td colspan="3"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128190;</span> Export Data</h2>
            </div>
            <div class="panel-content">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="exportFromDate">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="exportToDate">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="exportStatus">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REVISION_NEEDED">Revision Needed</option>
                        </select>
                    </div>
                    <div class="filter-group" style="justify-content: flex-end;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== BACKUP TAB ==================== -->
    <div class="tab-content" id="tab-backup">
        <!-- Description -->
        <div class="message info show" style="margin-bottom:20px;display:block;">
            This section provides secure access to verified backup copies of all laboratory data. Primary data are continuously stored in the system and replicated to an independent backup storage as immutable snapshots. Backups protect against accidental deletion, corruption, or system failure and do not affect ongoing work unless explicitly used.
        </div>

        <!-- Recovery Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Recovery</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadBackupSnapshots()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="backupMessage" class="message"></div>

                <!-- Step 1: Select Snapshot -->
                <div class="form-group">
                    <label>Select Recovery Point</label>
                    <select id="backupSnapshotSelect" onchange="clearBackupPreview()">
                        <option value="">Select a recovery point...</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="previewBackupRecovery()">Preview Comparison</button>
                </div>

                <!-- Step 2: Preview Summary -->
                <div id="backupPreviewContainer" style="display:none;">
                    <div class="stats-row" style="margin-bottom:10px;">
                        <div class="stat-card">
                            <div class="stat-value" id="bkpBackupCount">0</div>
                            <div class="stat-label">Files in Backup</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bkpR2Count">0</div>
                            <div class="stat-label">Files in Storage</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-value" id="bkpDiffCount">0</div>
                            <div class="stat-label">Estimated Difference</div>
                        </div>
                    </div>
                    <p id="backupSummaryText" style="color:#555;margin-bottom:15px;font-size:14px;"></p>

                    <!-- Step 3: Recovery Mode -->
                    <div class="form-group">
                        <label>Recovery Mode</label>
                        <select id="backupRecoveryMode">
                            <option value="add-missing">Add missing files only (recommended)</option>
                            <option value="full-restore">Full restore from backup</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" onclick="confirmBackupRecovery()" id="backupRecoverBtn">Start Recovery</button>
                </div>

                <!-- Recovery Progress -->
                <div id="backupRecoveryProgress" style="display:none;margin-top:15px;">
                    <div class="loading"><div class="spinner"></div>Recovery in progress. This may take several minutes.</div>
                </div>

                <!-- Recovery Result -->
                <div id="backupRecoveryResult" style="display:none;margin-top:15px;"></div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Download</h2>
            </div>
            <div class="panel-content">
                <p style="color:#555;margin-bottom:15px;font-size:14px;">Download current data directly from storage as ZIP files. Choose by researcher, by date range, or download everything. For large selections, multi-file download is recommended.</p>
                <div id="dlMessage" class="message"></div>

                <!-- Main buttons -->
                <div id="dlButtons" style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="dlStartFlow('researcher')">Download by Researcher</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('daterange')">Download by Date Range</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('full')">Full Data Download</button>
                </div>

                <!-- Flow container -->
                <div id="dlFlow" style="display:none;">
                    <div style="margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                        <button class="btn btn-sm btn-secondary" onclick="dlReset()">&larr; Back</button>
                        <span id="dlFlowTitle" style="font-weight:600;font-size:15px;"></span>
                        <span id="dlStepLabel" style="color:#888;font-size:13px;margin-left:auto;"></span>
                    </div>
                    <div id="dlStepContent"></div>
                    <div id="dlStepActions" style="margin-top:15px;display:flex;gap:10px;"></div>
                </div>

                <!-- Download progress / multi-part tracker -->
                <div id="dlProgress" style="display:none;margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== PURCHASES & INVENTORY TAB ==================== -->
    <div class="tab-content" id="tab-purchases-inventory">

        <!-- Purchase Requests for PI Review -->
        <div class="panel">
            <div class="panel-header">
                <h2>Purchase Requests</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllPurchaseRequests()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
                    <select id="prFilterStatus" onchange="loadAllPurchaseRequests()" style="padding:6px;border-radius:4px;border:1px solid #ddd;font-size:13px;">
                        <option value="">All Statuses</option>
                        <option value="SUBMITTED" selected>Submitted</option>
                        <option value="APPROVED">Approved</option>
                        <option value="DECLINED">Declined</option>
                    </select>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="data-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Requester</th>
                                <th>Affil.</th>
                                <th>Justification</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prAllTableBody">
                            <tr><td colspan="8" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchase Request Detail (hidden by default) -->
        <div class="panel" id="prDetailPanel" style="display:none;">
            <div class="panel-header">
                <h2 id="prDetailTitle">Request Detail</h2>
                <button class="btn btn-sm btn-secondary" onclick="closePrDetail()">Close</button>
            </div>
            <div class="panel-content">
                <div id="prDetailJustification" style="margin-bottom:10px;padding:8px 12px;background:#f8f9fa;border-radius:4px;font-size:13px;"></div>
                <table class="data-table" style="font-size:13px;">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Product</th>
                            <th>Catalog ID</th>
                            <th>Link</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Ordered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prDetailItemsBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6" style="text-align:right;font-weight:600;">Request Total:</td><td id="prDetailTotal" style="font-weight:700;" colspan="3"></td></tr>
                    </tfoot>
                </table>
                <div id="prDetailActions" style="margin-top:12px;display:flex;gap:10px;"></div>
            </div>
        </div>

        <!-- Consolidated Email (PI) -->
        <div class="panel">
            <div class="panel-header">
                <h2>Consolidated Purchase Email</h2>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('LiU')">Load LiU</button>
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('UNAV')">Load UNAV</button>
                </div>
                <div id="prConsolidatedArea" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong id="prConsolidatedTitle"></strong>
                        <button class="btn btn-sm btn-success" onclick="copyConsolidatedEmail()">Copy email text</button>
                    </div>
                    <pre id="prConsolidatedText" style="background:#f8f9fa;padding:12px;border-radius:4px;font-size:12px;white-space:pre-wrap;max-height:400px;overflow-y:auto;border:1px solid #ddd;"></pre>
                </div>
                <div id="prConsolidatedEmpty" style="display:none;text-align:center;color:#999;padding:10px;">No approved items to order for this affiliation.</div>
            </div>
        </div>

        <!-- Submitted Inventory Imports -->
        <div class="panel">
            <div class="panel-header">
                <h2>Submitted Inventory Imports</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadSubmittedInventoryImports()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="invImportMessage" class="message"></div>
                <table class="data-table" id="invImportTable">
                    <thead>
                        <tr>
                            <th>Submitted By</th>
                            <th>File</th>
                            <th>Affiliation</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invImportTableBody">
                        <tr><td colspan="5" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Import Review Area (hidden by default) -->
        <div class="panel" id="invReviewPanel" style="display:none;">
            <div class="panel-header">
                <h2 id="invReviewTitle">Review Import</h2>
                <button class="btn btn-sm btn-secondary" onclick="closeInventoryReview()">Close</button>
            </div>
            <div class="panel-content">
                <div id="invReviewMessage" class="message"></div>
                <div id="invReviewSummary" style="margin-bottom:15px;"></div>
                <div style="max-height:400px;overflow-y:auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Affiliation</th>
                                <th>Vendor</th>
                                <th>Product</th>
                                <th>Catalog ID</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Storage</th>
                                <th>Location</th>
                                <th>Responsible</th>
                            </tr>
                        </thead>
                        <tbody id="invReviewTableBody"></tbody>
                    </table>
                </div>
                <div style="margin-top:15px;display:flex;gap:10px;" id="invReviewActions"></div>
            </div>
        </div>

        <!-- All Inventory Items -->
        <div class="panel">
            <div class="panel-header">
                <h2>All Inventory Items</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllInventory()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <select id="invFilterAffiliation" onchange="loadAllInventory()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Affiliations</option>
                        <option value="LiU">LiU</option>
                        <option value="UNAV">UNAV</option>
                    </select>
                    <select id="invFilterResponsible" onchange="loadAllInventory()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Responsible</option>
                        <option value="user">User-owned</option>
                        <option value="group">Group</option>
                    </select>
                    <select id="invFilterStatus" onchange="loadAllInventory()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Statuses</option>
                        <option value="Active">Active</option>
                        <option value="Finished">Finished</option>
                    </select>
                    <select id="invFilterOrigin" onchange="loadAllInventory()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Origins</option>
                        <option value="online_purchase">Online Purchase</option>
                        <option value="offline_import">Offline Import</option>
                    </select>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Vendor</th>
                            <th>Catalog ID</th>
                            <th>Affiliation</th>
                            <th>Owner</th>
                            <th>Qty</th>
                            <th>Unit</th>
                            <th>Storage</th>
                            <th>Location</th>
                            <th>Status</th>
                            <th>Origin</th>
                        </tr>
                    </thead>
                    <tbody id="invAllTableBody">
                        <tr><td colspan="11" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // GLOBAL STATE & INIT
        // =====================================================
        let currentUser = null;
        let allMembers = [];
        let labFilesData = [];
        let selectedLabFiles = new Set();

        // Check authentication and PI role
        async function checkAuth() {
            try {
                const response = await fetch('/api/di/me', { credentials: 'include' });
                if (response.status === 401) { window.location.href = 'access.html'; return; }
                const data = await response.json();
                currentUser = data.user || data;

                // Check if user is PI
                const role = (currentUser.role || "").toUpperCase();
                if (role !== "PI" && role !== "ADMIN") {
                    window.location.href = 'upload.html';
                    return;
                }

                document.getElementById('userName').textContent = currentUser.researcher_id;

                // Load initial data
                loadDashboardData();
                populateResearcherDropdown();
                loadGroupDocuments();
                loadAllUsers();
                loadReportsData();

            } catch (err) {
                window.location.href = 'access.html';
            }
        }

        checkAuth();

        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update active tab content
                const tabId = btn.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');

                // Load tab-specific data
                if (tabId === 'lab-files') loadLabFiles();
                if (tabId === 'reports') loadReportsData();
                if (tabId === 'purchases-inventory') { loadAllPurchaseRequests(); loadSubmittedInventoryImports(); loadAllInventory(); }
            });
        });

        // =====================================================
        // DASHBOARD TAB
        // =====================================================
        async function loadDashboardData() {
            loadPendingApprovals();
            loadStats();
            loadInventoryBadge();
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/di/metrics', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statPending').textContent = data.byStatus?.PENDING || 0;
                    document.getElementById('statApproved').textContent = data.byStatus?.APPROVED || 0;
                    document.getElementById('statRevision').textContent = data.byStatus?.REVISION_NEEDED || 0;
                    document.getElementById('statTotal').textContent = data.total || 0;

                    // Update badge
                    const pending = data.byStatus?.PENDING || 0;
                    const badge = document.getElementById('pendingBadge');
                    if (pending > 0) {
                        badge.textContent = pending;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        async function loadPendingApprovals() {
            const container = document.getElementById('pendingApprovalsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await fetch('/api/di/pending-approvals', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                // Filter out INVENTORY submissions  they are reviewed in Purchases & Inventory tab
                data.submissions = (data.submissions || []).filter(s => s.file_type !== 'INVENTORY');

                if (!data.submissions || data.submissions.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No pending approvals</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Researcher</th>
                                <th>Type</th>
                                <th>Uploaded</th>
                                <th>AI Review</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.submissions.map(s => {
                                const aiScore = s.ai_review?.score;
                                const aiClass = aiScore >= 80 ? 'high' : aiScore >= 50 ? 'medium' : 'low';
                                const date = new Date(s.created_at).toLocaleDateString();
                                return `
                                    <tr>
                                        <td title="${escapeHtml(s.original_filename)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.original_filename)}</td>
                                        <td>${escapeHtml(s.researcher_id)}</td>
                                        <td><span class="type-badge ${s.file_type?.toLowerCase()}">${s.file_type}</span></td>
                                        <td>${date}</td>
                                        <td>${aiScore !== undefined ? `<span class="ai-score ${aiClass}">${aiScore}%</span>` : '<span style="color:#999;">-</span>'}</td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn btn-sm btn-primary" onclick="viewFile('${s.submission_id}')">View</button>
                                                <button class="btn btn-sm btn-success" onclick="quickApprove('${s.submission_id}')">Approve</button>
                                                <button class="btn btn-sm btn-warning" onclick="quickRevise('${s.submission_id}')">Revise</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading pending approvals</p>';
            }
        }

        function viewFile(id) {
            window.open(`/api/di/download/${id}`, '_blank');
        }

        async function quickApprove(id) {
            if (!confirm('Are you sure you want to approve this submission?')) return;

            try {
                // Generate token for approval link
                const token = btoa(id + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
                window.open(`/api/di/approve/${id}?token=${token}`, '_blank');
                setTimeout(() => {
                    loadPendingApprovals();
                    loadStats();
                }, 2000);
            } catch (err) {
                alert('Error approving submission');
            }
        }

        async function quickRevise(id) {
            const comments = prompt('Enter revision comments:');
            if (comments === null) return;

            try {
                const token = btoa(id + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
                const response = await fetch(`/api/di/revise/${id}?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Revision requested');
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert('Failed to request revision');
                }
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        // =====================================================
        // UPLOAD FUNCTIONALITY
        // =====================================================
        async function populateResearcherDropdown() {
            const select = document.getElementById('uploadResearcher');
            const filterSelect = document.getElementById('filterResearcher');

            try {
                const response = await fetch('/api/di/members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                allMembers = data.members || [];

                const options = allMembers.map(m =>
                    `<option value="${m.researcher_id}">${m.researcher_id} - ${m.name || ''} (${m.affiliation})</option>`
                ).join('');

                select.innerHTML = '<option value="">Select researcher...</option>' + options;
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Researchers</option>' + options;
                }
            } catch (err) {
                console.error('Error loading researchers:', err);
            }
        }

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');

        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileUploadArea.classList.add('has-file');
            } else {
                fileNameDisplay.textContent = '';
                fileUploadArea.classList.remove('has-file');
            }
        });

        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#2d5a87'; });
        fileUploadArea.addEventListener('dragleave', () => { fileUploadArea.style.borderColor = '#ddd'; });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = e.dataTransfer.files[0].name;
                fileUploadArea.classList.add('has-file');
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const researcherId = document.getElementById('uploadResearcher').value;
            const fileType = document.getElementById('fileType').value;
            const file = fileInput.files[0];

            if (!researcherId || !fileType || !file) {
                showMessage('uploadMessage', 'Please fill all fields', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('researcher_id', researcherId);
            formData.append('fileType', fileType);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('uploadMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('uploadMessage', `File uploaded: ${file.name}`, 'success');
                    document.getElementById('uploadForm').reset();
                    fileNameDisplay.textContent = '';
                    fileUploadArea.classList.remove('has-file');
                    loadPendingApprovals();
                    loadStats();
                }
            } catch (err) {
                showMessage('uploadMessage', 'Connection error', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
            }
        });

        // =====================================================
        // LABORATORY FILES TAB
        // =====================================================
        async function loadLabFiles() {
            const container = document.getElementById('labFilesTree');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

            try {
                const response = await fetch('/api/di/lab-files', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                labFilesData = data.files || [];

                // Populate year filter
                const years = [...new Set(labFilesData.map(f => new Date(f.created_at).getFullYear()))].sort((a, b) => b - a);
                document.getElementById('filterYear').innerHTML = '<option value="">All Years</option>' +
                    years.map(y => `<option value="${y}">${y}</option>`).join('');

                applyFilters();
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;">Error loading files</p>';
            }
        }

        function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const year = document.getElementById('filterYear').value;
            const researcher = document.getElementById('filterResearcher').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            let filtered = labFilesData.filter(f => {
                if (status && f.status !== status) return false;
                if (year && new Date(f.created_at).getFullYear() !== parseInt(year)) return false;
                if (researcher && f.researcher_id !== researcher) return false;
                if (search && !f.original_filename.toLowerCase().includes(search)) return false;
                return true;
            });

            renderLabFilesTree(filtered);
        }

        function renderLabFilesTree(files) {
            const container = document.getElementById('labFilesTree');

            if (files.length === 0) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No files match the filters</p>';
                return;
            }

            // Group by status, then year, then researcher
            const grouped = {};
            files.forEach(f => {
                const status = f.status || 'PENDING';
                const year = new Date(f.created_at).getFullYear();
                const researcher = f.researcher_id;

                if (!grouped[status]) grouped[status] = {};
                if (!grouped[status][year]) grouped[status][year] = {};
                if (!grouped[status][year][researcher]) grouped[status][year][researcher] = [];
                grouped[status][year][researcher].push(f);
            });

            let html = '';
            const statusOrder = ['PENDING', 'APPROVED', 'REVISION_NEEDED'];

            statusOrder.forEach(status => {
                if (!grouped[status]) return;
                const statusLabel = status === 'REVISION_NEEDED' ? 'Revision Needed' : status.charAt(0) + status.slice(1).toLowerCase();
                const statusClass = status === 'APPROVED' ? 'status-approved' : status === 'REVISION_NEEDED' ? 'status-revision' : 'status-pending';

                html += `
                    <div class="tree-item tree-folder" onclick="toggleFolder(this)">
                        <span class="icon">&#128193;</span>
                        <span>${statusLabel}</span>
                        <span class="status-badge ${statusClass}" style="margin-left:8px;">${Object.values(grouped[status]).reduce((a, y) => a + Object.values(y).reduce((b, r) => b + r.length, 0), 0)}</span>
                    </div>
                    <div class="tree-children">
                `;

                Object.keys(grouped[status]).sort((a, b) => b - a).forEach(year => {
                    html += `
                        <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:20px;">
                            <span class="icon">&#128197;</span>
                            <span>${year}</span>
                        </div>
                        <div class="tree-children collapsed">
                    `;

                    Object.keys(grouped[status][year]).sort().forEach(researcher => {
                        const researcherFiles = grouped[status][year][researcher];
                        html += `
                            <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:40px;">
                                <span class="icon">&#128100;</span>
                                <span>${researcher}</span>
                                <span style="color:#999;font-size:11px;margin-left:8px;">(${researcherFiles.length})</span>
                            </div>
                            <div class="tree-children collapsed">
                        `;

                        researcherFiles.forEach(f => {
                            const hasFile = f.r2_object_key || f.drive_file_id;
                            html += `
                                <div class="tree-item tree-file" style="padding-left:60px;" data-file-id="${f.submission_id}">
                                    <input type="checkbox" class="file-checkbox" data-id="${f.submission_id}" onclick="toggleLabFileSelection(event, '${f.submission_id}')">
                                    <span class="icon">${f.status === 'APPROVED' ? '&#9989;' : '&#128196;'}</span>
                                    <span title="${escapeHtml(f.original_filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(f.original_filename)}</span>
                                    <div class="file-actions">
                                        ${hasFile ? `
                                            <button class="btn btn-sm btn-primary" onclick="viewFile('${f.submission_id}')">View</button>
                                            <button class="btn btn-sm btn-success" onclick="downloadFile('${f.submission_id}')">Download</button>
                                        ` : '<span style="color:#999;font-size:11px;">No file</span>'}
                                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.submission_id}', '${escapeHtml(f.original_filename)}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                    });

                    html += '</div>';
                });

                html += '</div>';
            });

            container.innerHTML = html;
        }

        function toggleFolder(element) {
            const children = element.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }

        function toggleLabFileSelection(event, fileId) {
            event.stopPropagation();
            if (selectedLabFiles.has(fileId)) {
                selectedLabFiles.delete(fileId);
            } else {
                selectedLabFiles.add(fileId);
            }
            updateLabBulkActions();
        }

        function updateLabBulkActions() {
            const bar = document.getElementById('labBulkActions');
            const count = document.getElementById('labSelectedCount');
            if (selectedLabFiles.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selectedLabFiles.size} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        function selectAllLabFiles() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => {
                cb.checked = true;
                selectedLabFiles.add(cb.dataset.id);
            });
            updateLabBulkActions();
        }

        function clearLabSelection() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => cb.checked = false);
            selectedLabFiles.clear();
            updateLabBulkActions();
        }

        async function bulkDownloadLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }

            try {
                const response = await fetch('/api/di/bulk-download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ submission_ids: Array.from(selectedLabFiles) }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lab-files.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    // Fallback to individual downloads
                    const ids = Array.from(selectedLabFiles);
                    for (let i = 0; i < ids.length; i++) {
                        setTimeout(() => {
                            const link = document.createElement('a');
                            link.href = `/api/di/download/${ids[i]}?download=true`;
                            link.download = '';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }, i * 500);
                    }
                }
            } catch (err) {
                alert('Error downloading files');
            }
        }

        async function bulkDeleteLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }
            if (!confirm(`Delete ${selectedLabFiles.size} file(s)? This cannot be undone.`)) return;

            let success = 0, fail = 0;
            for (const id of selectedLabFiles) {
                try {
                    const response = await fetch(`/api/di/submissions/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (response.ok) success++;
                    else fail++;
                } catch { fail++; }
            }

            alert(`Deleted ${success} file(s)${fail > 0 ? `, ${fail} failed` : ''}`);
            selectedLabFiles.clear();
            updateLabBulkActions();
            loadLabFiles();
            loadStats();
        }

        function downloadFile(id) {
            window.location.href = `/api/di/download/${id}?download=true`;
        }

        async function deleteFile(id, filename) {
            if (!confirm(`Delete "${filename}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/submissions/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('File deleted');
                    selectedLabFiles.delete(id);
                    updateLabBulkActions();
                    loadLabFiles();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete file');
                }
            } catch (err) {
                alert('Error deleting file');
            }
        }

        // =====================================================
        // GROUP DOCUMENTS TAB
        // =====================================================
        async function loadGroupDocuments() {
            const tbody = document.getElementById('groupDocsTableBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/group-documents', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.documents || data.documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;padding:20px;">No documents yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.documents.map(doc => {
                    const typeClass = doc.file_type.toLowerCase();
                    const date = new Date(doc.created_at).toLocaleDateString();
                    const canDownload = doc.can_download !== false;
                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(doc.title)}</strong>
                                ${doc.description ? '<br><small style="color:#666;">' + escapeHtml(doc.description) + '</small>' : ''}
                            </td>
                            <td>${escapeHtml(doc.category)}</td>
                            <td><span class="type-badge ${typeClass}">${doc.file_type}</span></td>
                            <td>${canDownload ? '<span style="color:#28a745;">Yes</span>' : '<span style="color:#999;">View only</span>'}</td>
                            <td>${date}</td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-sm btn-success" onclick="window.location.href='${doc.downloadUrl}'">Download</button>
                                    <button class="btn btn-sm btn-warning" onclick="editGroupDoc('${doc.id}', '${escapeHtml(doc.title)}', '${escapeHtml(doc.category)}', '${escapeHtml(doc.description || '')}', ${canDownload})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGroupDoc('${doc.id}', '${escapeHtml(doc.title)}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#dc3545;text-align:center;">Error loading documents</td></tr>';
            }
        }

        // Group document file upload
        const groupDocUploadArea = document.getElementById('groupDocUploadArea');
        const groupDocFileInput = document.getElementById('groupDocFile');
        const groupDocFileName = document.getElementById('groupDocFileName');

        groupDocUploadArea.addEventListener('click', () => groupDocFileInput.click());
        groupDocFileInput.addEventListener('change', () => {
            if (groupDocFileInput.files.length > 0) {
                groupDocFileName.textContent = groupDocFileInput.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            } else {
                groupDocFileName.textContent = '';
                groupDocUploadArea.classList.remove('has-file');
            }
        });

        groupDocUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); groupDocUploadArea.style.borderColor = '#2d5a87'; });
        groupDocUploadArea.addEventListener('dragleave', () => { groupDocUploadArea.style.borderColor = '#ddd'; });
        groupDocUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            groupDocUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                groupDocFileInput.files = e.dataTransfer.files;
                groupDocFileName.textContent = e.dataTransfer.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            }
        });

        document.getElementById('groupDocForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('docTitle').value.trim();
            const category = document.getElementById('docCategory').value;
            const description = document.getElementById('docDescription').value.trim();
            const canDownload = document.getElementById('docCanDownload').checked;
            const file = groupDocFileInput.files[0];

            if (!title || !category || !file) {
                showMessage('groupDocMessage', 'Please fill all required fields', 'error');
                return;
            }

            const submitBtn = document.getElementById('groupDocSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('title', title);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('can_download', canDownload);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/group-documents', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('groupDocMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('groupDocMessage', 'Document uploaded!', 'success');
                    document.getElementById('groupDocForm').reset();
                    groupDocFileName.textContent = '';
                    groupDocUploadArea.classList.remove('has-file');
                    loadGroupDocuments();
                }
            } catch (err) {
                showMessage('groupDocMessage', 'Connection error', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Document';
            }
        });

        async function editGroupDoc(id, title, category, description, canDownload) {
            const newTitle = prompt('Edit title:', title);
            if (newTitle === null) return;

            const newCategory = prompt('Edit category (SOP, Guidelines, Templates, Training, Forms, Other):', category);
            if (newCategory === null) return;

            const newDescription = prompt('Edit description:', description);
            if (newDescription === null) return;

            const newCanDownload = confirm('Allow researchers to download this document?');

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: newTitle,
                        category: newCategory,
                        description: newDescription,
                        can_download: newCanDownload
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document updated');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Update failed');
                }
            } catch (err) {
                alert('Error updating document');
            }
        }

        async function deleteGroupDoc(id, title) {
            if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document deleted');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Delete failed');
                }
            } catch (err) {
                alert('Error deleting document');
            }
        }

        // =====================================================
        // USER MANAGEMENT TAB
        // =====================================================
        async function loadAllUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/all-members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.members || data.members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#666;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.members.map(u => {
                    const roleClass = u.role === 'pi' ? 'pi' : (u.role === 'supervisor' ? 'supervisor' : 'researcher');
                    const statusClass = u.active ? 'status-active' : 'status-inactive';
                    const canResetPassword = u.active && u.role !== 'pi' && u.last_login;
                    return `
                        <tr>
                            <td>${escapeHtml(u.name || '-')}</td>
                            <td>${escapeHtml(u.institution_email || '-')}</td>
                            <td>${escapeHtml(u.researcher_id)}</td>
                            <td>${escapeHtml(u.affiliation)}</td>
                            <td><span class="role-badge ${roleClass}">${(u.role || 'researcher').toUpperCase()}</span></td>
                            <td><span class="status-badge ${statusClass}">${u.active ? 'Active' : 'Inactive'}</span></td>
                            <td>${u.submission_count || 0}</td>
                            <td>
                                <div class="actions">
                                    ${u.active ?
                                        `<button class="btn btn-sm btn-danger" onclick="deactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Deactivate</button>` :
                                        `<button class="btn btn-sm btn-success" onclick="reactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reactivate</button>`
                                    }
                                    ${canResetPassword ?
                                        `<button class="btn btn-sm btn-warning" onclick="resetUserPassword('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reset Password</button>` : ''
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="color:#dc3545;text-align:center;">Error loading users</td></tr>';
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const affiliation = document.getElementById('newUserAffiliation').value;
            const role = document.getElementById('newUserRole').value;

            if (!name || !email || !affiliation || !role) {
                showMessage('addUserMessage', 'Please fill all fields', 'error');
                return;
            }

            const addBtn = document.getElementById('addUserBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/di/members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, institution_email: email, affiliation, role }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('addUserMessage', data.error || 'Failed to add user', 'error');
                } else {
                    showMessage('addUserMessage', `User added: ${data.researcher_id}`, 'success');
                    document.getElementById('addUserForm').reset();
                    loadAllUsers();
                    populateResearcherDropdown();
                }
            } catch (err) {
                showMessage('addUserMessage', 'Connection error', 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add User';
            }
        });

        async function deactivateUser(id, name) {
            // Check for active inventory items before confirming
            let warningMsg = `Deactivate user "${name}"? They will not be able to log in.`;
            try {
                const invResp = await fetch(`/api/di/inventory/check-user/${id}`, { credentials: 'include' });
                if (invResp.ok) {
                    const invData = await invResp.json();
                    if (invData.active_count > 0) {
                        warningMsg += `\n\nWARNING: This user has ${invData.active_count} active inventory item(s). These items will remain assigned but the user will not be able to manage them.`;
                    }
                }
            } catch (e) { /* non-blocking */ }

            if (!confirm(warningMsg)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/deactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User deactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to deactivate user');
                }
            } catch (err) {
                alert('Error deactivating user');
            }
        }

        async function reactivateUser(id, name) {
            if (!confirm(`Reactivate user "${name}"? All their previous data will be restored.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User reactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to reactivate user');
                }
            } catch (err) {
                alert('Error reactivating user');
            }
        }

        async function resetUserPassword(id, name) {
            if (!confirm(`Reset password for "${name}"?\n\nThey will be required to set a new password on their next login.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reset-password`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'Password reset flagged successfully');
                } else {
                    alert(data.error || 'Failed to reset password');
                }
            } catch (err) {
                alert('Error resetting password');
            }
        }

        // =====================================================
        // REPORTS TAB
        // =====================================================
        async function loadReportsData() {
            try {
                const response = await fetch('/api/di/metrics', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                // Update summary stats
                document.getElementById('reportTotalSubmissions').textContent = data.total || 0;
                document.getElementById('reportTotalResearchers').textContent = data.totalResearchers || 0;
                document.getElementById('reportThisMonth').textContent = data.thisMonth || 0;

                const approved = data.byStatus?.APPROVED || 0;
                const total = data.total || 1;
                document.getElementById('reportApprovalRate').textContent = Math.round((approved / total) * 100) + '%';

                // Status breakdown
                const statusBody = document.getElementById('statusBreakdownBody');
                statusBody.innerHTML = Object.entries(data.byStatus || {}).map(([status, count]) => {
                    const pct = Math.round((count / total) * 100);
                    const statusClass = status === 'APPROVED' ? 'status-approved' : status === 'REVISION_NEEDED' ? 'status-revision' : 'status-pending';
                    return `
                        <tr>
                            <td><span class="status-badge ${statusClass}">${status.replace('_', ' ')}</span></td>
                            <td>${count}</td>
                            <td>${pct}%</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="3" style="text-align:center;color:#666;">No data</td></tr>';

                // Researcher breakdown
                const researcherBody = document.getElementById('researcherBreakdownBody');
                const topResearchers = (data.byResearcher || []).slice(0, 10);
                researcherBody.innerHTML = topResearchers.map(r => `
                    <tr>
                        <td>${escapeHtml(r.researcher_id)}</td>
                        <td>${r.total}</td>
                        <td>${r.approved || 0}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" style="text-align:center;color:#666;">No data</td></tr>';

            } catch (err) {
                console.error('Error loading reports:', err);
            }
        }

        async function exportToCSV() {
            const from = document.getElementById('exportFromDate').value;
            const to = document.getElementById('exportToDate').value;
            const status = document.getElementById('exportStatus').value;

            let url = '/api/di/reports/export?format=csv';
            if (from) url += `&from=${from}`;
            if (to) url += `&to=${to}`;
            if (status) url += `&status=${status}`;

            window.location.href = url;
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message show ${type}`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/di/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {}
            window.location.href = 'access.html';
        });

        // =====================================================
        // DELEGATION FUNCTIONS
        // =====================================================
        async function loadDelegationData() {
            try {
                // Load supervisors
                const supRes = await fetch('/api/di/delegation/supervisors', { credentials: 'include' });
                const supData = supRes.ok ? await supRes.json() : { supervisors: [] };
                const supervisorSelect = document.getElementById('supervisorSelect');
                supervisorSelect.innerHTML = '<option value="">Select supervisor...</option>' +
                    supData.supervisors.map(s => `<option value="${s.researcher_id}">${s.name} (${s.researcher_id})</option>`).join('');

                // Load all members for promote/demote and assign
                const memRes = await fetch('/api/di/all-members', { credentials: 'include' });
                const memData = memRes.ok ? await memRes.json() : { members: [] };
                const activeMembers = memData.members.filter(m => m.active);

                // Populate promote select (researchers and supervisors only)
                const promoteSelect = document.getElementById('promoteSelect');
                const promotable = activeMembers.filter(m => m.role === 'researcher' || m.role === 'supervisor');
                promoteSelect.innerHTML = '<option value="">Select a user...</option>' +
                    promotable.map(m => `<option value="${m.researcher_id}" data-role="${m.role}">${m.name} (${m.role.toUpperCase()})</option>`).join('');

                // Populate assign researcher select (non-supervisor, non-PI)
                const assignSelect = document.getElementById('assignResearcherSelect');
                const assignable = activeMembers.filter(m => m.role === 'researcher');
                assignSelect.innerHTML = '<option value="">Select researcher...</option>' +
                    assignable.map(m => `<option value="${m.researcher_id}">${m.name} (${m.researcher_id})</option>`).join('');

                // Load assignments
                const assRes = await fetch('/api/di/delegation/assignments', { credentials: 'include' });
                const assData = assRes.ok ? await assRes.json() : { assignments: [] };
                const tbody = document.getElementById('assignmentsTableBody');
                if (assData.assignments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No assignments yet</td></tr>';
                } else {
                    tbody.innerHTML = assData.assignments.map(a => `
                        <tr>
                            <td>${escapeHtml(a.supervisor_name || a.supervisor_id)}</td>
                            <td>${escapeHtml(a.researcher_name)} (${escapeHtml(a.researcher_id)})</td>
                            <td>${new Date(a.assigned_at).toLocaleDateString()}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="removeAssignment('${a.supervisor_id}','${a.researcher_id}')">Remove</button></td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load delegation data error:', err);
            }
        }

        async function promoteToSupervisor() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to promote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role === 'supervisor') { alert('User is already a supervisor'); return; }
            if (!confirm('Promote this researcher to supervisor?')) return;
            try {
                const res = await fetch('/api/di/delegation/promote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User promoted to supervisor', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function demoteToResearcher() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to demote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role !== 'supervisor') { alert('User is not a supervisor'); return; }
            if (!confirm('Demote this supervisor to researcher? All assignments will be removed.')) return;
            try {
                const res = await fetch('/api/di/delegation/demote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User demoted to researcher', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function assignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/assign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher assigned to supervisor', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function unassignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher unassigned', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function removeAssignment(supId, resId) {
            if (!confirm('Remove this assignment?')) return;
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                if (res.ok) {
                    showMessage('delegationMessage', 'Assignment removed', 'success');
                    loadDelegationData();
                }
            } catch (err) { console.error(err); }
        }

        // Load delegation data on page load
        loadDelegationData();

        // =====================================================
        // BACKUP & RECOVERY TAB
        // =====================================================
        document.querySelector('[data-tab="backup"]').addEventListener('click', () => {
            loadBackupSnapshots();
            dlReset();
        });

        async function loadBackupSnapshots() {
            const select = document.getElementById('backupSnapshotSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/di/backup/snapshots', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                if (!data.snapshots || data.snapshots.length === 0) {
                    select.innerHTML = '<option value="">No snapshots available</option>';
                    return;
                }
                select.innerHTML = '<option value="">Select a recovery point...</option>' +
                    data.snapshots.map(s =>
                        `<option value="${escapeHtml(s.path)}">[${escapeHtml(s.type)}] ${escapeHtml(s.label)}</option>`
                    ).join('');
            } catch (err) {
                select.innerHTML = '<option value="">Error loading snapshots</option>';
                console.error('Load snapshots error:', err);
            }
        }

        function clearBackupPreview() {
            document.getElementById('backupPreviewContainer').style.display = 'none';
            document.getElementById('backupRecoveryResult').style.display = 'none';
            document.getElementById('backupRecoveryProgress').style.display = 'none';
        }

        async function previewBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            if (!snapshot) { alert('Please select a recovery point first.'); return; }

            clearBackupPreview();
            showMessage('backupMessage', 'Loading preview...', 'info');

            try {
                const resp = await fetch('/api/di/backup/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot }),
                    credentials: 'include'
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Preview failed');
                }
                const data = await resp.json();

                document.getElementById('bkpBackupCount').textContent = data.backupFileCount;
                document.getElementById('bkpR2Count').textContent = data.r2FileCount;
                document.getElementById('bkpDiffCount').textContent = data.estimatedDifference;
                document.getElementById('backupSummaryText').textContent = data.summaryText;

                document.getElementById('backupPreviewContainer').style.display = 'block';
                document.getElementById('backupMessage').className = 'message';
            } catch (err) {
                showMessage('backupMessage', 'Preview error: ' + err.message, 'error');
            }
        }

        async function confirmBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            const mode = document.getElementById('backupRecoveryMode').value;
            if (!snapshot) { alert('No snapshot selected.'); return; }

            const modeLabel = mode === 'add-missing' ? 'ADD MISSING FILES ONLY' : 'FULL RESTORE (overwrites changed files)';
            if (!window.confirm('You are about to perform: ' + modeLabel + ' from snapshot "' + snapshot + '". Continue?')) return;

            if (mode === 'full-restore') {
                if (!window.confirm('FINAL WARNING: Full restore will overwrite files that differ in size. Are you sure?')) return;
            }

            document.getElementById('backupRecoverBtn').disabled = true;
            document.getElementById('backupRecoveryProgress').style.display = 'block';
            document.getElementById('backupRecoveryResult').style.display = 'none';

            try {
                const resp = await fetch('/api/di/backup/recover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot, mode, confirm: true }),
                    credentials: 'include'
                });
                const data = await resp.json();
                document.getElementById('backupRecoveryProgress').style.display = 'none';

                const resultEl = document.getElementById('backupRecoveryResult');
                if (data.success) {
                    resultEl.innerHTML =
                        '<div class="message success show" style="display:block;">' +
                        '<strong>Recovery Complete</strong><br>' +
                        'Processed: ' + data.processed + ' | Copied: ' + data.copied +
                        ' | Skipped: ' + data.skipped + ' | Failed: ' + data.failed +
                        (data.failed > 0 ? '<br><span style="color:#dc3545;">Some files failed. Check server logs.</span>' : '') +
                        '</div>';
                } else {
                    resultEl.innerHTML = '<div class="message error show" style="display:block;"><strong>Recovery Failed:</strong> ' + escapeHtml(data.error || 'Unknown error') + '</div>';
                }
                resultEl.style.display = 'block';
            } catch (err) {
                document.getElementById('backupRecoveryProgress').style.display = 'none';
                showMessage('backupMessage', 'Recovery request failed: ' + err.message, 'error');
            } finally {
                document.getElementById('backupRecoverBtn').disabled = false;
            }
        }

        // --- Download (R2 on-demand ZIP) ---
        const dlState = { flow: null, step: 0, researchers: [], selected: [],
            dateFrom: '', dateTo: '', estimate: null, downloadMode: 'single',
            maxBytes: 524288000, cursor: '', partNum: 0 };

        function dlReset() {
            dlState.flow = null; dlState.step = 0; dlState.selected = [];
            dlState.dateFrom = ''; dlState.dateTo = ''; dlState.estimate = null;
            dlState.cursor = ''; dlState.partNum = 0; dlState.downloadMode = 'single';
            document.getElementById('dlButtons').style.display = 'flex';
            document.getElementById('dlFlow').style.display = 'none';
            document.getElementById('dlProgress').style.display = 'none';
            document.getElementById('dlMessage').className = 'message';
            document.getElementById('dlMessage').innerHTML = '';
            document.getElementById('dlStepActions').innerHTML = '';
        }

        async function dlStartFlow(flow) {
            dlReset();
            dlState.flow = flow;
            document.getElementById('dlButtons').style.display = 'none';
            document.getElementById('dlFlow').style.display = 'block';
            const titles = { researcher: 'Download by Researcher', daterange: 'Download by Date Range', full: 'Full Data Download' };
            document.getElementById('dlFlowTitle').textContent = titles[flow];
            if (flow === 'researcher') { dlState.step = 1; await dlShowResearcherStep(); }
            else if (flow === 'daterange') { dlState.step = 1; dlShowDateRangeStep(); }
            else { dlState.step = 1; await dlShowEstimateStep(); }
        }

        async function dlShowResearcherStep() {
            const stepLabel = dlState.flow === 'daterange' ? 'Step 2 \u2014 Select Researchers' : 'Step 1 \u2014 Select Researchers';
            document.getElementById('dlStepLabel').textContent = stepLabel;
            const content = document.getElementById('dlStepContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading researchers...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                if (!dlState.researchers.length) {
                    const resp = await fetch('/api/di/backup/download/researchers', { credentials: 'include' });
                    if (!resp.ok) throw new Error((await resp.json()).error || 'Failed');
                    const data = await resp.json();
                    dlState.researchers = data.researchers || [];
                }
                if (dlState.flow === 'daterange' && dlState.selected.length === 0) {
                    dlState.selected = dlState.researchers.map(r => r.id);
                }
                dlRenderResearcherList('');
            } catch (err) {
                content.innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
            }
        }

        function dlRenderResearcherList(filter) {
            const list = dlState.researchers;
            const q = (filter || '').toLowerCase();
            const filtered = q ? list.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : list;
            let html = '<div style="display:flex;gap:8px;margin-bottom:10px;">' +
                '<input type="text" id="dlSearchBox" placeholder="Search researchers..." oninput="dlRenderResearcherList(this.value)" style="flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:6px;" value="' + escapeHtml(filter || '') + '">' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(true)">Select All</button>' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(false)">Clear All</button>' +
                '</div>';
            html += '<div style="max-height:280px;overflow-y:auto;border:1px solid #eee;border-radius:6px;padding:4px;">';
            if (filtered.length === 0) {
                html += '<div style="padding:20px;text-align:center;color:#999;">No researchers found</div>';
            } else {
                for (const r of filtered) {
                    const checked = dlState.selected.includes(r.id) ? 'checked' : '';
                    html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:6px;padding:5px 8px;cursor:pointer;border-bottom:1px solid #f5f5f5;">' +
                        '<input type="checkbox" value="' + escapeHtml(r.id) + '" ' + checked + ' onchange="dlToggleResearcher(\'' + escapeHtml(r.id) + '\', this.checked)">' +
                        '<span>' + escapeHtml(r.name) + '</span>' +
                        '<span style="color:#888;font-size:12px;margin-left:auto;">' + escapeHtml(r.affiliation) + ' &middot; ' + r.files + ' files</span>' +
                        '</label>';
                }
            }
            html += '</div>';
            html += '<div style="margin-top:6px;color:#888;font-size:12px;" id="dlSelCount">' + dlState.selected.length + ' of ' + list.length + ' selected</div>';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlResearcherNext()">Next</button>';
        }

        function dlToggleResearcher(id, checked) {
            if (checked && !dlState.selected.includes(id)) dlState.selected.push(id);
            else if (!checked) dlState.selected = dlState.selected.filter(x => x !== id);
            const el = document.getElementById('dlSelCount');
            if (el) el.textContent = dlState.selected.length + ' of ' + dlState.researchers.length + ' selected';
        }

        function dlSelectAll(select) {
            const q = (document.getElementById('dlSearchBox')?.value || '').toLowerCase();
            const visible = q ? dlState.researchers.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : dlState.researchers;
            if (select) {
                for (const r of visible) { if (!dlState.selected.includes(r.id)) dlState.selected.push(r.id); }
            } else {
                const ids = new Set(visible.map(r => r.id));
                dlState.selected = dlState.selected.filter(id => !ids.has(id));
            }
            dlRenderResearcherList(document.getElementById('dlSearchBox')?.value || '');
        }

        async function dlResearcherNext() {
            if (dlState.selected.length === 0) { alert('Please select at least one researcher.'); return; }
            await dlShowEstimateStep();
        }

        function dlShowDateRangeStep() {
            document.getElementById('dlStepLabel').textContent = 'Step 1 \u2014 Date Range';
            const today = new Date().toISOString().slice(0, 10);
            const ago30 = new Date(Date.now() - 30 * 86400000).toISOString().slice(0, 10);
            document.getElementById('dlStepContent').innerHTML =
                '<div style="display:flex;gap:15px;flex-wrap:wrap;align-items:end;">' +
                '<div class="form-group" style="margin:0;"><label>From</label>' +
                '<input type="date" id="dlDateFrom" value="' + ago30 + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '<div class="form-group" style="margin:0;"><label>To</label>' +
                '<input type="date" id="dlDateTo" value="' + today + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '</div>';
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlDateRangeNext()">Next</button>';
        }

        async function dlDateRangeNext() {
            const from = document.getElementById('dlDateFrom').value;
            const to = document.getElementById('dlDateTo').value;
            if (!from || !to) { alert('Please select both dates.'); return; }
            if (from > to) { alert('"From" date must be before "To" date.'); return; }
            dlState.dateFrom = from;
            dlState.dateTo = to;
            dlState.step = 2;
            await dlShowResearcherStep();
        }

        async function dlShowEstimateStep() {
            const stepNum = dlState.flow === 'daterange' ? 3 : (dlState.flow === 'researcher' ? 2 : 1);
            document.getElementById('dlStepLabel').textContent = 'Step ' + stepNum + ' \u2014 Estimate & Download';
            document.getElementById('dlStepContent').innerHTML = '<div class="loading"><div class="spinner"></div>Estimating selection...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                const resp = await fetch('/api/di/backup/download/estimate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) throw new Error((await resp.json()).error || 'Estimate failed');
                dlState.estimate = await resp.json();
                dlRenderEstimate();
            } catch (err) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function dlSetMode(mode) {
            dlState.downloadMode = mode;
            const el = document.getElementById('dlChunkSize');
            if (el) el.style.display = mode === 'multi' ? '' : 'none';
        }

        function dlRenderEstimate() {
            const est = dlState.estimate;
            if (!est || est.fileCount === 0) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message info show" style="display:block;">No files match your selection.</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
                return;
            }
            let html = '<div class="stats-row" style="margin-bottom:15px;">' +
                '<div class="stat-card"><div class="stat-value">' + est.fileCount + '</div><div class="stat-label">Files</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + formatFileSize(est.totalBytes) + '</div><div class="stat-label">Total Size</div></div>' +
                '</div>';
            html += '<div class="form-group"><label>Download Mode</label><div id="dlModeRow" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">';
            if (est.singleZipAvailable) {
                html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;background:#f0f7ff;">' +
                    '<input type="radio" name="dlMode" value="single" checked onchange="dlSetMode(\'single\')"> Single ZIP download' +
                    (est.recommendedMode === 'single' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                    '</label>';
            }
            html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;' +
                (!est.singleZipAvailable ? 'background:#f0f7ff;' : '') + '">' +
                '<input type="radio" name="dlMode" value="multi" ' + (!est.singleZipAvailable ? 'checked' : '') + ' onchange="dlSetMode(\'multi\')"> Multi-file download' +
                (est.recommendedMode === 'multi' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                '</label>';
            html += '<div id="dlChunkSize" style="' + (est.singleZipAvailable ? 'display:none;' : '') + 'margin-left:28px;margin:0;">' +
                '<label style="font-size:13px;color:#666;">Chunk size: </label>' +
                '<select id="dlChunkSelect" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;" onchange="dlState.maxBytes=Number(this.value)">' +
                '<option value="262144000">250 MB</option>' +
                '<option value="524288000" selected>500 MB (Recommended)</option>' +
                '<option value="1073741824">1 GB</option>' +
                '</select></div>';
            html += '</div></div>';
            dlState.downloadMode = est.singleZipAvailable ? 'single' : 'multi';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlStartDownload()">Download</button>';
        }

        async function dlStartDownload() {
            if (!dlState.estimate) return;
            dlState.cursor = ''; dlState.partNum = 0;
            document.getElementById('dlStepActions').innerHTML = '';
            await dlDownloadPart(dlState.downloadMode === 'multi');
        }

        async function dlDownloadPart(isMulti) {
            dlState.partNum++;
            const progEl = document.getElementById('dlProgress');
            progEl.style.display = 'block';
            progEl.innerHTML = '<div class="loading"><div class="spinner"></div>Downloading' +
                (isMulti ? ' Part ' + dlState.partNum : '') + '... This may take a while.</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                if (isMulti) body.maxBytes = dlState.maxBytes;
                if (dlState.cursor) body.cursor = dlState.cursor;

                const resp = await fetch('/api/di/backup/download/zip', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) {
                    let errMsg = 'Download failed';
                    try { errMsg = (await resp.json()).error || errMsg; } catch(e) {}
                    throw new Error(errMsg);
                }
                const nextCursor = resp.headers.get('X-Next-Cursor') || '';
                const fileCount = resp.headers.get('X-File-Count') || '?';
                const blob = await resp.blob();
                const cd = resp.headers.get('Content-Disposition') || '';
                const fnMatch = cd.match(/filename="(.+?)"/);
                const filename = fnMatch ? fnMatch[1] : 'download.zip';
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 120000);

                dlState.cursor = nextCursor;
                if (isMulti && nextCursor) {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Part ' + dlState.partNum + ' downloaded</strong> (' + fileCount + ' files).<br>More data available.</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-primary" onclick="dlDownloadPart(true)">Download Part ' + (dlState.partNum + 1) + '</button>' +
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                } else {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Download complete</strong> (' + fileCount + ' files).</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                }
            } catch (err) {
                progEl.innerHTML = '<div class="message error show" style="display:block;">Download error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML =
                    '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
        }

        // =====================================================
        // PURCHASE REQUESTS (PI)
        // =====================================================

        async function loadAllPurchaseRequests() {
            const tbody = document.getElementById('prAllTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                let requests = data.requests || [];

                const statusFilter = document.getElementById('prFilterStatus').value;
                if (statusFilter) requests = requests.filter(r => r.status === statusFilter);

                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">No purchase requests found</td></tr>';
                    return;
                }

                const statusColors = { SUBMITTED: '#007bff', APPROVED: '#28a745', DECLINED: '#fd7e14' };
                tbody.innerHTML = requests.map(r => {
                    const items = r.items || [];
                    const itemNames = items.map(i => i.product_name).join(', ');
                    return `<tr>
                        <td style="white-space:nowrap;">${new Date(r.created_at).toLocaleDateString()}</td>
                        <td>${escapeHtml(r.requester_name || r.requester_id)}</td>
                        <td>${escapeHtml(r.affiliation)}</td>
                        <td title="${escapeHtml(r.justification)}" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(r.justification)}</td>
                        <td title="${escapeHtml(itemNames)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${items.length} item${items.length>1?'s':''}</td>
                        <td style="white-space:nowrap;font-weight:600;">${Number(r.request_total).toFixed(2)} ${escapeHtml(r.currency)}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[r.status]||'#666'};">${r.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showPrDetail('${r.id}')">Review</button></td>
                    </tr>`;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#dc3545;">Error loading requests</td></tr>';
            }
        }

        let prAllData = [];
        async function showPrDetail(requestId) {
            // Fetch fresh data
            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                prAllData = data.requests || [];
            } catch (err) { return; }

            const req = prAllData.find(r => r.id === requestId);
            if (!req) return;

            document.getElementById('prDetailPanel').style.display = 'block';
            document.getElementById('prDetailTitle').textContent = `Request from ${req.requester_name || req.requester_id} (${req.affiliation})`;
            document.getElementById('prDetailJustification').innerHTML = `<strong>Justification:</strong> ${escapeHtml(req.justification)}`;
            document.getElementById('prDetailTotal').textContent = `${Number(req.request_total).toFixed(2)} ${escapeHtml(req.currency)}`;

            const items = req.items || [];
            const tbody = document.getElementById('prDetailItemsBody');
            tbody.innerHTML = items.map(i => {
                const orderedLabel = i.ordered_at ? `<span style="color:#28a745;" title="${new Date(i.ordered_at).toLocaleDateString()}">Yes</span>` : '<span style="color:#999;">No</span>';
                const markOrderedBtn = (req.status === 'APPROVED' && !i.ordered_at)
                    ? `<button class="btn btn-sm btn-secondary" onclick="markItemOrdered('${i.id}','${requestId}')">Mark Ordered</button>`
                    : '';
                return `<tr>
                    <td>${escapeHtml(i.vendor_company)}</td>
                    <td>${escapeHtml(i.product_name)}</td>
                    <td>${escapeHtml(i.catalog_id)}</td>
                    <td>${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank" style="font-size:11px;">Link</a>' : ''}</td>
                    <td>${i.quantity}</td>
                    <td>${Number(i.unit_price).toFixed(2)}</td>
                    <td style="font-weight:600;">${Number(i.item_total).toFixed(2)}</td>
                    <td>${orderedLabel}</td>
                    <td>${markOrderedBtn}</td>
                </tr>`;
            }).join('');

            const actionsEl = document.getElementById('prDetailActions');
            if (req.status === 'SUBMITTED') {
                actionsEl.innerHTML = `
                    <button class="btn btn-success" onclick="approvePurchaseRequest('${requestId}')">Approve</button>
                    <button class="btn" style="background:#fd7e14;color:#fff;" onclick="declinePurchaseRequest('${requestId}')">Decline</button>
                `;
            } else if (req.status === 'DECLINED' && req.pi_comment) {
                actionsEl.innerHTML = `<div style="color:#856404;font-size:13px;"><strong>Declined:</strong> ${escapeHtml(req.pi_comment)}</div>`;
            } else {
                actionsEl.innerHTML = '';
            }
        }

        function closePrDetail() {
            document.getElementById('prDetailPanel').style.display = 'none';
        }

        async function approvePurchaseRequest(requestId) {
            if (!confirm('Approve this purchase request?')) return;
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/approve`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request approved.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function declinePurchaseRequest(requestId) {
            const comment = prompt('Enter reason for declining (required):');
            if (comment === null) return;
            if (!comment.trim()) { alert('A comment is required when declining.'); return; }
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/decline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pi_comment: comment }),
                    credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request declined.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function markItemOrdered(itemId, requestId) {
            try {
                const resp = await fetch(`/api/di/purchases/item/${itemId}/mark-ordered`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                showPrDetail(requestId);
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // CONSOLIDATED EMAIL
        // =====================================================

        let consolidatedEmailText = '';

        async function loadConsolidatedEmail(affiliation) {
            const area = document.getElementById('prConsolidatedArea');
            const emptyEl = document.getElementById('prConsolidatedEmpty');
            area.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const resp = await fetch(`/api/di/purchases/consolidated?affiliation=${affiliation}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];

                if (items.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                const subject = `NATLAB purchase request (${affiliation})`;
                let body = `Hi,\n\nPlease find below the products that have been approved and need to be ordered as soon as possible.\n\nThank you,\nBest,\nFrank\n\n`;

                items.forEach(i => {
                    body += `- Vendor: ${i.vendor_company}\n`;
                    body += `  Product name: ${i.product_name}\n`;
                    body += `  Catalog ID: ${i.catalog_id}\n`;
                    body += `  Quantity: ${i.quantity}\n`;
                    body += `  Unit price: ${Number(i.unit_price).toFixed(2)} ${i.currency}\n`;
                    body += `  Item total: ${Number(i.item_total).toFixed(2)} ${i.currency}\n`;
                    body += `  Product link: ${i.product_link}\n`;
                    body += `  Requested by: ${i.requester_name || i.requester_id}\n`;
                    body += `  Request ID: ${i.request_id.substring(0, 8)}\n\n`;
                });

                body += `---\nTotal: ${data.total.toFixed(2)} ${data.currency}`;

                consolidatedEmailText = `Subject: ${subject}\n\n${body}`;
                document.getElementById('prConsolidatedTitle').textContent = subject;
                document.getElementById('prConsolidatedText').textContent = consolidatedEmailText;
                area.style.display = 'block';
            } catch (err) {
                alert('Error loading consolidated data: ' + err.message);
            }
        }

        function copyConsolidatedEmail() {
            navigator.clipboard.writeText(consolidatedEmailText).then(() => {
                const btn = document.querySelector('#prConsolidatedArea .btn-success');
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 2000);
            }).catch(() => {
                // Fallback: select text
                const pre = document.getElementById('prConsolidatedText');
                const range = document.createRange();
                range.selectNodeContents(pre);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            });
        }

        // =====================================================
        // PURCHASES & INVENTORY TAB (INVENTORY IMPORTS)
        // =====================================================
        let currentReviewSubmissionId = null;

        async function loadInventoryBadge() {
            try {
                const resp = await fetch('/api/di/inventory/import/pending', { credentials: 'include' });
                if (resp.ok) {
                    const data = await resp.json();
                    const count = (data.submissions || []).length;
                    const badge = document.getElementById('invSubmittedBadge');
                    if (count > 0) {
                        badge.textContent = count;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (e) { /* silent */ }
        }

        async function loadSubmittedInventoryImports() {
            const tbody = document.getElementById('invImportTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            try {
                const resp = await fetch('/api/di/inventory/import/pending', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                const subs = data.submissions || [];

                // Update badge
                const badge = document.getElementById('invSubmittedBadge');
                if (subs.length > 0) { badge.textContent = subs.length; badge.style.display = 'inline'; }
                else { badge.style.display = 'none'; }

                if (subs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No submitted inventory imports</td></tr>';
                    return;
                }

                tbody.innerHTML = subs.map(s => `
                    <tr>
                        <td>${escapeHtml(s.researcher_name || s.researcher_id)}</td>
                        <td title="${escapeHtml(s.original_filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.original_filename)}</td>
                        <td>${escapeHtml(s.affiliation)}</td>
                        <td>${new Date(s.created_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="reviewInventoryImport('${s.submission_id}')">Review</button>
                        </td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#dc3545;">Error loading imports</td></tr>';
            }
        }

        async function reviewInventoryImport(submissionId) {
            currentReviewSubmissionId = submissionId;
            const panel = document.getElementById('invReviewPanel');
            const tbody = document.getElementById('invReviewTableBody');
            const summary = document.getElementById('invReviewSummary');
            const actions = document.getElementById('invReviewActions');
            const msgEl = document.getElementById('invReviewMessage');

            panel.style.display = 'block';
            tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';
            summary.innerHTML = '';
            actions.innerHTML = '';
            msgEl.className = 'message';
            msgEl.textContent = '';

            try {
                const resp = await fetch(`/api/di/inventory/import/preview/${submissionId}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed to load preview');
                const data = await resp.json();

                if (data.validation_errors) {
                    msgEl.className = 'message error show';
                    msgEl.style.display = 'block';
                    msgEl.innerHTML = '<strong>Validation errors found:</strong><br>' +
                        data.validation_errors.map(e => `Row ${e.row}: ${e.errors.join('; ')}`).join('<br>');
                    tbody.innerHTML = '';
                    actions.innerHTML = `<button class="btn btn-warning" onclick="requestInventoryRevision('${submissionId}')">Request Revision</button>`;
                    return;
                }

                const diff = data.diff;
                document.getElementById('invReviewTitle').textContent = `Review: ${escapeHtml(data.filename)}`;
                summary.innerHTML = `
                    <div style="display:flex;gap:15px;flex-wrap:wrap;">
                        <span style="padding:4px 12px;border-radius:12px;background:#d4edda;color:#155724;font-weight:600;">New: ${data.new_count}</span>
                        <span style="padding:4px 12px;border-radius:12px;background:#fff3cd;color:#856404;font-weight:600;">Updates: ${data.update_count}</span>
                        <span style="padding:4px 12px;border-radius:12px;background:#e2e3e5;color:#383d41;font-weight:600;">Duplicates: ${data.duplicate_count}</span>
                        <span style="color:#666;">Total rows: ${data.row_count}</span>
                    </div>`;

                let rows = '';
                for (const r of diff.new) {
                    rows += `<tr style="background:#d4edda;">
                        <td><strong>NEW</strong></td>
                        <td>${escapeHtml(r.affiliation)}</td><td>${escapeHtml(r.vendor_company)}</td>
                        <td>${escapeHtml(r.product_name)}</td><td>${escapeHtml(r.catalog_id)}</td>
                        <td>${r.quantity_remaining}</td><td>${escapeHtml(r.unit)}</td>
                        <td>${escapeHtml(r.storage)}</td><td>${escapeHtml(r.location)}</td>
                        <td>${escapeHtml(r.responsible_email)}</td>
                    </tr>`;
                }
                for (const item of diff.update) {
                    const r = item.incoming;
                    const ex = item.existing;
                    rows += `<tr style="background:#fff3cd;">
                        <td><strong>UPDATE</strong></td>
                        <td>${escapeHtml(r.affiliation)}</td><td>${escapeHtml(r.vendor_company)}</td>
                        <td>${escapeHtml(r.product_name)}${r.product_name !== ex.product_name ? ' <small style="color:#856404;">(was: '+escapeHtml(ex.product_name)+')</small>' : ''}</td>
                        <td>${escapeHtml(r.catalog_id)}</td>
                        <td>${r.quantity_remaining}${Number(r.quantity_remaining) !== Number(ex.quantity_remaining) ? ' <small style="color:#856404;">(was: '+ex.quantity_remaining+')</small>' : ''}</td>
                        <td>${escapeHtml(r.unit)}</td><td>${escapeHtml(r.storage)}</td>
                        <td>${escapeHtml(r.location)}${r.location !== (ex.location||'') ? ' <small style="color:#856404;">(was: '+escapeHtml(ex.location||'')+')</small>' : ''}</td>
                        <td>${escapeHtml(r.responsible_email)}</td>
                    </tr>`;
                }
                for (const item of diff.duplicate) {
                    const r = item.incoming;
                    rows += `<tr style="background:#e2e3e5;color:#6c757d;">
                        <td>DUPLICATE</td>
                        <td>${escapeHtml(r.affiliation)}</td><td>${escapeHtml(r.vendor_company)}</td>
                        <td>${escapeHtml(r.product_name)}</td><td>${escapeHtml(r.catalog_id)}</td>
                        <td>${r.quantity_remaining}</td><td>${escapeHtml(r.unit)}</td>
                        <td>${escapeHtml(r.storage)}</td><td>${escapeHtml(r.location)}</td>
                        <td>${escapeHtml(r.responsible_email)}</td>
                    </tr>`;
                }
                tbody.innerHTML = rows || '<tr><td colspan="10" style="text-align:center;color:#999;">No data</td></tr>';

                actions.innerHTML = `
                    <button class="btn btn-success" onclick="approveInventoryImport('${submissionId}')">Approve &amp; Apply</button>
                    <button class="btn btn-warning" onclick="requestInventoryRevision('${submissionId}')">Request Revision</button>
                `;

            } catch (err) {
                msgEl.className = 'message error show';
                msgEl.style.display = 'block';
                msgEl.textContent = 'Error loading preview: ' + err.message;
            }
        }

        async function approveInventoryImport(submissionId) {
            if (!confirm('Approve this inventory import? New items will be created and updates will be applied.')) return;

            try {
                const resp = await fetch(`/api/di/inventory/import/approve/${submissionId}`, {
                    method: 'POST', credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Approval failed');

                alert(`Import approved: ${data.new_count} new, ${data.update_count} updated, ${data.duplicate_count} duplicates skipped.`);
                closeInventoryReview();
                loadSubmittedInventoryImports();
                loadAllInventory();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function requestInventoryRevision(submissionId) {
            const comments = prompt('Enter revision comments for the researcher:');
            if (comments === null) return;

            try {
                const resp = await fetch(`/api/di/inventory/import/revise/${submissionId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments }),
                    credentials: 'include'
                });
                if (!resp.ok) throw new Error('Failed');

                alert('Revision requested');
                closeInventoryReview();
                loadSubmittedInventoryImports();
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        function closeInventoryReview() {
            document.getElementById('invReviewPanel').style.display = 'none';
            currentReviewSubmissionId = null;
        }

        async function loadAllInventory() {
            const tbody = document.getElementById('invAllTableBody');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            const aff = document.getElementById('invFilterAffiliation').value;
            const resp_type = document.getElementById('invFilterResponsible').value;
            const status = document.getElementById('invFilterStatus').value;
            const origin = document.getElementById('invFilterOrigin').value;

            const params = new URLSearchParams();
            if (aff) params.set('affiliation', aff);
            if (resp_type) params.set('responsible', resp_type);
            if (status) params.set('status', status);
            if (origin) params.set('origin', origin);

            try {
                const resp = await fetch('/api/di/inventory/all?' + params.toString(), { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];

                if (items.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#999;">No inventory items found</td></tr>';
                    return;
                }

                tbody.innerHTML = items.map(i => `
                    <tr>
                        <td title="${escapeHtml(i.product_link || '')}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                            ${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank">'+escapeHtml(i.product_name)+'</a>' : escapeHtml(i.product_name)}
                        </td>
                        <td>${escapeHtml(i.vendor_company)}</td>
                        <td>${escapeHtml(i.catalog_id)}</td>
                        <td>${escapeHtml(i.affiliation)}</td>
                        <td>${i.responsible_type === 'group' ? '<em>Group</em>' : escapeHtml(i.responsible_name || i.responsible_user_id || '')}</td>
                        <td>${i.quantity_remaining}</td>
                        <td>${escapeHtml(i.unit)}</td>
                        <td>${escapeHtml(i.storage)}</td>
                        <td>${escapeHtml(i.location || '')}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;background:${i.status==='Active'?'#d4edda':'#e2e3e5'};color:${i.status==='Active'?'#155724':'#383d41'};">${i.status}</span></td>
                        <td style="font-size:11px;color:#666;">${i.origin_type === 'offline_import' ? 'Import' : 'Purchase'}</td>
                    </tr>
                `).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#dc3545;">Error loading inventory</td></tr>';
            }
        }
    </script>
</body>
</html>
