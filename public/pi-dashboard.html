<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI Dashboard: NATLAB GLP Portal</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 20px; }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
        }
        .pi-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: #1a365d; background: #f8f9fa; }
        .tab-btn.active {
            color: #1a365d;
            border-bottom-color: #1a365d;
        }
        .tab-btn .badge {
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        /* Tab Content */
        .tab-content { display: none; padding: 20px; max-width: 1600px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* Panels */
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 {
            font-size: 16px;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel-header .icon { font-size: 20px; }
        .panel-content { padding: 20px; }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #1a365d;
        }
        .stat-card .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        .stat-card.pending .stat-value { color: #ffc107; }
        .stat-card.approved .stat-value { color: #28a745; }
        .stat-card.revision .stat-value { color: #dc3545; }

        /* Grid Layouts */
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .upload-column { max-width: 500px; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a87;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover { border-color: #2d5a87; background: #f8f9fa; }
        .file-upload.has-file { border-color: #28a745; background: #f0fff4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload-text { color: #666; font-size: 13px; }
        .file-upload-text strong { color: #2d5a87; }
        .file-name { margin-top: 8px; color: #28a745; font-weight: bold; font-size: 13px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #2d5a87; color: white; }
        .btn-primary:hover { background: #1a365d; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-full { width: 100%; }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        .data-table tr:hover { background: #f8f9fa; }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-revision { background: #f8d7da; color: #721c24; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #e2e3e5; color: #6c757d; }

        /* Type Badges */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .type-badge.pdf { background: #fee; color: #c00; }
        .type-badge.excel { background: #efe; color: #060; }
        .type-badge.word { background: #eef; color: #00c; }
        .type-badge.powerpoint { background: #fef3e0; color: #e65100; }
        .type-badge.sop { background: #e3f2fd; color: #1565c0; }
        .type-badge.data { background: #fff3e0; color: #e65100; }

        /* Role Badge */
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .role-badge.pi { background: #ffc107; color: #333; }
        .role-badge.supervisor { background: #17a2b8; color: white; }
        .role-badge.researcher { background: #e0e0e0; color: #333; }

        /* Actions */
        .actions { display: flex; gap: 5px; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 6px;
            margin-bottom: 15px;
            align-items: center;
        }
        .bulk-actions.hidden { display: none; }
        .bulk-actions span { font-size: 13px; color: #1a365d; font-weight: bold; }

        /* Tree View */
        .directory-tree { font-size: 13px; }
        .tree-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tree-item:hover { background: #f0f2f5; }
        .tree-item .icon { font-size: 16px; }
        .tree-folder { font-weight: bold; color: #1a365d; }
        .tree-file { color: #333; padding-left: 20px; }
        .tree-children { margin-left: 20px; border-left: 1px solid #e0e0e0; }
        .tree-children.collapsed { display: none; }
        .file-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .file-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Loading */
        .loading { text-align: center; padding: 30px; color: #666; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2d5a87;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Review Summary */
        .ai-summary {
            font-size: 12px;
            color: #666;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ai-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        .ai-score.high { background: #d4edda; color: #155724; }
        .ai-score.medium { background: #fff3cd; color: #856404; }
        .ai-score.low { background: #f8d7da; color: #721c24; }

        /* ==================== DATA INTELLIGENCE CONSOLE (DIC) ==================== */
        .dic-container {
            display: grid;
            grid-template-columns: 220px 380px 1fr;
            height: calc(100vh - 160px);
            gap: 0;
            background: #f0f2f5;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e4e7eb;
        }

        /* --- Sidebar --- */
        .dic-sidebar {
            background: #fff;
            border-right: 1px solid #e4e7eb;
            overflow-y: auto;
            padding: 0;
        }
        .dic-sidebar.collapsed { display: none; }
        .dic-sidebar-section {
            padding: 14px 16px 8px;
        }
        .dic-sidebar-section:not(:last-child) {
            border-bottom: 1px solid #f0f2f5;
        }
        .dic-micro-title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 8px;
        }
        .dic-status-bucket {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #374151;
            transition: background 0.15s;
        }
        .dic-status-bucket:hover { background: #f5f7fa; }
        .dic-status-bucket.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
        .dic-status-bucket .dic-count {
            background: #e8ecf1;
            color: #5a6578;
            font-size: 11px;
            font-weight: 600;
            padding: 1px 7px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .dic-status-bucket.active .dic-count {
            background: #1a365d;
            color: #fff;
        }
        .dic-year-item {
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #5a6578;
            transition: background 0.15s;
        }
        .dic-year-item:hover { background: #f5f7fa; }
        .dic-year-item.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
        .dic-researcher-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .dic-researcher-item:hover { background: #f5f7fa; }
        .dic-researcher-item.active { background: #eef2ff; }
        .dic-researcher-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #2d5a87;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .dic-researcher-name {
            font-size: 13px;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-researcher-item.active .dic-researcher-name { color: #1a365d; font-weight: 600; }

        /* --- Finder (Column A) --- */
        .dic-finder {
            background: #fafbfc;
            border-right: 1px solid #e4e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dic-search-area {
            padding: 16px 16px 0;
        }
        .dic-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .dic-search-input:focus {
            border-color: #2d5a87;
            box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.1);
        }
        .dic-scope-pills {
            display: flex;
            gap: 6px;
            padding: 10px 0 0;
        }
        .dic-scope-pill {
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid #d1d5db;
            background: #fff;
            color: #5a6578;
            transition: all 0.15s;
        }
        .dic-scope-pill:hover { border-color: #9ca3af; }
        .dic-scope-pill.active {
            background: #1a365d;
            color: #fff;
            border-color: #1a365d;
        }
        .dic-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px 16px;
            border-bottom: 1px solid #e4e7eb;
        }
        .dic-chip {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #e4e7eb;
            background: #fff;
            color: #5a6578;
            transition: all 0.15s;
        }
        .dic-chip:hover { border-color: #9ca3af; }
        .dic-chip.active {
            background: #eef2ff;
            border-color: #2d5a87;
            color: #1a365d;
            font-weight: 600;
        }
        .dic-chip.dic-chip-dragon.active {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }
        .dic-months-label {
            font-size: 10px;
            color: #9ca3af;
            padding: 2px 16px 0;
        }
        .dic-quick-metrics {
            display: flex;
            gap: 6px;
            padding: 10px 16px;
            border-bottom: 1px solid #e4e7eb;
        }
        .dic-metric-box {
            flex: 1;
            background: #fff;
            border: 1px solid #e4e7eb;
            border-radius: 8px;
            padding: 6px 4px;
            text-align: center;
        }
        .dic-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #1a365d;
        }
        .dic-metric-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #8c95a1;
        }
        .dic-results {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }
        .dic-result-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.15s;
            border: 1px solid transparent;
        }
        .dic-result-item:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-color: #e4e7eb;
        }
        .dic-result-item.active {
            background: #fff;
            border-color: #2d5a87;
            box-shadow: 0 2px 8px rgba(45, 90, 135, 0.1);
        }
        .dic-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            color: #fff;
        }
        .dic-result-icon.data { background: #2d5a87; }
        .dic-result-icon.sop { background: #6366f1; }
        .dic-result-icon.pres { background: #0891b2; }
        .dic-result-body { flex: 1; min-width: 0; }
        .dic-result-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-result-sub {
            font-size: 11px;
            color: #8c95a1;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-result-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        .dic-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .dic-badge.pending { background: #fff3cd; color: #856404; }
        .dic-badge.approved { background: #d4edda; color: #155724; }
        .dic-badge.revision { background: #f8d7da; color: #721c24; }
        .dic-badge.submitted { background: #cce5ff; color: #004085; }
        .dic-assoc-chip {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 4px;
            background: #eef2ff;
            color: #4338ca;
        }
        .dic-dragon-badge {
            font-size: 10px;
        }
        .dic-toolbar-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, opacity 0.15s;
            flex-shrink: 0;
            text-decoration: none;
        }
        .dic-toolbar-icon:hover { transform: translateY(-1px); opacity: 0.85; }
        .dic-toolbar-icon:focus-visible { outline: 2px solid #2d5a87; outline-offset: 2px; }
        .dic-toolbar-icon svg { width: 20px; height: 20px; }
        .dic-toolbar-dragon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid #d1d5db;
            background: #fff;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, opacity 0.15s, border-color 0.15s;
            flex-shrink: 0;
        }
        .dic-toolbar-dragon:hover { transform: translateY(-1px); opacity: 0.85; }
        .dic-toolbar-dragon:focus-visible { outline: 2px solid #2d5a87; outline-offset: 2px; }
        .dic-toolbar-dragon.sealed { background: #fef2f2; border-color: #dc2626; }
        .dic-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #8c95a1;
        }
        .dic-empty-state h3 {
            font-size: 14px;
            font-weight: 600;
            color: #5a6578;
            margin: 0 0 12px;
        }
        .dic-empty-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .dic-empty-btn {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-empty-btn:hover { border-color: #2d5a87; color: #1a365d; }

        /* --- Viewer (Column B) --- */
        .dic-viewer {
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dic-viewer-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid #e4e7eb;
            background: #fafbfc;
            min-height: 48px;
            flex-wrap: wrap;
        }
        .dic-viewer-filename {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-toolbar-btn {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-toolbar-btn:hover { background: #f5f7fa; border-color: #9ca3af; }
        .dic-toolbar-btn.approve { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .dic-toolbar-btn.approve:hover { background: #c3e6cb; }
        .dic-toolbar-btn.revise { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .dic-toolbar-btn.revise:hover { background: #ffeeba; }
        .dic-viewer-pdf {
            flex: 1;
            min-height: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: #f0f2f5;
        }
        .dic-viewer-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
        }
        .dic-intel-panel {
            border-top: 1px solid #e4e7eb;
            background: #fafbfc;
            padding: 0;
            flex-shrink: 0;
        }
        .dic-intel-strip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            height: 36px;
            box-sizing: border-box;
            border-bottom: 1px solid #f0f2f5;
        }
        .dic-intel-strip:last-child { border-bottom: none; }
        .dic-intel-strip-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8c95a1;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .dic-intel-chips {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .dic-intel-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #374151;
            background: #fff;
            border: 1px solid #e4e7eb;
            white-space: nowrap;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .dic-intel-chip:hover { border-color: #9ca3af; }
        .dic-intel-chip.heuristic {
            border-style: dashed;
            opacity: 0.7;
        }
        .dic-intel-chip .dic-badge { font-size: 8px; padding: 0 4px; }
        .dic-intel-chip-remove {
            font-size: 12px;
            color: #d1d5db;
            cursor: pointer;
            line-height: 1;
            margin-left: 2px;
        }
        .dic-intel-chip-remove:hover { color: #ef4444; }
        .dic-intel-chip-score {
            font-size: 9px;
            color: #9ca3af;
        }
        .dic-intel-link-btn {
            font-size: 10px;
            font-weight: 600;
            color: #2d5a87;
            cursor: pointer;
            border: none;
            background: none;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .dic-intel-link-btn:hover { background: #eef2ff; }
        .dic-intel-remove {
            font-size: 14px;
            color: #d1d5db;
            cursor: pointer;
            margin-left: 4px;
            line-height: 1;
            transition: color 0.15s;
        }
        .dic-intel-remove:hover { color: #ef4444; }

        /* --- Link Modal --- */
        .dic-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .dic-modal-overlay.active { display: flex; }
        .dic-modal {
            background: #fff;
            border-radius: 14px;
            width: 520px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .dic-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e7eb;
            font-size: 15px;
            font-weight: 700;
            color: #1a365d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dic-modal-close {
            font-size: 20px;
            cursor: pointer;
            color: #9ca3af;
            border: none;
            background: none;
            line-height: 1;
        }
        .dic-modal-close:hover { color: #374151; }
        .dic-modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }
        .dic-modal-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        .dic-modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 12px;
            color: #374151;
        }
        .dic-modal-item:hover { background: #f5f7fa; }
        .dic-modal-item.linked {
            opacity: 0.4;
            cursor: default;
        }
        .dic-modal-item .dic-badge { margin-left: auto; }

        /* --- Revise Modal --- */
        .dic-revise-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }
        .dic-revise-textarea:focus {
            border-color: #2d5a87;
            outline: none;
        }
        .dic-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e4e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .dic-modal-btn {
            padding: 7px 18px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-modal-btn:hover { background: #f5f7fa; }
        .dic-modal-btn.primary {
            background: #1a365d;
            color: #fff;
            border-color: #1a365d;
        }
        .dic-modal-btn.primary:hover { background: #2d5a87; }

        /* --- Sidebar toggle --- */
        .dic-sidebar-toggle {
            position: absolute;
            left: 220px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            width: 20px;
            height: 40px;
            background: #fff;
            border: 1px solid #e4e7eb;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #8c95a1;
            transition: all 0.15s;
        }
        .dic-sidebar-toggle:hover { background: #f5f7fa; color: #374151; }

        /* Responsive */
        @media (max-width: 1200px) {
            .dic-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .dic-sidebar { display: none; }
            .dic-finder { border-right: none; }
            .dic-viewer { min-height: 500px; }
            .two-column { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .tab-nav { overflow-x: auto; }
        }
        @media (max-width: 768px) {
            .tab-btn { padding: 12px 15px; font-size: 12px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group select, .filter-group input { width: 100%; }
        }
    
.download-mode-option.half-width {
  width: 48%;
  display: inline-flex;
  margin: 1%;
}
</style>
</head>
<body>
    <div class="header">
        <h1>NATLAB GLP Data Integrity Portal</h1>
        <div class="header-info">
            <span class="pi-badge">PRINCIPAL INVESTIGATOR</span>
            <span class="user-badge" id="userName">Loading...</span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="dashboard">Dashboard <span class="badge" id="pendingBadge" style="display:none;">0</span></button>
        <button class="tab-btn" data-tab="lab-files">Laboratory Files</button>
        <button class="tab-btn" data-tab="group-docs">Group Documents</button>
        <button class="tab-btn" data-tab="user-mgmt">User Management</button>
        <button class="tab-btn" data-tab="reports">Reports</button>
        <button class="tab-btn" data-tab="backup">Backup</button>
        <button class="tab-btn" data-tab="purchases-inventory">Purchases &amp; Inventory</button>
        <button class="tab-btn" data-tab="training">Training &amp; Approvals</button>
    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div class="tab-content active" id="tab-dashboard">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value" id="statApproved">-</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card revision">
                <div class="stat-value" id="statRevision">-</div>
                <div class="stat-label">Revision Needed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total Submissions</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Pending Approvals -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending Approvals</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPendingApprovals()">Refresh</button>
                </div>
                <div class="panel-content" style="max-height: 500px; overflow-y: auto;">
                    <div id="pendingApprovalsContainer">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Upload -->
            <div class="panel upload-column">
                <div class="panel-header">
                    <h2><span class="icon">&#128194;</span> Quick Upload</h2>
                </div>
                <div class="panel-content">
                    <div id="uploadMessage" class="message"></div>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="uploadResearcher">Upload for Researcher</label>
                            <select id="uploadResearcher" required>
                                <option value="">Select researcher...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fileType">File Type</label>
                            <select id="fileType" required>
                                <option value="">Select file type...</option>
                                <option value="SOP">SOP (Standard Operating Procedure)</option>
                                <option value="DATA">DATA (Research Data)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>File</label>
                            <div class="file-upload" id="fileUploadArea">
                                <input type="file" id="fileInput" accept=".pdf" required>
                                <p class="file-upload-text">
                                    <strong>Click to select a file</strong><br>
                                    or drag and drop here
                                </p>
                                <p class="file-name" id="fileName"></p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="uploadBtn">Upload File</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LABORATORY FILES TAB â€” DATA INTELLIGENCE CONSOLE ==================== -->
    <div class="tab-content" id="tab-lab-files">
        <div class="dic-container" style="position:relative;">
            <!-- Sidebar -->
            <div class="dic-sidebar" id="dicSidebar">
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">STATUS</div>
                    <div id="dicStatusBuckets"></div>
                </div>
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">YEAR</div>
                    <div id="dicYearList"></div>
                </div>
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">RESEARCHERS</div>
                    <div id="dicResearcherList"></div>
                </div>
            </div>

            <!-- Finder (Column A) -->
            <div class="dic-finder">
                <div class="dic-search-area">
                    <input type="text" class="dic-search-input" id="dicSearchInput" placeholder="Search files..." oninput="dicApplyFilters()">
                    <div class="dic-scope-pills">
                        <span class="dic-scope-pill active" data-scope="DATA" onclick="dicSetScope(this)">DATA</span>
                        <span class="dic-scope-pill" data-scope="PRESENTATION" onclick="dicSetScope(this)">PRES</span>
                        <span class="dic-scope-pill" data-scope="SOP" onclick="dicSetScope(this)">SOP</span>
                        <span class="dic-scope-pill" data-scope="" onclick="dicSetScope(this)">ALL</span>
                    </div>
                </div>
                <div class="dic-months-label" id="dicMonthsLabel">Showing last 12 months</div>
                <div class="dic-filter-row">
                    <span class="dic-chip active" data-filter="status" data-val="" onclick="dicSetChip('status','')" >All</span>
                    <span class="dic-chip" data-filter="status" data-val="PENDING" onclick="dicSetChip('status','PENDING')">Pending</span>
                    <span class="dic-chip" data-filter="status" data-val="APPROVED" onclick="dicSetChip('status','APPROVED')">Approved</span>
                    <span class="dic-chip" data-filter="status" data-val="REVISION_NEEDED" onclick="dicSetChip('status','REVISION_NEEDED')">Revision</span>
                    <span class="dic-chip dic-chip-dragon" data-filter="dragonSeal" onclick="dicToggleDragonSeal(this)">&#x1F409; Dragon Seal</span>
                </div>
                <div class="dic-filter-row">
                    <span class="dic-chip active" data-filter="time" data-val="" onclick="dicSetChip('time','')">All Time</span>
                    <span class="dic-chip" data-filter="time" data-val="7" onclick="dicSetChip('time','7')">7d</span>
                    <span class="dic-chip" data-filter="time" data-val="30" onclick="dicSetChip('time','30')">30d</span>
                    <span class="dic-chip" data-filter="time" data-val="90" onclick="dicSetChip('time','90')">90d</span>
                    <span class="dic-chip" data-filter="time" data-val="365" onclick="dicSetChip('time','365')">Year</span>
                    <span style="margin-left:auto;"></span>
                    <span class="dic-chip active" data-filter="sort" data-val="newest" onclick="dicSetChip('sort','newest')">Newest</span>
                    <span class="dic-chip" data-filter="sort" data-val="oldest" onclick="dicSetChip('sort','oldest')">Oldest</span>
                    <span class="dic-chip" data-filter="sort" data-val="name" onclick="dicSetChip('sort','name')">Name</span>
                </div>
                <div class="dic-quick-metrics" id="dicQuickMetrics" style="display:none;"></div>
                <div class="dic-results" id="dicResults">
                    <div class="dic-empty-state"><h3>Select a researcher or search to begin</h3></div>
                </div>
            </div>

            <!-- Viewer (Column B) -->
            <div class="dic-viewer">
                <div class="dic-viewer-toolbar" id="dicToolbar">
                    <span class="dic-viewer-filename" id="dicViewerFilename">No file selected</span>
                </div>
                <div class="dic-viewer-empty" id="dicViewerEmpty">Select a file to preview</div>
                <iframe class="dic-viewer-pdf" id="dicViewerPdf" style="display:none;"></iframe>
                <div class="dic-intel-panel" id="dicIntelPanel" style="display:none;">
                    <div class="dic-intel-strip">
                        <span class="dic-intel-strip-label" id="dicSopLabel">SOPs (0)</span>
                        <div class="dic-intel-chips" id="dicIntelSops"></div>
                        <button class="dic-intel-link-btn" onclick="dicOpenLinkModal('SOP')">+</button>
                    </div>
                    <div class="dic-intel-strip">
                        <span class="dic-intel-strip-label" id="dicPresLabel">PRES (0)</span>
                        <div class="dic-intel-chips" id="dicIntelPres"></div>
                        <button class="dic-intel-link-btn" onclick="dicOpenLinkModal('PRESENTATION')">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Link Modal -->
        <div class="dic-modal-overlay" id="dicLinkModal">
            <div class="dic-modal">
                <div class="dic-modal-header">
                    <span id="dicLinkModalTitle">Link File</span>
                    <button class="dic-modal-close" onclick="dicCloseLinkModal()">&times;</button>
                </div>
                <div class="dic-modal-body">
                    <input type="text" class="dic-modal-search" id="dicLinkSearch" placeholder="Search files..." oninput="dicFilterLinkCandidates()">
                    <div id="dicLinkCandidates"></div>
                </div>
            </div>
        </div>

        <!-- Revise Modal -->
        <div class="dic-modal-overlay" id="dicReviseModal">
            <div class="dic-modal">
                <div class="dic-modal-header">
                    <span>Request Revision</span>
                    <button class="dic-modal-close" onclick="dicCloseReviseModal()">&times;</button>
                </div>
                <div class="dic-modal-body">
                    <textarea class="dic-revise-textarea" id="dicReviseText" placeholder="Describe what needs to be revised..."></textarea>
                </div>
                <div class="dic-modal-footer">
                    <button class="dic-modal-btn" onclick="dicCloseReviseModal()">Cancel</button>
                    <button class="dic-modal-btn primary" onclick="dicSubmitRevision()">Submit Revision</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== GROUP DOCUMENTS TAB ==================== -->
    <div class="tab-content" id="tab-group-docs">
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128218;</span> Group Documents</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadGroupDocuments()">Refresh</button>
            </div>
            <div class="panel-content">
                <!-- Upload Form -->
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <h3 style="font-size: 14px; color: #1a365d; margin-bottom: 15px;">Upload New Document</h3>
                    <div id="groupDocMessage" class="message"></div>
                    <form id="groupDocForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="docTitle">Title *</label>
                                <input type="text" id="docTitle" required placeholder="Document title">
                            </div>
                            <div class="form-group">
                                <label for="docCategory">Category *</label>
                                <select id="docCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="SOP">SOP (Standard Operating Procedure)</option>
                                    <option value="Guidelines">Guidelines</option>
                                    <option value="Templates">Templates</option>
                                    <option value="Training">Training Materials</option>
                                    <option value="Forms">Forms</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="docDescription">Description (optional)</label>
                                <textarea id="docDescription" placeholder="Brief description of the document"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>File * (PDF, Word, Excel, PowerPoint)</label>
                                <div class="file-upload" id="groupDocUploadArea" style="padding: 15px;">
                                    <input type="file" id="groupDocFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                                    <p class="file-upload-text" style="margin: 0;">
                                        <strong>Click to select</strong> or drag and drop
                                    </p>
                                    <p class="file-name" id="groupDocFileName" style="margin: 5px 0 0 0;"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Permissions</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="docCanDownload" checked>
                                    <label for="docCanDownload">Allow researchers to download</label>
                                </div>
                                <p style="font-size: 11px; color: #666; margin-top: 5px;">If unchecked, researchers can only view online</p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="groupDocSubmitBtn">Upload Document</button>
                    </form>
                </div>

                <!-- Documents Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Download</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="groupDocsTableBody">
                        <tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== USER MANAGEMENT TAB ==================== -->
    <div class="tab-content" id="tab-user-mgmt">
        <div class="two-column">
            <!-- Add User Form -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128100;</span> Add New User</h2>
                </div>
                <div class="panel-content">
                    <div id="addUserMessage" class="message"></div>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName">Full Name *</label>
                            <input type="text" id="newUserName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Institution Email *</label>
                            <input type="email" id="newUserEmail" required placeholder="john.doe@liu.se">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserAffiliation">Affiliation *</label>
                                <select id="newUserAffiliation" required>
                                    <option value="">Select...</option>
                                    <option value="LiU">LiU</option>
                                    <option value="UNAV">UNAV</option>
                                    <option value="EXTERNAL">External</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newUserRole">Role *</label>
                                <select id="newUserRole" required>
                                    <option value="researcher">Researcher</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="pi">Principal Investigator</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="addUserBtn">Add User</button>
                    </form>
                </div>
            </div>

            <!-- User Info -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128712;</span> User Management Info</h2>
                </div>
                <div class="panel-content">
                    <div class="message info show">
                        <strong>Deactivation Policy:</strong><br><br>
                        When a user is deactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>They cannot log in or use the system</li>
                            <li>All their historical data remains intact</li>
                            <li>Their submissions are preserved</li>
                        </ul>
                        <br>
                        When reactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>All previous data, roles, and submissions are restored</li>
                            <li>They can log in again with the same credentials</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delegation Section -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> Supervisor Delegation</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadDelegationData()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="delegationMessage" class="message"></div>
                <div class="form-row">
                    <!-- Promote/Demote -->
                    <div class="form-group">
                        <label>Promote/Demote Researcher</label>
                        <select id="promoteSelect" style="margin-bottom:8px;">
                            <option value="">Select a researcher...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-success" onclick="promoteToSupervisor()">Promote to Supervisor</button>
                            <button class="btn btn-sm btn-warning" onclick="demoteToResearcher()">Demote to Researcher</button>
                        </div>
                    </div>
                    <!-- Assign Researchers -->
                    <div class="form-group">
                        <label>Assign Researcher to Supervisor</label>
                        <select id="supervisorSelect" style="margin-bottom:8px;">
                            <option value="">Select supervisor...</option>
                        </select>
                        <select id="assignResearcherSelect" style="margin-bottom:8px;">
                            <option value="">Select researcher to assign...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-primary" onclick="assignResearcher()">Assign</button>
                            <button class="btn btn-sm btn-danger" onclick="unassignResearcher()">Unassign</button>
                        </div>
                    </div>
                </div>
                <!-- Assignments Table -->
                <div style="margin-top:15px;">
                    <label>Current Assignments</label>
                    <table class="data-table" id="assignmentsTable">
                        <thead>
                            <tr><th>Supervisor</th><th>Researcher</th><th>Assigned</th><th>Action</th></tr>
                        </thead>
                        <tbody id="assignmentsTableBody">
                            <tr><td colspan="4" style="text-align:center;color:#666;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> All Users</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllUsers()">Refresh</button>
            </div>
            <div class="panel-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Researcher ID</th>
                            <th>Affiliation</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Submissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== REPORTS TAB ==================== -->
    <div class="tab-content" id="tab-reports">
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="reportTotalSubmissions">-</div>
                <div class="stat-label">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reportTotalResearchers">-</div>
                <div class="stat-label">Active Researchers</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value" id="reportApprovalRate">-</div>
                <div class="stat-label">Approval Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reportThisMonth">-</div>
                <div class="stat-label">This Month</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Submissions by Status -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128202;</span> Submissions by Status</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table" id="statusBreakdownTable">
                        <thead>
                            <tr>
                                <th>Status</th>
                                <th>Count</th>
                                <th>Percentage</th>
                            </tr>
                        </thead>
                        <tbody id="statusBreakdownBody">
                            <tr><td colspan="3"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Submissions by Researcher -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128100;</span> Top Researchers</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Submissions</th>
                                <th>Approved</th>
                            </tr>
                        </thead>
                        <tbody id="researcherBreakdownBody">
                            <tr><td colspan="3"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Export Section -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128190;</span> Export Data</h2>
            </div>
            <div class="panel-content">
                <div class="filter-bar">
                    <div class="filter-group">
                        <label>From Date</label>
                        <input type="date" id="exportFromDate">
                    </div>
                    <div class="filter-group">
                        <label>To Date</label>
                        <input type="date" id="exportToDate">
                    </div>
                    <div class="filter-group">
                        <label>Status</label>
                        <select id="exportStatus">
                            <option value="">All Statuses</option>
                            <option value="PENDING">Pending</option>
                            <option value="APPROVED">Approved</option>
                            <option value="REVISION_NEEDED">Revision Needed</option>
                        </select>
                    </div>
                    <div class="filter-group" style="justify-content: flex-end;">
                        <label>&nbsp;</label>
                        <button class="btn btn-success" onclick="exportToCSV()">Export to CSV</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== BACKUP TAB ==================== -->
    <div class="tab-content" id="tab-backup">
        <!-- Description -->
        <div class="message info show" style="margin-bottom:20px;display:block;">
            This section provides secure access to verified backup copies of all laboratory data. Primary data are continuously stored in the system and replicated to an independent backup storage as immutable snapshots. Backups protect against accidental deletion, corruption, or system failure and do not affect ongoing work unless explicitly used.
        </div>

        <!-- Recovery Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Recovery</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadBackupSnapshots()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="backupMessage" class="message"></div>

                <!-- Step 1: Select Snapshot -->
                <div class="form-group">
                    <label>Select Recovery Point</label>
                    <select id="backupSnapshotSelect" onchange="clearBackupPreview()">
                        <option value="">Select a recovery point...</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="previewBackupRecovery()">Preview Comparison</button>
                </div>

                <!-- Step 2: Preview Summary -->
                <div id="backupPreviewContainer" style="display:none;">
                    <div class="stats-row" style="margin-bottom:10px;">
                        <div class="stat-card">
                            <div class="stat-value" id="bkpBackupCount">0</div>
                            <div class="stat-label">Files in Backup</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bkpR2Count">0</div>
                            <div class="stat-label">Files in Storage</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-value" id="bkpDiffCount">0</div>
                            <div class="stat-label">Estimated Difference</div>
                        </div>
                    </div>
                    <p id="backupSummaryText" style="color:#555;margin-bottom:15px;font-size:14px;"></p>

                    <!-- Step 3: Recovery Mode -->
                    <div class="form-group">
                        <label>Recovery Mode</label>
                        <select id="backupRecoveryMode">
                            <option value="add-missing">Add missing files only (recommended)</option>
                            <option value="full-restore">Full restore from backup</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" onclick="confirmBackupRecovery()" id="backupRecoverBtn">Start Recovery</button>
                </div>

                <!-- Recovery Progress -->
                <div id="backupRecoveryProgress" style="display:none;margin-top:15px;">
                    <div class="loading"><div class="spinner"></div>Recovery in progress. This may take several minutes.</div>
                </div>

                <!-- Recovery Result -->
                <div id="backupRecoveryResult" style="display:none;margin-top:15px;"></div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Download</h2>
            </div>
            <div class="panel-content">
                <p style="color:#555;margin-bottom:15px;font-size:14px;">Download current data directly from storage as ZIP files. Choose by researcher, by date range, or download everything. For large selections, multi-file download is recommended.</p>
                <div id="dlMessage" class="message"></div>

                <!-- Main buttons -->
                <div id="dlButtons" style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="dlStartFlow('researcher')">Download by Researcher</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('daterange')">Download by Date Range</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('full')">Full Data Download</button>
                </div>

                <!-- Flow container -->
                <div id="dlFlow" style="display:none;">
                    <div style="margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                        <button class="btn btn-sm btn-secondary" onclick="dlReset()">&larr; Back</button>
                        <span id="dlFlowTitle" style="font-weight:600;font-size:15px;"></span>
                        <span id="dlStepLabel" style="color:#888;font-size:13px;margin-left:auto;"></span>
                    </div>
                    <div id="dlStepContent"></div>
                    <div id="dlStepActions" style="margin-top:15px;display:flex;gap:10px;"></div>
                </div>

                <!-- Download progress / multi-part tracker -->
                <div id="dlProgress" style="display:none;margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== PURCHASES & INVENTORY TAB ==================== -->
    <div class="tab-content" id="tab-purchases-inventory">

        <!-- Purchase Requests for PI Review -->
        <div class="panel">
            <div class="panel-header">
                <h2>Purchase Requests</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllPurchaseRequests()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
                    <select id="prFilterStatus" onchange="loadAllPurchaseRequests()" style="padding:6px;border-radius:4px;border:1px solid #ddd;font-size:13px;">
                        <option value="">All Statuses</option>
                        <option value="SUBMITTED" selected>Submitted</option>
                        <option value="APPROVED">Approved</option>
                        <option value="DECLINED">Declined</option>
                    </select>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="data-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Requester</th>
                                <th>Affil.</th>
                                <th>Justification</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prAllTableBody">
                            <tr><td colspan="8" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchase Request Detail (hidden by default) -->
        <div class="panel" id="prDetailPanel" style="display:none;">
            <div class="panel-header">
                <h2 id="prDetailTitle">Request Detail</h2>
                <button class="btn btn-sm btn-secondary" onclick="closePrDetail()">Close</button>
            </div>
            <div class="panel-content">
                <div id="prDetailJustification" style="margin-bottom:10px;padding:8px 12px;background:#f8f9fa;border-radius:4px;font-size:13px;"></div>
                <table class="data-table" style="font-size:13px;">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Product</th>
                            <th>Catalog ID</th>
                            <th>Link</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Ordered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prDetailItemsBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6" style="text-align:right;font-weight:600;">Request Total:</td><td id="prDetailTotal" style="font-weight:700;" colspan="3"></td></tr>
                    </tfoot>
                </table>
                <div id="prDetailActions" style="margin-top:12px;display:flex;gap:10px;"></div>
            </div>
        </div>

        <!-- Consolidated Email (PI) -->
        <div class="panel">
            <div class="panel-header">
                <h2>Consolidated Purchase Email</h2>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('LiU')">Load LiU</button>
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('UNAV')">Load UNAV</button>
                </div>
                <div id="prConsolidatedArea" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong id="prConsolidatedTitle"></strong>
                        <button class="btn btn-sm btn-success" onclick="copyConsolidatedEmail()">Copy email text</button>
                    </div>
                    <pre id="prConsolidatedText" style="background:#f8f9fa;padding:12px;border-radius:4px;font-size:12px;white-space:pre-wrap;max-height:400px;overflow-y:auto;border:1px solid #ddd;"></pre>
                </div>
                <div id="prConsolidatedEmpty" style="display:none;text-align:center;color:#999;padding:10px;">No approved items to order for this affiliation.</div>
            </div>
        </div>

        <!-- PO Numbers -->
        <div class="panel">
            <div class="panel-header">
                <h2>PO Numbers</h2>
            </div>
            <div class="panel-content">
                <input type="text" id="poSearchInput" oninput="searchPONumbers()" placeholder="Search by PO number, product, or researcher..."
                       style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-bottom:12px;box-sizing:border-box;">
                <table class="data-table" style="font-size:13px;">
                    <thead><tr><th>Product</th><th>Researcher</th><th>Date</th><th>PO Number</th><th>Status</th></tr></thead>
                    <tbody id="poTableBody"><tr><td colspan="5" style="text-align:center;color:#999;">Click tab to load data</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Management -->
        <div class="panel">
            <div class="panel-header">
                <h2>Inventory Management</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllInventoryV2()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <select id="invV2FilterType" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Types</option>
                        <option value="product">Products</option>
                        <option value="sample">Samples</option>
                        <option value="oligo">Oligos</option>
                    </select>
                    <select id="invV2FilterAffiliation" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Affiliations</option>
                        <option value="LiU">LiU</option>
                        <option value="UNAV">UNAV</option>
                    </select>
                    <select id="invV2FilterVisibility" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Visibility</option>
                        <option value="personal">Personal</option>
                        <option value="group">Group</option>
                    </select>
                    <select id="invV2FilterStatus" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Revision">Revision</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Received">Received</option>
                        <option value="ConsumePending">ConsumePending</option>
                        <option value="TransferPending">TransferPending</option>
                        <option value="ApprovedLinked">ApprovedLinked</option>
                        <option value="Consumed">Consumed</option>
                        <option value="DeletePending">DeletePending</option>
                        <option value="Deleted">Deleted</option>
                    </select>
                    <select id="invV2FilterSource" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Sources</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="data-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Identifier</th>
                                <th>Affiliation</th>
                                <th>Owner</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Storage</th>
                                <th>Status</th>
                                <th>Scope</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invV2AllTableBody">
                            <tr><td colspan="11" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TRAINING & APPROVALS TAB ==================== -->
    <div class="tab-content" id="tab-training">
        <!-- Toggle between Design, Management, Certifications, and My Training -->
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn btn-primary" id="toggleTrainingDesign" onclick="showTrainingToggle('design')" style="flex:1;">Training Design</button>
            <button class="btn btn-secondary" id="toggleTrainingMgmt" onclick="showTrainingToggle('management')" style="flex:1;">Training Management</button>
            <button class="btn btn-secondary" id="toggleTrainingCerts" onclick="showTrainingToggle('certifications')" style="flex:1;">Certifications</button>
            <a href="upload.html?section=training" class="btn btn-secondary" style="flex:1;text-align:center;text-decoration:none;">My Training Pack</a>
        </div>

        <!-- TRAINING DESIGN -->
        <div id="trainingDesignView">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128218;</span> Training Documents</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadTrainingDocuments()">Refresh</button>
                </div>
                <div class="panel-content">
                    <!-- Upload form -->
                    <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="font-size:14px;color:#1a365d;margin-bottom:15px;">Upload New Document</h3>
                        <div id="trainDocMessage" class="message"></div>
                        <form id="trainDocForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocTitle">Title *</label>
                                    <input type="text" id="trainDocTitle" required placeholder="Document title">
                                </div>
                                <div class="form-group">
                                    <label for="trainDocCategory">Category *</label>
                                    <select id="trainDocCategory" required>
                                        <option value="">Select...</option>
                                        <option value="Guidelines">Guidelines</option>
                                        <option value="Authorship">Authorship</option>
                                        <option value="Safety">Safety</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocAffiliation">Applies to *</label>
                                    <select id="trainDocAffiliation" required>
                                        <option value="All">All</option>
                                        <option value="LiU">LiU</option>
                                        <option value="UNAV">UNAV</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="trainDocRule">Requirement *</label>
                                    <select id="trainDocRule" required>
                                        <option value="Always">Always</option>
                                        <option value="Conditional">Conditional</option>
                                        <option value="Optional">Optional</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocCondKey">Condition Key</label>
                                    <input type="text" id="trainDocCondKey" placeholder="e.g. MICROBIOLOGY_ACCESS">
                                </div>
                                <div class="form-group">
                                    <label for="trainDocCondNote">Condition Note</label>
                                    <input type="text" id="trainDocCondNote" placeholder="Display text for condition">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>PDF File *</label>
                                <div class="file-upload" id="trainDocUploadArea" style="padding:15px;">
                                    <input type="file" id="trainDocFile" accept=".pdf">
                                    <p class="file-upload-text" style="margin:0;"><strong>Click to select</strong> or drag and drop</p>
                                    <p class="file-name" id="trainDocFileName" style="margin:5px 0 0 0;"></p>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="trainDocSubmitBtn">Upload Document</button>
                        </form>
                    </div>
                    <!-- Document list -->
                    <table class="data-table" id="trainDocsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Applies to</th>
                                <th>Rule</th>
                                <th>Current Version</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trainDocsTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRAINING MANAGEMENT -->
        <div id="trainingMgmtView" style="display:none;">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending Training Packs</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPendingTrainingPacks()">Refresh</button>
                </div>
                <div class="panel-content">
                    <div id="pendingPacksMessage" class="message"></div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Affiliation</th>
                                <th>Version</th>
                                <th>Agreements</th>
                                <th>Trainings</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingPacksTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                    <!-- Pack detail expansion area -->
                    <div id="packDetailArea" style="display:none;margin-top:20px;background:#f8f9fa;padding:20px;border-radius:8px;">
                        <h3 style="font-size:14px;color:#1a365d;margin-bottom:10px;" id="packDetailTitle">Pack Details</h3>
                        <div id="packDetailContent"></div>
                    </div>
                </div>
            </div>

            <!-- Sealed packs summary -->
            <div class="panel" style="margin-top:20px;">
                <div class="panel-header">
                    <h2><span class="icon">&#9989;</span> Sealed Training Packs</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Seal</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sealedPacksTableBody">
                            <tr><td colspan="3" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CERTIFICATIONS (PI route entries awaiting PI certification) -->
        <div id="trainingCertsView" style="display:none;">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending PI Certifications</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPiPendingCerts()">Refresh</button>
                </div>
                <div class="panel-content">
                    <p style="font-size:12px;color:#666;margin-bottom:10px;">Training entries routed to PI for certification (other supervisor / delegated delivery).</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Trainee</th>
                                <th>Training Type</th>
                                <th>Date</th>
                                <th>Other Supervisor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="piCertsTableBody">
                            <tr><td colspan="6" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // GLOBAL STATE & INIT
        // =====================================================
        let currentUser = null;
        let allMembers = [];
        let labFilesData = [];
        let selectedLabFiles = new Set();

        // Check authentication and PI role
        async function checkAuth() {
            try {
                const response = await fetch('/api/di/me', { credentials: 'include' });
                if (response.status === 401) { window.location.href = 'access.html'; return; }
                const data = await response.json();
                currentUser = data.user || data;

                // Check if user is PI
                const role = (currentUser.role || "").toUpperCase();
                if (role !== "PI" && role !== "ADMIN") {
                    window.location.href = 'upload.html';
                    return;
                }

                document.getElementById('userName').textContent = currentUser.researcher_id;

                // Load initial data
                loadDashboardData();
                populateResearcherDropdown();
                loadGroupDocuments();
                loadAllUsers();
                loadReportsData();

            } catch (err) {
                window.location.href = 'access.html';
            }
        }

        checkAuth();

        // =====================================================
        // TAB NAVIGATION
        // =====================================================
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active tab button
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                // Update active tab content
                const tabId = btn.dataset.tab;
                document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                document.getElementById('tab-' + tabId).classList.add('active');

                // Load tab-specific data
                if (tabId === 'lab-files') dicInit();
                if (tabId === 'reports') loadReportsData();
                if (tabId === 'purchases-inventory') { loadAllPurchaseRequests(); loadAllInventoryV2(); loadPONumbers(); }
                if (tabId === 'training') { loadTrainingDocuments(); loadPendingTrainingPacks(); loadSealedTrainingPacks(); }
            });
        });

        // =====================================================
        // DASHBOARD TAB
        // =====================================================
        async function loadDashboardData() {
            loadPendingApprovals();
            loadStats();
            // loadInventoryBadge removed (CSV imports deprecated)
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/di/metrics', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statPending').textContent = data.byStatus?.PENDING || 0;
                    document.getElementById('statApproved').textContent = data.byStatus?.APPROVED || 0;
                    document.getElementById('statRevision').textContent = data.openRevisionRequests ?? data.byStatus?.REVISION_NEEDED ?? 0;
                    document.getElementById('statTotal').textContent = data.total || 0;

                    // Update badge
                    const pending = data.byStatus?.PENDING || 0;
                    const badge = document.getElementById('pendingBadge');
                    if (pending > 0) {
                        badge.textContent = pending;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        async function loadPendingApprovals() {
            const container = document.getElementById('pendingApprovalsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await fetch('/api/di/pending-approvals', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                // Filter out INVENTORY submissions â€” they are reviewed in Purchases & Inventory tab
                data.submissions = (data.submissions || []).filter(s => s.file_type !== 'INVENTORY');

                if (!data.submissions || data.submissions.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No pending approvals</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Researcher</th>
                                <th>Type</th>
                                <th>Uploaded</th>
                                <th>AI Review</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.submissions.map(s => {
                                const aiScore = s.ai_review?.score;
                                const aiClass = aiScore >= 80 ? 'high' : aiScore >= 50 ? 'medium' : 'low';
                                const date = new Date(s.created_at).toLocaleDateString();
                                return `
                                    <tr>
                                        <td title="${escapeHtml(s.original_filename)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.original_filename)}</td>
                                        <td>${escapeHtml(s.researcher_id)}</td>
                                        <td><span class="type-badge ${s.file_type?.toLowerCase()}">${s.file_type}</span></td>
                                        <td>${date}</td>
                                        <td>${aiScore !== undefined ? `<span class="ai-score ${aiClass}">${aiScore}%</span>` : '<span style="color:#999;">-</span>'}</td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn btn-sm btn-primary" onclick="viewFile('${s.submission_id}')">View</button>
                                                <button class="btn btn-sm btn-success" onclick="quickApprove('${s.submission_id}')">Approve</button>
                                                <button class="btn btn-sm btn-warning" onclick="quickRevise('${s.submission_id}')">Revise</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading pending approvals</p>';
            }
        }

        function viewFile(id) {
            window.open(`/api/di/download/${id}`, '_blank');
        }

        async function quickApprove(id) {
            if (!confirm('Are you sure you want to approve this submission?')) return;

            try {
                // Generate token for approval link
                const token = btoa(id + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
                window.open(`/api/di/approve/${id}?token=${token}`, '_blank');
                setTimeout(() => {
                    loadPendingApprovals();
                    loadStats();
                }, 2000);
            } catch (err) {
                alert('Error approving submission');
            }
        }

        async function quickRevise(id) {
            const comments = prompt('Enter revision comments:');
            if (comments === null) return;

            try {
                const token = btoa(id + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
                const response = await fetch(`/api/di/revise/${id}?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Revision requested');
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert('Failed to request revision');
                }
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        // =====================================================
        // UPLOAD FUNCTIONALITY
        // =====================================================
        async function populateResearcherDropdown() {
            const select = document.getElementById('uploadResearcher');
            const filterSelect = document.getElementById('filterResearcher');

            try {
                const response = await fetch('/api/di/members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                allMembers = data.members || [];

                const options = allMembers.map(m =>
                    `<option value="${m.researcher_id}">${m.researcher_id} - ${m.name || ''} (${m.affiliation})</option>`
                ).join('');

                select.innerHTML = '<option value="">Select researcher...</option>' + options;
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Researchers</option>' + options;
                }
            } catch (err) {
                console.error('Error loading researchers:', err);
            }
        }

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');

        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileUploadArea.classList.add('has-file');
            } else {
                fileNameDisplay.textContent = '';
                fileUploadArea.classList.remove('has-file');
            }
        });

        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#2d5a87'; });
        fileUploadArea.addEventListener('dragleave', () => { fileUploadArea.style.borderColor = '#ddd'; });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = e.dataTransfer.files[0].name;
                fileUploadArea.classList.add('has-file');
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const researcherId = document.getElementById('uploadResearcher').value;
            const fileType = document.getElementById('fileType').value;
            const file = fileInput.files[0];

            if (!researcherId || !fileType || !file) {
                showMessage('uploadMessage', 'Please fill all fields', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('researcher_id', researcherId);
            formData.append('fileType', fileType);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('uploadMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('uploadMessage', `File uploaded: ${file.name}`, 'success');
                    document.getElementById('uploadForm').reset();
                    fileNameDisplay.textContent = '';
                    fileUploadArea.classList.remove('has-file');
                    loadPendingApprovals();
                    loadStats();
                }
            } catch (err) {
                showMessage('uploadMessage', 'Connection error', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
            }
        });

        // =====================================================
        // LABORATORY FILES TAB
        // =====================================================
        async function loadLabFiles() {
            const container = document.getElementById('labFilesTree');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

            try {
                const response = await fetch('/api/di/lab-files', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                labFilesData = data.files || [];

                // Populate year filter
                const years = [...new Set(labFilesData.map(f => new Date(f.created_at).getFullYear()))].sort((a, b) => b - a);
                document.getElementById('filterYear').innerHTML = '<option value="">All Years</option>' +
                    years.map(y => `<option value="${y}">${y}</option>`).join('');

                applyFilters();
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;">Error loading files</p>';
            }
        }

        async function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const year = document.getElementById('filterYear').value;
            const researcher = document.getElementById('filterResearcher').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            let filtered = labFilesData.filter(f => {
                if (status && f.status !== status) return false;
                if (year && new Date(f.created_at).getFullYear() !== parseInt(year)) return false;
                if (researcher && f.researcher_id !== researcher) return false;
                if (search && !f.original_filename.toLowerCase().includes(search)) return false;
                return true;
            });

            await renderLabFilesTree(filtered);
        }

        async function renderLabFilesTree(files) {
            const container = document.getElementById('labFilesTree');

            // Group by status, then year, then researcher
            const grouped = {};
            files.forEach(f => {
                const status = f.status || 'PENDING';
                const year = new Date(f.created_at).getFullYear();
                const researcher = f.researcher_id;

                if (!grouped[status]) grouped[status] = {};
                if (!grouped[status][year]) grouped[status][year] = {};
                if (!grouped[status][year][researcher]) grouped[status][year][researcher] = [];
                grouped[status][year][researcher].push(f);
            });

            let html = '';
            // No longer render REVISION_NEEDED from di_submissions (orphan rows)
            const statusOrder = ['PENDING', 'APPROVED'];

            statusOrder.forEach(status => {
                if (!grouped[status]) return;
                const statusLabel = status.charAt(0) + status.slice(1).toLowerCase();
                const statusClass = status === 'APPROVED' ? 'status-approved' : 'status-pending';

                html += `
                    <div class="tree-item tree-folder" onclick="toggleFolder(this)">
                        <span class="icon">&#128193;</span>
                        <span>${statusLabel}</span>
                        <span class="status-badge ${statusClass}" style="margin-left:8px;">${Object.values(grouped[status]).reduce((a, y) => a + Object.values(y).reduce((b, r) => b + r.length, 0), 0)}</span>
                    </div>
                    <div class="tree-children">
                `;

                Object.keys(grouped[status]).sort((a, b) => b - a).forEach(year => {
                    html += `
                        <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:20px;">
                            <span class="icon">&#128197;</span>
                            <span>${year}</span>
                        </div>
                        <div class="tree-children collapsed">
                    `;

                    Object.keys(grouped[status][year]).sort().forEach(researcher => {
                        const researcherFiles = grouped[status][year][researcher];
                        html += `
                            <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:40px;">
                                <span class="icon">&#128100;</span>
                                <span>${researcher}</span>
                                <span style="color:#999;font-size:11px;margin-left:8px;">(${researcherFiles.length})</span>
                            </div>
                            <div class="tree-children collapsed">
                        `;

                        researcherFiles.forEach(f => {
                            const hasFile = f.r2_object_key || f.drive_file_id;
                            html += `
                                <div class="tree-item tree-file" style="padding-left:60px;" data-file-id="${f.submission_id}">
                                    <input type="checkbox" class="file-checkbox" data-id="${f.submission_id}" onclick="toggleLabFileSelection(event, '${f.submission_id}')">
                                    <span class="icon">${f.status === 'APPROVED' ? '&#9989;' : '&#128196;'}</span>
                                    <span title="${escapeHtml(f.original_filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(f.original_filename)}</span>
                                    <div class="file-actions">
                                        ${hasFile ? `
                                            <button class="btn btn-sm btn-primary" onclick="viewFile('${f.submission_id}')">View</button>
                                            <button class="btn btn-sm btn-success" onclick="downloadFile('${f.submission_id}')">Download</button>
                                        ` : '<span style="color:#999;font-size:11px;">No file</span>'}
                                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.submission_id}', '${escapeHtml(f.original_filename)}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                    });

                    html += '</div>';
                });

                html += '</div>';
            });

            // Fetch open revision requests and render as "Revision Needed" section
            try {
                const rrResponse = await fetch('/api/di/revision-requests/all', { credentials: 'include' });
                if (rrResponse.ok) {
                    const rrData = await rrResponse.json();
                    const requests = rrData.requests || [];

                    // Apply current filters to revision requests
                    const filterYear = document.getElementById('filterYear').value;
                    const filterResearcher = document.getElementById('filterResearcher').value;
                    const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
                    const filterStatus = document.getElementById('filterStatus').value;

                    // Only show if no status filter or status filter is REVISION_NEEDED
                    if (!filterStatus || filterStatus === 'REVISION_NEEDED') {
                        const filteredRR = requests.filter(rr => {
                            if (filterYear && rr.year !== parseInt(filterYear)) return false;
                            if (filterResearcher && rr.researcher_id !== filterResearcher) return false;
                            if (filterSearch && !rr.filename.toLowerCase().includes(filterSearch)) return false;
                            return true;
                        });

                        if (filteredRR.length > 0) {
                            // Group by year, then researcher
                            const rrGrouped = {};
                            filteredRR.forEach(rr => {
                                if (!rrGrouped[rr.year]) rrGrouped[rr.year] = {};
                                if (!rrGrouped[rr.year][rr.researcher_id]) rrGrouped[rr.year][rr.researcher_id] = [];
                                rrGrouped[rr.year][rr.researcher_id].push(rr);
                            });

                            html += `
                                <div class="tree-item tree-folder" onclick="toggleFolder(this)">
                                    <span class="icon">&#128193;</span>
                                    <span>Revision Needed</span>
                                    <span class="status-badge status-revision" style="margin-left:8px;">${filteredRR.length}</span>
                                </div>
                                <div class="tree-children">
                            `;

                            Object.keys(rrGrouped).sort((a, b) => b - a).forEach(year => {
                                html += `
                                    <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:20px;">
                                        <span class="icon">&#128197;</span>
                                        <span>${year}</span>
                                    </div>
                                    <div class="tree-children collapsed">
                                `;

                                Object.keys(rrGrouped[year]).sort().forEach(researcher => {
                                    const researcherRRs = rrGrouped[year][researcher];
                                    html += `
                                        <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:40px;">
                                            <span class="icon">&#128100;</span>
                                            <span>${researcher}</span>
                                            <span style="color:#999;font-size:11px;margin-left:8px;">(${researcherRRs.length})</span>
                                        </div>
                                        <div class="tree-children collapsed">
                                    `;

                                    researcherRRs.forEach(rr => {
                                        html += `
                                            <div class="tree-item tree-file" style="padding-left:60px;" data-rr-id="${rr.id}">
                                                <span class="icon">&#128196;</span>
                                                <span title="${escapeHtml(rr.filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(rr.filename)}</span>
                                                <span class="type-badge" style="font-size:10px;margin-left:6px;padding:1px 5px;background:#e2e8f0;border-radius:3px;">${escapeHtml(rr.doc_type)}</span>
                                                <div class="file-actions">
                                                    <button class="btn btn-sm btn-secondary" onclick="toggleRevisionComment('${rr.id}')">Comments</button>
                                                    <button class="btn btn-sm btn-danger" onclick="cancelRevisionRequest('${rr.id}', '${escapeHtml(rr.filename)}')">Cancel</button>
                                                </div>
                                            </div>
                                            <div id="rr-comment-${rr.id}" style="display:none;padding:8px 12px 8px 60px;">
                                                <textarea id="rr-comment-text-${rr.id}" style="width:100%;min-height:60px;padding:6px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:12px;resize:vertical;">${escapeHtml(rr.pi_comment || '')}</textarea>
                                                <button class="btn btn-sm btn-primary" style="margin-top:4px;" onclick="saveRevisionComment('${rr.id}')">Save</button>
                                            </div>
                                        `;
                                    });

                                    html += '</div>';
                                });

                                html += '</div>';
                            });

                            html += '</div>';
                        }
                    }
                }
            } catch (err) {
                console.error('Error loading revision requests:', err);
            }

            if (!html) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No files match the filters</p>';
            } else {
                container.innerHTML = html;
            }
        }

        function toggleRevisionComment(id) {
            const el = document.getElementById('rr-comment-' + id);
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function saveRevisionComment(id) {
            const text = document.getElementById('rr-comment-text-' + id);
            if (!text) return;
            try {
                const response = await fetch('/api/di/revision-requests/' + id + '/comment', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: text.value }),
                    credentials: 'include'
                });
                if (response.ok) {
                    alert('Comment saved');
                } else {
                    alert('Failed to save comment');
                }
            } catch (err) {
                alert('Error saving comment');
            }
        }

        async function cancelRevisionRequest(id, filename) {
            if (!confirm('Cancel revision request for "' + filename + '"? This cannot be undone.')) return;
            try {
                const response = await fetch('/api/di/revision-requests/' + id + '/cancel', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    loadLabFiles();
                    loadStats();
                } else {
                    alert('Failed to cancel revision request');
                }
            } catch (err) {
                alert('Error cancelling revision request');
            }
        }

        function toggleFolder(element) {
            const children = element.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }

        function toggleLabFileSelection(event, fileId) {
            event.stopPropagation();
            if (selectedLabFiles.has(fileId)) {
                selectedLabFiles.delete(fileId);
            } else {
                selectedLabFiles.add(fileId);
            }
            updateLabBulkActions();
        }

        function updateLabBulkActions() {
            const bar = document.getElementById('labBulkActions');
            const count = document.getElementById('labSelectedCount');
            if (selectedLabFiles.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selectedLabFiles.size} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        function selectAllLabFiles() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => {
                cb.checked = true;
                selectedLabFiles.add(cb.dataset.id);
            });
            updateLabBulkActions();
        }

        function clearLabSelection() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => cb.checked = false);
            selectedLabFiles.clear();
            updateLabBulkActions();
        }

        async function bulkDownloadLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }

            try {
                const response = await fetch('/api/di/bulk-download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ submission_ids: Array.from(selectedLabFiles) }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lab-files.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    // Fallback to individual downloads
                    const ids = Array.from(selectedLabFiles);
                    for (let i = 0; i < ids.length; i++) {
                        setTimeout(() => {
                            const link = document.createElement('a');
                            link.href = `/api/di/download/${ids[i]}?download=true`;
                            link.download = '';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }, i * 500);
                    }
                }
            } catch (err) {
                alert('Error downloading files');
            }
        }

        async function bulkDeleteLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }
            if (!confirm(`Delete ${selectedLabFiles.size} file(s)? This cannot be undone.`)) return;

            let success = 0, fail = 0;
            for (const id of selectedLabFiles) {
                try {
                    const response = await fetch(`/api/di/submissions/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (response.ok) success++;
                    else fail++;
                } catch { fail++; }
            }

            alert(`Deleted ${success} file(s)${fail > 0 ? `, ${fail} failed` : ''}`);
            selectedLabFiles.clear();
            updateLabBulkActions();
            loadLabFiles();
            loadStats();
        }

        function downloadFile(id) {
            window.location.href = `/api/di/download/${id}?download=true`;
        }

        async function deleteFile(id, filename) {
            if (!confirm(`Delete "${filename}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/submissions/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('File deleted');
                    selectedLabFiles.delete(id);
                    updateLabBulkActions();
                    loadLabFiles();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete file');
                }
            } catch (err) {
                alert('Error deleting file');
            }
        }

        // =====================================================
        // DATA INTELLIGENCE CONSOLE (DIC)
        // =====================================================

        // IMPORTANT: This function is duplicated in server.js and pi-dashboard.html.
        // Any change MUST be applied to BOTH copies identically.
        // Server-side test cases validate correctness (see server.js parseNatlabFilename tests).
        function parseNatlabFilename(filename) {
            const NON_COMPLIANT = {
                parsed_date: null, parsed_initials: null, parsed_project: null,
                parsed_description: null, is_sop: false, is_compliant: false, raw: filename
            };
            const base = filename.replace(/\.[^.]+$/, '');
            const parts = base.split('_');
            if (parts.length < 4) return NON_COMPLIANT;
            const date = parts[0].trim();
            const initials = parts[1].trim();
            const slot2 = parts[2].trim();
            const slot3 = parts[3].trim();
            if (!date || !initials || !/^\d{4}-\d{2}-\d{2}$/.test(date) || !/^[A-Z]{2,4}$/.test(initials)) {
                return NON_COMPLIANT;
            }
            const is_sop = slot2 === 'SOP';
            const descTokens = parts.slice(3).map(t => t.trim()).filter(Boolean);
            const description = descTokens.join(' ').replace(/\s{2,}/g, ' ');
            if (is_sop) {
                if (!slot3) return NON_COMPLIANT;
                return {
                    parsed_date: date, parsed_initials: initials, parsed_project: slot3,
                    parsed_description: description, is_sop: true, is_compliant: true, raw: filename
                };
            }
            if (!slot2 || !slot3) return NON_COMPLIANT;
            return {
                parsed_date: date, parsed_initials: initials, parsed_project: slot2,
                parsed_description: description, is_sop: false, is_compliant: true, raw: filename
            };
        }

        let dicAllFiles = [], dicFilteredFiles = [], dicSelectedFileId = null;
        let dicCurrentScope = 'DATA';
        let dicFilters = { status: '', researcher: '', year: '', search: '', time: '', sort: 'newest', dragonSeal: false };
        let dicResearcherMetrics = {}, dicAssociationsCache = {};
        let dicMonthsUsed = 12;
        let dicLinkModalType = '';
        let dicReviseFileId = null;

        async function dicInit() {
            try {
                const [filesRes, metricsRes] = await Promise.all([
                    fetch(`/api/di/lab-files-enriched?months=${dicMonthsUsed}`, { credentials: 'include' }),
                    fetch('/api/di/researcher-file-metrics', { credentials: 'include' })
                ]);
                if (filesRes.ok) {
                    const fData = await filesRes.json();
                    dicAllFiles = fData.files || [];
                    dicMonthsUsed = fData.months_used || 12;
                    document.getElementById('dicMonthsLabel').textContent = `Showing last ${dicMonthsUsed} months`;
                }
                if (metricsRes.ok) {
                    const mData = await metricsRes.json();
                    dicResearcherMetrics = {};
                    (mData.metrics || []).forEach(m => { dicResearcherMetrics[m.researcher_id] = m; });
                }
            } catch (err) {
                console.error('DIC init error:', err);
            }
            dicRenderSidebar();
            dicApplyFilters();
        }

        function dicFormatResearcherName(name) {
            if (!name) return 'Unknown';
            const parts = name.trim().split(/\s+/);
            if (parts.length < 2) return name;
            return parts[0] + ' ' + parts[parts.length - 1][0] + '.';
        }

        function dicGetInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            return parts.map(p => p[0]).join('').toUpperCase().slice(0, 2);
        }

        function dicRenderSidebar() {
            // Status buckets
            const statusCounts = { '': 0, PENDING: 0, APPROVED: 0, REVISION_NEEDED: 0 };
            dicAllFiles.forEach(f => {
                statusCounts['']++;
                if (statusCounts[f.status] !== undefined) statusCounts[f.status]++;
            });
            const bucketsEl = document.getElementById('dicStatusBuckets');
            bucketsEl.innerHTML = [
                { key: '', label: 'All Files' },
                { key: 'PENDING', label: 'Pending' },
                { key: 'APPROVED', label: 'Approved' },
                { key: 'REVISION_NEEDED', label: 'Revision' }
            ].map(b => `<div class="dic-status-bucket${dicFilters.status === b.key ? ' active' : ''}" onclick="dicSetSidebarFilter('status','${b.key}')">
                <span>${b.label}</span><span class="dic-count">${statusCounts[b.key] || 0}</span>
            </div>`).join('');

            // Year list
            const years = new Set();
            dicAllFiles.forEach(f => {
                const yr = (f.created_at || '').substring(0, 4);
                if (yr) years.add(yr);
            });
            const sortedYears = [...years].sort().reverse();
            const yearEl = document.getElementById('dicYearList');
            yearEl.innerHTML = `<div class="dic-year-item${!dicFilters.year ? ' active' : ''}" onclick="dicSetSidebarFilter('year','')">All Years</div>` +
                sortedYears.map(y => `<div class="dic-year-item${dicFilters.year === y ? ' active' : ''}" onclick="dicSetSidebarFilter('year','${y}')">${y}</div>`).join('');

            // Researcher list
            const researchers = {};
            dicAllFiles.forEach(f => {
                if (!researchers[f.researcher_id]) {
                    researchers[f.researcher_id] = { id: f.researcher_id, name: f.researcher_name || f.researcher_id };
                }
            });
            const researcherList = Object.values(researchers).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            const resEl = document.getElementById('dicResearcherList');
            resEl.innerHTML = researcherList.map(r => `<div class="dic-researcher-item${dicFilters.researcher === r.id ? ' active' : ''}" onclick="dicSetSidebarFilter('researcher','${r.id}')">
                <div class="dic-researcher-avatar">${dicGetInitials(r.name)}</div>
                <span class="dic-researcher-name">${dicFormatResearcherName(r.name)}</span>
            </div>`).join('') || '<div style="font-size:12px;color:#9ca3af;padding:8px 10px;">No researchers</div>';
        }

        function dicSetSidebarFilter(key, val) {
            dicFilters[key] = val;
            if (key === 'researcher' && val) {
                dicCurrentScope = 'DATA';
                dicFilters.sort = 'newest';
                document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.toggle('active', p.dataset.scope === 'DATA'));
                document.querySelectorAll('.dic-chip[data-filter="sort"]').forEach(c => c.classList.toggle('active', c.dataset.val === 'newest'));
            }
            dicRenderSidebar();
            dicApplyFilters();
            if (key === 'researcher' && val) {
                dicRenderQuickMetrics(val);
                dicAutoSelectNewest();
            } else {
                document.getElementById('dicQuickMetrics').style.display = 'none';
            }
        }

        function dicSetScope(el) {
            dicCurrentScope = el.dataset.scope;
            document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            dicApplyFilters();
        }

        function dicSetChip(key, val) {
            if (key === 'status') {
                dicFilters.status = val;
                document.querySelectorAll('.dic-chip[data-filter="status"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            } else if (key === 'time') {
                dicFilters.time = val;
                document.querySelectorAll('.dic-chip[data-filter="time"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            } else if (key === 'sort') {
                dicFilters.sort = val;
                document.querySelectorAll('.dic-chip[data-filter="sort"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            }
            dicApplyFilters();
        }

        function dicToggleDragonSeal(el) {
            dicFilters.dragonSeal = !dicFilters.dragonSeal;
            el.classList.toggle('active', dicFilters.dragonSeal);
            dicApplyFilters();
        }

        function dicApplyFilters() {
            const search = (document.getElementById('dicSearchInput').value || '').toLowerCase();
            const now = new Date();

            dicFilteredFiles = dicAllFiles.filter(f => {
                if (dicCurrentScope && f.file_type !== dicCurrentScope) return false;
                if (dicFilters.status && f.status !== dicFilters.status) return false;
                if (dicFilters.researcher && f.researcher_id !== dicFilters.researcher) return false;
                if (dicFilters.year) {
                    const yr = (f.created_at || '').substring(0, 4);
                    if (yr !== dicFilters.year) return false;
                }
                if (search && !(f.original_filename || '').toLowerCase().includes(search)) return false;
                if (dicFilters.time) {
                    const days = parseInt(dicFilters.time);
                    const fileDate = new Date(f.created_at);
                    if ((now - fileDate) / (1000 * 60 * 60 * 24) > days) return false;
                }
                if (dicFilters.dragonSeal) {
                    if (!f.pi_dragon_seal) return false;
                }
                return true;
            });

            // Sort
            if (dicFilters.sort === 'newest') {
                dicFilteredFiles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (dicFilters.sort === 'oldest') {
                dicFilteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (dicFilters.sort === 'name') {
                dicFilteredFiles.sort((a, b) => (a.original_filename || '').localeCompare(b.original_filename || ''));
            }

            dicRenderResults();
        }

        function dicRenderResults() {
            const container = document.getElementById('dicResults');
            if (dicFilteredFiles.length === 0) {
                const resName = dicFilters.researcher ? dicFormatResearcherName(
                    (dicResearcherMetrics[dicFilters.researcher] || {}).researcher_name || dicFilters.researcher
                ) : '';
                let emptyHtml = '<div class="dic-empty-state">';
                if (dicFilters.researcher) {
                    const hasAnyFiles = dicAllFiles.some(f => f.researcher_id === dicFilters.researcher);
                    if (dicCurrentScope && !hasAnyFiles) {
                        emptyHtml += `<h3>No files found for ${resName} in the last ${dicMonthsUsed} months</h3>`;
                        emptyHtml += '<div class="dic-empty-actions">';
                        emptyHtml += `<button class="dic-empty-btn" onclick="dicShowAllMonths()">Show All Months</button>`;
                        emptyHtml += '</div>';
                    } else {
                        emptyHtml += `<h3>No ${dicCurrentScope || ''} files found for ${resName} in the last ${dicMonthsUsed} months</h3>`;
                        emptyHtml += '<div class="dic-empty-actions">';
                        emptyHtml += `<button class="dic-empty-btn" onclick="dicShowAllMonths()">Show All Months</button>`;
                        if (dicCurrentScope === 'DATA') {
                            emptyHtml += `<button class="dic-empty-btn" onclick="dicSwitchScope('PRESENTATION')">View Presentations</button>`;
                            emptyHtml += `<button class="dic-empty-btn" onclick="dicSwitchScope('SOP')">View SOPs</button>`;
                        }
                        emptyHtml += '</div>';
                    }
                } else {
                    emptyHtml += '<h3>Select a researcher or search to begin</h3>';
                }
                emptyHtml += '</div>';
                container.innerHTML = emptyHtml;
                return;
            }

            container.innerHTML = dicFilteredFiles.map(f => {
                const parsed = parseNatlabFilename(f.original_filename || '');
                const isActive = f.submission_id === dicSelectedFileId;
                const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');

                let typeClass = 'data';
                let typeLabel = 'DATA';
                if (f.file_type === 'SOP') { typeClass = 'sop'; typeLabel = 'SOP'; }
                else if (f.file_type === 'PRESENTATION') { typeClass = 'pres'; typeLabel = 'PRES'; }

                let title, subtitle;
                if (parsed.is_compliant) {
                    title = parsed.parsed_description;
                    subtitle = `${parsed.parsed_date} &middot; ${parsed.parsed_initials} &middot; ${parsed.parsed_project}`;
                } else {
                    title = f.original_filename;
                    subtitle = `${dicFormatResearcherName(f.researcher_name)} &middot; ${(f.created_at || '').substring(0, 10)}`;
                }

                let metaHtml = `<span class="dic-badge ${statusClass}">${statusLabel}</span>`;
                if (f.pi_dragon_seal) metaHtml += '<span class="dic-dragon-badge">&#x1F409;</span>';
                const sopCount = f.linked_sop_count || 0;
                const presCount = f.linked_pres_count || 0;
                if (sopCount > 0) metaHtml += `<span class="dic-assoc-chip">${sopCount} SOP</span>`;
                if (presCount > 0) metaHtml += `<span class="dic-assoc-chip">${presCount} PRES</span>`;

                return `<div class="dic-result-item${isActive ? ' active' : ''}" onclick="dicSelectFile('${f.submission_id}')">
                    <div class="dic-result-icon ${typeClass}">${typeLabel}</div>
                    <div class="dic-result-body">
                        <div class="dic-result-title" title="${(f.original_filename || '').replace(/"/g, '&quot;')}">${title}</div>
                        <div class="dic-result-sub">${subtitle}</div>
                        <div class="dic-result-meta">${metaHtml}</div>
                    </div>
                </div>`;
            }).join('');
        }

        function dicRenderQuickMetrics(researcherId) {
            const m = dicResearcherMetrics[researcherId];
            const el = document.getElementById('dicQuickMetrics');
            if (!m) { el.style.display = 'none'; return; }
            el.style.display = 'flex';
            const lastUpload = m.last_upload ? new Date(m.last_upload).toLocaleDateString() : 'N/A';
            el.innerHTML = [
                { v: m.data_count || 0, l: 'DATA' },
                { v: m.pres_count || 0, l: 'PRES' },
                { v: m.sop_count || 0, l: 'SOP' },
                { v: m.pending_count || 0, l: 'PENDING' },
                { v: lastUpload, l: 'LAST' }
            ].map(x => `<div class="dic-metric-box"><div class="dic-metric-value">${x.v}</div><div class="dic-metric-label">${x.l}</div></div>`).join('');
        }

        function dicAutoSelectNewest() {
            const first = dicFilteredFiles.find(f => f.file_type === 'DATA') || dicFilteredFiles[0];
            if (first) {
                dicSelectFile(first.submission_id);
            }
        }

        function dicBuildPdfViewerSrc(fileUrl) {
            const pdfjs = '/pdfjs/web/viewer.html';
            const fileParam = encodeURIComponent(fileUrl);
            return `${pdfjs}?file=${fileParam}#pagemode=none&zoom=page-width`;
        }

        function dicSelectFile(fileId) {
            dicSelectedFileId = fileId;
            const f = dicAllFiles.find(x => x.submission_id === fileId);
            if (!f) return;

            // Update results active state
            document.querySelectorAll('.dic-result-item').forEach(el => {
                el.classList.toggle('active', el.onclick && el.onclick.toString().includes(fileId));
            });
            dicRenderResults();

            // Toolbar
            const toolbar = document.getElementById('dicToolbar');
            const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');
            const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
            const dragonClass = f.pi_dragon_seal ? ' sealed' : '';
            let btns = '';
            if (f.status === 'PENDING') {
                btns += `<button class="dic-toolbar-btn approve" onclick="dicApproveFile('${f.submission_id}')">Approve</button>`;
                btns += `<button class="dic-toolbar-btn revise" onclick="dicOpenReviseModal('${f.submission_id}')">Revise</button>`;
            }
            btns += `<button class="dic-toolbar-dragon${dragonClass}" onclick="dicToggleDragonSealFile('${f.submission_id}')" title="Dragon Seal" aria-label="Toggle Dragon Seal">&#x1F409;</button>`;
            btns += `<button class="dic-toolbar-icon" style="background:#1f2937;" onclick="dicPresentationMode()" title="Presentation Mode" aria-label="Presentation Mode"><svg viewBox="0 0 24 24" width="20" height="20"><circle cx="12" cy="12" r="11" fill="#1f2937"/><rect x="7" y="8" width="10" height="8" rx="1.5" fill="#facc15"/><rect x="7" y="6" width="2" height="2" fill="#facc15"/><rect x="11" y="6" width="2" height="2" fill="#facc15"/><rect x="15" y="6" width="2" height="2" fill="#facc15"/><rect x="7" y="16" width="2" height="2" fill="#facc15"/><rect x="11" y="16" width="2" height="2" fill="#facc15"/><rect x="15" y="16" width="2" height="2" fill="#facc15"/></svg></button>`;
            btns += `<a class="dic-toolbar-icon" style="background:#000;" href="/api/di/download/${f.submission_id}" target="_blank" title="Download" aria-label="Download"><svg viewBox="0 0 20 20" fill="none"><path d="M10 3v10M10 13l-3.5-3.5M10 13l3.5-3.5M4 16h12" stroke="#fff" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a>`;
            toolbar.innerHTML = `<span class="dic-viewer-filename" title="${(f.original_filename || '').replace(/"/g, '&quot;')}">${f.original_filename}</span>
                <span class="dic-badge ${statusClass}">${statusLabel}</span>${btns}`;

            // PDF viewer â€” always route through PDF.js (no native browser PDF rendering)
            document.getElementById('dicViewerEmpty').style.display = 'none';
            const pdfEl = document.getElementById('dicViewerPdf');
            pdfEl.style.display = 'block';
            pdfEl.src = dicBuildPdfViewerSrc(`/api/di/download/${f.submission_id}`);

            // Intel panel
            document.getElementById('dicIntelPanel').style.display = 'block';
            dicLoadAssociations(fileId, f);
        }

        async function dicLoadAssociations(fileId, file) {
            const sopsEl = document.getElementById('dicIntelSops');
            const presEl = document.getElementById('dicIntelPres');
            sopsEl.innerHTML = '';
            presEl.innerHTML = '';

            try {
                const res = await fetch(`/api/di/file-associations/${fileId}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                dicAssociationsCache[fileId] = data;

                const manualSops = (data.manual || []).filter(m => m.link_type === 'SOP');
                const manualPres = (data.manual || []).filter(m => m.link_type === 'PRESENTATION');
                const heuristicSops = (data.heuristic_sop || []);
                const heuristicPres = (data.heuristic_pres || []);

                const sopTotal = manualSops.length + heuristicSops.length;
                const presTotal = manualPres.length + heuristicPres.length;
                document.getElementById('dicSopLabel').textContent = `SOPs (${manualSops.length})`;
                document.getElementById('dicPresLabel').textContent = `PRES (${manualPres.length})`;

                dicRenderIntelStrip(sopsEl, manualSops, heuristicSops, 'SOP');
                dicRenderIntelStrip(presEl, manualPres, heuristicPres, 'PRESENTATION');
            } catch (err) {
                sopsEl.innerHTML = '<span style="font-size:10px;color:#ef4444;">Error</span>';
                presEl.innerHTML = '<span style="font-size:10px;color:#ef4444;">Error</span>';
            }
        }

        function dicRenderIntelStrip(container, manual, heuristic, type) {
            let html = '';
            const maxItems = 2;
            let count = 0;

            manual.forEach(m => {
                if (count >= maxItems) return;
                const statusClass = (m.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = m.status === 'REVISION_NEEDED' ? 'REV' : (m.status || '').substring(0, 3);
                html += `<span class="dic-intel-chip" onclick="dicSelectFile('${m.target_id}')" title="${(m.original_filename || '').replace(/"/g, '&quot;')}">
                    ${dicTruncate(m.original_filename || '', 30)}
                    <span class="dic-badge ${statusClass}">${statusLabel}</span>
                    <span class="dic-intel-chip-remove" onclick="event.stopPropagation();dicUnlinkFile('${m.id}')">&times;</span>
                </span>`;
                count++;
            });

            heuristic.forEach(h => {
                if (count >= maxItems) return;
                html += `<span class="dic-intel-chip heuristic" onclick="dicQuickLink('${h.submission_id}','${type}')" title="Click to link: ${(h.filename || '').replace(/"/g, '&quot;')}">
                    ${dicTruncate(h.filename || '', 28)}
                    <span class="dic-intel-chip-score">${h.score}pt</span>
                </span>`;
                count++;
            });

            if (count === 0) {
                html = '<span style="font-size:10px;color:#9ca3af;">None</span>';
            }
            container.innerHTML = html;
        }

        function dicTruncate(str, max) {
            return str.length > max ? str.substring(0, max - 1) + '\u2026' : str;
        }

        function dicPresentationMode() {
            try {
                const iframe = document.getElementById('dicViewerPdf');
                if (iframe && iframe.contentWindow) {
                    const btn = iframe.contentDocument.getElementById('presentationMode');
                    if (btn) { btn.click(); return; }
                }
            } catch (e) { /* cross-origin fallback */ }
            const iframe2 = document.getElementById('dicViewerPdf');
            if (iframe2) iframe2.contentWindow.postMessage({ type: 'presentationMode' }, '*');
        }

        async function dicToggleDragonSealFile(id) {
            const f = dicAllFiles.find(x => x.submission_id === id);
            if (!f) return;
            const newVal = !f.pi_dragon_seal;
            try {
                const res = await fetch(`/api/di/documents/${id}/dragon-seal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: newVal })
                });
                const data = await res.json();
                if (data.success) {
                    f.pi_dragon_seal = data.pi_dragon_seal;
                    dicRenderResults();
                    dicSelectFile(id);
                } else {
                    alert(data.error || 'Failed to toggle Dragon Seal');
                }
            } catch (err) {
                alert('Error toggling Dragon Seal');
            }
        }

        async function dicApproveFile(id) {
            if (!confirm('Approve this file?')) return;
            try {
                const res = await fetch(`/api/di/approve-inline/${id}`, {
                    method: 'POST', credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    alert('File approved successfully.');
                    await dicInit();
                    dicSelectFile(id);
                } else {
                    alert(data.error || 'Approval failed');
                }
            } catch (err) {
                alert('Error approving file');
            }
        }

        function dicOpenReviseModal(id) {
            dicReviseFileId = id;
            document.getElementById('dicReviseText').value = '';
            document.getElementById('dicReviseModal').classList.add('active');
        }

        function dicCloseReviseModal() {
            document.getElementById('dicReviseModal').classList.remove('active');
            dicReviseFileId = null;
        }

        async function dicSubmitRevision() {
            const comments = document.getElementById('dicReviseText').value.trim();
            if (!comments) { alert('Please provide revision comments.'); return; }
            if (!dicReviseFileId) return;
            try {
                const res = await fetch(`/api/di/revise-inline/${dicReviseFileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ comments })
                });
                const data = await res.json();
                if (data.success) {
                    dicCloseReviseModal();
                    alert('Revision requested.');
                    await dicInit();
                } else {
                    alert(data.error || 'Revision failed');
                }
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        async function dicQuickLink(targetId, type) {
            if (!dicSelectedFileId) return;
            try {
                const res = await fetch('/api/di/file-associations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ source_id: dicSelectedFileId, target_id: targetId, link_type: type })
                });
                const data = await res.json();
                if (data.success) {
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to link');
                }
            } catch (err) {
                alert('Error linking file');
            }
        }

        async function dicUnlinkFile(assocId) {
            if (!confirm('Remove this link?')) return;
            try {
                const res = await fetch(`/api/di/file-associations/${assocId}`, {
                    method: 'DELETE', credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to unlink');
                }
            } catch (err) {
                alert('Error unlinking file');
            }
        }

        function dicOpenLinkModal(type) {
            dicLinkModalType = type;
            document.getElementById('dicLinkModalTitle').textContent = type === 'SOP' ? 'Link SOP' : 'Link Presentation';
            document.getElementById('dicLinkSearch').value = '';
            document.getElementById('dicLinkModal').classList.add('active');
            dicFilterLinkCandidates();
        }

        function dicCloseLinkModal() {
            document.getElementById('dicLinkModal').classList.remove('active');
        }

        function dicFilterLinkCandidates() {
            const search = (document.getElementById('dicLinkSearch').value || '').toLowerCase();
            const container = document.getElementById('dicLinkCandidates');
            const cached = dicAssociationsCache[dicSelectedFileId];
            const manualIds = new Set();
            if (cached && cached.manual) {
                cached.manual.filter(m => m.link_type === dicLinkModalType).forEach(m => manualIds.add(m.target_id));
            }

            const candidates = dicAllFiles.filter(f => {
                if (f.file_type !== dicLinkModalType) return false;
                if (f.submission_id === dicSelectedFileId) return false;
                if (search && !(f.original_filename || '').toLowerCase().includes(search)) return false;
                return true;
            });

            if (candidates.length === 0) {
                container.innerHTML = '<div style="font-size:12px;color:#9ca3af;text-align:center;padding:20px;">No candidates found</div>';
                return;
            }

            container.innerHTML = candidates.slice(0, 50).map(f => {
                const linked = manualIds.has(f.submission_id);
                const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = f.status === 'REVISION_NEEDED' ? 'REV' : (f.status || '').substring(0, 4);
                return `<div class="dic-modal-item${linked ? ' linked' : ''}" ${linked ? '' : `onclick="dicLinkFromModal('${f.submission_id}')"`}>
                    <span>${f.original_filename}</span>
                    <span class="dic-badge ${statusClass}">${statusLabel}</span>
                    ${linked ? '<span style="font-size:10px;color:#9ca3af;">linked</span>' : ''}
                </div>`;
            }).join('');
        }

        async function dicLinkFromModal(targetId) {
            if (!dicSelectedFileId) return;
            try {
                const res = await fetch('/api/di/file-associations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ source_id: dicSelectedFileId, target_id: targetId, link_type: dicLinkModalType })
                });
                const data = await res.json();
                if (data.success) {
                    dicCloseLinkModal();
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to link');
                }
            } catch (err) {
                alert('Error linking file');
            }
        }

        function dicShowAllMonths() {
            dicMonthsUsed = 60;
            dicInit();
        }

        function dicSwitchScope(scope) {
            dicCurrentScope = scope;
            document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.toggle('active', p.dataset.scope === scope));
            dicApplyFilters();
        }

        function toggleDicSidebar() {
            const sidebar = document.getElementById('dicSidebar');
            sidebar.classList.toggle('collapsed');
        }

        // =====================================================
        // GROUP DOCUMENTS TAB
        // =====================================================
        async function loadGroupDocuments() {
            const tbody = document.getElementById('groupDocsTableBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/group-documents', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.documents || data.documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;padding:20px;">No documents yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.documents.map(doc => {
                    const typeClass = doc.file_type.toLowerCase();
                    const date = new Date(doc.created_at).toLocaleDateString();
                    const canDownload = doc.can_download !== false;
                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(doc.title)}</strong>
                                ${doc.description ? '<br><small style="color:#666;">' + escapeHtml(doc.description) + '</small>' : ''}
                            </td>
                            <td>${escapeHtml(doc.category)}</td>
                            <td><span class="type-badge ${typeClass}">${doc.file_type}</span></td>
                            <td>${canDownload ? '<span style="color:#28a745;">Yes</span>' : '<span style="color:#999;">View only</span>'}</td>
                            <td>${date}</td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-sm btn-success" onclick="window.location.href='${doc.downloadUrl}'">Download</button>
                                    <button class="btn btn-sm btn-warning" onclick="editGroupDoc('${doc.id}', '${escapeHtml(doc.title)}', '${escapeHtml(doc.category)}', '${escapeHtml(doc.description || '')}', ${canDownload})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGroupDoc('${doc.id}', '${escapeHtml(doc.title)}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#dc3545;text-align:center;">Error loading documents</td></tr>';
            }
        }

        // Group document file upload
        const groupDocUploadArea = document.getElementById('groupDocUploadArea');
        const groupDocFileInput = document.getElementById('groupDocFile');
        const groupDocFileName = document.getElementById('groupDocFileName');

        groupDocUploadArea.addEventListener('click', () => groupDocFileInput.click());
        groupDocFileInput.addEventListener('change', () => {
            if (groupDocFileInput.files.length > 0) {
                groupDocFileName.textContent = groupDocFileInput.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            } else {
                groupDocFileName.textContent = '';
                groupDocUploadArea.classList.remove('has-file');
            }
        });

        groupDocUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); groupDocUploadArea.style.borderColor = '#2d5a87'; });
        groupDocUploadArea.addEventListener('dragleave', () => { groupDocUploadArea.style.borderColor = '#ddd'; });
        groupDocUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            groupDocUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                groupDocFileInput.files = e.dataTransfer.files;
                groupDocFileName.textContent = e.dataTransfer.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            }
        });

          // Training Design document file upload
          const trainDocUploadArea = document.getElementById('trainDocUploadArea');
          const trainDocFileInput = document.getElementById('trainDocFile');
          const trainDocFileName = document.getElementById('trainDocFileName');

          if (trainDocUploadArea && trainDocFileInput) {
              trainDocUploadArea.addEventListener('click', () => trainDocFileInput.click());
              trainDocFileInput.addEventListener('change', () => {
                  if (trainDocFileInput.files.length > 0) {
                      if (trainDocFileName) trainDocFileName.textContent = trainDocFileInput.files[0].name;
                      trainDocUploadArea.classList.add('has-file');
                  } else {
                      if (trainDocFileName) trainDocFileName.textContent = '';
                      trainDocUploadArea.classList.remove('has-file');
                  }
              });

              trainDocUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); trainDocUploadArea.style.borderColor = '#2d5a87'; });
              trainDocUploadArea.addEventListener('dragleave', () => { trainDocUploadArea.style.borderColor = '#ddd'; });
              trainDocUploadArea.addEventListener('drop', (e) => {
                  e.preventDefault();
                  trainDocUploadArea.style.borderColor = '#ddd';
                  if (e.dataTransfer.files.length > 0) {
                      trainDocFileInput.files = e.dataTransfer.files;
                      if (trainDocFileName) trainDocFileName.textContent = e.dataTransfer.files[0].name;
                      trainDocUploadArea.classList.add('has-file');
                  }
              });
          }

        document.getElementById('groupDocForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('docTitle').value.trim();
            const category = document.getElementById('docCategory').value;
            const description = document.getElementById('docDescription').value.trim();
            const canDownload = document.getElementById('docCanDownload').checked;
            const file = groupDocFileInput.files[0];

            if (!title || !category || !file) {
                showMessage('groupDocMessage', 'Please fill all required fields', 'error');
                return;
            }

            const submitBtn = document.getElementById('groupDocSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('title', title);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('can_download', canDownload);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/group-documents', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('groupDocMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('groupDocMessage', 'Document uploaded!', 'success');
                    document.getElementById('groupDocForm').reset();
                    groupDocFileName.textContent = '';
                    groupDocUploadArea.classList.remove('has-file');
                    loadGroupDocuments();
                }
            } catch (err) {
                showMessage('groupDocMessage', 'Connection error', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Document';
            }
        });

        async function editGroupDoc(id, title, category, description, canDownload) {
            const newTitle = prompt('Edit title:', title);
            if (newTitle === null) return;

            const newCategory = prompt('Edit category (SOP, Guidelines, Templates, Training, Forms, Other):', category);
            if (newCategory === null) return;

            const newDescription = prompt('Edit description:', description);
            if (newDescription === null) return;

            const newCanDownload = confirm('Allow researchers to download this document?');

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: newTitle,
                        category: newCategory,
                        description: newDescription,
                        can_download: newCanDownload
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document updated');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Update failed');
                }
            } catch (err) {
                alert('Error updating document');
            }
        }

        async function deleteGroupDoc(id, title) {
            if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document deleted');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Delete failed');
                }
            } catch (err) {
                alert('Error deleting document');
            }
        }

        // =====================================================
        // USER MANAGEMENT TAB
        // =====================================================
        async function loadAllUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/all-members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.members || data.members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#666;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.members.map(u => {
                    const roleClass = u.role === 'pi' ? 'pi' : (u.role === 'supervisor' ? 'supervisor' : 'researcher');
                    const statusClass = u.active ? 'status-active' : 'status-inactive';
                    const canResetPassword = u.active && u.role !== 'pi' && u.last_login;
                    return `
                        <tr>
                            <td>${escapeHtml(u.name || '-')}</td>
                            <td>${escapeHtml(u.institution_email || '-')}</td>
                            <td>${escapeHtml(u.researcher_id)}</td>
                            <td>${escapeHtml(u.affiliation)}</td>
                            <td><span class="role-badge ${roleClass}">${(u.role || 'researcher').toUpperCase()}</span></td>
                            <td><span class="status-badge ${statusClass}">${u.active ? 'Active' : 'Inactive'}</span></td>
                            <td>${u.submission_count || 0}</td>
                            <td>
                                <div class="actions">
                                    ${u.active ?
                                        `<button class="btn btn-sm btn-danger" onclick="deactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Deactivate</button>` :
                                        `<button class="btn btn-sm btn-success" onclick="reactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reactivate</button>`
                                    }
                                    ${canResetPassword ?
                                        `<button class="btn btn-sm btn-warning" onclick="resetUserPassword('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reset Password</button>` : ''
                                    }
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="color:#dc3545;text-align:center;">Error loading users</td></tr>';
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const affiliation = document.getElementById('newUserAffiliation').value;
            const role = document.getElementById('newUserRole').value;

            if (!name || !email || !affiliation || !role) {
                showMessage('addUserMessage', 'Please fill all fields', 'error');
                return;
            }

            const addBtn = document.getElementById('addUserBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/di/members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, institution_email: email, affiliation, role }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('addUserMessage', data.error || 'Failed to add user', 'error');
                } else {
                    showMessage('addUserMessage', `User added: ${data.researcher_id}`, 'success');
                    document.getElementById('addUserForm').reset();
                    loadAllUsers();
                    populateResearcherDropdown();
                }
            } catch (err) {
                showMessage('addUserMessage', 'Connection error', 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add User';
            }
        });

        async function deactivateUser(id, name) {
            // Check for active inventory items before confirming
            let warningMsg = `Deactivate user "${name}"? They will not be able to log in.`;
            try {
                const invResp = await fetch(`/api/di/inventory/check-user/${id}`, { credentials: 'include' });
                if (invResp.ok) {
                    const invData = await invResp.json();
                    if (invData.active_count > 0) {
                        warningMsg += `\n\nWARNING: This user has ${invData.active_count} active inventory item(s). These items will remain assigned but the user will not be able to manage them.`;
                    }
                }
            } catch (e) { /* non-blocking */ }

            if (!confirm(warningMsg)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/deactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User deactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to deactivate user');
                }
            } catch (err) {
                alert('Error deactivating user');
            }
        }

        async function reactivateUser(id, name) {
            if (!confirm(`Reactivate user "${name}"? All their previous data will be restored.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User reactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to reactivate user');
                }
            } catch (err) {
                alert('Error reactivating user');
            }
        }

        async function resetUserPassword(id, name) {
            if (!confirm(`Reset password for "${name}"?\n\nThey will be required to set a new password on their next login.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reset-password`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'Password reset flagged successfully');
                } else {
                    alert(data.error || 'Failed to reset password');
                }
            } catch (err) {
                alert('Error resetting password');
            }
        }

        // =====================================================
        // REPORTS TAB
        // =====================================================
        async function loadReportsData() {
            try {
                const response = await fetch('/api/di/metrics', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                // Update summary stats
                document.getElementById('reportTotalSubmissions').textContent = data.total || 0;
                document.getElementById('reportTotalResearchers').textContent = data.totalResearchers || 0;
                document.getElementById('reportThisMonth').textContent = data.thisMonth || 0;

                const approved = data.byStatus?.APPROVED || 0;
                const total = data.total || 1;
                document.getElementById('reportApprovalRate').textContent = Math.round((approved / total) * 100) + '%';

                // Status breakdown
                const statusBody = document.getElementById('statusBreakdownBody');
                statusBody.innerHTML = Object.entries(data.byStatus || {}).map(([status, count]) => {
                    const pct = Math.round((count / total) * 100);
                    const statusClass = status === 'APPROVED' ? 'status-approved' : status === 'REVISION_NEEDED' ? 'status-revision' : 'status-pending';
                    return `
                        <tr>
                            <td><span class="status-badge ${statusClass}">${status.replace('_', ' ')}</span></td>
                            <td>${count}</td>
                            <td>${pct}%</td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="3" style="text-align:center;color:#666;">No data</td></tr>';

                // Researcher breakdown
                const researcherBody = document.getElementById('researcherBreakdownBody');
                const topResearchers = (data.byResearcher || []).slice(0, 10);
                researcherBody.innerHTML = topResearchers.map(r => `
                    <tr>
                        <td>${escapeHtml(r.researcher_id)}</td>
                        <td>${r.total}</td>
                        <td>${r.approved || 0}</td>
                    </tr>
                `).join('') || '<tr><td colspan="3" style="text-align:center;color:#666;">No data</td></tr>';

            } catch (err) {
                console.error('Error loading reports:', err);
            }
        }

        async function exportToCSV() {
            const from = document.getElementById('exportFromDate').value;
            const to = document.getElementById('exportToDate').value;
            const status = document.getElementById('exportStatus').value;

            let url = '/api/di/reports/export?format=csv';
            if (from) url += `&from=${from}`;
            if (to) url += `&to=${to}`;
            if (status) url += `&status=${status}`;

            window.location.href = url;
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message show ${type}`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/di/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {}
            window.location.href = 'access.html';
        });

        // =====================================================
        // DELEGATION FUNCTIONS
        // =====================================================
        async function loadDelegationData() {
            try {
                // Load supervisors
                const supRes = await fetch('/api/di/delegation/supervisors', { credentials: 'include' });
                const supData = supRes.ok ? await supRes.json() : { supervisors: [] };
                const supervisorSelect = document.getElementById('supervisorSelect');
                supervisorSelect.innerHTML = '<option value="">Select supervisor...</option>' +
                    supData.supervisors.map(s => `<option value="${s.researcher_id}">${s.name} (${s.researcher_id})</option>`).join('');

                // Load all members for promote/demote and assign
                const memRes = await fetch('/api/di/all-members', { credentials: 'include' });
                const memData = memRes.ok ? await memRes.json() : { members: [] };
                const activeMembers = memData.members.filter(m => m.active);

                // Populate promote select (researchers and supervisors only)
                const promoteSelect = document.getElementById('promoteSelect');
                const promotable = activeMembers.filter(m => m.role === 'researcher' || m.role === 'supervisor');
                promoteSelect.innerHTML = '<option value="">Select a user...</option>' +
                    promotable.map(m => `<option value="${m.researcher_id}" data-role="${m.role}">${m.name} (${m.role.toUpperCase()})</option>`).join('');

                // Populate assign researcher select (non-supervisor, non-PI)
                const assignSelect = document.getElementById('assignResearcherSelect');
                const assignable = activeMembers.filter(m => m.role === 'researcher');
                assignSelect.innerHTML = '<option value="">Select researcher...</option>' +
                    assignable.map(m => `<option value="${m.researcher_id}">${m.name} (${m.researcher_id})</option>`).join('');

                // Load assignments
                const assRes = await fetch('/api/di/delegation/assignments', { credentials: 'include' });
                const assData = assRes.ok ? await assRes.json() : { assignments: [] };
                const tbody = document.getElementById('assignmentsTableBody');
                if (assData.assignments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No assignments yet</td></tr>';
                } else {
                    tbody.innerHTML = assData.assignments.map(a => `
                        <tr>
                            <td>${escapeHtml(a.supervisor_name || a.supervisor_id)}</td>
                            <td>${escapeHtml(a.researcher_name)} (${escapeHtml(a.researcher_id)})</td>
                            <td>${new Date(a.assigned_at).toLocaleDateString()}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="removeAssignment('${a.supervisor_id}','${a.researcher_id}')">Remove</button></td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load delegation data error:', err);
            }
        }

        async function promoteToSupervisor() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to promote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role === 'supervisor') { alert('User is already a supervisor'); return; }
            if (!confirm('Promote this researcher to supervisor?')) return;
            try {
                const res = await fetch('/api/di/delegation/promote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User promoted to supervisor', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function demoteToResearcher() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to demote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role !== 'supervisor') { alert('User is not a supervisor'); return; }
            if (!confirm('Demote this supervisor to researcher? All assignments will be removed.')) return;
            try {
                const res = await fetch('/api/di/delegation/demote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User demoted to researcher', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function assignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/assign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher assigned to supervisor', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function unassignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher unassigned', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function removeAssignment(supId, resId) {
            if (!confirm('Remove this assignment?')) return;
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                if (res.ok) {
                    showMessage('delegationMessage', 'Assignment removed', 'success');
                    loadDelegationData();
                }
            } catch (err) { console.error(err); }
        }

        // Load delegation data on page load
        loadDelegationData();

        // =====================================================
        // BACKUP & RECOVERY TAB
        // =====================================================
        document.querySelector('[data-tab="backup"]').addEventListener('click', () => {
            loadBackupSnapshots();
            dlReset();
        });

        async function loadBackupSnapshots() {
            const select = document.getElementById('backupSnapshotSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/di/backup/snapshots', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                if (!data.snapshots || data.snapshots.length === 0) {
                    select.innerHTML = '<option value="">No snapshots available</option>';
                    return;
                }
                select.innerHTML = '<option value="">Select a recovery point...</option>' +
                    data.snapshots.map(s =>
                        `<option value="${escapeHtml(s.path)}">[${escapeHtml(s.type)}] ${escapeHtml(s.label)}</option>`
                    ).join('');
            } catch (err) {
                select.innerHTML = '<option value="">Error loading snapshots</option>';
                console.error('Load snapshots error:', err);
            }
        }

        function clearBackupPreview() {
            document.getElementById('backupPreviewContainer').style.display = 'none';
            document.getElementById('backupRecoveryResult').style.display = 'none';
            document.getElementById('backupRecoveryProgress').style.display = 'none';
        }

        async function previewBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            if (!snapshot) { alert('Please select a recovery point first.'); return; }

            clearBackupPreview();
            showMessage('backupMessage', 'Loading preview...', 'info');

            try {
                const resp = await fetch('/api/di/backup/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot }),
                    credentials: 'include'
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Preview failed');
                }
                const data = await resp.json();

                document.getElementById('bkpBackupCount').textContent = data.backupFileCount;
                document.getElementById('bkpR2Count').textContent = data.r2FileCount;
                document.getElementById('bkpDiffCount').textContent = data.estimatedDifference;
                document.getElementById('backupSummaryText').textContent = data.summaryText;

                document.getElementById('backupPreviewContainer').style.display = 'block';
                document.getElementById('backupMessage').className = 'message';
            } catch (err) {
                showMessage('backupMessage', 'Preview error: ' + err.message, 'error');
            }
        }

        async function confirmBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            const mode = document.getElementById('backupRecoveryMode').value;
            if (!snapshot) { alert('No snapshot selected.'); return; }

            const modeLabel = mode === 'add-missing' ? 'ADD MISSING FILES ONLY' : 'FULL RESTORE (overwrites changed files)';
            if (!window.confirm('You are about to perform: ' + modeLabel + ' from snapshot "' + snapshot + '". Continue?')) return;

            if (mode === 'full-restore') {
                if (!window.confirm('FINAL WARNING: Full restore will overwrite files that differ in size. Are you sure?')) return;
            }

            document.getElementById('backupRecoverBtn').disabled = true;
            document.getElementById('backupRecoveryProgress').style.display = 'block';
            document.getElementById('backupRecoveryResult').style.display = 'none';

            try {
                const resp = await fetch('/api/di/backup/recover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot, mode, confirm: true }),
                    credentials: 'include'
                });
                const data = await resp.json();
                document.getElementById('backupRecoveryProgress').style.display = 'none';

                const resultEl = document.getElementById('backupRecoveryResult');
                if (data.success) {
                    resultEl.innerHTML =
                        '<div class="message success show" style="display:block;">' +
                        '<strong>Recovery Complete</strong><br>' +
                        'Processed: ' + data.processed + ' | Copied: ' + data.copied +
                        ' | Skipped: ' + data.skipped + ' | Failed: ' + data.failed +
                        (data.failed > 0 ? '<br><span style="color:#dc3545;">Some files failed. Check server logs.</span>' : '') +
                        '</div>';
                } else {
                    resultEl.innerHTML = '<div class="message error show" style="display:block;"><strong>Recovery Failed:</strong> ' + escapeHtml(data.error || 'Unknown error') + '</div>';
                }
                resultEl.style.display = 'block';
            } catch (err) {
                document.getElementById('backupRecoveryProgress').style.display = 'none';
                showMessage('backupMessage', 'Recovery request failed: ' + err.message, 'error');
            } finally {
                document.getElementById('backupRecoverBtn').disabled = false;
            }
        }

        // --- Download (R2 on-demand ZIP) ---
        const dlState = { flow: null, step: 0, researchers: [], selected: [],
            dateFrom: '', dateTo: '', estimate: null, downloadMode: 'single',
            maxBytes: 524288000, cursor: '', partNum: 0 };

        function dlReset() {
            dlState.flow = null; dlState.step = 0; dlState.selected = [];
            dlState.dateFrom = ''; dlState.dateTo = ''; dlState.estimate = null;
            dlState.cursor = ''; dlState.partNum = 0; dlState.downloadMode = 'single';
            document.getElementById('dlButtons').style.display = 'flex';
            document.getElementById('dlFlow').style.display = 'none';
            document.getElementById('dlProgress').style.display = 'none';
            document.getElementById('dlMessage').className = 'message';
            document.getElementById('dlMessage').innerHTML = '';
            document.getElementById('dlStepActions').innerHTML = '';
        }

        async function dlStartFlow(flow) {
            dlReset();
            dlState.flow = flow;
            document.getElementById('dlButtons').style.display = 'none';
            document.getElementById('dlFlow').style.display = 'block';
            const titles = { researcher: 'Download by Researcher', daterange: 'Download by Date Range', full: 'Full Data Download' };
            document.getElementById('dlFlowTitle').textContent = titles[flow];
            if (flow === 'researcher') { dlState.step = 1; await dlShowResearcherStep(); }
            else if (flow === 'daterange') { dlState.step = 1; dlShowDateRangeStep(); }
            else { dlState.step = 1; await dlShowEstimateStep(); }
        }

        async function dlShowResearcherStep() {
            const stepLabel = dlState.flow === 'daterange' ? 'Step 2 \u2014 Select Researchers' : 'Step 1 \u2014 Select Researchers';
            document.getElementById('dlStepLabel').textContent = stepLabel;
            const content = document.getElementById('dlStepContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading researchers...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                if (!dlState.researchers.length) {
                    const resp = await fetch('/api/di/backup/download/researchers', { credentials: 'include' });
                    if (!resp.ok) throw new Error((await resp.json()).error || 'Failed');
                    const data = await resp.json();
                    dlState.researchers = data.researchers || [];
                }
                if (dlState.flow === 'daterange' && dlState.selected.length === 0) {
                    dlState.selected = dlState.researchers.map(r => r.id);
                }
                dlRenderResearcherList('');
            } catch (err) {
                content.innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
            }
        }

        function dlRenderResearcherList(filter) {
            const list = dlState.researchers;
            const q = (filter || '').toLowerCase();
            const filtered = q ? list.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : list;
            let html = '<div style="display:flex;gap:8px;margin-bottom:10px;">' +
                '<input type="text" id="dlSearchBox" placeholder="Search researchers..." oninput="dlRenderResearcherList(this.value)" style="flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:6px;" value="' + escapeHtml(filter || '') + '">' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(true)">Select All</button>' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(false)">Clear All</button>' +
                '</div>';
            html += '<div style="max-height:280px;overflow-y:auto;border:1px solid #eee;border-radius:6px;padding:4px;">';
            if (filtered.length === 0) {
                html += '<div style="padding:20px;text-align:center;color:#999;">No researchers found</div>';
            } else {
                for (const r of filtered) {
                    const checked = dlState.selected.includes(r.id) ? 'checked' : '';
                    html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:6px;padding:5px 8px;cursor:pointer;border-bottom:1px solid #f5f5f5;">' +
                        '<input type="checkbox" value="' + escapeHtml(r.id) + '" ' + checked + ' onchange="dlToggleResearcher(\'' + escapeHtml(r.id) + '\', this.checked)">' +
                        '<span>' + escapeHtml(r.name) + '</span>' +
                        '<span style="color:#888;font-size:12px;margin-left:auto;">' + escapeHtml(r.affiliation) + ' &middot; ' + r.files + ' files</span>' +
                        '</label>';
                }
            }
            html += '</div>';
            html += '<div style="margin-top:6px;color:#888;font-size:12px;" id="dlSelCount">' + dlState.selected.length + ' of ' + list.length + ' selected</div>';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlResearcherNext()">Next</button>';
        }

        function dlToggleResearcher(id, checked) {
            if (checked && !dlState.selected.includes(id)) dlState.selected.push(id);
            else if (!checked) dlState.selected = dlState.selected.filter(x => x !== id);
            const el = document.getElementById('dlSelCount');
            if (el) el.textContent = dlState.selected.length + ' of ' + dlState.researchers.length + ' selected';
        }

        function dlSelectAll(select) {
            const q = (document.getElementById('dlSearchBox')?.value || '').toLowerCase();
            const visible = q ? dlState.researchers.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : dlState.researchers;
            if (select) {
                for (const r of visible) { if (!dlState.selected.includes(r.id)) dlState.selected.push(r.id); }
            } else {
                const ids = new Set(visible.map(r => r.id));
                dlState.selected = dlState.selected.filter(id => !ids.has(id));
            }
            dlRenderResearcherList(document.getElementById('dlSearchBox')?.value || '');
        }

        async function dlResearcherNext() {
            if (dlState.selected.length === 0) { alert('Please select at least one researcher.'); return; }
            await dlShowEstimateStep();
        }

        function dlShowDateRangeStep() {
            document.getElementById('dlStepLabel').textContent = 'Step 1 \u2014 Date Range';
            const today = new Date().toISOString().slice(0, 10);
            const ago30 = new Date(Date.now() - 30 * 86400000).toISOString().slice(0, 10);
            document.getElementById('dlStepContent').innerHTML =
                '<div style="display:flex;gap:15px;flex-wrap:wrap;align-items:end;">' +
                '<div class="form-group" style="margin:0;"><label>From</label>' +
                '<input type="date" id="dlDateFrom" value="' + ago30 + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '<div class="form-group" style="margin:0;"><label>To</label>' +
                '<input type="date" id="dlDateTo" value="' + today + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '</div>';
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlDateRangeNext()">Next</button>';
        }

        async function dlDateRangeNext() {
            const from = document.getElementById('dlDateFrom').value;
            const to = document.getElementById('dlDateTo').value;
            if (!from || !to) { alert('Please select both dates.'); return; }
            if (from > to) { alert('"From" date must be before "To" date.'); return; }
            dlState.dateFrom = from;
            dlState.dateTo = to;
            dlState.step = 2;
            await dlShowResearcherStep();
        }

        async function dlShowEstimateStep() {
            const stepNum = dlState.flow === 'daterange' ? 3 : (dlState.flow === 'researcher' ? 2 : 1);
            document.getElementById('dlStepLabel').textContent = 'Step ' + stepNum + ' \u2014 Estimate & Download';
            document.getElementById('dlStepContent').innerHTML = '<div class="loading"><div class="spinner"></div>Estimating selection...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                const resp = await fetch('/api/di/backup/download/estimate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) throw new Error((await resp.json()).error || 'Estimate failed');
                dlState.estimate = await resp.json();
                dlRenderEstimate();
            } catch (err) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function dlSetMode(mode) {
            dlState.downloadMode = mode;
            const el = document.getElementById('dlChunkSize');
            if (el) el.style.display = mode === 'multi' ? '' : 'none';
        }

        function dlRenderEstimate() {
            const est = dlState.estimate;
            if (!est || est.fileCount === 0) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message info show" style="display:block;">No files match your selection.</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
                return;
            }
            let html = '<div class="stats-row" style="margin-bottom:15px;">' +
                '<div class="stat-card"><div class="stat-value">' + est.fileCount + '</div><div class="stat-label">Files</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + formatFileSize(est.totalBytes) + '</div><div class="stat-label">Total Size</div></div>' +
                '</div>';
            html += '<div class="form-group"><label>Download Mode</label><div id="dlModeRow" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">';
            if (est.singleZipAvailable) {
                html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;background:#f0f7ff;">' +
                    '<input type="radio" name="dlMode" value="single" checked onchange="dlSetMode(\'single\')"> Single ZIP download' +
                    (est.recommendedMode === 'single' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                    '</label>';
            }
            html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;' +
                (!est.singleZipAvailable ? 'background:#f0f7ff;' : '') + '">' +
                '<input type="radio" name="dlMode" value="multi" ' + (!est.singleZipAvailable ? 'checked' : '') + ' onchange="dlSetMode(\'multi\')"> Multi-file download' +
                (est.recommendedMode === 'multi' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                '</label>';
            html += '<div id="dlChunkSize" style="' + (est.singleZipAvailable ? 'display:none;' : '') + 'margin-left:28px;margin:0;">' +
                '<label style="font-size:13px;color:#666;">Chunk size: </label>' +
                '<select id="dlChunkSelect" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;" onchange="dlState.maxBytes=Number(this.value)">' +
                '<option value="262144000">250 MB</option>' +
                '<option value="524288000" selected>500 MB (Recommended)</option>' +
                '<option value="1073741824">1 GB</option>' +
                '</select></div>';
            html += '</div></div>';
            dlState.downloadMode = est.singleZipAvailable ? 'single' : 'multi';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlStartDownload()">Download</button>';
        }

        async function dlStartDownload() {
            if (!dlState.estimate) return;
            dlState.cursor = ''; dlState.partNum = 0;
            document.getElementById('dlStepActions').innerHTML = '';
            await dlDownloadPart(dlState.downloadMode === 'multi');
        }

        async function dlDownloadPart(isMulti) {
            dlState.partNum++;
            const progEl = document.getElementById('dlProgress');
            progEl.style.display = 'block';
            progEl.innerHTML = '<div class="loading"><div class="spinner"></div>Downloading' +
                (isMulti ? ' Part ' + dlState.partNum : '') + '... This may take a while.</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                if (isMulti) body.maxBytes = dlState.maxBytes;
                if (dlState.cursor) body.cursor = dlState.cursor;

                const resp = await fetch('/api/di/backup/download/zip', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) {
                    let errMsg = 'Download failed';
                    try { errMsg = (await resp.json()).error || errMsg; } catch(e) {}
                    throw new Error(errMsg);
                }
                const nextCursor = resp.headers.get('X-Next-Cursor') || '';
                const fileCount = resp.headers.get('X-File-Count') || '?';
                const blob = await resp.blob();
                const cd = resp.headers.get('Content-Disposition') || '';
                const fnMatch = cd.match(/filename="(.+?)"/);
                const filename = fnMatch ? fnMatch[1] : 'download.zip';
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 120000);

                dlState.cursor = nextCursor;
                if (isMulti && nextCursor) {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Part ' + dlState.partNum + ' downloaded</strong> (' + fileCount + ' files).<br>More data available.</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-primary" onclick="dlDownloadPart(true)">Download Part ' + (dlState.partNum + 1) + '</button>' +
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                } else {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Download complete</strong> (' + fileCount + ' files).</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                }
            } catch (err) {
                progEl.innerHTML = '<div class="message error show" style="display:block;">Download error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML =
                    '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
        }

        // =====================================================
        // PURCHASE REQUESTS (PI)
        // =====================================================

        async function loadAllPurchaseRequests() {
            const tbody = document.getElementById('prAllTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                let requests = data.requests || [];

                const statusFilter = document.getElementById('prFilterStatus').value;
                if (statusFilter) requests = requests.filter(r => r.status === statusFilter);

                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">No purchase requests found</td></tr>';
                    return;
                }

                const statusColors = { SUBMITTED: '#007bff', APPROVED: '#28a745', DECLINED: '#fd7e14' };
                tbody.innerHTML = requests.map(r => {
                    const items = r.items || [];
                    const itemNames = items.map(i => i.product_name).join(', ');
                    return `<tr>
                        <td style="white-space:nowrap;">${new Date(r.created_at).toLocaleDateString()}</td>
                        <td>${escapeHtml(r.requester_name || r.requester_id)}</td>
                        <td>${escapeHtml(r.affiliation)}</td>
                        <td title="${escapeHtml(r.justification)}" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(r.justification)}</td>
                        <td title="${escapeHtml(itemNames)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${items.length} item${items.length>1?'s':''}</td>
                        <td style="white-space:nowrap;font-weight:600;">${Number(r.request_total).toFixed(2)} ${escapeHtml(r.currency)}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[r.status]||'#666'};">${r.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showPrDetail('${r.id}')">Review</button></td>
                    </tr>`;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#dc3545;">Error loading requests</td></tr>';
            }
        }

        let prAllData = [];
        async function showPrDetail(requestId) {
            // Fetch fresh data
            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                prAllData = data.requests || [];
            } catch (err) { return; }

            const req = prAllData.find(r => r.id === requestId);
            if (!req) return;

            document.getElementById('prDetailPanel').style.display = 'block';
            document.getElementById('prDetailTitle').textContent = `Request from ${req.requester_name || req.requester_id} (${req.affiliation})`;
            document.getElementById('prDetailJustification').innerHTML = `<strong>Justification:</strong> ${escapeHtml(req.justification)}`;
            document.getElementById('prDetailTotal').textContent = `${Number(req.request_total).toFixed(2)} ${escapeHtml(req.currency)}`;

            const items = req.items || [];
            const tbody = document.getElementById('prDetailItemsBody');
            tbody.innerHTML = items.map(i => {
                const orderedLabel = i.ordered_at ? `<span style="color:#28a745;" title="${new Date(i.ordered_at).toLocaleDateString()}">Yes</span>` : '<span style="color:#999;">No</span>';
                const markOrderedBtn = (req.status === 'APPROVED' && !i.ordered_at)
                    ? `<button class="btn btn-sm btn-secondary" onclick="markItemOrdered('${i.id}','${requestId}')">Mark Ordered</button>`
                    : '';
                return `<tr>
                    <td>${escapeHtml(i.vendor_company)}</td>
                    <td>${escapeHtml(i.product_name)}</td>
                    <td>${escapeHtml(i.catalog_id)}</td>
                    <td>${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank" style="font-size:11px;">Link</a>' : ''}</td>
                    <td>${i.quantity}</td>
                    <td>${Number(i.unit_price).toFixed(2)}</td>
                    <td style="font-weight:600;">${Number(i.item_total).toFixed(2)}</td>
                    <td>${orderedLabel}</td>
                    <td>${markOrderedBtn}</td>
                </tr>`;
            }).join('');

            const actionsEl = document.getElementById('prDetailActions');
            if (req.status === 'SUBMITTED') {
                actionsEl.innerHTML = `
                    <button class="btn btn-success" onclick="approvePurchaseRequest('${requestId}')">Approve</button>
                    <button class="btn" style="background:#fd7e14;color:#fff;" onclick="declinePurchaseRequest('${requestId}')">Decline</button>
                `;
            } else if (req.status === 'DECLINED' && req.pi_comment) {
                actionsEl.innerHTML = `<div style="color:#856404;font-size:13px;"><strong>Declined:</strong> ${escapeHtml(req.pi_comment)}</div>`;
            } else {
                actionsEl.innerHTML = '';
            }
        }

        function closePrDetail() {
            document.getElementById('prDetailPanel').style.display = 'none';
        }

        async function approvePurchaseRequest(requestId) {
            if (!confirm('Approve this purchase request?')) return;
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/approve`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request approved.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function declinePurchaseRequest(requestId) {
            const comment = prompt('Enter reason for declining (required):');
            if (comment === null) return;
            if (!comment.trim()) { alert('A comment is required when declining.'); return; }
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/decline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pi_comment: comment }),
                    credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request declined.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function markItemOrdered(itemId, requestId) {
            try {
                const resp = await fetch(`/api/di/purchases/item/${itemId}/mark-ordered`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                showPrDetail(requestId);
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // CONSOLIDATED EMAIL
        // =====================================================

        let consolidatedEmailText = '';

        async function loadConsolidatedEmail(affiliation) {
            const area = document.getElementById('prConsolidatedArea');
            const emptyEl = document.getElementById('prConsolidatedEmpty');
            area.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const resp = await fetch(`/api/di/purchases/consolidated?affiliation=${affiliation}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];

                if (items.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                const subject = `NATLAB purchase request (${affiliation})`;
                let body = `Hi,\n\nPlease find below the products that have been approved and need to be ordered as soon as possible.\n\nThank you,\nBest,\nFrank\n\n`;

                items.forEach(i => {
                    body += `- Vendor: ${i.vendor_company}\n`;
                    body += `  Product name: ${i.product_name}\n`;
                    body += `  Catalog ID: ${i.catalog_id}\n`;
                    body += `  Quantity: ${i.quantity}\n`;
                    body += `  Unit price: ${Number(i.unit_price).toFixed(2)} ${i.currency}\n`;
                    body += `  Item total: ${Number(i.item_total).toFixed(2)} ${i.currency}\n`;
                    body += `  Product link: ${i.product_link}\n`;
                    body += `  Requested by: ${i.requester_name || i.requester_id}\n`;
                    body += `  Request ID: ${i.request_id.substring(0, 8)}\n\n`;
                });

                body += `---\nTotal: ${data.total.toFixed(2)} ${data.currency}`;

                consolidatedEmailText = `Subject: ${subject}\n\n${body}`;
                document.getElementById('prConsolidatedTitle').textContent = subject;
                document.getElementById('prConsolidatedText').textContent = consolidatedEmailText;
                area.style.display = 'block';
            } catch (err) {
                alert('Error loading consolidated data: ' + err.message);
            }
        }

        function copyConsolidatedEmail() {
            navigator.clipboard.writeText(consolidatedEmailText).then(() => {
                const btn = document.querySelector('#prConsolidatedArea .btn-success');
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 2000);
            }).catch(() => {
                // Fallback: select text
                const pre = document.getElementById('prConsolidatedText');
                const range = document.createRange();
                range.selectNodeContents(pre);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            });
        }

        // =====================================================
        // PURCHASES & INVENTORY TAB (V2 â€” CANONICAL MODEL)
        // =====================================================

        // PO Numbers
        let poData = [];
        async function loadPONumbers() {
            const tbody = document.getElementById('poTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';
            try {
                const resp = await fetch('/api/di/inventory-v2/po-numbers', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                poData = data.items || [];
                renderPOTable(poData);
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#dc3545;">Error loading PO numbers</td></tr>';
            }
        }

        function searchPONumbers() {
            const q = document.getElementById('poSearchInput').value.toLowerCase().trim();
            if (!q) { renderPOTable(poData); return; }
            renderPOTable(poData.filter(i =>
                (i.internal_order_number || '').toLowerCase().includes(q) ||
                (i.product_name || '').toLowerCase().includes(q) ||
                (i.requester_name || '').toLowerCase().includes(q) ||
                (i.requester_id || '').toLowerCase().includes(q)
            ));
        }

        function renderPOTable(items) {
            const tbody = document.getElementById('poTableBody');
            if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No PO numbers found</td></tr>'; return; }
            tbody.innerHTML = items.map(i => `<tr>
                <td>${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank">'+escapeHtml(i.product_name)+'</a>' : escapeHtml(i.product_name)}</td>
                <td>${escapeHtml(i.requester_name || i.requester_id)}</td>
                <td>${i.ordered_at ? new Date(i.ordered_at).toLocaleDateString() : '-'}</td>
                <td style="font-weight:600;color:#0c5460;">${escapeHtml(i.internal_order_number)}</td>
                <td>${i.received_at ? '<span style="color:#28a745;">Received</span>' : '<span style="color:#999;">Pending</span>'}</td>
            </tr>`).join('');
        }

        // Inventory Management V2
        async function loadAllInventoryV2() {
            const tbody = document.getElementById('invV2AllTableBody');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            const params = new URLSearchParams();
            const type = document.getElementById('invV2FilterType').value;
            const aff = document.getElementById('invV2FilterAffiliation').value;
            const vis = document.getElementById('invV2FilterVisibility').value;
            const status = document.getElementById('invV2FilterStatus').value;
            const source = document.getElementById('invV2FilterSource').value;
            if (type) params.set('item_type', type);
            if (aff) params.set('affiliation', aff);
            if (vis) params.set('visibility_scope', vis);
            if (status) params.set('status', status);
            if (source) params.set('source', source);

            try {
                const resp = await fetch('/api/di/inventory-v2/all?' + params.toString(), { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];
                if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#999;">No inventory items found</td></tr>'; return; }

                const statusColors = { Pending: '#ffc107', Approved: '#28a745', Revision: '#fd7e14', Rejected: '#dc3545', Received: '#17a2b8', ConsumePending: '#fd7e14', TransferPending: '#6f42c1', ApprovedLinked: '#20c997', Consumed: '#6c757d', DeletePending: '#e83e8c', Deleted: '#6c757d' };
                tbody.innerHTML = items.map(i => {
                    let actions = '';
                    if ((i.status === 'Pending' || i.status === 'Revision') && i.source === 'Offline') {
                        // Offline pending: approve-as-new, show duplicates, reject
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveAsNew('${i.id}')" title="Approve as New">&#10003; New</button> `;
                        actions += `<button class="btn btn-sm btn-info" style="color:#fff;" onclick="piShowDuplicates('${i.id}')" title="Show Duplicates">&#128269; Dup</button> `;
                        actions += `<button class="btn btn-sm btn-warning" onclick="piRevisionItem('${i.id}')" title="Revision">&#8635;</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectItem('${i.id}')" title="Reject">&#10007;</button> `;
                    } else if (i.status === 'Pending' || i.status === 'Revision') {
                        // Online pending: existing approve/revision/reject
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveItem('${i.id}')" title="Approve">&#10003;</button> `;
                        actions += `<button class="btn btn-sm btn-warning" onclick="piRevisionItem('${i.id}')" title="Revision">&#8635;</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectItem('${i.id}')" title="Reject">&#10007;</button> `;
                    }
                    if (i.status === 'ConsumePending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveConsume('${i.id}')" title="Approve Consume">&#10003; Consume</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectConsume('${i.id}')" title="Reject Consume">&#10007; Consume</button> `;
                    }
                    if (i.status === 'TransferPending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveTransfer('${i.id}')" title="Approve Transfer">&#10003; Transfer</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectTransfer('${i.id}')" title="Reject Transfer">&#10007; Transfer</button> `;
                    }
                    if (i.status === 'DeletePending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveDelete('${i.id}')" title="Approve Delete">&#10003; Delete</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectDelete('${i.id}')" title="Reject Delete">&#10007; Delete</button> `;
                        if (i.delete_reason) actions += `<br><small style="color:#856404;">Reason: ${escapeHtml(i.delete_reason)}${i.delete_reason_detail ? ' â€” '+escapeHtml(i.delete_reason_detail) : ''}</small>`;
                    }
                    if (i.status === 'Approved' && i.visibility_scope === 'personal') {
                        actions += `<button class="btn btn-sm btn-primary" onclick="piPromoteToGroup('${i.id}')" title="Promote to Group">&#8593; Group</button>`;
                    }
                    if (i.status === 'Approved' && i.visibility_scope === 'group') {
                        actions += `<button class="btn btn-sm btn-secondary" onclick="piDemoteFromGroup('${i.id}')" title="Remove from Group">&#8595; Personal</button>`;
                    }
                    return `<tr>
                        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(i.item_name)}">${escapeHtml(i.item_name)}</td>
                        <td>${escapeHtml(i.item_type)}</td>
                        <td>${escapeHtml(i.item_identifier)}</td>
                        <td>${escapeHtml(i.affiliation)}</td>
                        <td>${escapeHtml(i.created_by_name || i.created_by)}</td>
                        <td>${i.quantity}</td>
                        <td>${escapeHtml(i.quantity_unit)}</td>
                        <td>${escapeHtml(i.storage_temperature)}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[i.status]||'#666'};">${i.status}</span>${i.status_comment ? '<br><small style="color:#856404;">'+escapeHtml(i.status_comment)+'</small>' : ''}</td>
                        <td style="font-size:11px;">${i.visibility_scope === 'group' ? '<strong style="color:#0c5460;">Group</strong>' : 'Personal'}</td>
                        <td style="white-space:nowrap;">${actions}</td>
                    </tr>`;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#dc3545;">Error loading inventory</td></tr>';
            }
        }

        async function piApproveItem(id) {
            if (!confirm('Approve this inventory item?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRevisionItem(id) {
            const comment = prompt('Enter revision comment for the researcher:');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/revision`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectItem(id) {
            const comment = prompt('Enter rejection reason (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piPromoteToGroup(id) {
            if (!confirm('Promote this item to Group Inventory?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/promote-to-group`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piDemoteFromGroup(id) {
            if (!confirm('Remove this item from Group Inventory? It will return to personal scope.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/demote-from-group`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        // ==================== INVENTORY RULES â€” NEW PI FUNCTIONS ====================

        async function piApproveConsume(id) {
            if (!confirm('Approve consume request? Item will be marked as Consumed.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-consume`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectConsume(id) {
            const comment = prompt('Rejection reason for consume request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-consume`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveTransfer(id) {
            if (!confirm('Approve transfer to Group Inventory?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-transfer`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectTransfer(id) {
            const comment = prompt('Rejection reason for transfer request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-transfer`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveDelete(id) {
            if (!confirm('Approve deletion? Item will be permanently removed from active inventory.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-delete`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectDelete(id) {
            const comment = prompt('Rejection reason for delete request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveAsNew(id) {
            if (!confirm('Approve this offline item as a NEW Group Inventory entry?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-as-new`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveAsDuplicate(itemId, dupId) {
            if (!confirm('Link this item to the selected group inventory record as a duplicate?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${itemId}/approve-as-duplicate`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duplicate_of_inventory_id: dupId }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                // Remove the suggestions row
                const sugRow = document.getElementById('dup-suggestions-' + itemId);
                if (sugRow) sugRow.remove();
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piShowDuplicates(id) {
            // Toggle: if suggestions row already exists, remove it
            const existingRow = document.getElementById('dup-suggestions-' + id);
            if (existingRow) { existingRow.remove(); return; }

            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/duplicate-suggestions`, { credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                const data = await resp.json();
                const suggestions = data.suggestions || [];

                // Find the row for this item and insert after it
                const tbody = document.getElementById('invV2AllTableBody');
                const rows = tbody.querySelectorAll('tr');
                let targetRow = null;
                for (const row of rows) {
                    if (row.innerHTML.includes(id)) { targetRow = row; break; }
                }
                if (!targetRow) return;

                const sugRow = document.createElement('tr');
                sugRow.id = 'dup-suggestions-' + id;
                sugRow.style.background = '#f8f9fa';

                if (suggestions.length === 0) {
                    sugRow.innerHTML = '<td colspan="11" style="padding:12px;text-align:center;color:#999;font-style:italic;">No duplicate suggestions found in Group Inventory.</td>';
                } else {
                    let html = '<td colspan="11" style="padding:12px;"><strong style="font-size:12px;">Duplicate Suggestions (up to 5):</strong><table style="width:100%;font-size:12px;border-collapse:collapse;margin-top:6px;"><thead><tr style="color:#666;"><th style="padding:4px 8px;text-align:left;">Name</th><th style="padding:4px 8px;text-align:left;">Vendor</th><th style="padding:4px 8px;text-align:left;">Catalog ID</th><th style="padding:4px 8px;text-align:left;">Location</th><th style="padding:4px 8px;text-align:left;">Lot/Batch</th><th style="padding:4px 8px;text-align:left;">Match</th><th style="padding:4px 8px;">Action</th></tr></thead><tbody>';
                    suggestions.forEach(s => {
                        html += `<tr>
                            <td style="padding:4px 8px;">${escapeHtml(s.item_name)}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.vendor_company || '')}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.item_identifier || '')}</td>
                            <td style="padding:4px 8px;background:#fff3cd;font-weight:600;">${escapeHtml(s.storage_location || '')}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.lot_or_batch_number || '')}</td>
                            <td style="padding:4px 8px;font-size:10px;color:#666;">${escapeHtml(s.match_type)}</td>
                            <td style="padding:4px 8px;text-align:center;"><button class="btn btn-sm btn-primary" onclick="piApproveAsDuplicate('${id}','${s.id}')">Link</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table></td>';
                    sugRow.innerHTML = html;
                }

                targetRow.after(sugRow);
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // TRAINING & APPROVALS
        // =====================================================
        function showTrainingToggle(view) {
            document.getElementById('trainingDesignView').style.display = view === 'design' ? 'block' : 'none';
            document.getElementById('trainingMgmtView').style.display = view === 'management' ? 'block' : 'none';
            document.getElementById('trainingCertsView').style.display = view === 'certifications' ? 'block' : 'none';
            document.getElementById('toggleTrainingDesign').className = 'btn ' + (view === 'design' ? 'btn-primary' : 'btn-secondary');
            document.getElementById('toggleTrainingMgmt').className = 'btn ' + (view === 'management' ? 'btn-primary' : 'btn-secondary');
            document.getElementById('toggleTrainingCerts').className = 'btn ' + (view === 'certifications' ? 'btn-primary' : 'btn-secondary');
            if (view === 'management') { loadPendingTrainingPacks(); loadSealedTrainingPacks(); }
            if (view === 'certifications') { loadPiPendingCerts(); }
        }

        // -- Training Document Upload --
        document.getElementById('trainDocFile').addEventListener('change', function() {
            document.getElementById('trainDocFileName').textContent = this.files[0] ? this.files[0].name : '';
        });

        document.getElementById('trainDocForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const msgEl = document.getElementById('trainDocMessage');
            const btn = document.getElementById('trainDocSubmitBtn');
            const file = document.getElementById('trainDocFile').files[0];
            if (!file) { msgEl.className = 'message error show'; msgEl.textContent = 'Select a PDF file'; return; }

            btn.disabled = true; btn.textContent = 'Uploading...';
            const fd = new FormData();
            fd.append('file', file);
            fd.append('title', document.getElementById('trainDocTitle').value);
            fd.append('category', document.getElementById('trainDocCategory').value);
            fd.append('affiliation', document.getElementById('trainDocAffiliation').value);
            fd.append('requirement_rule', document.getElementById('trainDocRule').value);
            fd.append('condition_key', document.getElementById('trainDocCondKey').value);
            fd.append('condition_note', document.getElementById('trainDocCondNote').value);

            try {
                const resp = await fetch('/api/di/training/documents', { method: 'POST', body: fd, credentials: 'include' });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Upload failed');
                msgEl.className = 'message success show'; msgEl.textContent = 'Document uploaded successfully';
                document.getElementById('trainDocForm').reset();
                document.getElementById('trainDocFileName').textContent = '';
                loadTrainingDocuments();
            } catch (err) {
                msgEl.className = 'message error show'; msgEl.textContent = err.message;
            } finally { btn.disabled = false; btn.textContent = 'Upload Document'; }
        });

        async function loadTrainingDocuments() {
            try {
                const resp = await fetch('/api/di/training/documents', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('trainDocsTableBody');
                if (!data.documents || data.documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No training documents yet</td></tr>';
                    return;
                }
                tbody.innerHTML = data.documents.map(d => {
                    const currentV = d.versions ? d.versions.find(v => v.is_current) : null;
                    const statusClass = d.is_active ? 'status-approved' : 'status-inactive';
                    const statusText = d.is_active ? 'Active' : 'Retired';
                    const versionList = d.versions ? d.versions.map(v =>
                        `<span style="font-size:11px;${v.is_current ? 'font-weight:bold;' : 'color:#999;'}">v${v.version}</span>`
                    ).join(' ') : '-';
                    return `<tr>
                        <td>${escapeHtml(d.title)}${d.condition_key ? ' <span style="font-size:10px;color:#666;">(' + escapeHtml(d.condition_key) + ')</span>' : ''}</td>
                        <td>${escapeHtml(d.category)}</td>
                        <td>${escapeHtml(d.affiliation)}</td>
                        <td>${escapeHtml(d.requirement_rule)}</td>
                        <td>${versionList}${currentV ? ' <a href="/api/di/training/document-versions/' + currentV.id + '/view" target="_blank" style="font-size:11px;">View</a>' : ''}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${d.is_active
                                ? `<button class="btn btn-sm btn-warning" onclick="retireTrainDoc('${d.id}')">Retire</button>`
                                : `<button class="btn btn-sm btn-success" onclick="activateTrainDoc('${d.id}')">Activate</button>`}
                            <button class="btn btn-sm btn-primary" onclick="uploadNewVersion('${d.id}')">New Version</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (err) { console.error('[TRAINING] load docs error:', err); }
        }

        async function retireTrainDoc(id) {
            if (!confirm('Retire this document? It will no longer appear to researchers.')) return;
            try {
                await fetch(`/api/di/training/documents/${id}/retire`, { method: 'PUT', credentials: 'include' });
                loadTrainingDocuments();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function activateTrainDoc(id) {
            try {
                await fetch(`/api/di/training/documents/${id}/activate`, { method: 'PUT', credentials: 'include' });
                loadTrainingDocuments();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function uploadNewVersion(docId) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.pdf';
            input.onchange = async () => {
                if (!input.files[0]) return;
                const fd = new FormData();
                fd.append('file', input.files[0]);
                try {
                    const resp = await fetch(`/api/di/training/documents/${docId}/versions`, { method: 'POST', body: fd, credentials: 'include' });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Upload failed');
                    alert('Version ' + data.version + ' uploaded');
                    loadTrainingDocuments();
                } catch (err) { alert('Error: ' + err.message); }
            };
            input.click();
        }

        // -- Training Management --
        async function loadPendingTrainingPacks() {
            try {
                const resp = await fetch('/api/di/training/packs/pending', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('pendingPacksTableBody');
                if (!data.packs || data.packs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No pending packs</td></tr>';
                    return;
                }
                tbody.innerHTML = data.packs.map(p => `<tr>
                    <td>${escapeHtml(p.researcher_name)}</td>
                    <td>${escapeHtml(p.researcher_affiliation)}</td>
                    <td>v${p.version}</td>
                    <td>${p.agreement_count}</td>
                    <td>${p.entry_count}</td>
                    <td>${new Date(p.updated_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPackDetails('${p.id}')">Review</button>
                        <button class="btn btn-sm btn-success" onclick="sealPack('${p.id}')">Seal</button>
                        <button class="btn btn-sm btn-warning" onclick="revisePack('${p.id}')">Revise</button>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load pending packs error:', err); }
        }

        async function viewPackDetails(packId) {
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}`, { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const area = document.getElementById('packDetailArea');
                area.style.display = 'block';
                document.getElementById('packDetailTitle').textContent = `Pack Details â€” ${data.pack.researcher_name} v${data.pack.version}`;

                let html = '<h4 style="font-size:13px;color:#333;margin:10px 0 5px;">Agreements</h4>';
                if (data.agreements.length === 0) { html += '<p style="color:#999;font-size:12px;">No agreements</p>'; }
                else {
                    html += '<table class="data-table" style="font-size:12px;"><thead><tr><th>Document</th><th>Version</th><th>Confirmed by</th><th>Date</th></tr></thead><tbody>';
                    data.agreements.forEach(a => {
                        html += `<tr><td>${escapeHtml(a.document_title)}</td><td>v${a.doc_version}</td><td>${escapeHtml(a.confirmed_name)}</td><td>${new Date(a.confirmed_at).toLocaleDateString()}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }

                html += '<h4 style="font-size:13px;color:#333;margin:15px 0 5px;">Training Entries</h4>';
                if (data.entries.length === 0) { html += '<p style="color:#999;font-size:12px;">No entries</p>'; }
                else {
                    html += '<table class="data-table" style="font-size:12px;"><thead><tr><th>Type</th><th>Date</th><th>Supervisor</th><th>Status</th></tr></thead><tbody>';
                    data.entries.forEach(e => {
                        const badgeClass = e.status === 'CERTIFIED' ? 'status-approved' : e.status === 'REJECTED' ? 'status-revision' : 'status-pending';
                        const supText = e.certification_route === 'PI' ? `${escapeHtml(e.supervisor_name || '')} <span style="font-size:10px;color:#856404;">(PI oversight)</span>` : escapeHtml(e.supervisor_name || '');
                        html += `<tr><td>${escapeHtml(e.training_type)}</td><td>${new Date(e.training_date).toLocaleDateString()}</td><td>${supText}</td><td><span class="status-badge ${badgeClass}">${e.status}</span></td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                document.getElementById('packDetailContent').innerHTML = html;
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function sealPack(packId) {
            if (!confirm('Seal this training pack? This action is permanent and will generate a certificate.')) return;
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}/seal`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Seal failed');
                alert('Pack sealed. Verification: ' + data.verification_code);
                loadPendingTrainingPacks();
                loadSealedTrainingPacks();
                document.getElementById('packDetailArea').style.display = 'none';
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function revisePack(packId) {
            const comments = prompt('Enter revision comments:');
            if (!comments) return;
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}/revise`, {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Revision request failed');
                alert('Revision requested');
                loadPendingTrainingPacks();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function loadSealedTrainingPacks() {
            try {
                const resp = await fetch('/api/di/training/sealed-overview', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('sealedPacksTableBody');
                if (!data.packs || data.packs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999;">No sealed packs yet</td></tr>';
                    return;
                }
                tbody.innerHTML = data.packs.map(p => `<tr>
                    <td>${escapeHtml(p.researcher_name)}</td>
                    <td><span class="status-badge status-approved">SEALED</span> ${new Date(p.sealed_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPackDetails('${p.id}')">View</button>
                        <a href="/api/di/training/certificate/${p.id}" class="btn btn-sm btn-secondary" style="text-decoration:none;">Download</a>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load sealed packs error:', err); }
        }

        // -- PI Certifications (PI-route entries) --
        async function loadPiPendingCerts() {
            try {
                const resp = await fetch('/api/di/training/pi-pending-certifications', { credentials: 'include' });
                if (resp.status === 501) return;
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('piCertsTableBody');
                if (!data.entries || data.entries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No pending PI certifications</td></tr>';
                    return;
                }
                tbody.innerHTML = data.entries.map(e => `<tr>
                    <td>${escapeHtml(e.trainee_name)}</td>
                    <td>${escapeHtml(e.training_type)}</td>
                    <td>${new Date(e.training_date).toLocaleDateString()}</td>
                    <td>${escapeHtml(e.other_supervisor_name || '')} ${e.other_supervisor_email ? '(' + escapeHtml(e.other_supervisor_email) + ')' : ''}</td>
                    <td style="font-size:11px;color:#666;">${escapeHtml(e.notes || '-')}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="piCertifyEntry('${e.id}')">Certify</button>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load PI pending certs:', err); }
        }

        async function piCertifyEntry(entryId) {
            if (!confirm('Certify this training entry under PI oversight?')) return;
            try {
                const resp = await fetch(`/api/di/training/entries/${entryId}/pi-certify`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');
                loadPiPendingCerts();
            } catch (err) { alert('Error: ' + err.message); }
        }
    </script>
</body>
</html>
