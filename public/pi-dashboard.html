<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PI Dashboard: NATLAB GLP Portal</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        
          
          /* =====================================================
             EMBED MODE (GLP Vision mirror for researcher 1-to-1)
             Shows only the DIC/GLP Vision content, driven by ?user= &mode=
             ===================================================== */
          body.embed-mode { background: #ffffff; }
          body.embed-mode .header,
          body.embed-mode .tab-nav { display: none !important; }
          

          body.embed-mode .tab-content { max-width: none !important; margin: 0 !important; padding: 0 !important; }
          body.embed-mode .panel { border-radius: 0 !important; box-shadow: none !important; margin-bottom: 0 !important; }

          /* Only show the GLP Vision tab content */
          body.embed-mode #tab-lab-files { display: block !important; }
          body.embed-mode .tab-content:not(#tab-lab-files) { display: none !important; }

          /* Within GLP Vision: hide sidebar + PDF viewer, stretch the results column */
          body.embed-mode #dicSidebar { display: none !important; }
          body.embed-mode .dic-viewer { display: none !important; }
          body.embed-mode .dic-finder { width: 100% !important; }
          body.embed-mode .dic-vision-bar { display: none !important; }

/* =====================================================
             EMBED MODE (iframe mirror for GLP Vision)
             Only show requested module content
             ===================================================== */
          body.embed-mode {
              background: #ffffff;
          }
          body.embed-mode .header,
          body.embed-mode .tab-nav {
              display: none !important;
          }
          body.embed-mode .tab-content {
              max-width: none !important;
              margin: 0 !important;
              padding: 0 !important;
          }
          body.embed-mode .panel {
              border-radius: 0 !important;
              box-shadow: none !important;
              margin-bottom: 0 !important;
          }

.header {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 20px; }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
        }
        .pi-badge {
            background: #ffc107;
            color: #333;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Tab Navigation */
        .tab-nav {
            background: white;
            border-bottom: 2px solid #e0e0e0;
            display: flex;
            padding: 0 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .tab-btn {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .tab-btn:hover { color: #1a365d; background: #f8f9fa; }
        .tab-btn.active {
            color: #1a365d;
            border-bottom-color: #1a365d;
        }
        .tab-btn .badge {
            background: #dc3545;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 6px;
        }

        /* Tab Content */
        .tab-content { display: none; padding: 20px; max-width: 1600px; margin: 0 auto; }
        .tab-content.active { display: block; }

        /* Panels */
        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 20px;
        }
        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header h2 {
            font-size: 16px;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel-header .icon { font-size: 20px; }
        .panel-content { padding: 20px; }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            text-align: center;
        }
        .stat-card .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #1a365d;
        }
        .stat-card .stat-label {
            font-size: 13px;
            color: #666;
            margin-top: 5px;
        }
        .stat-card.pending .stat-value { color: #ffc107; }
        .stat-card.approved .stat-value { color: #28a745; }
        .stat-card.revision .stat-value { color: #dc3545; }

        /* Grid Layouts */
        .two-column { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .upload-column { max-width: 500px; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: #333;
            font-weight: bold;
            font-size: 14px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2d5a87;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        .form-group.full-width { grid-column: 1 / -1; }
        .form-group textarea { resize: vertical; min-height: 60px; }

        /* Checkbox Group */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label {
            margin: 0;
            font-weight: normal;
            cursor: pointer;
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        .file-upload:hover { border-color: #2d5a87; background: #f8f9fa; }
        .file-upload.has-file { border-color: #28a745; background: #f0fff4; }
        .file-upload input[type="file"] { display: none; }
        .file-upload-text { color: #666; font-size: 13px; }
        .file-upload-text strong { color: #2d5a87; }
        .file-name { margin-top: 8px; color: #28a745; font-weight: bold; font-size: 13px; }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: #2d5a87; color: white; }
        .btn-primary:hover { background: #1a365d; }
        .btn-primary:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #c82333; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-warning:hover { background: #e0a800; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-sm { padding: 4px 8px; font-size: 11px; }
        .btn-full { width: 100%; }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .data-table th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #e0e0e0;
            font-size: 12px;
            color: #666;
            font-weight: 600;
        }
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            vertical-align: middle;
        }
        .data-table tr:hover { background: #f8f9fa; }

        /* Status Badges */
        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #d4edda; color: #155724; }
        .status-revision { background: #f8d7da; color: #721c24; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #e2e3e5; color: #6c757d; }

        /* Type Badges */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .type-badge.pdf { background: #fee; color: #c00; }
        .type-badge.excel { background: #efe; color: #060; }
        .type-badge.word { background: #eef; color: #00c; }
        .type-badge.powerpoint { background: #fef3e0; color: #e65100; }
        .type-badge.sop { background: #e3f2fd; color: #1565c0; }
        .type-badge.data { background: #fff3e0; color: #e65100; }

        /* Role Badge */
        .role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }
        .role-badge.pi { background: #ffc107; color: #333; }
        .role-badge.supervisor { background: #17a2b8; color: white; }
        .role-badge.researcher { background: #e0e0e0; color: #333; }

        /* Actions */
        .actions { display: flex; gap: 5px; }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .filter-group label {
            font-size: 11px;
            font-weight: bold;
            color: #666;
        }
        .filter-group select, .filter-group input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            min-width: 150px;
        }

        /* Bulk Actions Bar */
        .bulk-actions {
            display: flex;
            gap: 10px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 6px;
            margin-bottom: 15px;
            align-items: center;
        }
        .bulk-actions.hidden { display: none; }
        .bulk-actions span { font-size: 13px; color: #1a365d; font-weight: bold; }

        /* Tree View */
        .directory-tree { font-size: 13px; }
        .tree-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tree-item:hover { background: #f0f2f5; }
        .tree-item .icon { font-size: 16px; }
        .tree-folder { font-weight: bold; color: #1a365d; }
        .tree-file { color: #333; padding-left: 20px; }
        .tree-children { margin-left: 20px; border-left: 1px solid #e0e0e0; }
        .tree-children.collapsed { display: none; }
        .file-checkbox { width: 16px; height: 16px; cursor: pointer; }
        .file-actions { margin-left: auto; display: flex; gap: 5px; }

        /* Messages */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Loading */
        .loading { text-align: center; padding: 30px; color: #666; }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #2d5a87;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* AI Review Summary */
        .ai-summary {
            font-size: 12px;
            color: #666;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .ai-score {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }
        .ai-score.high { background: #d4edda; color: #155724; }
        .ai-score.medium { background: #fff3cd; color: #856404; }
        .ai-score.low { background: #f8d7da; color: #721c24; }

        /* ==================== DATA INTELLIGENCE CONSOLE (DIC) ==================== */
        .dic-container {
            display: grid;
            grid-template-columns: 220px 380px 1fr;
            height: calc(100vh - 160px);
            gap: 0;
            background: #f0f2f5;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e4e7eb;
        }

        /* --- Sidebar --- */
        .dic-sidebar {
            background: #fff;
            border-right: 1px solid #e4e7eb;
            overflow-y: auto;
            padding: 0;
        }
        .dic-sidebar.collapsed { display: none; }
        .dic-sidebar-section {
            padding: 14px 16px 8px;
        }
        .dic-sidebar-section:not(:last-child) {
            border-bottom: 1px solid #f0f2f5;
        }
        .dic-micro-title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 8px;
        }
        .dic-status-bucket {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #374151;
            transition: background 0.15s;
        }
        .dic-status-bucket:hover { background: #f5f7fa; }
        .dic-status-bucket.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
        .dic-status-bucket .dic-count {
            background: #e8ecf1;
            color: #5a6578;
            font-size: 11px;
            font-weight: 600;
            padding: 1px 7px;
            border-radius: 10px;
            min-width: 20px;
            text-align: center;
        }
        .dic-status-bucket.active .dic-count {
            background: #1a365d;
            color: #fff;
        }
        .dic-year-item {
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: #5a6578;
            transition: background 0.15s;
        }
        .dic-year-item:hover { background: #f5f7fa; }
        .dic-year-item.active { background: #eef2ff; color: #1a365d; font-weight: 600; }
        .dic-researcher-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 7px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .dic-researcher-item:hover { background: #f5f7fa; }
        .dic-researcher-item.active { background: #eef2ff; }
        .dic-researcher-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #2d5a87;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            flex-shrink: 0;
        }
        .dic-researcher-name {
            font-size: 13px;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-researcher-item.active .dic-researcher-name { color: #1a365d; font-weight: 600; }

        /* --- Finder (Column A) --- */
        .dic-finder {
            background: #fafbfc;
            border-right: 1px solid #e4e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dic-search-area {
            padding: 16px 16px 0;
        }
        .dic-search-input {
            width: 100%;
            padding: 10px 14px;
            border: 1.5px solid #d1d5db;
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
            box-sizing: border-box;
        }
        .dic-search-input:focus {
            border-color: #2d5a87;
            box-shadow: 0 0 0 3px rgba(45, 90, 135, 0.1);
        }
        .dic-scope-pills {
            display: flex;
            flex-wrap: wrap;
            row-gap: 6px;
            gap: 6px;
            padding: 10px 0 0;
        }
        .dic-scope-pill {
            padding: 4px 12px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid #d1d5db;
            background: #fff;
            color: #5a6578;
            transition: all 0.15s;
        }
        .dic-scope-pill:hover { border-color: #9ca3af; }
        .dic-scope-pill.active {
            background: #1a365d;
            color: #fff;
            border-color: #1a365d;
        }
        .dic-vision-bar {
            display: flex;
            gap: 4px;
            padding: 10px 14px;
            border-bottom: 1px solid #eee;
        }
        .dic-vision-btn {
            padding: 5px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #e4e7eb;
            background: #fff;
            color: #6b7280;
            transition: all 0.15s;
        }
        .dic-vision-btn:hover { border-color: #9ca3af; }
        .dic-vision-btn.active {
            background: #1a365d;
            color: #fff;
            border-color: #1a365d;
        }
        .dic-filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            padding: 10px 16px;
            border-bottom: 1px solid #e4e7eb;
        }
        .dic-chip {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            cursor: pointer;
            border: 1px solid #e4e7eb;
            background: #fff;
            color: #5a6578;
            transition: all 0.15s;
        }
        .dic-chip:hover { border-color: #9ca3af; }
        .dic-chip.active {
            background: #eef2ff;
            border-color: #2d5a87;
            color: #1a365d;
            font-weight: 600;
        }
        .dic-chip.dic-chip-dragon.active {
            background: #fef2f2;
            border-color: #dc2626;
            color: #991b1b;
        }
        .dic-months-label {
            font-size: 10px;
            color: #9ca3af;
            padding: 2px 16px 0;
        }
        .dic-quick-metrics {
            display: flex;
            gap: 6px;
            padding: 10px 16px;
            border-bottom: 1px solid #e4e7eb;
        }
        .dic-metric-box {
            flex: 1;
            background: #fff;
            border: 1px solid #e4e7eb;
            border-radius: 8px;
            padding: 6px 4px;
            text-align: center;
        }
        .dic-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #1a365d;
        }
        .dic-metric-label {
            font-size: 9px;
            font-weight: 600;
            letter-spacing: 0.8px;
            text-transform: uppercase;
            color: #8c95a1;
        }
        .dic-results {
            flex: 1;
            overflow-y: auto;
            padding: 8px 12px;
        }
        .dic-result-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.15s, box-shadow 0.15s;
            border: 1px solid transparent;
        }
        .dic-result-item:hover {
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            border-color: #e4e7eb;
        }
        .dic-result-item.active {
            background: #fff;
            border-color: #2d5a87;
            box-shadow: 0 2px 8px rgba(45, 90, 135, 0.1);
        }
        .dic-result-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 700;
            flex-shrink: 0;
            color: #fff;
        }
        .dic-result-icon.data { background: #2d5a87; }
        .dic-result-icon.sop { background: #6366f1; }
        .dic-result-icon.pres { background: #0891b2; }
        .dic-result-body { flex: 1; min-width: 0; }
        .dic-result-title {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-result-sub {
            font-size: 11px;
            color: #8c95a1;
            margin-top: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-result-meta {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 4px;
        }
        .dic-badge {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 6px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .dic-badge.pending { background: #fff3cd; color: #856404; }
        .dic-badge.approved { background: #d4edda; color: #155724; }
        .dic-badge.revision { background: #f8d7da; color: #721c24; }
        .dic-badge.submitted { background: #cce5ff; color: #004085; }
        .dic-assoc-chip {
            font-size: 9px;
            font-weight: 600;
            padding: 1px 5px;
            border-radius: 4px;
            background: #eef2ff;
            color: #4338ca;
        }
        .dic-dragon-badge {
            font-size: 10px;
        }
        .dic-toolbar-icon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, opacity 0.15s;
            flex-shrink: 0;
            text-decoration: none;
        }
        .dic-toolbar-icon:hover { transform: translateY(-1px); opacity: 0.85; }
        .dic-toolbar-icon:focus-visible { outline: 2px solid #2d5a87; outline-offset: 2px; }
        .dic-toolbar-icon svg { width: 20px; height: 20px; }
        .dic-toolbar-presentation {
            background: #ffffff;
            border: 1px solid #e5e7eb;
        }
        .dic-emoji-icon {
            font-size: 18px;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .dic-toolbar-dragon {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            border: 2px solid #d1d5db;
            background: #fff;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, opacity 0.15s, border-color 0.15s;
            flex-shrink: 0;
        }
        .dic-toolbar-dragon:hover { transform: translateY(-1px); opacity: 0.85; }
        .dic-toolbar-dragon:focus-visible { outline: 2px solid #2d5a87; outline-offset: 2px; }
        .dic-toolbar-dragon.sealed { background: #fef2f2; border-color: #dc2626; }
        .dic-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
            text-align: center;
            color: #8c95a1;
        }
        .dic-empty-state h3 {
            font-size: 14px;
            font-weight: 600;
            color: #5a6578;
            margin: 0 0 12px;
        }
        .dic-empty-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        .dic-empty-btn {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1.5px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-empty-btn:hover { border-color: #2d5a87; color: #1a365d; }

        /* --- Viewer (Column B) --- */
        
                /* GLP Vision overlay in right viewer (Training / Inventory / 1-to-1) */
        .dic-vision-overlay{
            position:absolute;
            top:0;left:0;right:0;bottom:0;
            width:100%;
            height:100%;
            overflow:auto;
            background:#ffffff;
            border-radius:12px;
            z-index:5;
            padding:16px;
            box-sizing:border-box;
        }

.dic-viewer {
              position: relative;

            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .dic-viewer-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid #e4e7eb;
            background: #fafbfc;
            min-height: 48px;
            flex-wrap: wrap;
        }
        .dic-viewer-filename {
            font-size: 13px;
            font-weight: 600;
            color: #1e293b;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .dic-toolbar-btn {
            padding: 5px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-toolbar-btn:hover { background: #f5f7fa; border-color: #9ca3af; }
        .dic-toolbar-btn.approve { background: #d4edda; color: #155724; border-color: #c3e6cb; }
        .dic-toolbar-btn.approve:hover { background: #c3e6cb; }
        .dic-toolbar-btn.revise { background: #fff3cd; color: #856404; border-color: #ffeeba; }
        .dic-toolbar-btn.revise:hover { background: #ffeeba; }
        .dic-viewer-pdf {
            flex: 1;
            min-height: 0;
            width: 100%;
            height: 100%;
            border: none;
            background: #f0f2f5;
        }
        .dic-viewer-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
            font-size: 14px;
        }
          /* Presentation mode overlay */
        #dicPresentationOverlay:fullscreen,
        #dicPresentationOverlay:-webkit-full-screen { background: #000; }
        #dicPresentationOverlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 99999; background: #000; display: none;
        }
        #dicPresentationOverlay iframe {
            width: 100%; height: 100%; border: 0;
        }
        #dicPresentationOverlay .dic-pres-close {
            position: absolute; top: 12px; right: 16px; z-index: 100000;
            background: rgba(255,255,255,0.85); border: none; border-radius: 8px;
            font-size: 22px; width: 40px; height: 40px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            color: #1e293b; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        #dicPresentationOverlay .dic-pres-close:hover { background: #fff; }
        .dic-badge.paper { background: #6b214f; color: #fff; border: 1px solid rgba(255,255,255,0.2); }
        .dic-result-icon.paper { background: #6b214f; }
        .dic-intel-panel {
            border-top: 1px solid #e4e7eb;
            background: #fafbfc;
            padding: 0;
            flex-shrink: 0;
        }
        .dic-intel-strip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 16px;
            height: 36px;
            box-sizing: border-box;
            border-bottom: 1px solid #f0f2f5;
        }
        .dic-intel-strip:last-child { border-bottom: none; }
        .dic-intel-strip-label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8c95a1;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .dic-intel-chips {
            display: flex;
            align-items: center;
            gap: 5px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .dic-intel-chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            color: #374151;
            background: #fff;
            border: 1px solid #e4e7eb;
            white-space: nowrap;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        .dic-intel-chip:hover { border-color: #9ca3af; }
        .dic-intel-chip.heuristic {
            border-style: dashed;
            opacity: 0.7;
        }
        .dic-intel-chip .dic-badge { font-size: 8px; padding: 0 4px; }
        .dic-intel-chip-remove {
            font-size: 12px;
            color: #d1d5db;
            cursor: pointer;
            line-height: 1;
            margin-left: 2px;
        }
        .dic-intel-chip-remove:hover { color: #ef4444; }
        .dic-intel-chip-score {
            font-size: 9px;
            color: #9ca3af;
        }
        .dic-intel-link-btn {
            font-size: 10px;
            font-weight: 600;
            color: #2d5a87;
            cursor: pointer;
            border: none;
            background: none;
            padding: 2px 6px;
            border-radius: 4px;
            transition: background 0.15s;
            white-space: nowrap;
            flex-shrink: 0;
        }
        .dic-intel-link-btn:hover { background: #eef2ff; }
        .dic-intel-remove {
            font-size: 14px;
            color: #d1d5db;
            cursor: pointer;
            margin-left: 4px;
            line-height: 1;
            transition: color 0.15s;
        }
        .dic-intel-remove:hover { color: #ef4444; }

        /* --- Link Modal --- */
        .dic-modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .dic-modal-overlay.active { display: flex; }
        .dic-modal {
            background: #fff;
            border-radius: 14px;
            width: 520px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
        }
        .dic-modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e4e7eb;
            font-size: 15px;
            font-weight: 700;
            color: #1a365d;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .dic-modal-close {
            font-size: 20px;
            cursor: pointer;
            color: #9ca3af;
            border: none;
            background: none;
            line-height: 1;
        }
        .dic-modal-close:hover { color: #374151; }
        .dic-modal-body {
            padding: 16px 20px;
            overflow-y: auto;
            flex: 1;
        }
        .dic-modal-search {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 12px;
            box-sizing: border-box;
        }
        .dic-modal-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s;
            font-size: 12px;
            color: #374151;
        }
        .dic-modal-item:hover { background: #f5f7fa; }
        .dic-modal-item.linked {
            opacity: 0.4;
            cursor: default;
        }
        .dic-modal-item .dic-badge { margin-left: auto; }

        /* --- Revise Modal --- */
        .dic-revise-textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            resize: vertical;
            box-sizing: border-box;
        }
        .dic-revise-textarea:focus {
            border-color: #2d5a87;
            outline: none;
        }
        .dic-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid #e4e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
        .dic-modal-btn {
            padding: 7px 18px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: 1px solid #d1d5db;
            background: #fff;
            color: #374151;
            transition: all 0.15s;
        }
        .dic-modal-btn:hover { background: #f5f7fa; }
        .dic-modal-btn.primary {
            background: #1a365d;
            color: #fff;
            border-color: #1a365d;
        }
        .dic-modal-btn.primary:hover { background: #2d5a87; }
        .dic-modal-btn.danger {
            background: #dc3545;
            color: #fff;
            border-color: #dc3545;
        }
        .dic-modal-btn.danger:hover { background: #c82333; }
        .dic-modal-label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }
        .dic-modal-select {
            width: 100%;
            padding: 8px 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            box-sizing: border-box;
            background: #fff;
        }
        .dic-modal-select:focus { border-color: #2d5a87; outline: none; }
        .dic-modal-input {
            width: 100%;
            padding: 8px 12px;
            border: 1.5px solid #d1d5db;
            border-radius: 8px;
            font-size: 13px;
            font-family: inherit;
            box-sizing: border-box;
        }
        .dic-modal-input:focus { border-color: #2d5a87; outline: none; }
        .dic-modal-warning {
            background: #fff3cd;
            color: #856404;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 12px;
        }
        .dic-modal-field + .dic-modal-field { margin-top: 12px; }

        /* --- Sidebar toggle --- */
        .dic-sidebar-toggle {
            position: absolute;
            left: 220px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 10;
            width: 20px;
            height: 40px;
            background: #fff;
            border: 1px solid #e4e7eb;
            border-radius: 0 6px 6px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #8c95a1;
            transition: all 0.15s;
        }
        .dic-sidebar-toggle:hover { background: #f5f7fa; color: #374151; }

        /* ==================== GLP CONSOLE ==================== */
        .glpc-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            height: calc(100vh - 140px);
            gap: 0;
            background: #f8f9fa;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #e4e7eb;
        }
        .glpc-left {
            background: #ffffff;
            border-right: 1px solid #e4e7eb;
            overflow-y: auto;
            padding: 16px;
        }
        .glpc-right {
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .glpc-section {
            margin-bottom: 20px;
        }
        .glpc-section-title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 10px;
        }
        .glpc-mode-switch {
            display: flex;
            gap: 4px;
            background: #f3f4f6;
            border-radius: 8px;
            padding: 3px;
            margin-bottom: 12px;
        }
        .glpc-mode-btn {
            flex: 1;
            padding: 6px 0;
            border: none;
            background: transparent;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .glpc-mode-btn.active {
            background: #ffffff;
            color: #1a365d;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .glpc-search {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #e4e7eb;
            border-radius: 8px;
            font-size: 12px;
            outline: none;
            margin-bottom: 8px;
            box-sizing: border-box;
        }
        .glpc-search:focus { border-color: #2d5a87; }
        .glpc-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 10px;
        }
        .glpc-chip {
            padding: 4px 8px;
            border: 1px solid #e4e7eb;
            border-radius: 12px;
            background: #ffffff;
            font-size: 10px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.15s;
        }
        .glpc-chip:hover { border-color: #2d5a87; color: #2d5a87; }
        .glpc-chip.active {
            background: #1a365d;
            color: #ffffff;
            border-color: #1a365d;
        }
        .glpc-member-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .glpc-member-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.12s;
        }
        .glpc-member-row:hover { background: #f3f4f6; }
        .glpc-member-row.glpc-member-selected { background: #e8f0fe; }
        .glpc-member-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 700;
            color: #ffffff;
            flex-shrink: 0;
        }
        .glpc-member-info { min-width: 0; }
        .glpc-member-name {
            font-size: 12px;
            font-weight: 600;
            color: #1a365d;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .glpc-member-meta {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-wrap: wrap;
        }
        .glpc-member-badge {
            font-size: 9px;
            font-weight: 600;
            color: #6b7280;
            background: #f3f4f6;
            padding: 1px 5px;
            border-radius: 4px;
        }
        .glpc-member-week {
            font-size: 9px;
            color: #9ca3af;
        }
        .glpc-overview-cards {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin: 10px 0;
        }
        .glpc-overview-card {
            background: #fafbfc;
            border: 1px solid #e4e7eb;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }
        .glpc-overview-label {
            font-size: 8px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 2px;
        }
        .glpc-overview-value {
            font-size: 14px;
            font-weight: 700;
            color: #1a365d;
        }
        .glpc-group-actions { margin-top: 10px; }
        .glpc-btn-generate {
            width: 100%;
            padding: 8px;
            border: 1px solid #2d5a87;
            border-radius: 8px;
            background: #ffffff;
            color: #2d5a87;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
        }
        .glpc-btn-generate:hover { background: #2d5a87; color: #ffffff; }
        .glpc-btn-generate:disabled { opacity: 0.5; cursor: not-allowed; }
        .glpc-mgmt-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }
        .glpc-mgmt-tab {
            flex: 1;
            padding: 5px;
            border: 1px solid #e4e7eb;
            border-radius: 6px;
            background: #ffffff;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
        }
        .glpc-mgmt-tab.active { background: #1a365d; color: #ffffff; border-color: #1a365d; }
        .glpc-mgmt-filter { margin-bottom: 8px; }
        .glpc-toggle-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: #6b7280;
            cursor: pointer;
        }
        .glpc-toggle-label input[type="checkbox"] { accent-color: #2d5a87; }
        .glpc-mgmt-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .glpc-mgmt-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4px 0;
            border-bottom: 1px solid #f3f4f6;
        }
        .glpc-mgmt-row.glpc-mgmt-inactive { opacity: 0.5; }
        .glpc-mgmt-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
        }
        .glpc-mgmt-checkbox input { accent-color: #2d5a87; }
        .glpc-mgmt-meta {
            font-size: 9px;
            color: #9ca3af;
        }
        .glpc-mgmt-actions {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 8px;
        }
        .glpc-btn-apply {
            padding: 6px 16px;
            border: none;
            border-radius: 6px;
            background: #2d5a87;
            color: #ffffff;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
        }
        .glpc-btn-apply:disabled { opacity: 0.4; cursor: not-allowed; }
        .glpc-saved-msg {
            font-size: 11px;
            color: #16a34a;
            font-weight: 600;
        }
        .glpc-empty {
            text-align: center;
            color: #9ca3af;
            font-size: 12px;
            padding: 20px 10px;
        }
        .glpc-empty-state {
            text-align: center;
            padding: 60px 20px;
        }
        .glpc-empty-icon { margin-bottom: 16px; }
        .glpc-empty-title {
            font-size: 16px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 6px;
        }
        .glpc-empty-sub {
            font-size: 12px;
            color: #9ca3af;
            max-width: 300px;
            margin: 0 auto;
        }
        /* Trajectory Insights */
        .glpc-trajectory-header {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 8px;
        }
        .glpc-trajectory-panel {
            background: #ffffff;
            border: 1px solid #e4e7eb;
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
        }
        .glpc-trajectory-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }
        .glpc-trajectory-wide { grid-column: 1 / -1; }
        .glpc-trajectory-label {
            font-size: 9px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 2px;
        }
        .glpc-trajectory-value {
            font-size: 13px;
            font-weight: 700;
            color: #1a365d;
        }
        .glpc-trajectory-suggestions { }
        .glpc-trajectory-suggestion {
            font-size: 11px;
            color: #4b5563;
            padding: 4px 0;
            border-top: 1px solid #f3f4f6;
        }
        .glpc-trajectory-suggestion:first-child { border-top: none; }

        /* ── GLP Premium Card System (mirrored from researcher UI) ── */
        .glpWrap {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
        }
        .glpCard {
            background: #fafbfc;
            border: 1px solid #e4e7eb;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
            padding: 28px 32px;
            margin-bottom: 20px;
            transition: box-shadow 0.25s ease;
        }
        .glpCard:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.07);
        }
        .glpMicroTitle {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 10px;
        }

        /* Header card */
        #glpcHeaderCard {
            background: linear-gradient(180deg, #f2f4f8 0%, #eceef3 100%);
            border-color: #d4d9e2;
            box-shadow: 0 2px 10px rgba(30,41,59,0.06);
        }
        .glpHdr__topRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2px;
        }
        .glpHdr__title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.6px;
            text-transform: uppercase;
            color: #8c95a1;
        }
        .glpHdr__mainRow {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }
        .glpHdr__mainLeft {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            min-width: 0;
        }
        .glpHdr__divider {
            height: 1px;
            background: rgba(30,41,59,0.08);
            margin-bottom: 14px;
        }
        .glpHdr__statusRow {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .glpHdr__statusText { flex: 1; min-width: 0; }
        .glpHdr__maturityLine {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            color: #3a5068;
            line-height: 1.3;
        }
        .glpHdr__qualifierLine {
            font-size: 16px;
            font-weight: 800;
            color: #1e293b;
            line-height: 1.3;
            margin-top: 1px;
        }
        .glpHdr__timestamp {
            flex-shrink: 0;
            font-size: 11px;
            color: #9ba5b1;
            white-space: nowrap;
            align-self: flex-end;
        }

        /* Week selector */
        .glpWeekSelector {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6b7685;
        }
        .glpWeekNav {
            width: 24px; height: 24px;
            border: 1px solid #dce3eb;
            border-radius: 6px;
            background: #f6f7f9;
            color: #6b7685;
            font-size: 14px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .glpWeekNav:hover { background: #e8ebf0; }
        .glpWeekNav:disabled { opacity: 0.3; cursor: default; }
        .glpWeekLabel {
            font-weight: 600; font-size: 11px;
            letter-spacing: 0.5px;
            min-width: 60px; text-align: center;
        }

        /* Name + badges */
        .glpName {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.25;
            white-space: nowrap;
        }
        .glpBadgeRow {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        .glpBadge {
            display: inline-block;
            padding: 4px 14px;
            border-radius: 9px;
            font-size: 12.5px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .glpBadge--role { background: #e0ecf7; color: #2b5a8a; }
        .glpBadge--aff  { background: #dbeafe; color: #1e5faa; }

        /* Maturity icon */
        #glpcMaturityIcon {
            flex-shrink: 0;
            width: 52px;
            height: 52px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #glpcMaturityIcon img {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        /* Vision Table score strip */
        .glpVisionTable { margin-bottom: 16px; }
        .glpVT__row {
            display: flex; gap: 8px; flex-wrap: wrap;
        }
        .glpVT__cell {
            flex: 1; min-width: 80px;
            text-align: center;
            padding: 8px 6px;
            background: #f6f7f9;
            border-radius: 8px;
            border: 1px solid #e8ebf0;
        }
        .glpVT__label { font-size: 10px; color: #8a95a5; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .glpVT__score { font-size: 22px; font-weight: 700; color: #1a365d; }
        .glpVT__delta { font-size: 11px; font-weight: 600; margin-top: 2px; }
        .glpVT__delta--up { color: #28a745; }
        .glpVT__delta--down { color: #dc3545; }

        /* Mini-cards (SOPs / Experiments / Inventory) */
        .glpMiniCards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            border: 1px solid #e0e4ea;
            border-radius: 12px;
            overflow: hidden;
            background: #fff;
        }
        .glpMiniCard {
            padding: 22px 20px;
            text-align: center;
        }
        .glpMiniCard + .glpMiniCard {
            border-left: 1px solid #e0e4ea;
        }
        .glpMiniCard__title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.4px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 8px;
        }
        .glpMiniCard__big {
            font-size: 32px;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.1;
            margin-bottom: 10px;
        }
        .glpMiniCard__row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #5f6b7a;
            padding: 3px 0;
        }
        .glpMiniCard__row + .glpMiniCard__row {
            border-top: 1px solid #f0f2f5;
        }
        .glpMiniCard__rowVal {
            font-weight: 600;
            color: #3a5068;
        }
        .glpMiniCard__coverage {
            font-size: 11px;
            color: #8c95a1;
            margin-bottom: 4px;
        }

        /* Conformity section */
        .glpConformityInner {
            display: flex;
            flex-direction: column;
        }
        .glpConfContent {
            display: flex;
            flex-direction: column;
            gap: 14px;
        }
        .glpConfSection__title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.4px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 6px;
        }
        .glpConfSection__text {
            font-size: 14px;
            color: #3a5068;
            line-height: 1.6;
            margin: 0;
        }
        .glpConfSection__list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .glpConfSection__list li {
            position: relative;
            padding-left: 16px;
            font-size: 13px;
            color: #5f6b7a;
            line-height: 1.6;
            margin-bottom: 4px;
        }
        .glpConfSection__list li::before {
            content: '';
            position: absolute;
            left: 0;
            top: 8px;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: #8ca8c4;
        }

        /* GLP premium responsive */
        @media (max-width: 900px) {
            .glpWrap { padding: 16px; }
            .glpCard { padding: 20px 18px; }
        }
        @media (max-width: 700px) {
            .glpHdr__mainRow { flex-direction: column; align-items: flex-start; gap: 10px; }
            .glpHdr__statusRow { flex-wrap: wrap; }
            .glpHdr__timestamp { align-self: flex-start; margin-top: 6px; }
            .glpMiniCards { grid-template-columns: 1fr; }
            .glpMiniCard + .glpMiniCard { border-left: none; border-top: 1px solid #e0e4ea; }
        }

        /* ── Harmony Map (PI mirror of researcher UI) ── */
        .glpHarmonyMap {
            margin-top: 20px;
            border-radius: 14px;
            padding: 36px 24px 28px;
            text-align: center;
            background: linear-gradient(180deg, #f4f6fa 0%, #eaedf2 100%);
            border: 1px solid #dce0e8;
        }
        .glpHarmonyMap__title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.6px;
            color: #3a5068;
            margin-bottom: 4px;
        }
        .glpHarmonyMap__sub {
            font-size: 12px;
            color: #8c95a1;
            margin-bottom: 16px;
        }
        .glpHarmonyMap__body {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
        }
        .glpHarmonyImg {
            width: 520px;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }
        .glpHarmonyPanel { padding: 4px 0; }
        .glpHarmonyPanel--left  { text-align: right; }
        .glpHarmonyPanel--right { text-align: left; }
        .glpHarmonyPanel__title {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1.2px;
            text-transform: uppercase;
            color: #8c95a1;
            margin-bottom: 8px;
        }
        .glpHarmonyPanel__list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .glpHarmonyPanel__item {
            font-size: 12.5px;
            color: #3a5068;
            line-height: 1.6;
            padding: 3px 0;
        }
        .glpHarmonyPanel__text {
            font-size: 12.5px;
            color: #5f6b7a;
            line-height: 1.6;
            margin: 0;
        }
        @media (max-width: 900px) {
            .glpHarmonyMap__body {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
            }
            .glpHarmonyPanel--left,
            .glpHarmonyPanel--right { text-align: center; }
            .glpHarmonyImg { max-width: 280px; }
        }
        @media (max-width: 600px) {
            .glpHarmonyMap { padding: 24px 12px 20px; }
        }

        /* GLP Console responsive */
        @media (max-width: 900px) {
            .glpc-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            .glpc-left { border-right: none; border-bottom: 1px solid #e4e7eb; max-height: 400px; }
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .dic-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            .dic-sidebar { display: none; }
            .dic-finder { border-right: none; }
            .dic-viewer { min-height: 500px; }
            .two-column { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .tab-nav { overflow-x: auto; }
        }
        @media (max-width: 768px) {
            .tab-btn { padding: 12px 15px; font-size: 12px; }
            .stats-row { grid-template-columns: 1fr 1fr; }
            .filter-bar { flex-direction: column; }
            .filter-group { width: 100%; }
            .filter-group select, .filter-group input { width: 100%; }
        }
    
.download-mode-option.half-width {
  width: 48%;
  display: inline-flex;
  margin: 1%;
}

/* Legacy badges and pack cards */
.legacy-badge {
    display: inline-block; background: #f59e0b; color: #78350f;
    padding: 1px 6px; border-radius: 8px; font-size: 9px; font-weight: 700;
    margin-left: 4px; letter-spacing: 0.5px; vertical-align: middle;
}
.legacy-pack-card {
    background: #fffbeb; border: 1px solid #fde68a; border-radius: 8px;
    padding: 14px; margin-bottom: 10px; cursor: pointer;
    transition: border-color 0.2s;
}
.legacy-pack-card:hover { border-color: #f59e0b; }
.legacy-pack-header { display: flex; align-items: center; gap: 8px; }
.legacy-pack-meta { font-size: 11px; color: #92400e; margin-top: 4px; }
.dic-year-item.legacy-year { color: #92400e; font-weight: 600; }

        /* Premium Group Docs toggles */
        .gd-toggles{
            margin: 12px 0 14px 0;
            padding: 12px 14px;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            background: #ffffff;
            box-shadow: 0 1px 0 rgba(0,0,0,0.03);
            max-width: 520px;
        }
        .gd-toggle{
            display: flex;
            align-items: center;
            gap: 10px;
            user-select: none;
            cursor: pointer;
            font-size: 13px;
            color: #0f172a;
            font-weight: 700;
            letter-spacing: 0.02em;
        }
        .gd-toggle input{ display:none; }
        .gd-switch{
            width: 42px;
            height: 24px;
            border-radius: 999px;
            background: #e5e7eb;
            position: relative;
            border: 1px solid #d1d5db;
            transition: background 0.15s, border-color 0.15s;
            flex: 0 0 auto;
        }
        .gd-switch:after{
            content:"";
            width: 18px;
            height: 18px;
            border-radius: 999px;
            background: #ffffff;
            position: absolute;
            top: 2px;
            left: 2px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.12);
            transition: transform 0.15s;
        }
        .gd-toggle input:checked + .gd-switch{
            background: #1f4b7a;
            border-color: #1f4b7a;
        }
        .gd-toggle input:checked + .gd-switch:after{
            transform: translateX(18px);
        }
        .gd-label{ line-height: 1.2; }

</style>
</head>
<body>
    <div class="header">
        <h1>NATLAB GLP Data Integrity Portal</h1>
        <div class="header-info">
            <span class="pi-badge">PRINCIPAL INVESTIGATOR</span>
            <span class="user-badge" id="userName">Loading...</span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" data-tab="dashboard">Dashboard <span class="badge" id="pendingBadge" style="display:none;">0</span></button>
        <button class="tab-btn" data-tab="lab-files">GLP Vision</button>
        <button class="tab-btn" data-tab="glp-console">GLP Status</button>
        <button class="tab-btn" data-tab="group-docs">Group Docs</button>
        <button class="tab-btn" data-tab="user-mgmt">User Control</button>
        <button class="tab-btn" data-tab="training">Training</button>
        <button class="tab-btn" data-tab="purchases-inventory">Inventory</button>
        <button class="tab-btn" data-tab="backup">Backup</button>

    </div>

    <!-- ==================== DASHBOARD TAB ==================== -->
    <div class="tab-content active" id="tab-dashboard">
        <!-- Stats Row -->
        <div class="stats-row">
            <div class="stat-card pending">
                <div class="stat-value" id="statPending">-</div>
                <div class="stat-label">Pending Review</div>
            </div>
            <div class="stat-card approved">
                <div class="stat-value" id="statApproved">-</div>
                <div class="stat-label">Approved</div>
            </div>
            <div class="stat-card revision">
                <div class="stat-value" id="statRevision">-</div>
                <div class="stat-label">Revision Needed</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statTotal">-</div>
                <div class="stat-label">Total Submissions</div>
            </div>
        </div>

        <div class="two-column">
            <!-- Pending Approvals -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending Approvals</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPendingApprovals()">Refresh</button>
                </div>
                <div class="panel-content" style="max-height: 500px; overflow-y: auto;">
                    <div id="pendingApprovalsContainer">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Quick Upload -->
            <div class="panel upload-column">
                <div class="panel-header">
                    <h2><span class="icon">&#128194;</span> Quick Upload</h2>
                </div>              
<div class="panel-content">
                    <div id="uploadMessage" class="message"></div>
                    <form id="uploadForm">
                        <div class="form-group">
                            <label for="uploadResearcher">Upload for Researcher</label>
                            <select id="uploadResearcher" required>
                                <option value="">Select researcher...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fileType">File Type</label>
                            <select id="fileType" required>
                                <option value="">Select file type...</option>
                                <option value="SOP">SOP (Standard Operating Procedure)</option>
                                <option value="DATA">DATA (Research Data)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>File</label>
                            <div class="file-upload" id="fileUploadArea">
                                <input type="file" id="fileInput" accept=".pdf" required>
                                <p class="file-upload-text">
                                    <strong>Click to select a file</strong><br>
                                    or drag and drop here
                                </p>
                                <p class="file-name" id="fileName"></p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="uploadBtn">Upload File</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LABORATORY FILES TAB — DATA INTELLIGENCE CONSOLE ==================== -->
    <div class="tab-content" id="tab-lab-files">
        <div class="dic-container" style="position:relative;">
            <!-- Sidebar -->
            <div class="dic-sidebar" id="dicSidebar">
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">STATUS</div>
                    <div id="dicStatusBuckets"></div>
                </div>
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">YEAR</div>
                    <div id="dicYearList"></div>
                </div>
                <div class="dic-sidebar-section">
                    <div class="dic-micro-title">RESEARCHERS</div>
                    <div id="dicResearcherList"></div>
                </div>
            </div>

            <!-- Finder (Column A) -->
            <div class="dic-finder">
                <div class="dic-vision-bar" id="dicVisionBar">
                    <button class="dic-vision-btn active" onclick="dicSetVisionMode('all', this)">All</button>
                    <button class="dic-vision-btn" onclick="dicSetVisionMode('training', this)">Training</button>
                    <button class="dic-vision-btn" onclick="dicSetVisionMode('inventory', this)">Inventory</button>
                    <button class="dic-vision-btn" onclick="dicSetVisionMode('onetoone', this)">1-to-1</button>
</div>
                <div class="dic-search-area">
                    <input type="text" class="dic-search-input" id="dicSearchInput" placeholder="Search files..." oninput="dicApplyFilters()">
                    <div class="dic-scope-pills">
                        <span class="dic-scope-pill active" data-scope="DATA" onclick="dicSetScope(this)">DATA</span>
                        <span class="dic-scope-pill" data-scope="PRESENTATION" onclick="dicSetScope(this)">PRES</span>
                        <span class="dic-scope-pill" data-scope="SOP" onclick="dicSetScope(this)">SOP</span>
                        <span class="dic-scope-pill" data-scope="" onclick="dicSetScope(this)">ALL</span>
                        <select id="dicIntdocsSelect" class="dic-scope-pill" style="display:none;cursor:pointer;padding:6px 10px; min-width:110px;border:2px solid #dbe3ee;border-radius:999px;background:white;font-weight:700;" onchange="dicIntdocsChanged(this)" onclick="dicIntdocsChanged(this)">
                            <option value="papers">Papers</option>
                            <option value="projects">Projects</option>
                            <option value="grants">Grants</option>
                            <option value="collaborators">Collaborators</option>
                            <option value="other">Other</option>
                            <option value="all">All internal docs</option>
                        </select>
                        <select id="dicIntdocsFolderSel" class="dic-scope-pill" style="display:none;cursor:pointer;padding:6px 10px; min-width:110px;border:2px solid #dbe3ee;border-radius:999px;background:white;font-weight:700; flex-basis:100%; margin-top:6px;" onchange="dicIntdocsFolderChanged(this)" onclick="dicIntdocsFolderChanged(this)"></select>
                    </div>
                </div>
                <div class="dic-months-label" id="dicMonthsLabel">Showing last 12 months</div>
                <div class="dic-filter-row">
                    <span class="dic-chip active" data-filter="status" data-val="" onclick="dicSetChip('status','')" >All</span>
                    <span class="dic-chip" data-filter="status" data-val="PENDING" onclick="dicSetChip('status','PENDING')">Pending</span>
                    <span class="dic-chip" data-filter="status" data-val="APPROVED" onclick="dicSetChip('status','APPROVED')">Approved</span>
                    <span class="dic-chip" data-filter="status" data-val="REVISION_NEEDED" onclick="dicSetChip('status','REVISION_NEEDED')">Revision</span>
                    <span class="dic-chip dic-chip-dragon" data-filter="dragonSeal" onclick="dicToggleDragonSeal(this)">&#x1F409; Dragon Seal</span>
                </div>
                <div class="dic-filter-row">
                    <span class="dic-chip active" data-filter="time" data-val="" onclick="dicSetChip('time','')">All Time</span>
                    <span class="dic-chip" data-filter="time" data-val="7" onclick="dicSetChip('time','7')">7d</span>
                    <span class="dic-chip" data-filter="time" data-val="30" onclick="dicSetChip('time','30')">30d</span>
                    <span class="dic-chip" data-filter="time" data-val="90" onclick="dicSetChip('time','90')">90d</span>
                    <span class="dic-chip" data-filter="time" data-val="365" onclick="dicSetChip('time','365')">Year</span>
                    <span style="margin-left:auto;"></span>
                    <span class="dic-chip active" data-filter="sort" data-val="newest" onclick="dicSetChip('sort','newest')">Newest</span>
                    <span class="dic-chip" data-filter="sort" data-val="oldest" onclick="dicSetChip('sort','oldest')">Oldest</span>
                    <span class="dic-chip" data-filter="sort" data-val="name" onclick="dicSetChip('sort','name')">Name</span>
                </div>
                <div class="dic-quick-metrics" id="dicQuickMetrics" style="display:none;"></div>
                <div class="dic-results" id="dicResults">
                    <div class="dic-empty-state"><h3>Select a researcher or search to begin</h3></div>
                </div>
            </div>

            <!-- Viewer (Column B) -->
            <div class="dic-viewer">
                <div class="dic-viewer-toolbar" id="dicToolbar">
                    <span class="dic-viewer-filename" id="dicViewerFilename">No file selected</span>
                </div>
                <div class="dic-viewer-empty" id="dicViewerEmpty">Select a file to preview</div>
                <iframe class="dic-viewer-pdf" id="dicViewerPdf" style="display:none;"></iframe>
                <div class="dic-vision-overlay" id="dicVisionOverlay" style="display:none;"></div>
                <div class="dic-intel-panel" id="dicIntelPanel" style="display:none;">
                    <div class="dic-intel-strip">
                        <span class="dic-intel-strip-label" id="dicSopLabel">SOPs (0)</span>
                        <div class="dic-intel-chips" id="dicIntelSops"></div>
                        <button class="dic-intel-link-btn" onclick="dicOpenLinkModal('SOP')">+</button>
                    </div>
                    <div class="dic-intel-strip">
                        <span class="dic-intel-strip-label" id="dicPresLabel">PRES (0)</span>
                        <div class="dic-intel-chips" id="dicIntelPres"></div>
                        <button class="dic-intel-link-btn" onclick="dicOpenLinkModal('PRESENTATION')">+</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Link Modal -->
        <div class="dic-modal-overlay" id="dicLinkModal">
            <div class="dic-modal">
                <div class="dic-modal-header">
                    <span id="dicLinkModalTitle">Link File</span>
                    <button class="dic-modal-close" onclick="dicCloseLinkModal()">&times;</button>
                </div>
                <div class="dic-modal-body">
                    <input type="text" class="dic-modal-search" id="dicLinkSearch" placeholder="Search files..." oninput="dicFilterLinkCandidates()">
                    <div id="dicLinkCandidates"></div>
                </div>
            </div>
        </div>

        <!-- Revise Modal -->
        <div class="dic-modal-overlay" id="dicReviseModal">
            <div class="dic-modal">
                <div class="dic-modal-header">
                    <span>Request Revision</span>
                    <button class="dic-modal-close" onclick="dicCloseReviseModal()">&times;</button>
                </div>
                <div class="dic-modal-body">
                    <textarea class="dic-revise-textarea" id="dicReviseText" placeholder="Describe what needs to be revised..."></textarea>
                </div>
                <div class="dic-modal-footer">
                    <button class="dic-modal-btn" onclick="dicCloseReviseModal()">Cancel</button>
                    <button class="dic-modal-btn primary" onclick="dicSubmitRevision()">Submit Revision</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Modal (Pending Approvals) — top-level so visible from any tab -->
    <div class="dic-modal-overlay" id="paApproveModal">
        <div class="dic-modal">
            <div class="dic-modal-header">
                <span>Approve Submission</span>
                <button class="dic-modal-close" onclick="paCloseApproveModal()">&times;</button>
            </div>
            <div class="dic-modal-body">
                <p style="font-size:13px;color:#374151;margin:0 0 12px;">Approve <strong id="paApproveFilename"></strong>?</p>
                <div class="dic-modal-field">
                    <label class="dic-modal-label">Approval comment (optional)</label>
                    <input type="text" class="dic-modal-input" id="paApproveComment" placeholder="Optional one-line comment for the researcher" maxlength="500">
                </div>
            </div>
            <div class="dic-modal-footer">
                <button class="dic-modal-btn" onclick="paCloseApproveModal()">Cancel</button>
                <button class="dic-modal-btn primary" id="paApproveConfirmBtn" onclick="paConfirmApprove()">Approve</button>
            </div>
        </div>
    </div>

    <!-- Discard Modal (Pending Approvals) — top-level so visible from any tab -->
    <div class="dic-modal-overlay" id="paDiscardModal">
        <div class="dic-modal">
            <div class="dic-modal-header">
                <span>Discard Submission</span>
                <button class="dic-modal-close" onclick="paCloseDiscardModal()">&times;</button>
            </div>
            <div class="dic-modal-body">
                <p style="font-size:13px;color:#374151;margin:0 0 12px;">Discard <strong id="paDiscardFilename"></strong>?</p>
                <div class="dic-modal-field">
                    <label class="dic-modal-label">Discard reason (required)</label>
                    <select class="dic-modal-select" id="paDiscardReason">
                        <option value="">Select a reason...</option>
                        <option value="Mistaken upload">Mistaken upload</option>
                        <option value="Training material">Training material</option>
                        <option value="Wrong category">Wrong category</option>
                        <option value="Duplicate">Duplicate</option>
                        <option value="Not admissible for GLP records">Not admissible for GLP records</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="dic-modal-field">
                    <label class="dic-modal-label">Note (optional)</label>
                    <input type="text" class="dic-modal-input" id="paDiscardNote" placeholder="Optional note" maxlength="500">
                </div>
                <div class="dic-modal-warning">This action is final. The file will be removed from all views but preserved for audit.</div>
            </div>
            <div class="dic-modal-footer">
                <button class="dic-modal-btn" onclick="paCloseDiscardModal()">Cancel</button>
                <button class="dic-modal-btn danger" id="paDiscardConfirmBtn" onclick="paConfirmDiscard()">Discard</button>
            </div>
        </div>
    </div>

    <!-- ==================== GROUP DOCUMENTS TAB ==================== -->
    <div class="tab-content" id="tab-group-docs">
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128218;</span> Group Docs</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadGroupDocuments()">Refresh</button>
            </div>
              <div class="gd-toggles">
                  <label class="gd-toggle">
                      <input type="checkbox" id="gdToggleUpload" checked>
                      <span class="gd-switch"></span>
                      <span class="gd-label">Upload new document</span>
                  </label>

                  <label class="gd-toggle" style="margin-top:10px;">
                      <input type="checkbox" id="gdToggleInternal">
                      <span class="gd-switch"></span>
                      <span class="gd-label">Internal documents</span>
                  </label>
              </div>

            <div class="panel-content">
                <!-- Upload Form -->
                <div id="gdUploadBlock" style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 16px;">
                    <h3 style="font-size: 14px; color: #1a365d; margin-bottom: 15px;">Upload New Document</h3>
                    <div id="groupDocMessage" class="message"></div>
                    <form id="groupDocForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="docTitle">Title *</label>
                                <input type="text" id="docTitle" required placeholder="Document title">
                            </div>
                            <div class="form-group">
                                <label for="docCategory">Category *</label>
                                <select id="docCategory" required>
                                    <option value="">Select category...</option>
                                    <option value="SOP">SOP (Standard Operating Procedure)</option>
                                    <option value="Guidelines">Guidelines</option>
                                    <option value="Templates">Templates</option>
                                    <option value="Training">Training Materials</option>
                                    <option value="Forms">Forms</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="docDescription">Description (optional)</label>
                                <textarea id="docDescription" placeholder="Brief description of the document"></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>File * (PDF, Word, Excel, PowerPoint)</label>
                                <div class="file-upload" id="groupDocUploadArea" style="padding: 15px;">
                                    <input type="file" id="groupDocFile" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx">
                                    <p class="file-upload-text" style="margin: 0;">
                                        <strong>Click to select</strong> or drag and drop
                                    </p>
                                    <p class="file-name" id="groupDocFileName" style="margin: 5px 0 0 0;"></p>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Permissions</label>
                                <div class="checkbox-group">
                                    <input type="checkbox" id="docCanDownload" checked>
                                    <label for="docCanDownload">Allow researchers to download</label>
                                </div>
                                <p style="font-size: 11px; color: #666; margin-top: 5px;">If unchecked, researchers can only view online</p>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="groupDocSubmitBtn">Upload Document</button>
                    </form>
                </div>

                <!-- Documents Table -->
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Download</th>
                            <th>Uploaded</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="groupDocsTableBody">
                        <tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== USER MANAGEMENT TAB ==================== -->
    <div class="tab-content" id="tab-user-mgmt">
        <div class="two-column">
            <!-- Add User Form -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128100;</span> Add New User</h2>
                </div>
                <div class="panel-content">
                    <div id="addUserMessage" class="message"></div>
                    <form id="addUserForm">
                        <div class="form-group">
                            <label for="newUserName">Full Name *</label>
                            <input type="text" id="newUserName" required placeholder="John Doe">
                        </div>
                        <div class="form-group">
                            <label for="newUserEmail">Institution Email *</label>
                            <input type="email" id="newUserEmail" required placeholder="john.doe@liu.se">
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="newUserAffiliation">Affiliation *</label>
                                <select id="newUserAffiliation" required>
                                    <option value="">Select...</option>
                                    <option value="LiU">LiU</option>
                                    <option value="UNAV">UNAV</option>
                                    <option value="EXTERNAL">External</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="newUserRole">Role *</label>
                                <select id="newUserRole" required>
                                    <option value="researcher">Researcher</option>
                                    <option value="supervisor">Supervisor</option>
                                    <option value="pi">Principal Investigator</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-full" id="addUserBtn">Add User</button>
                    </form>
                </div>
            </div>

            <!-- User Info -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128712;</span> User Management Info</h2>
                </div>
                <div class="panel-content">
                    <div class="message info show">
                        <strong>Deactivation Policy:</strong><br><br>
                        When a user is deactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>They cannot log in or use the system</li>
                            <li>All their historical data remains intact</li>
                            <li>Their submissions are preserved</li>
                        </ul>
                        <br>
                        When reactivated:
                        <ul style="margin: 10px 0 0 20px;">
                            <li>All previous data, roles, and submissions are restored</li>
                            <li>They can log in again with the same credentials</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delegation Section -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> Supervisor Delegation</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadDelegationData()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="delegationMessage" class="message"></div>
                <div class="form-row">
                    <!-- Promote/Demote -->
                    <div class="form-group">
                        <label>Promote/Demote Researcher</label>
                        <select id="promoteSelect" style="margin-bottom:8px;">
                            <option value="">Select a researcher...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-success" onclick="promoteToSupervisor()">Promote to Supervisor</button>
                            <button class="btn btn-sm btn-warning" onclick="demoteToResearcher()">Demote to Researcher</button>
                        </div>
                    </div>
                    <!-- Assign Researchers -->
                    <div class="form-group">
                        <label>Assign Researcher to Supervisor</label>
                        <select id="supervisorSelect" style="margin-bottom:8px;">
                            <option value="">Select supervisor...</option>
                        </select>
                        <select id="assignResearcherSelect" style="margin-bottom:8px;">
                            <option value="">Select researcher to assign...</option>
                        </select>
                        <div style="display:flex;gap:8px;">
                            <button class="btn btn-sm btn-primary" onclick="assignResearcher()">Assign</button>
                            <button class="btn btn-sm btn-danger" onclick="unassignResearcher()">Unassign</button>
                        </div>
                    </div>
                </div>
                <!-- Assignments Table -->
                <div style="margin-top:15px;">
                    <label>Current Assignments</label>
                    <table class="data-table" id="assignmentsTable">
                        <thead>
                            <tr><th>Supervisor</th><th>Researcher</th><th>Assigned</th><th>Action</th></tr>
                        </thead>
                        <tbody id="assignmentsTableBody">
                            <tr><td colspan="4" style="text-align:center;color:#666;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="panel">
            <div class="panel-header">
                <h2><span class="icon">&#128101;</span> All Users</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllUsers()">Refresh</button>
            </div>
            <div class="panel-content">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Researcher ID</th>
                            <th>Affiliation</th>
                            <th>Role</th>
                            <th>Status</th>
                            <th>Submissions</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ==================== GLP CONSOLE TAB ==================== -->
    <div class="tab-content" id="tab-glp-console">
        <div class="glpc-layout">
            <!-- LEFT PANEL -->
            <div class="glpc-left" id="glpcLeftPanel">
                <!-- Visualization Section -->
                <div class="glpc-section">
                    <div class="glpc-section-title">VISUALIZATION</div>

                    <!-- Mode Switch -->
                    <div class="glpc-mode-switch">
                        <button class="glpc-mode-btn active" id="glpcModeIndividual" onclick="glpcSetMode('individual')">Individual</button>
                        <button class="glpc-mode-btn" id="glpcModeGroup" onclick="glpcSetMode('group')">Group</button>
                    </div>

                    <!-- Individual Mode: Member List -->
                    <div id="glpcIndividualPanel">
                        <input type="text" class="glpc-search" id="glpcMemberSearch" placeholder="Search members..." oninput="glpcFilterMembers()">
                        <div class="glpc-chips" id="glpcFilterChips">
                            <button class="glpc-chip active" onclick="glpcSetMemberFilter('all', this)">All</button>
                            <button class="glpc-chip" onclick="glpcSetMemberFilter('researcher', this)">Researchers</button>
                            <button class="glpc-chip" onclick="glpcSetMemberFilter('supervisor', this)">Supervisors</button>
                            <button class="glpc-chip" onclick="glpcSetMemberFilter('LiU', this)">LiU</button>
                            <button class="glpc-chip" onclick="glpcSetMemberFilter('UNAV', this)">UNAV</button>
                        </div>
                        <div class="glpc-member-list" id="glpcMemberList">
                            <div class="glpc-empty">Loading members...</div>
                        </div>
                        <div class="glpc-group-actions" id="glpcIndividualActions" style="display:none;">
                            <button class="glpc-btn-generate" id="glpcBtnUpdateStatus" onclick="glpcUpdateSelectedProfilePreview()">Update Status</button>
                        </div>
                    </div>

                    <!-- Group Mode: Group Selector -->
                    <div id="glpcGroupPanel" style="display:none;">
                        <div class="glpc-chips">
                            <button class="glpc-chip active" id="glpcGroupBoth" onclick="glpcSelectGroup('BOTH')">Both</button>
                            <button class="glpc-chip" id="glpcGroupLiU" onclick="glpcSelectGroup('LIU')">LiU</button>
                            <button class="glpc-chip" id="glpcGroupUNAV" onclick="glpcSelectGroup('UNAV')">UNAV</button>
                        </div>
                        <!-- Group Overview Cards -->
                        <div class="glpc-overview-cards" id="glpcGroupOverview">
                            <div class="glpc-overview-card">
                                <div class="glpc-overview-label">MEMBERS</div>
                                <div class="glpc-overview-value" id="glpcGroupMembers">--</div>
                            </div>
                            <div class="glpc-overview-card">
                                <div class="glpc-overview-label">MATURITY</div>
                                <div class="glpc-overview-value" id="glpcGroupMaturity">--</div>
                            </div>
                            <div class="glpc-overview-card">
                                <div class="glpc-overview-label">WEEK DELTA</div>
                                <div class="glpc-overview-value" id="glpcGroupDelta">--</div>
                            </div>
                        </div>
                        <div class="glpc-group-actions">
                            <button class="glpc-btn-generate" id="glpcBtnGenerateGroup" onclick="glpcGenerateGroup()">Generate Group Snapshot</button>
                        </div>
                    </div>
                </div>

                <!-- Management Section -->
                <div class="glpc-section">
                    <div class="glpc-section-title">MANAGEMENT</div>
                    <div class="glpc-mgmt-tabs">
                        <button class="glpc-mgmt-tab active" onclick="glpcSetMgmtTab('LIU', this)">LiU</button>
                        <button class="glpc-mgmt-tab" onclick="glpcSetMgmtTab('UNAV', this)">UNAV</button>
                        <button class="glpc-mgmt-tab" onclick="glpcSetMgmtTab('EXTERNAL', this)">External</button>
                    </div>
                    <div class="glpc-mgmt-filter">
                        <label class="glpc-toggle-label">
                            <input type="checkbox" id="glpcShowInactive" onchange="glpcLoadMgmt(glpcCurrentMgmtCohort)"> Show inactive
                        </label>
                    </div>
                    <div class="glpc-mgmt-list" id="glpcMgmtList">
                        <div class="glpc-empty">Loading...</div>
                    </div>
                    <div class="glpc-mgmt-actions">
                        <button class="glpc-btn-apply" id="glpcApplyBtn" onclick="glpcApplyMgmt()" disabled>Apply Changes</button>
                        <span class="glpc-saved-msg" id="glpcSavedMsg"></span>
                    </div>
                </div>
            </div>

            <!-- RIGHT PANEL: GLP Status Viewer -->
            <div class="glpc-right" id="glpcRightPanel">
                <!-- Trajectory Insights Toggle -->
                <div class="glpc-trajectory-header">
                    <label class="glpc-toggle-label">
                        <input type="checkbox" id="glpcTrajectoryToggle" onchange="glpcToggleTrajectory()">
                        Trajectory Insights
                    </label>
                </div>

                <!-- Trajectory Insights Panel (hidden by default) -->
                <div class="glpc-trajectory-panel" id="glpcTrajectoryPanel" style="display:none;">
                    <div class="glpc-trajectory-grid">
                        <div class="glpc-trajectory-item">
                            <div class="glpc-trajectory-label">TRAJECTORY</div>
                            <div class="glpc-trajectory-value" id="glpcTrajSlope">--</div>
                        </div>
                        <div class="glpc-trajectory-item">
                            <div class="glpc-trajectory-label">VOLATILITY</div>
                            <div class="glpc-trajectory-value" id="glpcTrajVolatility">--</div>
                        </div>
                        <div class="glpc-trajectory-item glpc-trajectory-wide">
                            <div class="glpc-trajectory-label">TOP DOMAINS DRIVING CHANGE</div>
                            <div class="glpc-trajectory-value" id="glpcTrajDomains">--</div>
                        </div>
                    </div>
                    <div class="glpc-trajectory-suggestions" id="glpcTrajSuggestions"></div>
                </div>

                <!-- GLP Status Viewer (replicates upload.html structure) -->
                <div class="glpWrap" id="glpcViewer">
                    <div class="glpc-empty-state" id="glpcEmptyState">
                        <div class="glpc-empty-icon">
                            <img src="/assets/glp-icons/Owl.png" alt="GLP" style="width:64px;opacity:0.5;">
                        </div>
                        <div class="glpc-empty-title">Select a member or group</div>
                        <div class="glpc-empty-sub">Choose an individual member from the list or switch to Group mode to view aggregated GLP status.</div>
                    </div>

                    <!-- A. Header card -->
                    <div class="glpCard" id="glpcHeaderCard" style="display:none;">
                        <div class="glpHdr__topRow">
                            <span class="glpHdr__title">GLP Status</span>
                            <div class="glpWeekSelector" id="glpcWeekSelector">
                                <button class="glpWeekNav" id="glpcWeekPrev" onclick="glpcNavWeek(-1)" title="Previous week" disabled>&lsaquo;</button>
                                <span class="glpWeekLabel" id="glpcWeekLabel">--</span>
                                <button class="glpWeekNav" id="glpcWeekNext" onclick="glpcNavWeek(1)" title="Next week" disabled>&rsaquo;</button>
                            </div>
                        </div>
                        <div class="glpHdr__mainRow">
                            <div class="glpHdr__mainLeft">
                                <div class="glpName" id="glpcName"></div>
                                <div class="glpBadgeRow">
                                    <span class="glpBadge glpBadge--role" id="glpcRoleBadge"></span>
                                    <span class="glpBadge glpBadge--aff" id="glpcAffiliationBadge"></span>
                                </div>
                            </div>
                        </div>
                        <div class="glpHdr__divider"></div>
                        <div class="glpHdr__statusRow">
                            <div id="glpcMaturityIcon">
                                <img src="/assets/glp-icons/Owl.png" alt="Owl" />
                            </div>
                            <div class="glpHdr__statusText">
                                <div class="glpHdr__maturityLine" id="glpcStateText">GLP in development</div>
                                <div class="glpHdr__qualifierLine" id="glpcQualifier">Partial implementation</div>
                            </div>
                            <div class="glpHdr__timestamp" id="glpcLastUpdated">Last updated: &mdash;</div>
                        </div>
                    </div>

                    <!-- B. Evidence Harmony card -->
                    <div class="glpCard" id="glpcEvidenceCard" style="display:none;">
                        <div class="glpMicroTitle">Evidence Harmony</div>
                        <div class="glpVisionTable" id="glpcVisionTable">
                            <div class="glpVT__row">
                                <div class="glpVT__cell">
                                    <div class="glpVT__label">Overall</div>
                                    <div class="glpVT__score" id="glpcVTOverall">--</div>
                                    <div class="glpVT__delta" id="glpcVTOverallDelta"></div>
                                </div>
                                <div class="glpVT__cell">
                                    <div class="glpVT__label">Documentation</div>
                                    <div class="glpVT__score" id="glpcVTDoc">--</div>
                                    <div class="glpVT__delta" id="glpcVTDocDelta"></div>
                                </div>
                                <div class="glpVT__cell">
                                    <div class="glpVT__label">Training</div>
                                    <div class="glpVT__score" id="glpcVTTrain">--</div>
                                    <div class="glpVT__delta" id="glpcVTTrainDelta"></div>
                                </div>
                                <div class="glpVT__cell">
                                    <div class="glpVT__label">Traceability</div>
                                    <div class="glpVT__score" id="glpcVTTrace">--</div>
                                    <div class="glpVT__delta" id="glpcVTTraceDelta"></div>
                                </div>
                                <div class="glpVT__cell">
                                    <div class="glpVT__label">Data Integrity</div>
                                    <div class="glpVT__score" id="glpcVTData">--</div>
                                    <div class="glpVT__delta" id="glpcVTDataDelta"></div>
                                </div>
                            </div>
                        </div>
                        <div class="glpMiniCards">
                            <div class="glpMiniCard">
                                <div class="glpMiniCard__title">SOPs</div>
                                <div class="glpMiniCard__big" id="glpcSopApproved">--</div>
                                <div class="glpMiniCard__coverage" id="glpcSopCoverage">--</div>
                            </div>
                            <div class="glpMiniCard">
                                <div class="glpMiniCard__title">Experiments</div>
                                <div class="glpMiniCard__big" id="glpcExpReported">--</div>
                                <div class="glpMiniCard__coverage" id="glpcExpCoverage">--</div>
                            </div>
                            <div class="glpMiniCard">
                                <div class="glpMiniCard__title">Inventory</div>
                                <div class="glpMiniCard__big" id="glpcInvTotal">--</div>
                                <div class="glpMiniCard__row"><span>Products</span><span class="glpMiniCard__rowVal" id="glpcInvProducts">--</span></div>
                                <div class="glpMiniCard__row"><span>Samples</span><span class="glpMiniCard__rowVal" id="glpcInvSamples">--</span></div>
                                <div class="glpMiniCard__row"><span>Oligos</span><span class="glpMiniCard__rowVal" id="glpcInvOligos">--</span></div>
                            </div>
                        </div>

                        <!-- Harmony Map section -->
                        <div class="glpHarmonyMap" id="glpcHarmonyMapWrap">
                            <div class="glpHarmonyMap__title">Harmony Map</div>
                            <div class="glpHarmonyMap__sub">SOPs, Data, Inventory, and Training alignment</div>
                            <div class="glpHarmonyMap__body">
                                <div class="glpHarmonyPanel glpHarmonyPanel--left">
                                    <div class="glpHarmonyPanel__title">GLP coherence wins this week</div>
                                    <ul class="glpHarmonyPanel__list" id="glpcHarmonyWins">
                                        <li class="glpHarmonyPanel__item">&mdash;</li>
                                    </ul>
                                </div>
                                <img class="glpHarmonyImg" src="/assets/glp/harmony-map.png" alt="Harmony Map showing SOP, Data, Inventory, and Training alignment"/>
                                <div class="glpHarmonyPanel glpHarmonyPanel--right">
                                    <div>
                                        <div class="glpHarmonyPanel__title">Best coherence upgrade next week</div>
                                        <ul class="glpHarmonyPanel__list">
                                            <li class="glpHarmonyPanel__item" id="glpcHarmonyUpgrade">&mdash;</li>
                                        </ul>
                                    </div>
                                    <div style="margin-top:14px;">
                                        <div class="glpHarmonyPanel__title">Trend vs previous weeks</div>
                                        <p class="glpHarmonyPanel__text" id="glpcHarmonyTrend">&mdash;</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- C. GLP Conformity card -->
                    <div class="glpCard" id="glpcConformityCard" style="display:none;">
                        <div class="glpMicroTitle">GLP Conformity</div>
                        <div class="glpConformityInner">
                            <div class="glpConfContent">
                                <div class="glpConfSection">
                                    <div class="glpConfSection__title">What is working well</div>
                                    <ul class="glpConfSection__list" id="glpcConfWorking"></ul>
                                </div>
                                <div class="glpConfSection">
                                    <div class="glpConfSection__title">Main improvement for next week</div>
                                    <ul class="glpConfSection__list" id="glpcConfImprovement"></ul>
                                </div>
                                <div class="glpConfSection">
                                    <div class="glpConfSection__title">Trend vs previous weeks</div>
                                    <p class="glpConfSection__text" id="glpcConfTrend"></p>
                                </div>
                                <div class="glpConfSection">
                                    <div class="glpConfSection__title">Focus for the coming week</div>
                                    <ul class="glpConfSection__list" id="glpcConfFocus"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== BACKUP TAB ==================== -->
    <div class="tab-content" id="tab-backup">
        <!-- Description -->
        <div class="message info show" style="margin-bottom:20px;display:block;">
            This section provides secure access to verified backup copies of all laboratory data. Primary data are continuously stored in the system and replicated to an independent backup storage as immutable snapshots. Backups protect against accidental deletion, corruption, or system failure and do not affect ongoing work unless explicitly used.
        </div>

        <!-- Recovery Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Recovery</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadBackupSnapshots()">Refresh</button>
            </div>
            <div class="panel-content">
                <div id="backupMessage" class="message"></div>

                <!-- Step 1: Select Snapshot -->
                <div class="form-group">
                    <label>Select Recovery Point</label>
                    <select id="backupSnapshotSelect" onchange="clearBackupPreview()">
                        <option value="">Select a recovery point...</option>
                    </select>
                </div>

                <div style="margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="previewBackupRecovery()">Preview Comparison</button>
                </div>

                <!-- Step 2: Preview Summary -->
                <div id="backupPreviewContainer" style="display:none;">
                    <div class="stats-row" style="margin-bottom:10px;">
                        <div class="stat-card">
                            <div class="stat-value" id="bkpBackupCount">0</div>
                            <div class="stat-label">Files in Backup</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="bkpR2Count">0</div>
                            <div class="stat-label">Files in Storage</div>
                        </div>
                        <div class="stat-card pending">
                            <div class="stat-value" id="bkpDiffCount">0</div>
                            <div class="stat-label">Estimated Difference</div>
                        </div>
                    </div>
                    <p id="backupSummaryText" style="color:#555;margin-bottom:15px;font-size:14px;"></p>

                    <!-- Step 3: Recovery Mode -->
                    <div class="form-group">
                        <label>Recovery Mode</label>
                        <select id="backupRecoveryMode">
                            <option value="add-missing">Add missing files only (recommended)</option>
                            <option value="full-restore">Full restore from backup</option>
                        </select>
                    </div>
                    <button class="btn btn-warning" onclick="confirmBackupRecovery()" id="backupRecoverBtn">Start Recovery</button>
                </div>

                <!-- Recovery Progress -->
                <div id="backupRecoveryProgress" style="display:none;margin-top:15px;">
                    <div class="loading"><div class="spinner"></div>Recovery in progress. This may take several minutes.</div>
                </div>

                <!-- Recovery Result -->
                <div id="backupRecoveryResult" style="display:none;margin-top:15px;"></div>
            </div>
        </div>

        <!-- Download Section -->
        <div class="panel">
            <div class="panel-header">
                <h2>Download</h2>
            </div>
            <div class="panel-content">
                <p style="color:#555;margin-bottom:15px;font-size:14px;">Download current data directly from storage as ZIP files. Choose by researcher, by date range, or download everything. For large selections, multi-file download is recommended.</p>
                <div id="dlMessage" class="message"></div>

                <!-- Main buttons -->
                <div id="dlButtons" style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-primary" onclick="dlStartFlow('researcher')">Download by Researcher</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('daterange')">Download by Date Range</button>
                    <button class="btn btn-primary" onclick="dlStartFlow('full')">Full Data Download</button>
                </div>

                <!-- Flow container -->
                <div id="dlFlow" style="display:none;">
                    <div style="margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                        <button class="btn btn-sm btn-secondary" onclick="dlReset()">&larr; Back</button>
                        <span id="dlFlowTitle" style="font-weight:600;font-size:15px;"></span>
                        <span id="dlStepLabel" style="color:#888;font-size:13px;margin-left:auto;"></span>
                    </div>
                    <div id="dlStepContent"></div>
                    <div id="dlStepActions" style="margin-top:15px;display:flex;gap:10px;"></div>
                </div>

                <!-- Download progress / multi-part tracker -->
                <div id="dlProgress" style="display:none;margin-top:15px;"></div>
            </div>
        </div>
    </div>

    <!-- ==================== PURCHASES & INVENTORY TAB ==================== -->
    <div class="tab-content" id="tab-purchases-inventory">

        <!-- Purchase Requests for PI Review -->
        <div class="panel">
            <div class="panel-header">
                <h2>Purchase Requests</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllPurchaseRequests()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
                    <select id="prFilterStatus" onchange="loadAllPurchaseRequests()" style="padding:6px;border-radius:4px;border:1px solid #ddd;font-size:13px;">
                        <option value="">All Statuses</option>
                        <option value="SUBMITTED" selected>Submitted</option>
                        <option value="APPROVED">Approved</option>
                        <option value="DECLINED">Declined</option>
                        <option value="PENDING_CHANGES">Pending Changes</option>
                    </select>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="data-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Requester</th>
                                <th>Affil.</th>
                                <th>Justification</th>
                                <th>Items</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="prAllTableBody">
                            <tr><td colspan="8" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Purchase Request Detail (hidden by default) -->
        <div class="panel" id="prDetailPanel" style="display:none;">
            <div class="panel-header">
                <h2 id="prDetailTitle">Request Detail</h2>
                <button class="btn btn-sm btn-secondary" onclick="closePrDetail()">Close</button>
            </div>
            <div class="panel-content">
                <div id="prDetailJustification" style="margin-bottom:10px;padding:8px 12px;background:#f8f9fa;border-radius:4px;font-size:13px;"></div>
                <table class="data-table" style="font-size:13px;">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Product</th>
                            <th>Catalog ID</th>
                            <th>Link</th>
                            <th>Qty</th>
                            <th>Unit Price</th>
                            <th>Total</th>
                            <th>Ordered</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="prDetailItemsBody"></tbody>
                    <tfoot>
                        <tr><td colspan="6" style="text-align:right;font-weight:600;">Request Total:</td><td id="prDetailTotal" style="font-weight:700;" colspan="3"></td></tr>
                    </tfoot>
                </table>
                <div id="prDetailActions" style="margin-top:12px;display:flex;gap:10px;"></div>
            </div>
        </div>

        <!-- Consolidated Email (PI) -->
        <div class="panel">
            <div class="panel-header">
                <h2>Consolidated Purchase Email</h2>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:10px;">
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('LiU')">Load LiU</button>
                    <button class="btn btn-sm btn-primary" onclick="loadConsolidatedEmail('UNAV')">Load UNAV</button>
                </div>
                <div id="prConsolidatedArea" style="display:none;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                        <strong id="prConsolidatedTitle"></strong>
                        <button class="btn btn-sm btn-success" onclick="copyConsolidatedEmail()">Copy email text</button>
                    </div>
                    <pre id="prConsolidatedText" style="background:#f8f9fa;padding:12px;border-radius:4px;font-size:12px;white-space:pre-wrap;max-height:400px;overflow-y:auto;border:1px solid #ddd;"></pre>
                </div>
                <div id="prConsolidatedEmpty" style="display:none;text-align:center;color:#999;padding:10px;">No approved items to order for this affiliation.</div>
            </div>
        </div>

        <!-- PO Numbers -->
        <div class="panel">
            <div class="panel-header">
                <h2>PO Numbers</h2>
            </div>
            <div class="panel-content">
                <input type="text" id="poSearchInput" oninput="searchPONumbers()" placeholder="Search by PO number, product, or researcher..."
                       style="width:100%;padding:8px 12px;border:1px solid #ddd;border-radius:4px;font-size:13px;margin-bottom:12px;box-sizing:border-box;">
                <table class="data-table" style="font-size:13px;">
                    <thead><tr><th>Product</th><th>Researcher</th><th>Date</th><th>PO Number</th><th>Status</th></tr></thead>
                    <tbody id="poTableBody"><tr><td colspan="5" style="text-align:center;color:#999;">Click tab to load data</td></tr></tbody>
                </table>
            </div>
        </div>

        <!-- Inventory Management -->
        <div class="panel">
            <div class="panel-header">
                <h2>Inventory Management</h2>
                <button class="btn btn-sm btn-secondary" onclick="loadAllInventoryV2()">Refresh</button>
            </div>
            <div class="panel-content">
                <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                    <select id="invV2FilterType" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Types</option>
                        <option value="product">Products</option>
                        <option value="sample">Samples</option>
                        <option value="oligo">Oligos</option>
                    </select>
                    <select id="invV2FilterAffiliation" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Affiliations</option>
                        <option value="LiU">LiU</option>
                        <option value="UNAV">UNAV</option>
                    </select>
                    <select id="invV2FilterVisibility" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Visibility</option>
                        <option value="personal">Personal</option>
                        <option value="group">Group</option>
                    </select>
                    <select id="invV2FilterStatus" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Statuses</option>
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Revision">Revision</option>
                        <option value="Rejected">Rejected</option>
                        <option value="Received">Received</option>
                        <option value="ConsumePending">ConsumePending</option>
                        <option value="TransferPending">TransferPending</option>
                        <option value="ApprovedLinked">ApprovedLinked</option>
                        <option value="Consumed">Consumed</option>
                        <option value="DeletePending">DeletePending</option>
                        <option value="Deleted">Deleted</option>
                    </select>
                    <select id="invV2FilterSource" onchange="loadAllInventoryV2()" style="padding:6px;border-radius:4px;border:1px solid #ddd;">
                        <option value="">All Sources</option>
                        <option value="Online">Online</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div style="max-height:500px;overflow-y:auto;">
                    <table class="data-table" style="font-size:13px;">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Identifier</th>
                                <th>Affiliation</th>
                                <th>Owner</th>
                                <th>Qty</th>
                                <th>Unit</th>
                                <th>Storage</th>
                                <th>Status</th>
                                <th>Scope</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invV2AllTableBody">
                            <tr><td colspan="11" style="text-align:center;color:#999;">Click tab to load data</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== TRAINING & APPROVALS TAB ==================== -->
    <div class="tab-content" id="tab-training">
        <!-- Toggle between Design, Management, Certifications, and My Training -->
        <div style="display:flex;gap:10px;margin-bottom:20px;">
            <button class="btn btn-primary" id="toggleTrainingDesign" onclick="showTrainingToggle('design')" style="flex:1;">Training Design</button>
            <button class="btn btn-secondary" id="toggleTrainingMgmt" onclick="showTrainingToggle('management')" style="flex:1;">Training Management</button>
            <button class="btn btn-secondary" id="toggleTrainingCerts" onclick="showTrainingToggle('certifications')" style="flex:1;">Certifications</button>
            <a href="upload.html?section=training" class="btn btn-secondary" style="flex:1;text-align:center;text-decoration:none;">My Training Pack</a>
        </div>

        <!-- TRAINING DESIGN -->
        <div id="trainingDesignView">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128218;</span> Training Documents</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadTrainingDocuments()">Refresh</button>
                </div>
                <div class="panel-content">
                    <!-- Upload form -->
                    <div style="background:#f8f9fa;padding:20px;border-radius:8px;margin-bottom:20px;">
                        <h3 style="font-size:14px;color:#1a365d;margin-bottom:15px;">Upload New Document</h3>
                        <div id="trainDocMessage" class="message"></div>
                        <form id="trainDocForm">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocTitle">Title *</label>
                                    <input type="text" id="trainDocTitle" required placeholder="Document title">
                                </div>
                                <div class="form-group">
                                    <label for="trainDocCategory">Category *</label>
                                    <select id="trainDocCategory" required>
                                        <option value="">Select...</option>
                                        <option value="Guidelines">Guidelines</option>
                                        <option value="Authorship">Authorship</option>
                                        <option value="Safety">Safety</option>
                                        <option value="Other">Other</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocAffiliation">Applies to *</label>
                                    <select id="trainDocAffiliation" required>
                                        <option value="All">All</option>
                                        <option value="LiU">LiU</option>
                                        <option value="UNAV">UNAV</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="trainDocRule">Requirement *</label>
                                    <select id="trainDocRule" required>
                                        <option value="Always">Always</option>
                                        <option value="Conditional">Conditional</option>
                                        <option value="Optional">Optional</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="trainDocCondKey">Condition Key</label>
                                    <input type="text" id="trainDocCondKey" placeholder="e.g. MICROBIOLOGY_ACCESS">
                                </div>
                                <div class="form-group">
                                    <label for="trainDocCondNote">Condition Note</label>
                                    <input type="text" id="trainDocCondNote" placeholder="Display text for condition">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>PDF File *</label>
                                <div class="file-upload" id="trainDocUploadArea" style="padding:15px;">
                                    <input type="file" id="trainDocFile" accept=".pdf">
                                    <p class="file-upload-text" style="margin:0;"><strong>Click to select</strong> or drag and drop</p>
                                    <p class="file-name" id="trainDocFileName" style="margin:5px 0 0 0;"></p>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary" id="trainDocSubmitBtn">Upload Document</button>
                        </form>
                    </div>
                    <!-- Document list -->
                    <table class="data-table" id="trainDocsTable">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Category</th>
                                <th>Applies to</th>
                                <th>Rule</th>
                                <th>Current Version</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trainDocsTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRAINING MANAGEMENT -->
        <div id="trainingMgmtView" style="display:none;">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending Training Packs</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPendingTrainingPacks()">Refresh</button>
                </div>
                <div class="panel-content">
                    <div id="pendingPacksMessage" class="message"></div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Affiliation</th>
                                <th>Version</th>
                                <th>Agreements</th>
                                <th>Trainings</th>
                                <th>Submitted</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pendingPacksTableBody">
                            <tr><td colspan="7" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                    <!-- Pack detail expansion area -->
                    <div id="packDetailArea" style="display:none;margin-top:20px;background:#f8f9fa;padding:20px;border-radius:8px;">
                        <h3 style="font-size:14px;color:#1a365d;margin-bottom:10px;" id="packDetailTitle">Pack Details</h3>
                        <div id="packDetailContent"></div>
                    </div>
                </div>
            </div>

            <!-- Sealed packs summary -->
            <div class="panel" style="margin-top:20px;">
                <div class="panel-header">
                    <h2><span class="icon">&#9989;</span> Sealed Training Packs</h2>
                </div>
                <div class="panel-content">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Researcher</th>
                                <th>Seal</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sealedPacksTableBody">
                            <tr><td colspan="3" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CERTIFICATIONS (PI route entries awaiting PI certification) -->
        <div id="trainingCertsView" style="display:none;">
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128203;</span> Pending PI Certifications</h2>
                    <button class="btn btn-sm btn-secondary" onclick="loadPiPendingCerts()">Refresh</button>
                </div>
                <div class="panel-content">
                    <p style="font-size:12px;color:#666;margin-bottom:10px;">Training entries routed to PI for certification (other supervisor / delegated delivery).</p>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Trainee</th>
                                <th>Training Type</th>
                                <th>Date</th>
                                <th>Other Supervisor</th>
                                <th>Notes</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="piCertsTableBody">
                            <tr><td colspan="6" style="text-align:center;color:#999;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== INTERNAL DOCUMENTS TAB ==================== -->
    <div class="tab-content" id="tab-internal-docs">
        <div class="two-column">
            <!-- Upload Zone -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128194;</span> Upload Internal Documents</h2>
                </div>
                <div class="panel-content">
                    <div id="intdocUploadMsg" style="display:none;padding:8px;font-size:12px;margin-bottom:10px;border-radius:4px;"></div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="intdocCategory" onchange="intdocCategoryChanged()">
                            <option value="papers">Papers</option>
                            <option value="projects">Projects</option>
                            <option value="grants">Grants</option>
                            <option value="collaborators">Collaborators</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group" id="intdocFolderGroup" style="display:none;">
                        <label>Folder</label>
                        <select id="intdocFolderSelect" style="margin-bottom:6px;">
                            <option value="">Select folder...</option>
                        </select>
                        <input type="text" id="intdocNewFolder" placeholder="Or type new folder name" style="padding:6px 10px;border:1px solid #ddd;border-radius:4px;font-size:13px;width:100%;box-sizing:border-box;">
                    </div>
                    <div class="form-group">
                        <label>PDF Files</label>
                        <input type="file" id="intdocFiles" accept=".pdf" multiple style="font-size:13px;">
                    </div>
                    <button class="btn btn-primary btn-full" id="intdocUploadBtn" onclick="intdocUpload()">Upload</button>
                </div>
            </div>

            <!-- Management Zone -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128218;</span> Document Manager</h2>
                    <button class="btn btn-sm btn-secondary" onclick="intdocLoadTree()">Refresh</button>
                </div>
                <div class="panel-content" style="max-height:600px;overflow-y:auto;">
                    <div id="intdocTree">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                    <div id="intdocFilePanel" style="display:none;margin-top:15px;border-top:1px solid #e0e0e0;padding-top:15px;">
                        <h3 id="intdocFilePanelTitle" style="margin:0 0 10px;font-size:14px;color:#1a365d;"></h3>
                        <div id="intdocFilePanelList"></div>
                    </div>
                    <div style="margin-top:20px;border-top:1px solid #e0e0e0;padding-top:15px;">
                        <button class="btn btn-sm" onclick="intdocToggleTrash()" style="font-size:12px;color:#666;background:none;border:1px solid #ddd;padding:4px 10px;border-radius:4px;cursor:pointer;">&#128465; Trash</button>
                        <div id="intdocTrashPanel" style="display:none;margin-top:10px;">
                            <div id="intdocTrashList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // =====================================================
        // GLOBAL STATE & INIT
        // =====================================================
        let currentUser = null;
        let allMembers = [];
        let labFilesData = [];
        let selectedLabFiles = new Set();

        // Check authentication and PI role
        async function checkAuth() {
            try {
                const response = await fetch('/api/di/me', { credentials: 'include' });
                if (response.status === 401) { window.location.href = 'access.html'; return; }
                const data = await response.json();
                currentUser = data.user || data;

                // Check if user is PI
                const role = (currentUser.role || "").toUpperCase();
                if (role !== "PI" && role !== "ADMIN") {
                    window.location.href = 'upload.html';
                    return;
                }

                document.getElementById('userName').textContent = currentUser.researcher_id;

                // Load initial data
                loadDashboardData();
                populateResearcherDropdown();
                loadGroupDocuments();
                loadAllUsers();} catch (err) {
                window.location.href = 'access.html';
            }
        }
          checkAuth();
        // =====================================================
          // TAB NAVIGATION
          // =====================================================
          document.querySelectorAll('.tab-btn').forEach(btn => {
              btn.addEventListener('click', () => {
                  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                  btn.classList.add('active');

                  const tabId = btn.dataset.tab;

                  // Special handling: Group Docs has an INTERNAL sub-mode
                  if (tabId === 'group-docs' && typeof gdOpenMode === 'function') { gdOpenMode('docs'); return; }
                  if (tabId !== 'group-docs' && typeof _gdSetPill === 'function') { _gdSetPill('docs'); }

                  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                  const el = document.getElementById('tab-' + tabId);
                  if (el) el.classList.add('active');

                  if (tabId === 'lab-files') dicInit();
                  if (tabId === 'glp-console') glpcInit();
                  if (tabId === 'purchases-inventory') { loadAllPurchaseRequests(); loadAllInventoryV2(); loadPONumbers(); }
                  if (tabId === 'training') { loadTrainingDocuments(); loadPendingTrainingPacks(); loadSealedTrainingPacks(); }
              });
          });

          function dicOpenTopTab(tabId) {
              if (!tabId) return;

              if (tabId === 'group-docs' && typeof gdOpenMode === 'function') { gdOpenMode('docs'); return; }
              if (tabId !== 'group-docs' && typeof _gdSetPill === 'function') { _gdSetPill('docs'); }

              const btn = document.querySelector('.tab-btn[data-tab="' + tabId + '"]');
              document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
              if (btn) btn.classList.add('active');

              document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
              const el = document.getElementById('tab-' + tabId);
              if (el) el.classList.add('active');

              if (tabId === 'lab-files') dicInit();
              if (tabId === 'glp-console') glpcInit();
              if (tabId === 'purchases-inventory') { loadAllPurchaseRequests(); loadAllInventoryV2(); loadPONumbers(); }
              if (tabId === 'training') { loadTrainingDocuments(); loadPendingTrainingPacks(); loadSealedTrainingPacks(); }
          }

function dicInitEmbedModeFromUrl() {
  try {
    const u = new URL(window.location.href);
    const isEmbed = u.searchParams.get('embed') === '1';
    if (!isEmbed) return;

    const userId = u.searchParams.get('user') || '';
    const mode = (u.searchParams.get('mode') || '').toLowerCase(); // training | inventory | onetoone | all

    window.dicEmbed = true;
    window.dicEmbedUserId = userId;
    window.dicEmbedMode = mode;

    document.body.classList.add('embed-mode');

    // Force GLP Vision tab visible
    try { dicOpenTopTab('lab-files'); } catch(e) {}

    // dicInit is async (loads DIC data + sidebar structures)
    if (typeof dicInit === 'function') {
      Promise.resolve(dicInit()).then(() => {
        try {
          // Apply researcher filter (this drives the Vision context)
          if (userId && typeof dicSetSidebarFilter === 'function') {
            dicSetSidebarFilter('researcher', userId);
          }

          // Activate the requested vision mode
          const want = (mode === 'training' || mode === 'inventory' || mode === 'onetoone') ? mode : 'all';
          const btn = document.querySelector('.dic-vision-btn[onclick*="\'' + want + '\'"]') ||
                      document.querySelector('.dic-vision-btn');
          if (typeof dicSetVisionMode === 'function') {
            dicSetVisionMode(want, btn);
          }
        } catch(e) {}
      }).catch(() => {});
    }
  } catch (e) {}
}


          dicInitEmbedModeFromUrl();

// =====================================================
          // GROUP DOCS MODE TOGGLE (UPLOAD | INTERNAL)
          // =====================================================
          function _gdSetInternalToggle(on) {
              const t = document.getElementById("gdToggleInternal");
              if (t) t.checked = !!on;
          }

          function _gdActivateTopTab() {
              const top = document.querySelector('.tab-btn[data-tab="group-docs"]');
              if (!top) return;
              document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
              top.classList.add('active');
          }

          function gdOpenMode(mode) {
              if (mode === "internal") {
                  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                  const el = document.getElementById("tab-internal-docs");
                  if (el) el.classList.add('active');
                  _gdActivateTopTab();
                  _gdSetInternalToggle(true);
                  if (typeof intdocInit === "function") intdocInit();
                  return;
              }
              // default: group docs
              document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
              const el = document.getElementById("tab-group-docs");
              if (el) el.classList.add('active');
              _gdActivateTopTab();
              _gdSetInternalToggle(false);
              if (typeof loadGroupDocuments === "function") loadGroupDocuments();
          }

          (function _wireGroupDocsToggles() {
              const tInternal = document.getElementById("gdToggleInternal");
              if (tInternal) {
                  tInternal.addEventListener("change", () => {
                      gdOpenMode(tInternal.checked ? "internal" : "docs");
                  });
              }

              const tUpload = document.getElementById("gdToggleUpload");
              const uploadBlock = document.getElementById("gdUploadBlock");
              function applyUploadVis() {
                  if (!tUpload || !uploadBlock) return;
                  uploadBlock.style.display = tUpload.checked ? "" : "none";
              }
              if (tUpload) tUpload.addEventListener("change", applyUploadVis);
              applyUploadVis();
          })();

          // =====================================================


        // DASHBOARD TAB
        // =====================================================
        async function loadDashboardData() {
            loadPendingApprovals();
            loadStats();
            // loadInventoryBadge removed (CSV imports deprecated)
        }

        async function loadStats() {
            try {
                const response = await fetch('/api/di/metrics', { credentials: 'include' });
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('statPending').textContent = data.byStatus?.PENDING || 0;
                    document.getElementById('statApproved').textContent = data.byStatus?.APPROVED || 0;
                    document.getElementById('statRevision').textContent = data.openRevisionRequests ?? data.byStatus?.REVISION_NEEDED ?? 0;
                    document.getElementById('statTotal').textContent = data.total || 0;

                    // Update badge
                    const pending = data.byStatus?.PENDING || 0;
                    const badge = document.getElementById('pendingBadge');
                    if (pending > 0) {
                        badge.textContent = pending;
                        badge.style.display = 'inline';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (err) {
                console.error('Error loading stats:', err);
            }
        }

        async function loadPendingApprovals() {
            const container = document.getElementById('pendingApprovalsContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const response = await fetch('/api/di/pending-approvals', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                // Filter out INVENTORY submissions — they are reviewed in Purchases & Inventory tab
                data.submissions = (data.submissions || []).filter(s => s.file_type !== 'INVENTORY');
                // Cache for modal lookups (avoids single-quote injection in onclick)
                window._paSubmissions = {};
                data.submissions.forEach(s => { window._paSubmissions[s.submission_id] = s; });

                if (!data.submissions || data.submissions.length === 0) {
                    container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No pending approvals</p>';
                    return;
                }

                container.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>File</th>
                                <th>Researcher</th>
                                <th>Type</th>
                                <th>Origin Date</th>
                                <th>Uploaded</th>
                                <th>AI Review</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.submissions.map(s => {
                                const aiScore = s.ai_review?.score;
                                const aiClass = aiScore >= 80 ? 'high' : aiScore >= 50 ? 'medium' : 'low';
                                const date = new Date(s.created_at).toLocaleDateString();
                                const isLegacy = s.record_origin === 'legacy_pre2026';
                                const originDate = isLegacy && s.original_created_at ? new Date(s.original_created_at).toLocaleDateString() : '-';
                                const legacyBadge = isLegacy ? '<span class="legacy-badge">LEGACY</span>' : '';
                                return `
                                    <tr>
                                        <td title="${escapeHtml(s.original_filename)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(s.original_filename)}</td>
                                        <td>${escapeHtml(s.researcher_id)}</td>
                                        <td><span class="type-badge ${s.file_type?.toLowerCase()}">${s.file_type}</span>${legacyBadge}</td>
                                        <td>${originDate}</td>
                                        <td>${date}</td>
                                        <td>${aiScore !== undefined ? `<span class="ai-score ${aiClass}">${aiScore}%</span>` : '<span style="color:#999;">-</span>'}</td>
                                        <td>
                                            <div class="actions">
                                                <button class="btn btn-sm btn-primary" onclick="viewFile('${s.submission_id}')">View</button>
                                                <button class="btn btn-sm btn-success" onclick="quickApprove('${s.submission_id}')">Approve</button>
                                                <button class="btn btn-sm btn-warning" onclick="quickRevise('${s.submission_id}')">Revise</button>
                                                <button class="btn btn-sm btn-danger" onclick="quickDiscard('${s.submission_id}')">Discard</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading pending approvals</p>';
            }
        }

        function viewFile(id) {
            window.open(`/api/di/download/${id}`, '_blank');
        }

        // --- Approve modal ---
        let paApproveTargetId = null;

        function quickApprove(id) {
            paApproveTargetId = id;
            const s = (window._paSubmissions || {})[id];
            document.getElementById('paApproveFilename').textContent = s ? s.original_filename : id;
            document.getElementById('paApproveComment').value = '';
            document.getElementById('paApproveConfirmBtn').disabled = false;
            document.getElementById('paApproveModal').classList.add('active');
        }

        function paCloseApproveModal() {
            document.getElementById('paApproveModal').classList.remove('active');
            paApproveTargetId = null;
        }

        async function paConfirmApprove() {
            if (!paApproveTargetId) return;
            const btn = document.getElementById('paApproveConfirmBtn');
            btn.disabled = true;
            btn.textContent = 'Approving...';
            try {
                const comment = document.getElementById('paApproveComment').value.trim();
                const resp = await fetch(`/api/di/approve-inline/${paApproveTargetId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ approval_comment: comment || undefined })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    paCloseApproveModal();
                    alert('Approved');
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert(data.error || 'Failed to approve');
                }
            } catch (err) {
                alert('Error approving submission');
            }
            btn.disabled = false;
            btn.textContent = 'Approve';
        }

        // --- Discard modal ---
        let paDiscardTargetId = null;

        function quickDiscard(id) {
            paDiscardTargetId = id;
            const s = (window._paSubmissions || {})[id];
            document.getElementById('paDiscardFilename').textContent = s ? s.original_filename : id;
            document.getElementById('paDiscardReason').value = '';
            document.getElementById('paDiscardNote').value = '';
            document.getElementById('paDiscardConfirmBtn').disabled = false;

            // Add/remove legacy-specific discard reason
            const sel = document.getElementById('paDiscardReason');
            const legacyOpt = sel.querySelector('[value="Refused by PI (legacy)"]');
            if (s && s.record_origin === 'legacy_pre2026') {
                if (!legacyOpt) {
                    const opt = document.createElement('option');
                    opt.value = 'Refused by PI (legacy)';
                    opt.textContent = 'Refused by PI (legacy)';
                    const otherOpt = sel.querySelector('[value="Other"]');
                    sel.insertBefore(opt, otherOpt);
                }
            } else if (legacyOpt) {
                legacyOpt.remove();
            }

            document.getElementById('paDiscardModal').classList.add('active');
        }

        function paCloseDiscardModal() {
            document.getElementById('paDiscardModal').classList.remove('active');
            paDiscardTargetId = null;
        }

        async function paConfirmDiscard() {
            if (!paDiscardTargetId) return;
            const reason = document.getElementById('paDiscardReason').value;
            if (!reason) { alert('Please select a discard reason.'); return; }
            const note = document.getElementById('paDiscardNote').value.trim();
            const btn = document.getElementById('paDiscardConfirmBtn');
            btn.disabled = true;
            btn.textContent = 'Discarding...';
            try {
                const resp = await fetch(`/api/di/discard-inline/${paDiscardTargetId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ reason, note: note || undefined })
                });
                const data = await resp.json();
                if (resp.ok && data.success) {
                    paCloseDiscardModal();
                    alert('Submission discarded');
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert(data.error || 'Failed to discard');
                }
            } catch (err) {
                alert('Error discarding submission');
            }
            btn.disabled = false;
            btn.textContent = 'Discard';
        }

        async function quickRevise(id) {
            const comments = prompt('Enter revision comments:');
            if (comments === null) return;

            try {
                const token = btoa(id + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
                const response = await fetch(`/api/di/revise/${id}?token=${token}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Revision requested');
                    loadPendingApprovals();
                    loadStats();
                } else {
                    alert('Failed to request revision');
                }
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        // =====================================================
        // UPLOAD FUNCTIONALITY
        // =====================================================
        async function populateResearcherDropdown() {
            const select = document.getElementById('uploadResearcher');
            const filterSelect = document.getElementById('filterResearcher');

            try {
                const response = await fetch('/api/di/members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();
                allMembers = data.members || [];

                const options = allMembers.map(m =>
                    `<option value="${m.researcher_id}">${m.researcher_id} - ${m.name || ''} (${m.affiliation})</option>`
                ).join('');

                select.innerHTML = '<option value="">Select researcher...</option>' + options;
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">All Researchers</option>' + options;
                }
            } catch (err) {
                console.error('Error loading researchers:', err);
            }
        }

        // File upload handling
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');

        fileUploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                fileNameDisplay.textContent = fileInput.files[0].name;
                fileUploadArea.classList.add('has-file');
            } else {
                fileNameDisplay.textContent = '';
                fileUploadArea.classList.remove('has-file');
            }
        });

        fileUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); fileUploadArea.style.borderColor = '#2d5a87'; });
        fileUploadArea.addEventListener('dragleave', () => { fileUploadArea.style.borderColor = '#ddd'; });
        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = e.dataTransfer.files[0].name;
                fileUploadArea.classList.add('has-file');
            }
        });

        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const researcherId = document.getElementById('uploadResearcher').value;
            const fileType = document.getElementById('fileType').value;
            const file = fileInput.files[0];

            if (!researcherId || !fileType || !file) {
                showMessage('uploadMessage', 'Please fill all fields', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('researcher_id', researcherId);
            formData.append('fileType', fileType);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('uploadMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('uploadMessage', `File uploaded: ${file.name}`, 'success');
                    document.getElementById('uploadForm').reset();
                    fileNameDisplay.textContent = '';
                    fileUploadArea.classList.remove('has-file');
                    loadPendingApprovals();
                    loadStats();
                }
            } catch (err) {
                showMessage('uploadMessage', 'Connection error', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'Upload File';
            }
        });

        // =====================================================
        // LABORATORY FILES TAB
        // =====================================================
        async function loadLabFiles() {
            const container = document.getElementById('labFilesTree');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

            try {
                const response = await fetch('/api/di/lab-files', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                labFilesData = data.files || [];

                // Populate year filter
                const years = [...new Set(labFilesData.map(f => new Date(f.created_at).getFullYear()))].sort((a, b) => b - a);
                document.getElementById('filterYear').innerHTML = '<option value="">All Years</option>' +
                    years.map(y => `<option value="${y}">${y}</option>`).join('');

                applyFilters();
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;">Error loading files</p>';
            }
        }

        async function applyFilters() {
            const status = document.getElementById('filterStatus').value;
            const year = document.getElementById('filterYear').value;
            const researcher = document.getElementById('filterResearcher').value;
            const search = document.getElementById('filterSearch').value.toLowerCase();

            let filtered = labFilesData.filter(f => {
                if (status && f.status !== status) return false;
                if (year && new Date(f.created_at).getFullYear() !== parseInt(year)) return false;
                if (researcher && f.researcher_id !== researcher) return false;
                if (search && !f.original_filename.toLowerCase().includes(search)) return false;
                return true;
            });

            await renderLabFilesTree(filtered);
        }

        async function renderLabFilesTree(files) {
            const container = document.getElementById('labFilesTree');

            // Group by status, then year, then researcher
            const grouped = {};
            files.forEach(f => {
                const status = f.status || 'PENDING';
                const year = new Date(f.created_at).getFullYear();
                const researcher = f.researcher_id;

                if (!grouped[status]) grouped[status] = {};
                if (!grouped[status][year]) grouped[status][year] = {};
                if (!grouped[status][year][researcher]) grouped[status][year][researcher] = [];
                grouped[status][year][researcher].push(f);
            });

            let html = '';
            // No longer render REVISION_NEEDED from di_submissions (orphan rows)
            const statusOrder = ['PENDING', 'APPROVED'];

            statusOrder.forEach(status => {
                if (!grouped[status]) return;
                const statusLabel = status.charAt(0) + status.slice(1).toLowerCase();
                const statusClass = status === 'APPROVED' ? 'status-approved' : 'status-pending';

                html += `
                    <div class="tree-item tree-folder" onclick="toggleFolder(this)">
                        <span class="icon">&#128193;</span>
                        <span>${statusLabel}</span>
                        <span class="status-badge ${statusClass}" style="margin-left:8px;">${Object.values(grouped[status]).reduce((a, y) => a + Object.values(y).reduce((b, r) => b + r.length, 0), 0)}</span>
                    </div>
                    <div class="tree-children">
                `;

                Object.keys(grouped[status]).sort((a, b) => b - a).forEach(year => {
                    html += `
                        <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:20px;">
                            <span class="icon">&#128197;</span>
                            <span>${year}</span>
                        </div>
                        <div class="tree-children collapsed">
                    `;

                    Object.keys(grouped[status][year]).sort().forEach(researcher => {
                        const researcherFiles = grouped[status][year][researcher];
                        html += `
                            <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:40px;">
                                <span class="icon">&#128100;</span>
                                <span>${researcher}</span>
                                <span style="color:#999;font-size:11px;margin-left:8px;">(${researcherFiles.length})</span>
                            </div>
                            <div class="tree-children collapsed">
                        `;

                        researcherFiles.forEach(f => {
                            const hasFile = f.r2_object_key || f.drive_file_id;
                            html += `
                                <div class="tree-item tree-file" style="padding-left:60px;" data-file-id="${f.submission_id}">
                                    <input type="checkbox" class="file-checkbox" data-id="${f.submission_id}" onclick="toggleLabFileSelection(event, '${f.submission_id}')">
                                    <span class="icon">${f.status === 'APPROVED' ? '&#9989;' : '&#128196;'}</span>
                                    <span title="${escapeHtml(f.original_filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(f.original_filename)}</span>
                                    <div class="file-actions">
                                        ${hasFile ? `
                                            <button class="btn btn-sm btn-primary" onclick="viewFile('${f.submission_id}')">View</button>
                                            <button class="btn btn-sm btn-success" onclick="downloadFile('${f.submission_id}')">Download</button>
                                        ` : '<span style="color:#999;font-size:11px;">No file</span>'}
                                        <button class="btn btn-sm btn-danger" onclick="deleteFile('${f.submission_id}', '${escapeHtml(f.original_filename)}')">Delete</button>
                                    </div>
                                </div>
                            `;
                        });

                        html += '</div>';
                    });

                    html += '</div>';
                });

                html += '</div>';
            });

            // Fetch open revision requests and render as "Revision Needed" section
            try {
                const rrResponse = await fetch('/api/di/revision-requests/all', { credentials: 'include' });
                if (rrResponse.ok) {
                    const rrData = await rrResponse.json();
                    const requests = rrData.requests || [];

                    // Apply current filters to revision requests
                    const filterYear = document.getElementById('filterYear').value;
                    const filterResearcher = document.getElementById('filterResearcher').value;
                    const filterSearch = document.getElementById('filterSearch').value.toLowerCase();
                    const filterStatus = document.getElementById('filterStatus').value;

                    // Only show if no status filter or status filter is REVISION_NEEDED
                    if (!filterStatus || filterStatus === 'REVISION_NEEDED') {
                        const filteredRR = requests.filter(rr => {
                            if (filterYear && rr.year !== parseInt(filterYear)) return false;
                            if (filterResearcher && rr.researcher_id !== filterResearcher) return false;
                            if (filterSearch && !rr.filename.toLowerCase().includes(filterSearch)) return false;
                            return true;
                        });

                        if (filteredRR.length > 0) {
                            // Group by year, then researcher
                            const rrGrouped = {};
                            filteredRR.forEach(rr => {
                                if (!rrGrouped[rr.year]) rrGrouped[rr.year] = {};
                                if (!rrGrouped[rr.year][rr.researcher_id]) rrGrouped[rr.year][rr.researcher_id] = [];
                                rrGrouped[rr.year][rr.researcher_id].push(rr);
                            });

                            html += `
                                <div class="tree-item tree-folder" onclick="toggleFolder(this)">
                                    <span class="icon">&#128193;</span>
                                    <span>Revision Needed</span>
                                    <span class="status-badge status-revision" style="margin-left:8px;">${filteredRR.length}</span>
                                </div>
                                <div class="tree-children">
                            `;

                            Object.keys(rrGrouped).sort((a, b) => b - a).forEach(year => {
                                html += `
                                    <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:20px;">
                                        <span class="icon">&#128197;</span>
                                        <span>${year}</span>
                                    </div>
                                    <div class="tree-children collapsed">
                                `;

                                Object.keys(rrGrouped[year]).sort().forEach(researcher => {
                                    const researcherRRs = rrGrouped[year][researcher];
                                    html += `
                                        <div class="tree-item tree-folder" onclick="toggleFolder(this)" style="padding-left:40px;">
                                            <span class="icon">&#128100;</span>
                                            <span>${researcher}</span>
                                            <span style="color:#999;font-size:11px;margin-left:8px;">(${researcherRRs.length})</span>
                                        </div>
                                        <div class="tree-children collapsed">
                                    `;

                                    researcherRRs.forEach(rr => {
                                        html += `
                                            <div class="tree-item tree-file" style="padding-left:60px;" data-rr-id="${rr.id}">
                                                <span class="icon">&#128196;</span>
                                                <span title="${escapeHtml(rr.filename)}" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(rr.filename)}</span>
                                                <span class="type-badge" style="font-size:10px;margin-left:6px;padding:1px 5px;background:#e2e8f0;border-radius:3px;">${escapeHtml(rr.doc_type)}</span>
                                                <div class="file-actions">
                                                    <button class="btn btn-sm btn-secondary" onclick="toggleRevisionComment('${rr.id}')">Comments</button>
                                                    <button class="btn btn-sm btn-danger" onclick="cancelRevisionRequest('${rr.id}', '${escapeHtml(rr.filename)}')">Cancel</button>
                                                </div>
                                            </div>
                                            <div id="rr-comment-${rr.id}" style="display:none;padding:8px 12px 8px 60px;">
                                                <textarea id="rr-comment-text-${rr.id}" style="width:100%;min-height:60px;padding:6px 8px;border:1px solid #dee2e6;border-radius:4px;font-size:12px;resize:vertical;">${escapeHtml(rr.pi_comment || '')}</textarea>
                                                <button class="btn btn-sm btn-primary" style="margin-top:4px;" onclick="saveRevisionComment('${rr.id}')">Save</button>
                                            </div>
                                        `;
                                    });

                                    html += '</div>';
                                });

                                html += '</div>';
                            });

                            html += '</div>';
                        }
                    }
                }
            } catch (err) {
                console.error('Error loading revision requests:', err);
            }

            if (!html) {
                container.innerHTML = '<p style="text-align:center;color:#666;padding:20px;">No files match the filters</p>';
            } else {
                container.innerHTML = html;
            }
        }

        function toggleRevisionComment(id) {
            const el = document.getElementById('rr-comment-' + id);
            if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function saveRevisionComment(id) {
            const text = document.getElementById('rr-comment-text-' + id);
            if (!text) return;
            try {
                const response = await fetch('/api/di/revision-requests/' + id + '/comment', {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: text.value }),
                    credentials: 'include'
                });
                if (response.ok) {
                    alert('Comment saved');
                } else {
                    alert('Failed to save comment');
                }
            } catch (err) {
                alert('Error saving comment');
            }
        }

        async function cancelRevisionRequest(id, filename) {
            if (!confirm('Cancel revision request for "' + filename + '"? This cannot be undone.')) return;
            try {
                const response = await fetch('/api/di/revision-requests/' + id + '/cancel', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (response.ok) {
                    loadLabFiles();
                    loadStats();
                } else {
                    alert('Failed to cancel revision request');
                }
            } catch (err) {
                alert('Error cancelling revision request');
            }
        }

        function toggleFolder(element) {
            const children = element.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }

        function toggleLabFileSelection(event, fileId) {
            event.stopPropagation();
            if (selectedLabFiles.has(fileId)) {
                selectedLabFiles.delete(fileId);
            } else {
                selectedLabFiles.add(fileId);
            }
            updateLabBulkActions();
        }

        function updateLabBulkActions() {
            const bar = document.getElementById('labBulkActions');
            const count = document.getElementById('labSelectedCount');
            if (selectedLabFiles.size > 0) {
                bar.classList.remove('hidden');
                count.textContent = `${selectedLabFiles.size} selected`;
            } else {
                bar.classList.add('hidden');
            }
        }

        function selectAllLabFiles() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => {
                cb.checked = true;
                selectedLabFiles.add(cb.dataset.id);
            });
            updateLabBulkActions();
        }

        function clearLabSelection() {
            document.querySelectorAll('#labFilesTree .file-checkbox').forEach(cb => cb.checked = false);
            selectedLabFiles.clear();
            updateLabBulkActions();
        }

        async function bulkDownloadLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }

            try {
                const response = await fetch('/api/di/bulk-download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ submission_ids: Array.from(selectedLabFiles) }),
                    credentials: 'include'
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'lab-files.zip';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    // Fallback to individual downloads
                    const ids = Array.from(selectedLabFiles);
                    for (let i = 0; i < ids.length; i++) {
                        setTimeout(() => {
                            const link = document.createElement('a');
                            link.href = `/api/di/download/${ids[i]}?download=true`;
                            link.download = '';
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        }, i * 500);
                    }
                }
            } catch (err) {
                alert('Error downloading files');
            }
        }

        async function bulkDeleteLab() {
            if (selectedLabFiles.size === 0) { alert('No files selected'); return; }
            if (!confirm(`Delete ${selectedLabFiles.size} file(s)? This cannot be undone.`)) return;

            let success = 0, fail = 0;
            for (const id of selectedLabFiles) {
                try {
                    const response = await fetch(`/api/di/submissions/${id}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });
                    if (response.ok) success++;
                    else fail++;
                } catch { fail++; }
            }

            alert(`Deleted ${success} file(s)${fail > 0 ? `, ${fail} failed` : ''}`);
            selectedLabFiles.clear();
            updateLabBulkActions();
            loadLabFiles();
            loadStats();
        }

        function downloadFile(id) {
            window.location.href = `/api/di/download/${id}?download=true`;
        }

        async function deleteFile(id, filename) {
            if (!confirm(`Delete "${filename}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/submissions/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('File deleted');
                    selectedLabFiles.delete(id);
                    updateLabBulkActions();
                    loadLabFiles();
                    loadStats();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to delete file');
                }
            } catch (err) {
                alert('Error deleting file');
            }
        }

        // =====================================================
        // DATA INTELLIGENCE CONSOLE (DIC)
        // =====================================================

        // IMPORTANT: This function is duplicated in server.js and pi-dashboard.html.
        // Any change MUST be applied to BOTH copies identically.
        // Server-side test cases validate correctness (see server.js parseNatlabFilename tests).
        function parseNatlabFilename(filename) {
            const NON_COMPLIANT = {
                parsed_date: null, parsed_initials: null, parsed_project: null,
                parsed_description: null, is_sop: false, is_compliant: false, raw: filename
            };
            const base = filename.replace(/\.[^.]+$/, '');
            const parts = base.split('_');
            if (parts.length < 4) return NON_COMPLIANT;
            const date = parts[0].trim();
            const initials = parts[1].trim();
            const slot2 = parts[2].trim();
            const slot3 = parts[3].trim();
            if (!date || !initials || !/^\d{4}-\d{2}-\d{2}$/.test(date) || !/^[A-Z]{2,4}$/.test(initials)) {
                return NON_COMPLIANT;
            }
            const is_sop = slot2 === 'SOP';
            const descTokens = parts.slice(3).map(t => t.trim()).filter(Boolean);
            const description = descTokens.join(' ').replace(/\s{2,}/g, ' ');
            if (is_sop) {
                if (!slot3) return NON_COMPLIANT;
                return {
                    parsed_date: date, parsed_initials: initials, parsed_project: slot3,
                    parsed_description: description, is_sop: true, is_compliant: true, raw: filename
                };
            }
            if (!slot2 || !slot3) return NON_COMPLIANT;
            return {
                parsed_date: date, parsed_initials: initials, parsed_project: slot2,
                parsed_description: description, is_sop: false, is_compliant: true, raw: filename
            };
        }

        let dicAllFiles = [], dicFilteredFiles = [], dicSelectedFileId = null;
        let dicCurrentScope = 'DATA';
        let dicFilters = { status: '', researcher: '', year: '', search: '', time: '', sort: 'newest', dragonSeal: false };
        let dicResearcherMetrics = {}, dicAssociationsCache = {};
        let dicMonthsUsed = 12;
        let dicLinkModalType = '';
        let dicReviseFileId = null;

        async function dicInit() {
            try {
                const [filesRes, metricsRes] = await Promise.all([
                    fetch(`/api/di/lab-files-enriched?months=${dicMonthsUsed}`, { credentials: 'include' }),
                    fetch('/api/di/researcher-file-metrics', { credentials: 'include' })
                ]);
                if (filesRes.ok) {
                    const fData = await filesRes.json();
                    dicAllFiles = fData.files || [];
                    dicMonthsUsed = fData.months_used || 12;
                    document.getElementById('dicMonthsLabel').textContent = `Showing last ${dicMonthsUsed} months`;
                }
                if (metricsRes.ok) {
                    const mData = await metricsRes.json();
                    dicResearcherMetrics = {};
                    (mData.metrics || []).forEach(m => { dicResearcherMetrics[m.researcher_id] = m; });
                }
            } catch (err) {
                console.error('DIC init error:', err);
            }
            dicRenderSidebar();
            dicApplyFilters();
        }

        function dicFormatResearcherName(name) {
            if (!name) return 'Unknown';
            const parts = name.trim().split(/\s+/);
            if (parts.length < 2) return name;
            return parts[0] + ' ' + parts[parts.length - 1][0] + '.';
        }

        function dicGetInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            return parts.map(p => p[0]).join('').toUpperCase().slice(0, 2);
        }

        function dicRenderSidebar() {
            // Status buckets
            const statusCounts = { '': 0, PENDING: 0, APPROVED: 0, REVISION_NEEDED: 0 };
            dicAllFiles.forEach(f => {
                statusCounts['']++;
                if (statusCounts[f.status] !== undefined) statusCounts[f.status]++;
            });
            const bucketsEl = document.getElementById('dicStatusBuckets');
            bucketsEl.innerHTML = [
                { key: '', label: 'All Files' },
                { key: 'PENDING', label: 'Pending' },
                { key: 'APPROVED', label: 'Approved' },
                { key: 'REVISION_NEEDED', label: 'Revision' }
            ].map(b => `<div class="dic-status-bucket${dicFilters.status === b.key ? ' active' : ''}" onclick="dicSetSidebarFilter('status','${b.key}')">
                <span>${b.label}</span><span class="dic-count">${statusCounts[b.key] || 0}</span>
            </div>`).join('');

            // Year list
            const years = new Set();
            dicAllFiles.forEach(f => {
                const yr = (f.created_at || '').substring(0, 4);
                if (yr) years.add(yr);
            });
            const sortedYears = [...years].sort().reverse();
            const yearEl = document.getElementById('dicYearList');
            // Check if any legacy files exist to show legacy filter
            const hasLegacyFiles = dicAllFiles.some(f => f.record_origin === 'legacy_pre2026');
            const legacyItem = hasLegacyFiles
                ? `<div class="dic-year-item legacy-year${dicFilters.year === 'legacy' ? ' active' : ''}" onclick="dicSetSidebarFilter('year','legacy')">Legacy &lt;2026</div>`
                : '';
            yearEl.innerHTML = `<div class="dic-year-item${!dicFilters.year ? ' active' : ''}" onclick="dicSetSidebarFilter('year','')">All Years</div>` +
                legacyItem +
                sortedYears.map(y => `<div class="dic-year-item${dicFilters.year === y ? ' active' : ''}" onclick="dicSetSidebarFilter('year','${y}')">${y}</div>`).join('');

            // Researcher list
            const researchers = {};
            dicAllFiles.forEach(f => {
                if (!researchers[f.researcher_id]) {
                    researchers[f.researcher_id] = { id: f.researcher_id, name: f.researcher_name || f.researcher_id };
                }
            });
            const researcherList = Object.values(researchers).sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            const resEl = document.getElementById('dicResearcherList');
            resEl.innerHTML = researcherList.map(r => `<div class="dic-researcher-item${dicFilters.researcher === r.id ? ' active' : ''}" onclick="dicSetSidebarFilter('researcher','${r.id}')">
                <div class="dic-researcher-avatar">${dicGetInitials(r.name)}</div>
                <span class="dic-researcher-name">${dicFormatResearcherName(r.name)}</span>
            </div>`).join('') || '<div style="font-size:12px;color:#9ca3af;padding:8px 10px;">No researchers</div>';
        }

        function dicSetSidebarFilter(key, val) {
            dicFilters[key] = val;
            if (key === 'researcher' && val) {
                dicCurrentScope = 'DATA';
                dicFilters.sort = 'newest';
                document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.toggle('active', p.dataset.scope === 'DATA'));
                document.querySelectorAll('.dic-chip[data-filter="sort"]').forEach(c => c.classList.toggle('active', c.dataset.val === 'newest'));
            }
            dicRenderSidebar();
            dicApplyFilters();
            if (key === 'researcher' && val) {
                dicRenderQuickMetrics(val);
                dicAutoSelectNewest();
            } else {
                document.getElementById('dicQuickMetrics').style.display = 'none';
            }
        }

        function dicSetScope(el) {
            dicCurrentScope = el.dataset.scope;
            document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.remove('active'));
            el.classList.add('active');
            dicApplyFilters();
        }

        // ===============================
        // GLP Vision Mode Toggle
        // ===============================
        let dicVisionMode = 'all';

        function dicSetVisionMode(mode, btn) {
            dicVisionMode = mode;
            document.querySelectorAll('.dic-vision-btn').forEach(b => b.classList.remove('active'));
            if (btn) btn.classList.add('active');

            const selectedUser = dicFilters.researcher || null;
            // DIC chrome elements
            const searchArea = document.querySelector('.dic-finder .dic-search-area');
            const monthsLabel = document.getElementById('dicMonthsLabel');
            const filterRows = document.querySelectorAll('.dic-finder .dic-filter-row');
            const quickMetrics = document.getElementById('dicQuickMetrics');
            const showChrome = (mode === 'all' || mode === 'papers');

            if (searchArea) searchArea.style.display = showChrome ? '' : 'none';
            if (monthsLabel) monthsLabel.style.display = showChrome ? '' : 'none';
            filterRows.forEach(r => r.style.display = showChrome ? '' : 'none');
            if (!showChrome && quickMetrics) quickMetrics.style.display = 'none';

            if (mode === 'all') {
                dicRightPanelHide();
                glpVisionRenderAll(selectedUser);
            } else if (mode === 'papers') {
                dicRightPanelHide();
                glpVisionRenderPapers(selectedUser);
            } else if (mode === 'training') {
                glpVisionRenderTraining(selectedUser);
            } else if (mode === 'inventory') {
                glpVisionRenderInventory(selectedUser);
            } else if (mode === 'onetoone') {
                glpVisionRenderOneToOne(selectedUser);
            }
        }

        function glpVisionRenderAll(selectedUser) {
            dicInternalDocsMode = false;
            dicSetScopePillsEnabled(true);
            dicApplyFilters();
            if (selectedUser) dicRenderQuickMetrics(selectedUser);
        }

        function glpVisionRenderPapers(selectedUser) {
            const sel = document.getElementById('dicIntdocsSelect');
            if (sel) {
                sel.value = 'papers';
                dicIntdocsChanged(sel);
            }
        }

        // ── Vision summary builders (middle panel #dicResults) ──
        function dicBuildTrainingSummaryHtml(d) {
            const s = d.status;
            const aq = d.data.action_queue;
            const rec = d.data.record;
            const fmtDate = v => v ? new Date(v).toLocaleDateString('en-SE') : '\u2014';
            const badgeClass = s.overall === 'ok' ? 'approved' : 'pending';
            const badgeLabel = s.overall === 'ok' ? 'OK' : 'NEEDS ATTENTION';
            let html = '';
            html += `<div class="glpCard" style="background:linear-gradient(180deg,#f2f4f8,#eceef3);border-color:#d4d9e2;">`;
            html += `<div class="glpMicroTitle">TRAINING OVERVIEW</div>`;
            html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">`;
            html += `<span class="dic-badge ${badgeClass}" style="font-size:10px;padding:2px 8px;">${badgeLabel}</span>`;
            if (s.reasons.length) html += `<span style="font-size:11px;color:#6b7280;">${s.reasons.map(r => escapeHtml(r)).join(' &middot; ')}</span>`;
            html += `</div>`;
            html += `<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:12px;color:#4b5563;margin-bottom:8px;">`;
            html += `<span>Last sealed: <b>${fmtDate(s.last_sealed_at)}</b></span>`;
            html += `<span>Next expiry: <b>${fmtDate(s.next_expiry_at)}</b></span>`;
            html += `</div>`;
            html += `<div class="glpMiniCards" style="display:grid;grid-template-columns:repeat(3,1fr);gap:0;">`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Seal Pending</div><div class="glpMiniCard__big">${s.counts.seal_pending}</div></div>`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Cert Pending</div><div class="glpMiniCard__big">${s.counts.cert_pending}</div></div>`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Agreements Missing</div><div class="glpMiniCard__big">${s.counts.agreements_missing_or_expired}</div></div>`;
            html += `</div></div>`;
            html += `<div class="glpCard"><div class="glpMicroTitle">ACTION QUEUE</div>`;
            if (aq.seal_training_packs.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Packs Pending Seal</div>`;
                aq.seal_training_packs.forEach(p => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(p.title)}</span><span style="color:#6b7280;">${fmtDate(p.submitted_at)}</span></div>`;
                });
                html += `</div>`;
            }
            if (aq.certifications_pending.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Certifications Pending</div>`;
                aq.certifications_pending.forEach(c => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(c.pack_title)}</span><span style="color:#6b7280;">by ${escapeHtml(c.requested_by)} &middot; ${fmtDate(c.requested_at)}</span></div>`;
                });
                html += `</div>`;
            }
            if (aq.agreements_missing_or_expired.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Agreements Missing / Expired</div>`;
                aq.agreements_missing_or_expired.forEach(a => {
                    html += `<div style="padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;display:flex;align-items:center;gap:8px;">`;
                    html += `<span>${escapeHtml(a.agreement_type)}</span><span class="dic-badge ${a.status === 'expired' ? 'revision' : 'pending'}">${a.status.toUpperCase()}</span></div>`;
                });
                html += `</div>`;
            }
            if (!aq.seal_training_packs.length && !aq.certifications_pending.length && !aq.agreements_missing_or_expired.length) {
                html += `<p style="font-size:12px;color:#9ca3af;margin:0;">No pending items</p>`;
            }
            html += `</div>`;
            html += `<div class="glpCard"><div class="glpMicroTitle">RECORD</div>`;
            if (rec.sealed_training_packs.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Sealed Packs</div>`;
                rec.sealed_training_packs.forEach(p => {
                    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(p.title)}</span><span style="color:#6b7280;">${fmtDate(p.sealed_at)} by ${escapeHtml(p.sealed_by)}</span></div>`;
                });
                html += `</div>`;
            }
            if (rec.certifications_approved.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Certifications Approved</div>`;
                rec.certifications_approved.forEach(c => {
                    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(c.pack_title)}</span><span style="color:#6b7280;">${fmtDate(c.approved_at)} by ${escapeHtml(c.approved_by)}</span></div>`;
                });
                html += `</div>`;
            }
            if (rec.agreements_signed.length) {
                html += `<div style="margin-bottom:12px;"><div style="font-size:11px;font-weight:700;color:#4b5563;margin-bottom:6px;">Agreements Signed</div>`;
                rec.agreements_signed.forEach(a => {
                    html += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(a.agreement_type)} <span style="color:#9ca3af;">${escapeHtml(a.version)}</span></span><span style="color:#6b7280;">${fmtDate(a.signed_at)}</span></div>`;
                });
                html += `</div>`;
            }
            if (!rec.sealed_training_packs.length && !rec.certifications_approved.length && !rec.agreements_signed.length) {
                html += `<p style="font-size:12px;color:#9ca3af;margin:0;">No records found</p>`;
            }
            html += `</div>`;
            html += `<div style="text-align:right;padding:4px;"><span style="font-size:10px;color:#b0b8c4;">Generated ${fmtDate(d.generated_at)}</span></div>`;
            return html;
        }

        function dicBuildInventorySummaryHtml(d) {
            const s = d.status;
            const data = d.data;
            const fmtDate = v => v ? new Date(v).toLocaleDateString('en-SE') : '\u2014';
            const badgeClass = s.overall === 'ok' ? 'approved' : 'pending';
            const badgeLabel = s.overall === 'ok' ? 'OK' : 'NEEDS ATTENTION';
            let html = '';
            html += `<div class="glpCard" style="background:linear-gradient(180deg,#f2f4f8,#eceef3);border-color:#d4d9e2;">`;
            html += `<div class="glpMicroTitle">INVENTORY OVERVIEW</div>`;
            html += `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">`;
            html += `<span class="dic-badge ${badgeClass}" style="font-size:10px;padding:2px 8px;">${badgeLabel}</span>`;
            if (s.reasons.length) html += `<span style="font-size:11px;color:#6b7280;">${s.reasons.map(r => escapeHtml(r)).join(' &middot; ')}</span>`;
            html += `</div>`;
            html += `<div style="font-size:12px;color:#4b5563;margin-bottom:8px;">Last activity: <b>${fmtDate(s.last_activity_at)}</b></div>`;
            html += `<div class="glpMiniCards" style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;">`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Assigned</div><div class="glpMiniCard__big">${s.counts.assigned}</div></div>`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Pending Online</div><div class="glpMiniCard__big">${s.counts.pending_online}</div></div>`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Pending Offline</div><div class="glpMiniCard__big">${s.counts.pending_offline}</div></div>`;
            html += `<div class="glpMiniCard"><div class="glpMiniCard__title">Exceptions</div><div class="glpMiniCard__big">${s.counts.exceptions}</div></div>`;
            html += `</div></div>`;
            html += `<div class="glpCard"><div class="glpMicroTitle">ASSIGNED ITEMS</div>`;
            if (data.assigned_items.length) {
                data.assigned_items.forEach(item => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<div><span style="font-weight:600;">${escapeHtml(item.name)}</span> <span class="dic-badge submitted">${escapeHtml(item.category)}</span></div>`;
                    html += `<div style="color:#6b7280;text-align:right;font-size:11px;">${escapeHtml(item.location)}${item.lot ? ' &middot; Lot: ' + escapeHtml(item.lot) : ''}${item.expiry ? ' &middot; Exp: ' + escapeHtml(item.expiry) : ''}</div></div>`;
                });
            } else { html += `<p style="font-size:12px;color:#9ca3af;margin:0;">No assigned items</p>`; }
            html += `</div>`;
            html += `<div class="glpCard"><div class="glpMicroTitle">PENDING ONLINE</div>`;
            if (data.pending_online_items.length) {
                data.pending_online_items.forEach(item => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<div><span>${escapeHtml(item.name)}</span> <span class="dic-badge pending">${escapeHtml(item.status)}</span></div>`;
                    html += `<span style="color:#6b7280;">${fmtDate(item.requested_at)}</span></div>`;
                });
            } else { html += `<p style="font-size:12px;color:#9ca3af;margin:0;">No pending items</p>`; }
            html += `</div>`;
            html += `<div class="glpCard"><div class="glpMicroTitle">PENDING OFFLINE</div>`;
            if (data.pending_offline_items.length) {
                data.pending_offline_items.forEach(item => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<div><span>${escapeHtml(item.name)}</span> <span class="dic-badge pending">PENDING</span></div>`;
                    html += `<span style="color:#6b7280;">${fmtDate(item.submitted_at)} by ${escapeHtml(item.submitted_by)}</span></div>`;
                });
            } else { html += `<p style="font-size:12px;color:#9ca3af;margin:0;">No pending items</p>`; }
            html += `</div>`;
            if (data.exceptions.length) {
                html += `<div class="glpCard" style="border-color:#fcd34d;"><div class="glpMicroTitle">EXCEPTIONS</div>`;
                data.exceptions.forEach(ex => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">`;
                    html += `<span>${escapeHtml(ex.name)}</span>`;
                    html += `<div style="display:flex;gap:4px;">${ex.missing.map(m => `<span class="dic-badge revision">${escapeHtml(m)}</span>`).join('')}</div></div>`;
                });
                html += `</div>`;
            }
            html += `<div style="text-align:right;padding:4px;"><span style="font-size:10px;color:#b0b8c4;">Generated ${fmtDate(d.generated_at)}</span></div>`;
            return html;
        }

        // ── Researcher-tab renderers (right panel #dicVisionOverlay) ──
        // These replicate the exact UI from upload.html Training/Inventory tabs (read-only).

        function dicRenderResearcherTrainingTab(data) {
            const pack = data.pack;
            const agreements = data.agreements || [];
            const entries = data.entries || [];
            const sealedPacks = data.sealed_packs || [];
            const documents = data.documents || [];
            const fmtDate = v => v ? new Date(v).toLocaleDateString() : '\u2014';

            let html = '<div style="padding:12px;">';

            // Pack status banner (same as upload.html renderTrainingPackUI)
            if (pack) {
                const statusLabels = { DRAFT: 'Draft', SUBMITTED: 'Submitted \u2014 Awaiting PI Review', REVISION_NEEDED: 'Revision Needed', SEALED: 'Sealed' };
                const statusColors = { DRAFT: '#ffc107', SUBMITTED: '#17a2b8', REVISION_NEEDED: '#dc3545', SEALED: '#28a745' };
                html += `<div style="margin-bottom:16px;">
                    <span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:bold;background:${statusColors[pack.status]};color:${pack.status==='DRAFT'?'#333':'#fff'};">${statusLabels[pack.status] || pack.status}</span>
                    <span style="font-size:12px;color:#666;margin-left:8px;">Pack v${pack.version}</span>
                </div>`;
                if (pack.status === 'REVISION_NEEDED' && pack.revision_comments) {
                    html += `<div style="color:#dc3545;font-size:12px;margin-bottom:12px;">PI comment: ${escapeHtml(pack.revision_comments)}</div>`;
                }
            } else {
                html += '<p style="color:#999;font-size:13px;">No training pack found for this researcher.</p>';
            }

            // Agreements section (same as upload.html renderAgreements — read-only)
            html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">Training Documents &amp; Agreements</h4>';
            if (documents.length === 0) {
                html += '<p style="color:#999;font-size:13px;">No training documents available.</p>';
            } else {
                const confirmedDocIds = new Set(agreements.map(a => a.document_id));
                documents.forEach(doc => {
                    const isConfirmed = confirmedDocIds.has(doc.id);
                    const agreement = agreements.find(a => a.document_id === doc.id);
                    const ruleColor = doc.requirement_rule === 'Always' ? '#dc3545' : doc.requirement_rule === 'Conditional' ? '#fd7e14' : '#6c757d';
                    const versionId = doc.version_id;
                    html += `<div style="border:1px solid #e0e0e0;border-radius:8px;padding:12px;margin-bottom:8px;${isConfirmed ? 'background:#f0fff0;' : ''}">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <div>
                                <strong style="font-size:13px;">${escapeHtml(doc.title)}</strong>
                                <span style="font-size:11px;color:#666;margin-left:6px;">${escapeHtml(doc.category)}</span>
                                <span style="font-size:10px;color:${ruleColor};margin-left:6px;font-weight:600;">${escapeHtml(doc.requirement_rule)}</span>
                                ${doc.condition_note ? `<span style="font-size:10px;color:#999;margin-left:4px;">(${escapeHtml(doc.condition_note)})</span>` : ''}
                            </div>
                            <a href="/api/di/training/document-versions/${versionId}/view" target="_blank" style="font-size:11px;color:#2d5a87;text-decoration:none;font-weight:600;">View PDF</a>
                        </div>`;
                    if (isConfirmed) {
                        html += `<div style="color:#28a745;font-size:12px;">\u2705 Confirmed by ${escapeHtml((agreement && agreement.confirmed_name) || '')} on ${fmtDate(agreement && agreement.confirmed_at)}</div>`;
                    } else {
                        html += `<span style="color:#dc3545;font-size:12px;">Not confirmed</span>`;
                    }
                    html += '</div>';
                });
            }

            // Entries table (same as upload.html renderTrainingEntries — read-only)
            html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">Training Entries</h4>';
            if (entries.length === 0) {
                html += '<p style="color:#999;font-size:13px;text-align:center;">No entries yet</p>';
            } else {
                html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<thead><tr style="border-bottom:2px solid #e0e0e0;"><th style="text-align:left;padding:6px;">Type</th><th style="text-align:left;padding:6px;">Date</th><th style="text-align:left;padding:6px;">Supervisor</th><th style="text-align:left;padding:6px;">Status</th></tr></thead>';
                html += '<tbody>';
                entries.forEach(e => {
                    const badgeColors = { PENDING: '#ffc107', CERTIFIED: '#28a745', REJECTED: '#dc3545' };
                    const textColor = e.status === 'PENDING' ? '#333' : '#fff';
                    const supLabel = e.certification_route === 'PI'
                        ? `${escapeHtml(e.supervisor_name || '')} <span style="font-size:10px;color:#856404;">(PI oversight)</span>`
                        : escapeHtml(e.supervisor_name || '');
                    html += `<tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:6px;">${escapeHtml(e.training_type)}</td>
                        <td style="padding:6px;">${fmtDate(e.training_date)}</td>
                        <td style="padding:6px;">${supLabel}</td>
                        <td style="padding:6px;">
                            <span style="display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;background:${badgeColors[e.status] || '#999'};color:${textColor};">${e.status}</span>
                            ${e.status === 'REJECTED' && e.rejection_comment ? `<span style="font-size:11px;color:#dc3545;margin-left:5px;">\u2014 ${escapeHtml(e.rejection_comment)}</span>` : ''}
                        </td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // Certificates (same as upload.html renderTrainingCertificates — read-only)
            if (sealedPacks.length > 0) {
                html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">Sealed Certificates</h4>';
                sealedPacks.forEach(sp => {
                    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #eee;">
                        <div>
                            <span style="display:inline-block;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:bold;background:#28a745;color:#fff;">SEALED</span>
                            <span style="font-size:13px;margin-left:10px;">v${sp.version} \u2014 ${fmtDate(sp.sealed_at)}</span>
                            <span style="font-size:11px;color:#666;margin-left:10px;">${escapeHtml(sp.verification_code)}</span>
                        </div>
                        <a href="/api/di/training/certificate/${sp.id}" target="_blank" style="font-size:11px;color:#2d5a87;text-decoration:none;font-weight:600;">Download Certificate</a>
                    </div>`;
                });
            }
            html += '</div>';
            return html;
        }

        function dicRenderResearcherInventoryTab(data) {
            const purchases = data.purchase_requests || [];
            const toReceive = data.approved_to_receive || [];
            const myProducts = data.my_products || [];
            const mySamples = data.my_samples || [];
            const fmtDate = v => v ? new Date(v).toLocaleDateString() : '\u2014';

            let html = '<div style="padding:12px;">';

            // Purchase Requests (read-only — same layout as upload.html loadMyPurchaseRequests)
            html += '<h4 style="font-size:13px;font-weight:700;margin:0 0 8px;">Purchase Requests</h4>';
            if (purchases.length === 0) {
                html += '<p style="color:#999;font-size:13px;">No purchase requests yet</p>';
            } else {
                const statusColors = { SUBMITTED: '#007bff', APPROVED: '#28a745', DECLINED: '#fd7e14' };
                purchases.forEach(r => {
                    const items = r.items || [];
                    const itemSummary = items.map(i => i.product_name).join(', ');
                    html += `<div style="border:1px solid #e0e0e0;border-radius:8px;padding:10px;margin-bottom:8px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <span style="font-size:12px;">${fmtDate(r.created_at)} \u2014 ${items.length} item${items.length > 1 ? 's' : ''}</span>
                            <span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[r.status] || '#666'};">${r.status}</span>
                        </div>
                        <div style="font-size:12px;color:#4b5563;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(itemSummary)}">${escapeHtml(itemSummary)}</div>
                        <div style="font-size:12px;font-weight:600;margin-top:4px;">${Number(r.request_total).toFixed(2)} ${escapeHtml(r.currency)}</div>
                        ${r.pi_comment ? `<div style="font-size:11px;color:#856404;margin-top:4px;">PI: ${escapeHtml(r.pi_comment)}</div>` : ''}`;
                    if (items.length > 0) {
                        html += '<div style="margin-top:6px;">';
                        items.forEach(i => {
                            const ordered = i.ordered_at ? '<span style="color:#28a745;font-size:11px;">Ordered ' + fmtDate(i.ordered_at) + '</span>' : '<span style="color:#999;font-size:11px;">Not ordered</span>';
                            const received = i.received_at ? ' \u00b7 <span style="color:#28a745;font-size:11px;">Received ' + fmtDate(i.received_at) + '</span>' : '';
                            const po = i.internal_order_number ? '<span style="font-size:10px;color:#0c5460;margin-left:4px;">PO: ' + escapeHtml(i.internal_order_number) + '</span>' : '';
                            html += `<div style="display:flex;justify-content:space-between;padding:3px 0;border-bottom:1px solid #f3f4f6;font-size:12px;">
                                <span>${escapeHtml(i.product_name)}${po}</span>
                                <span style="white-space:nowrap;">${i.quantity} \u00d7 ${Number(i.unit_price).toFixed(2)} \u00b7 ${ordered}${received}</span>
                            </div>`;
                        });
                        html += '</div>';
                    }
                    html += '</div>';
                });
            }

            // Approved Items to Receive (read-only — same as upload.html loadApprovedToReceive)
            if (toReceive.length > 0) {
                html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">Approved Items Awaiting Receipt</h4>';
                html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<thead><tr style="border-bottom:2px solid #e0e0e0;"><th style="text-align:left;padding:4px;">Product</th><th style="text-align:left;padding:4px;">Vendor</th><th style="text-align:left;padding:4px;">Cat. ID</th><th style="text-align:right;padding:4px;">Qty</th></tr></thead>';
                html += '<tbody>';
                toReceive.forEach(i => {
                    html += `<tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:4px;">${i.product_link ? '<a href="' + escapeHtml(i.product_link) + '" target="_blank" style="color:#2d5a87;">' + escapeHtml(i.product_name) + '</a>' : escapeHtml(i.product_name)}</td>
                        <td style="padding:4px;">${escapeHtml(i.vendor_company)}</td>
                        <td style="padding:4px;">${escapeHtml(i.catalog_id)}</td>
                        <td style="padding:4px;text-align:right;">${i.quantity}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // My Inventory — Products (read-only — same as upload.html loadMyInventoryV2('product'))
            html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">My Inventory \u2014 Products</h4>';
            if (myProducts.length === 0) {
                html += '<p style="color:#999;font-size:13px;">No products in inventory</p>';
            } else {
                html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<thead><tr style="border-bottom:2px solid #e0e0e0;"><th style="text-align:left;padding:4px;">Name</th><th style="text-align:left;padding:4px;">Vendor</th><th style="text-align:left;padding:4px;">Cat. ID</th><th style="text-align:right;padding:4px;">Qty</th><th style="padding:4px;">Unit</th><th style="padding:4px;">Temp</th><th style="padding:4px;">Location</th><th style="padding:4px;">Status</th></tr></thead>';
                html += '<tbody>';
                myProducts.forEach(i => {
                    const po = (i.source === 'Online' && i.internal_order_number) ? '<br><small style="color:#0c5460;">PO: ' + escapeHtml(i.internal_order_number) + '</small>' : '';
                    html += `<tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:4px;">${i.product_link ? '<a href="' + escapeHtml(i.product_link) + '" target="_blank" style="color:#2d5a87;">' + escapeHtml(i.item_name) + '</a>' : escapeHtml(i.item_name)}${po}</td>
                        <td style="padding:4px;">${escapeHtml(i.vendor_company || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.item_identifier || '')}</td>
                        <td style="padding:4px;text-align:right;">${i.quantity}</td>
                        <td style="padding:4px;">${escapeHtml(i.quantity_unit || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.storage_temperature || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.storage_location || '')}</td>
                        <td style="padding:4px;"><span class="dic-badge ${(i.status || '').toLowerCase().replace('_','')}">${escapeHtml(i.status || '')}</span>${i.status_comment ? '<br><small style="color:#856404;">' + escapeHtml(i.status_comment) + '</small>' : ''}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }

            // My Inventory — Samples (read-only — same as upload.html loadMyInventoryV2('sample'))
            html += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;">My Inventory \u2014 Samples</h4>';
            if (mySamples.length === 0) {
                html += '<p style="color:#999;font-size:13px;">No samples in inventory</p>';
            } else {
                html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                html += '<thead><tr style="border-bottom:2px solid #e0e0e0;"><th style="text-align:left;padding:4px;">Name</th><th style="text-align:left;padding:4px;">ID</th><th style="text-align:left;padding:4px;">Origin</th><th style="text-align:left;padding:4px;">Provider</th><th style="text-align:right;padding:4px;">Qty</th><th style="padding:4px;">Unit</th><th style="padding:4px;">Temp</th><th style="padding:4px;">Location</th><th style="padding:4px;">Status</th></tr></thead>';
                html += '<tbody>';
                mySamples.forEach(i => {
                    html += `<tr style="border-bottom:1px solid #f0f0f0;">
                        <td style="padding:4px;">${escapeHtml(i.item_name || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.item_identifier || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.sample_origin || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.provider_or_collaborator || '')}</td>
                        <td style="padding:4px;text-align:right;">${i.quantity}</td>
                        <td style="padding:4px;">${escapeHtml(i.quantity_unit || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.storage_temperature || '')}</td>
                        <td style="padding:4px;">${escapeHtml(i.storage_location || '')}</td>
                        <td style="padding:4px;"><span class="dic-badge ${(i.status || '').toLowerCase().replace('_','')}">${escapeHtml(i.status || '')}</span>${i.status_comment ? '<br><small style="color:#856404;">' + escapeHtml(i.status_comment) + '</small>' : ''}</td>
                    </tr>`;
                });
                html += '</tbody></table>';
            }
            html += '</div>';
            return html;
        }

        // ── Main Training/Inventory render functions ──
        // Middle panel = vision summary (#dicResults)
        // Right panel  = researcher tab UI (#dicVisionOverlay via dicRightPanelShow)

        async function glpVisionRenderTraining(selectedUser) {
            const results = document.getElementById('dicResults');
            if (!selectedUser) {
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Select a researcher to view training</h3></div>';
                dicRightPanelShow('<div class="dic-empty-state"><h3>Select a researcher to view training</h3></div>');
                return;
            }
            const modeAtStart = dicVisionMode;
            const userAtStart = selectedUser;
            if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Training</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>';
            dicRightPanelShow('<div class="dic-empty-state"><h3>Training</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>');
            try {
                const [summaryResp, tabResp] = await Promise.all([
                    fetch(`/api/di/vision/training/${encodeURIComponent(selectedUser)}`, { credentials: 'include' }),
                    fetch(`/api/di/training/pi-researcher-view/${encodeURIComponent(selectedUser)}`, { credentials: 'include' })
                ]);
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart) return;
                const [summaryData, tabData] = await Promise.all([summaryResp.json(), tabResp.json()]);
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart) return;
                // Middle panel: vision summary
                if (results) {
                    results.innerHTML = summaryData.success
                        ? dicBuildTrainingSummaryHtml(summaryData)
                        : '<div class="dic-empty-state"><h3>Training summary unavailable</h3></div>';
                }
                // Right panel: researcher Training tab UI
                if (tabData.success) {
                    dicRightPanelShow(dicRenderResearcherTrainingTab(tabData));
                } else {
                    dicRightPanelShow('<div class="glpCard" style="border-color:#f8d7da;"><div class="glpMicroTitle">ERROR</div><p style="color:#721c24;font-size:13px;margin:0;">' + escapeHtml(tabData.error || 'Failed to load') + '</p></div>');
                }
            } catch (err) {
                console.error('[Vision] training fetch error:', err);
                if (dicVisionMode !== modeAtStart) return;
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Training summary failed</h3></div>';
                dicRightPanelShow('<div class="glpCard" style="border-color:#f8d7da;"><div class="glpMicroTitle">ERROR</div><p style="color:#721c24;font-size:13px;margin:0;">Failed to load training data</p></div>');
            }
        }

        async function glpVisionRenderInventory(selectedUser) {
            const results = document.getElementById('dicResults');
            if (!selectedUser) {
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Select a researcher to view inventory</h3></div>';
                dicRightPanelShow('<div class="dic-empty-state"><h3>Select a researcher to view inventory</h3></div>');
                return;
            }
            const modeAtStart = dicVisionMode;
            const userAtStart = selectedUser;
            if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Inventory</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>';
            dicRightPanelShow('<div class="dic-empty-state"><h3>Inventory</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>');
            try {
                const [summaryResp, tabResp] = await Promise.all([
                    fetch(`/api/di/vision/inventory/${encodeURIComponent(selectedUser)}`, { credentials: 'include' }),
                    fetch(`/api/di/inventory-v2/pi-researcher-view/${encodeURIComponent(selectedUser)}`, { credentials: 'include' })
                ]);
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart) return;
                const [summaryData, tabData] = await Promise.all([summaryResp.json(), tabResp.json()]);
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart) return;
                // Middle panel: vision summary
                if (results) {
                    results.innerHTML = summaryData.success
                        ? dicBuildInventorySummaryHtml(summaryData)
                        : '<div class="dic-empty-state"><h3>Inventory summary unavailable</h3></div>';
                }
                // Right panel: researcher Inventory tab UI
                if (tabData.success) {
                    dicRightPanelShow(dicRenderResearcherInventoryTab(tabData));
                } else {
                    dicRightPanelShow('<div class="glpCard" style="border-color:#f8d7da;"><div class="glpMicroTitle">ERROR</div><p style="color:#721c24;font-size:13px;margin:0;">' + escapeHtml(tabData.error || 'Failed to load') + '</p></div>');
                }
            } catch (err) {
                console.error('[Vision] inventory fetch error:', err);
                if (dicVisionMode !== modeAtStart) return;
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Inventory summary failed</h3></div>';
                dicRightPanelShow('<div class="glpCard" style="border-color:#f8d7da;"><div class="glpMicroTitle">ERROR</div><p style="color:#721c24;font-size:13px;margin:0;">Failed to load inventory data</p></div>');
            }
        }

        // ===============================
        // GLP Vision — 1-to-1 Mode
        // ===============================
        let _1to1SeqCounter = 0;

        async function glpVisionRenderOneToOne(selectedUser) {
            const results = document.getElementById('dicResults');
            if (!selectedUser) {
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>Select a researcher to view 1-to-1 meetings</h3></div>';
                dicRightPanelShow('<div class="dic-empty-state"><h3>Select a researcher to view 1-to-1 meetings</h3></div>');
                return;
            }
            const modeAtStart = dicVisionMode;
            const userAtStart = selectedUser;
            const seq = ++_1to1SeqCounter;

            if (results) results.innerHTML = '<div class="dic-empty-state"><h3>1-to-1</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>';
            dicRightPanelShow('<div class="dic-empty-state"><h3>1-to-1</h3><p style="color:#6b7280;margin-top:8px;">Loading\u2026</p></div>');

            try {
                const resp = await fetch(`/api/di/1to1/listMeetings/${encodeURIComponent(selectedUser)}`, { credentials: 'include' });
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart || seq !== _1to1SeqCounter) return;
                const data = await resp.json();
                if (dicVisionMode !== modeAtStart || dicFilters.researcher !== userAtStart || seq !== _1to1SeqCounter) return;

                if (!data.success) {
                    if (results) results.innerHTML = '<div class="dic-empty-state"><h3>1-to-1 unavailable</h3><p style="color:#6b7280;font-size:13px;">' + escapeHtml(data.error || 'Tables not ready') + '</p></div>';
                    dicRightPanelShow('<div class="dic-empty-state"><h3>1-to-1 unavailable</h3></div>');
                    return;
                }

                const draft = data.draft;
                const versions = data.versions || [];
                const researcherName = (data.researcher && data.researcher.name) ? data.researcher.name : selectedUser;

                // --- Middle panel ---
                let mid = '';
                // Sticky draft banner
                if (draft) {
                    const updatedStr = draft.updated_at ? new Date(draft.updated_at).toLocaleString() : '';
                    mid += '<div style="background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:10px 14px;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;">'
                        + '<div><strong style="font-size:13px;">Draft in progress</strong>'
                        + (updatedStr ? '<span style="font-size:11px;color:#92400e;margin-left:8px;">Updated ' + escapeHtml(updatedStr) + '</span>' : '')
                        + '</div><div style="display:flex;gap:6px;">'
                        + '<button onclick="oneToOneDiscardDraft(\'' + escapeHtml(selectedUser) + '\')" style="font-size:12px;padding:4px 10px;border:1px solid #dc2626;background:#fff;color:#dc2626;border-radius:6px;cursor:pointer;">Discard draft</button>'
                        + '<button onclick="oneToOneFinalize(\'' + escapeHtml(selectedUser) + '\')" style="font-size:12px;padding:4px 10px;border:none;background:#059669;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Save 1-to-1 meeting</button>'
                        + '</div></div>';
                    mid += dicBuildOneToOneFormHtml(draft);
                } else {
                    mid += '<div style="text-align:center;padding:24px 0;">'
                        + '<button onclick="oneToOneCreateDraft(\'' + escapeHtml(selectedUser) + '\')" style="font-size:14px;padding:8px 20px;border:none;background:#2563eb;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;">New 1-to-1</button>'
                        + '</div>';
                }

                // Past meetings list
                if (versions.length > 0) {
                    mid += '<h4 style="font-size:13px;font-weight:700;margin:16px 0 8px;border-top:1px solid #e5e7eb;padding-top:12px;">Past Meetings</h4>';
                    // Group by meeting_id, show newest first
                    const seen = new Set();
                    versions.forEach(v => {
                        if (seen.has(v.version_id)) return;
                        seen.add(v.version_id);
                        const dateStr = v.version_created_at ? new Date(v.version_created_at).toLocaleDateString() : '';
                        const pillars = [];
                        try { if (v.pillar_sop && v.pillar_sop.status) pillars.push('SOP: ' + v.pillar_sop.status); } catch(e){}
                        try { if (v.pillar_data && v.pillar_data.status) pillars.push('DATA: ' + v.pillar_data.status); } catch(e){}
                        try { if (v.pillar_training && v.pillar_training.status) pillars.push('Training: ' + v.pillar_training.status); } catch(e){}
                        try { if (v.pillar_inventory && v.pillar_inventory.status) pillars.push('Inventory: ' + v.pillar_inventory.status); } catch(e){}
                        mid += '<div style="border:1px solid #e0e0e0;border-radius:8px;padding:10px;margin-bottom:8px;">'
                            + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                            + '<span style="font-size:12px;font-weight:600;">v' + v.version + ' — ' + escapeHtml(dateStr) + '</span>'
                            + '<div style="display:flex;gap:4px;">'
                            + '<button onclick="oneToOneViewVersion(' + v.version_id + ')" style="font-size:11px;padding:2px 8px;border:1px solid #2563eb;background:#fff;color:#2563eb;border-radius:4px;cursor:pointer;">View</button>'
                            + '<button onclick="oneToOneEditFromLatest(\'' + escapeHtml(selectedUser) + '\')" style="font-size:11px;padding:2px 8px;border:1px solid #059669;background:#fff;color:#059669;border-radius:4px;cursor:pointer;">Edit</button>'
                            + '</div></div>';
                        if (pillars.length) mid += '<div style="font-size:11px;color:#6b7280;margin-top:4px;">' + escapeHtml(pillars.join(' | ')) + '</div>';
                        mid += '</div>';
                    });
                }
                if (results) results.innerHTML = mid || '<div class="dic-empty-state"><h3>No 1-to-1 records</h3></div>';

                // --- Right panel: preview ---
                if (draft) {
                    dicRightPanelShow(dicBuildOneToOnePreviewHtml(draft, researcherName));
                } else if (versions.length > 0) {
                    // Show latest version preview
                    const latest = versions[0];
                    dicRightPanelShow(dicBuildOneToOnePreviewHtml(latest, researcherName));
                } else {
                    dicRightPanelShow('<div class="dic-empty-state"><h3>No 1-to-1 meetings yet</h3><p style="color:#6b7280;font-size:13px;">Click "New 1-to-1" to start</p></div>');
                }
            } catch (err) {
                console.error('[Vision] 1-to-1 fetch error:', err);
                if (dicVisionMode !== modeAtStart || seq !== _1to1SeqCounter) return;
                if (results) results.innerHTML = '<div class="dic-empty-state"><h3>1-to-1 failed to load</h3></div>';
                dicRightPanelShow('<div class="glpCard" style="border-color:#f8d7da;"><div class="glpMicroTitle">ERROR</div><p style="color:#721c24;font-size:13px;margin:0;">Failed to load 1-to-1 data</p></div>');
            }
        }

        // --- Draft form builder (middle panel, editable) ---
        function dicBuildOneToOneFormHtml(draft) {
            const pillars = [
                { key: 'sop', label: 'SOP', data: draft.pillar_sop || {} },
                { key: 'data', label: 'DATA / ALCOA', data: draft.pillar_data || {} },
                { key: 'training', label: 'Training', data: draft.pillar_training || {} },
                { key: 'inventory', label: 'Inventory', data: draft.pillar_inventory || {} }
            ];
            const statusOpts = ['Not reviewed', 'OK', 'Needs action'];
            const roleOpts = ['Researcher', 'Supervisor', 'PI'];
            const actions = Array.isArray(draft.actions) ? draft.actions : [];

            let html = '<div id="oneToOneFormArea" style="font-size:13px;">';
            pillars.forEach(p => {
                const st = p.data.status || 'Not reviewed';
                const comment = p.data.comment || '';
                html += '<div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-bottom:10px;">'
                    + '<div style="font-weight:700;margin-bottom:6px;">' + escapeHtml(p.label) + '</div>'
                    + '<label style="font-size:11px;color:#6b7280;">Status</label>'
                    + '<select data-pillar="' + p.key + '" data-field="status" onchange="oneToOneAutoSave()" style="display:block;width:100%;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;margin-bottom:6px;font-size:12px;">';
                statusOpts.forEach(o => { html += '<option' + (st === o ? ' selected' : '') + '>' + escapeHtml(o) + '</option>'; });
                html += '</select>'
                    + '<label style="font-size:11px;color:#6b7280;">Comment</label>'
                    + '<input type="text" data-pillar="' + p.key + '" data-field="comment" value="' + escapeHtml(comment).replace(/"/g, '&quot;') + '" onchange="oneToOneAutoSave()" style="display:block;width:100%;padding:4px 6px;border:1px solid #d1d5db;border-radius:4px;font-size:12px;box-sizing:border-box;" />'
                    + '</div>';
            });

            // Actions section
            html += '<div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-bottom:10px;">'
                + '<div style="font-weight:700;margin-bottom:6px;">Action Items</div>'
                + '<div id="oneToOneActionsContainer">';
            for (let i = 0; i < Math.min(actions.length, 12); i++) {
                const a = actions[i];
                html += oneToOneActionRowHtml(i, a);
            }
            html += '</div>'
                + '<button onclick="oneToOneAddAction()" style="font-size:11px;padding:3px 10px;border:1px solid #d1d5db;background:#f9fafb;border-radius:4px;cursor:pointer;margin-top:4px;">+ Add action</button>'
                + '</div>';

            // Private comment
            html += '<div style="border:1px solid #e5e7eb;border-radius:8px;padding:10px;margin-bottom:10px;">'
                + '<div style="font-weight:700;margin-bottom:6px;">PI Private Comment</div>'
                + '<textarea id="oneToOnePrivateComment" onchange="oneToOneAutoSave()" style="width:100%;min-height:50px;padding:6px;border:1px solid #d1d5db;border-radius:4px;font-size:12px;box-sizing:border-box;resize:vertical;">' + escapeHtml(draft.private_comment || '') + '</textarea>'
                + '<div style="font-size:10px;color:#9ca3af;margin-top:2px;">This comment is never visible to researchers.</div>'
                + '</div>';

            html += '</div>';
            return html;
        }

        function oneToOneActionRowHtml(idx, a) {
            a = a || {};
            const roleOpts = ['Researcher', 'Supervisor', 'PI'];
            const pillOpts = ['sop', 'data', 'training', 'inventory'];
            let html = '<div class="oto-action-row" data-action-idx="' + idx + '" style="display:grid;grid-template-columns:1fr 80px 80px 90px 28px;gap:4px;margin-bottom:4px;align-items:center;">'
                + '<input type="text" data-action="text" value="' + escapeHtml(a.text || a.action_text || '').replace(/"/g, '&quot;') + '" onchange="oneToOneAutoSave()" placeholder="Action..." style="font-size:11px;padding:3px 4px;border:1px solid #d1d5db;border-radius:3px;" />'
                + '<select data-action="pillar" onchange="oneToOneAutoSave()" style="font-size:11px;padding:3px;border:1px solid #d1d5db;border-radius:3px;">';
            pillOpts.forEach(p => { html += '<option value="' + p + '"' + ((a.pillar||'sop') === p ? ' selected' : '') + '>' + p.toUpperCase().slice(0,5) + '</option>'; });
            html += '</select>'
                + '<select data-action="owner_role" onchange="oneToOneAutoSave()" style="font-size:11px;padding:3px;border:1px solid #d1d5db;border-radius:3px;">';
            roleOpts.forEach(r => { html += '<option' + ((a.owner_role||'Researcher') === r ? ' selected' : '') + '>' + r + '</option>'; });
            html += '</select>'
                + '<input type="date" data-action="due_date" value="' + (a.due_date ? String(a.due_date).slice(0,10) : '') + '" onchange="oneToOneAutoSave()" style="font-size:10px;padding:2px;border:1px solid #d1d5db;border-radius:3px;" />'
                + '<button onclick="this.closest(\'.oto-action-row\').remove();oneToOneAutoSave()" style="font-size:14px;border:none;background:none;color:#dc2626;cursor:pointer;padding:0;">&times;</button>'
                + '</div>';
            return html;
        }

        function oneToOneAddAction() {
            const container = document.getElementById('oneToOneActionsContainer');
            if (!container) return;
            const rows = container.querySelectorAll('.oto-action-row');
            if (rows.length >= 12) return; // reasonable max
            const idx = rows.length;
            container.insertAdjacentHTML('beforeend', oneToOneActionRowHtml(idx, {}));
        }

        // --- Preview builder (right panel, read-only) ---
        function dicBuildOneToOnePreviewHtml(record, researcherName) {
            const pillars = [
                { key: 'sop', label: 'SOP', data: record.pillar_sop || {} },
                { key: 'data', label: 'DATA / ALCOA', data: record.pillar_data || {} },
                { key: 'training', label: 'Training', data: record.pillar_training || {} },
                { key: 'inventory', label: 'Inventory', data: record.pillar_inventory || {} }
            ];
            const statusColors = { 'OK': '#059669', 'Needs action': '#dc2626', 'Not reviewed': '#6b7280' };
            const dateStr = record.version_created_at ? new Date(record.version_created_at).toLocaleDateString() : (record.updated_at ? new Date(record.updated_at).toLocaleDateString() : 'Draft');
            const isVersion = !!record.version;
            const actions = record.actions || [];

            let html = '<div style="padding:12px;font-size:13px;">';
            html += '<h3 style="margin:0 0 4px;font-size:15px;">1-to-1 — ' + escapeHtml(researcherName) + '</h3>';
            html += '<div style="font-size:11px;color:#6b7280;margin-bottom:12px;">' + (isVersion ? 'Version ' + record.version + ' — ' : 'Draft — ') + escapeHtml(dateStr) + '</div>';

            pillars.forEach(p => {
                const st = p.data.status || 'Not reviewed';
                const color = statusColors[st] || '#6b7280';
                html += '<div style="border-left:3px solid ' + color + ';padding:6px 10px;margin-bottom:8px;background:#f9fafb;border-radius:0 6px 6px 0;">'
                    + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                    + '<span style="font-weight:700;">' + escapeHtml(p.label) + '</span>'
                    + '<span style="font-size:11px;font-weight:600;color:' + color + ';">' + escapeHtml(st) + '</span></div>';
                if (p.data.comment) html += '<div style="font-size:12px;color:#4b5563;margin-top:2px;">' + escapeHtml(p.data.comment) + '</div>';
                // Show actions for this pillar
                const pillarActions = actions.filter(a => a.pillar === p.key);
                if (pillarActions.length) {
                    html += '<div style="margin-top:4px;">';
                    pillarActions.forEach(a => {
                        const txt = a.action_text || a.text || '';
                        const doneStyle = a.done ? 'text-decoration:line-through;color:#9ca3af;' : '';
                        html += '<div style="font-size:11px;margin-left:6px;' + doneStyle + '">'
                            + (a.done ? '\u2611' : '\u2610') + ' ' + escapeHtml(txt)
                            + ' <span style="color:#9ca3af;">(' + escapeHtml(a.owner_role || '') + (a.due_date ? ' — ' + String(a.due_date).slice(0,10) : '') + ')</span></div>';
                    });
                    html += '</div>';
                }
                html += '</div>';
            });

            // Private comment (only in preview for PI)
            if (record.private_comment) {
                html += '<div style="border:1px dashed #d1d5db;border-radius:6px;padding:8px;margin-top:8px;background:#fef3c7;">'
                    + '<div style="font-size:11px;font-weight:700;color:#92400e;margin-bottom:2px;">PI Private Note</div>'
                    + '<div style="font-size:12px;color:#78350f;">' + escapeHtml(record.private_comment) + '</div></div>';
            }
            html += '</div>';
            return html;
        }

        // --- Auto-save (debounced) ---
        let _1to1SaveTimer = null;
        function oneToOneAutoSave() {
            clearTimeout(_1to1SaveTimer);
            const capturedResearcherId = dicFilters.researcher;
            _1to1SaveTimer = setTimeout(() => oneToOneDoSave(capturedResearcherId), 1200);
            // Update right panel preview immediately
            const draftData = oneToOneCollectFormData();
            if (draftData) {
                const name = dicFilters.researcher ? dicFormatResearcherName(
                    (dicResearcherMetrics[dicFilters.researcher] || {}).researcher_name || dicFilters.researcher
                ) : '';
                dicRightPanelShow(dicBuildOneToOnePreviewHtml(draftData, name));
            }
        }

        function oneToOneCollectFormData() {
            const form = document.getElementById('oneToOneFormArea');
            if (!form) return null;
            const pillars = {};
            form.querySelectorAll('[data-pillar]').forEach(el => {
                const key = el.getAttribute('data-pillar');
                const field = el.getAttribute('data-field');
                if (!pillars[key]) pillars[key] = {};
                pillars[key][field] = el.value;
            });
            const actions = [];
            form.querySelectorAll('.oto-action-row').forEach(row => {
                const a = {};
                row.querySelectorAll('[data-action]').forEach(el => { a[el.getAttribute('data-action')] = el.value; });
                if (a.text) actions.push(a);
            });
            const privateComment = (document.getElementById('oneToOnePrivateComment') || {}).value || '';
            return {
                pillar_sop: pillars.sop || {},
                pillar_data: pillars.data || {},
                pillar_training: pillars.training || {},
                pillar_inventory: pillars.inventory || {},
                actions,
                private_comment: privateComment,
                updated_at: new Date().toISOString()
            };
        }

        async function oneToOneDoSave(researcherIdOverride) {
            const researcherId = researcherIdOverride || dicFilters.researcher;
            if (!researcherId || dicVisionMode !== 'onetoone') return;
            const formData = oneToOneCollectFormData();
            if (!formData) return;
            try {
                await fetch('/api/di/1to1/updateDraft', {
                    method: 'PUT',
                    credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ researcher_id: researcherId, ...formData })
                });
            } catch (err) {
                console.error('[1to1] auto-save error:', err);
            }
        }

        // --- Actions: create, discard, finalize, view, edit ---
        async function oneToOneCreateDraft(researcherId) {
            try {
                const resp = await fetch('/api/di/1to1/createDraft', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ researcher_id: researcherId })
                });
                const data = await resp.json();
                if (data.success) glpVisionRenderOneToOne(researcherId);
                else alert(data.error || 'Failed to create draft');
            } catch (err) { console.error('[1to1] createDraft error:', err); }
        }

        async function oneToOneDiscardDraft(researcherId) {
            if (!confirm('Discard this draft? This cannot be undone.')) return;
            try {
                await fetch('/api/di/1to1/discardDraft', {
                    method: 'DELETE', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ researcher_id: researcherId })
                });
                glpVisionRenderOneToOne(researcherId);
            } catch (err) { console.error('[1to1] discardDraft error:', err); }
        }

        async function oneToOneFinalize(researcherId) {
            // Flush any pending auto-save first
            clearTimeout(_1to1SaveTimer);
            await oneToOneDoSave();
            try {
                const resp = await fetch('/api/di/1to1/finalizeDraftToVersion', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ researcher_id: researcherId })
                });
                const data = await resp.json();
                if (data.success) glpVisionRenderOneToOne(researcherId);
                else alert(data.error || 'Failed to save meeting');
            } catch (err) { console.error('[1to1] finalize error:', err); }
        }

        async function oneToOneViewVersion(versionId) {
            try {
                const resp = await fetch(`/api/di/1to1/getVersion/${versionId}`, { credentials: 'include' });
                const data = await resp.json();
                if (data.success) {
                    const v = data.version;
                    v.actions = data.actions || [];
                    const name = dicFilters.researcher ? dicFormatResearcherName(
                        (dicResearcherMetrics[dicFilters.researcher] || {}).researcher_name || dicFilters.researcher
                    ) : '';
                    dicRightPanelShow(dicBuildOneToOnePreviewHtml(v, name));
                }
            } catch (err) { console.error('[1to1] viewVersion error:', err); }
        }

        async function oneToOneEditFromLatest(researcherId) {
            try {
                const resp = await fetch('/api/di/1to1/startEditFromLatest', {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ researcher_id: researcherId })
                });
                const data = await resp.json();
                if (data.success) glpVisionRenderOneToOne(researcherId);
                else alert(data.error || 'Failed to start edit');
            } catch (err) { console.error('[1to1] editFromLatest error:', err); }
        }

// ===============================
// InternalDocs, PI-only, DIC integration (pi-dashboard)
// ===============================
let dicInternalDocsMode = false;
let dicInternalDocsTree = null;
let dicInternalDocsItems = [];
let dicSelectedInternalKey = null;

function dicFindViewerIframe() {
  return document.getElementById('dicViewerPdf');
}

function dicEnsureViewerIframe() {
  var iframe = document.getElementById('dicViewerPdf');
  if (iframe) return iframe;
  // Create the iframe with the same id/class/styles used by DATA
  iframe = document.createElement('iframe');
  iframe.id = 'dicViewerPdf';
  iframe.className = 'dic-viewer-pdf';
  iframe.style.cssText = 'display:block;width:100%;height:100%;border:0;';
  var viewer = document.querySelector('.dic-viewer');
  if (viewer) {
    var empty = document.getElementById('dicViewerEmpty');
    if (empty) empty.style.display = 'none';
    viewer.appendChild(iframe);
  }
  return iframe;
}

function dicSetViewerHeaderForInternalDoc(key) {
  var filename = key.split('/').pop() || 'document.pdf';
  var toolbar = document.getElementById('dicToolbar');
  if (!toolbar) return;
  toolbar.innerHTML =
    '<span class="dic-viewer-filename" title="' + filename.replace(/"/g, '&quot;') + '">' + filename + '</span>' +
    '<span class="dic-badge paper">PAPER</span>' +
    '<button class="dic-toolbar-icon dic-toolbar-presentation" onclick="dicPresentationMode()" title="Presentation Mode" aria-label="Presentation Mode"><span class="dic-emoji-icon" aria-hidden="true">\uD83C\uDFAC</span></button>';
  // Hide intel panel (not relevant for Papers)
  var intel = document.getElementById('dicIntelPanel');
  if (intel) intel.style.display = 'none';
}

function dicSetScopePillsEnabled(enabled) {
  const pillsWrap = document.querySelector('.dic-scope-pills');
  if (!pillsWrap) return;
  pillsWrap.querySelectorAll('.dic-scope-pill').forEach(p => {
    if (p.tagName === 'SELECT') return;
    p.style.opacity = enabled ? '' : '0.45';
    p.style.pointerEvents = enabled ? '' : 'none';
  });
}

async function dicInitInternalDocs() {
  const sel = document.getElementById('dicIntdocsSelect');
  if (!sel) return;

  try {
    const r = await fetch('/api/internal-docs/tree', { credentials: 'include' });
    if (!r.ok) { sel.style.display = 'none'; return; }
    const data = await r.json();
    dicInternalDocsTree = data.categories || {};
    sel.style.display = 'inline-block';
    if (!sel.value) sel.value = 'papers';
    await dicIntdocsChanged(sel);
  } catch (e) {
    sel.style.display = 'none';
  }
}

async function dicFetchInternalDocsList(category, folder) {
  let url = '/api/internal-docs/list?category=' + encodeURIComponent(category);
  if (folder) url += '&folder=' + encodeURIComponent(folder);
  const r = await fetch(url, { credentials: 'include' });
  const data = await r.json();
  data.items = data.items || data.files || [];
  if (!r.ok) throw new Error((data && (data.error || data.message)) || 'Failed to list internal docs');
  return data;
}

function dicRenderInternalDocs(items) {
  const container = document.getElementById('dicResults');
  if (!container) return;

  const search = (document.getElementById('dicSearchInput')?.value || '').toLowerCase();
  let filtered = (items || []).filter(it => !search || ((it.name || '').toLowerCase().includes(search)));
  filtered = filtered.sort((a, b) => (b.name || "").localeCompare(a.name || ""));

  if (filtered.length === 0) {
    container.innerHTML = '<div class="dic-empty-state"><h3>No internal documents found</h3></div>';
    return;
  }

  container.innerHTML = filtered.map(it => {
    const keyEsc = (it.key || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const nameEsc = (it.name || '').replace(/"/g, '&quot;');
    const isActive = it.key === dicSelectedInternalKey;
    const sizeTxt = it.size ? (it.size >= 1048576 ? (Math.round(it.size / 104857.6) / 10 + ' MB') : (Math.round(it.size / 1024) + ' KB')) : '';
    return '<div class="dic-result-item' + (isActive ? ' active' : '') + '" onclick="dicOpenInternalDoc(\'' + keyEsc + '\')">' +
      '<div class="dic-result-icon paper">PDF</div>' +
      '<div class="dic-result-body">' +
        '<div class="dic-result-title" title="' + nameEsc + '">' + nameEsc + '</div>' +
        '<div class="dic-result-sub">' + sizeTxt + '</div>' +
        '<div class="dic-result-meta"><span class="dic-badge paper">PAPER</span></div>' +
      '</div>' +
    '</div>';
  }).join('');
}

function dicOpenInternalDoc(key) {
    const token = btoa(key + '_glp_2024_sec').replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
    const fileUrl = "/api/internal-docs/open?key=" + encodeURIComponent(key) + "&token=" + token + "#pagemode=none&zoom=page-width";

    dicSelectedInternalKey = key;
    dicRenderInternalDocs(dicInternalDocsItems);

    dicSetViewerHeaderForInternalDoc(key);
    const iframe = dicEnsureViewerIframe();
    if (iframe) {
      iframe.src = fileUrl;
      return;
    }
    window.open(fileUrl, "_blank", "noopener");
}

async function dicIntdocsChanged(sel) {
  const category = sel.value || 'papers';
  const folderSel = document.getElementById('dicIntdocsFolderSel');

  dicInternalDocsMode = true;

  if (folderSel) folderSel.style.display = 'none';

  const needsFolder = (category !== 'papers' && category !== 'all');
  if (needsFolder) {
    const folders = ((dicInternalDocsTree[category] || {}).folders || []).map(f => f.name);
    if (folderSel) {
      folderSel.innerHTML = '';
      folders.forEach(fn => {
        const opt = document.createElement('option');
        opt.value = fn;
        opt.textContent = fn;
        folderSel.appendChild(opt);
      });
      folderSel.style.display = 'inline-block';
    }
    const firstFolder = folders.length ? folders[0] : '';
    const data = await dicFetchInternalDocsList(category, firstFolder);
    dicInternalDocsItems = (data.items || []).map(it => {
      it.scope_label = category + (firstFolder ? (': ' + firstFolder) : '');
      return it;
    });
    dicRenderInternalDocs(dicInternalDocsItems);
    return;
  }

  const data = await dicFetchInternalDocsList(category, '');
  dicInternalDocsItems = (data.items || []).map(it => {
    let label = category;
    if (category === 'all') {
      const k = it.key || '';
      const rel = k.replace('group-docs/internal/', '');
      const parts = rel.split('/');
      if (parts.length >= 2) {
        const top = parts[0];
        const maybeFolder = parts[1];
        label = (top === 'papers') ? 'papers' : (top + ': ' + maybeFolder);
      }
    }
    it.scope_label = label;
    return it;
  });

  dicRenderInternalDocs(dicInternalDocsItems);
}

async function dicIntdocsFolderChanged(sel) {
  const categorySel = document.getElementById('dicIntdocsSelect');
  if (!categorySel) return;
  const category = categorySel.value;
  const folder = sel.value;

  const data = await dicFetchInternalDocsList(category, folder);
  dicInternalDocsItems = (data.items || []).map(it => {
    it.scope_label = category + ': ' + folder;
    return it;
  });
  dicRenderInternalDocs(dicInternalDocsItems);
}

        function dicSetChip(key, val) {
            if (key === 'status') {
                dicFilters.status = val;
                document.querySelectorAll('.dic-chip[data-filter="status"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            } else if (key === 'time') {
                dicFilters.time = val;
                document.querySelectorAll('.dic-chip[data-filter="time"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            } else if (key === 'sort') {
                dicFilters.sort = val;
                document.querySelectorAll('.dic-chip[data-filter="sort"]').forEach(c => c.classList.toggle('active', c.dataset.val === val));
            }
            dicApplyFilters();
        }

        function dicToggleDragonSeal(el) {
            dicFilters.dragonSeal = !dicFilters.dragonSeal;
            el.classList.toggle('active', dicFilters.dragonSeal);
            dicApplyFilters();
        }

        function dicApplyFilters() {
            const search = (document.getElementById('dicSearchInput').value || '').toLowerCase();
            const now = new Date();

            dicFilteredFiles = dicAllFiles.filter(f => {
                if (dicCurrentScope && f.file_type !== dicCurrentScope) return false;
                if (dicFilters.status && f.status !== dicFilters.status) return false;
                if (dicFilters.researcher && f.researcher_id !== dicFilters.researcher) return false;
                if (dicFilters.year === 'legacy') {
                    if (f.record_origin !== 'legacy_pre2026') return false;
                } else if (dicFilters.year) {
                    const yr = (f.created_at || '').substring(0, 4);
                    if (yr !== dicFilters.year) return false;
                }
                if (search && !(f.original_filename || '').toLowerCase().includes(search)) return false;
                if (dicFilters.time) {
                    const days = parseInt(dicFilters.time);
                    const fileDate = new Date(f.created_at);
                    if ((now - fileDate) / (1000 * 60 * 60 * 24) > days) return false;
                }
                if (dicFilters.dragonSeal) {
                    if (!f.pi_dragon_seal) return false;
                }
                return true;
            });

            // Sort
            if (dicFilters.sort === 'newest') {
                dicFilteredFiles.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            } else if (dicFilters.sort === 'oldest') {
                dicFilteredFiles.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
            } else if (dicFilters.sort === 'name') {
                dicFilteredFiles.sort((a, b) => (a.original_filename || '').localeCompare(b.original_filename || ''));
            }

            dicRenderResults();
        }

        function dicRenderResults() {
            const container = document.getElementById('dicResults');

            // Legacy pack-grouped view
            if (dicFilters.year === 'legacy') {
                return dicRenderLegacyPacks(container);
            }

            if (dicFilteredFiles.length === 0) {
                const resName = dicFilters.researcher ? dicFormatResearcherName(
                    (dicResearcherMetrics[dicFilters.researcher] || {}).researcher_name || dicFilters.researcher
                ) : '';
                let emptyHtml = '<div class="dic-empty-state">';
                if (dicFilters.researcher) {
                    const hasAnyFiles = dicAllFiles.some(f => f.researcher_id === dicFilters.researcher);
                    if (dicCurrentScope && !hasAnyFiles) {
                        emptyHtml += `<h3>No files found for ${resName} in the last ${dicMonthsUsed} months</h3>`;
                        emptyHtml += '<div class="dic-empty-actions">';
                        emptyHtml += `<button class="dic-empty-btn" onclick="dicShowAllMonths()">Show All Months</button>`;
                        emptyHtml += '</div>';
                    } else {
                        emptyHtml += `<h3>No ${dicCurrentScope || ''} files found for ${resName} in the last ${dicMonthsUsed} months</h3>`;
                        emptyHtml += '<div class="dic-empty-actions">';
                        emptyHtml += `<button class="dic-empty-btn" onclick="dicShowAllMonths()">Show All Months</button>`;
                        if (dicCurrentScope === 'DATA') {
                            emptyHtml += `<button class="dic-empty-btn" onclick="dicSwitchScope('PRESENTATION')">View Presentations</button>`;
                            emptyHtml += `<button class="dic-empty-btn" onclick="dicSwitchScope('SOP')">View SOPs</button>`;
                        }
                        emptyHtml += '</div>';
                    }
                } else {
                    emptyHtml += '<h3>Select a researcher or search to begin</h3>';
                }
                emptyHtml += '</div>';
                container.innerHTML = emptyHtml;
                return;
            }

            container.innerHTML = dicFilteredFiles.map(f => {
                const parsed = parseNatlabFilename(f.original_filename || '');
                const isActive = f.submission_id === dicSelectedFileId;
                const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');

                let typeClass = 'data';
                let typeLabel = 'DATA';
                if (f.file_type === 'SOP') { typeClass = 'sop'; typeLabel = 'SOP'; }
                else if (f.file_type === 'PRESENTATION') { typeClass = 'pres'; typeLabel = 'PRES'; }

                let title, subtitle;
                if (parsed.is_compliant) {
                    title = parsed.parsed_description;
                    subtitle = `${parsed.parsed_date} &middot; ${parsed.parsed_initials} &middot; ${parsed.parsed_project}`;
                } else {
                    title = f.original_filename;
                    subtitle = `${dicFormatResearcherName(f.researcher_name)} &middot; ${(f.created_at || '').substring(0, 10)}`;
                }

                let metaHtml = `<span class="dic-badge ${statusClass}">${statusLabel}</span>`;
                if (f.record_origin === 'legacy_pre2026') metaHtml += '<span class="legacy-badge">LEGACY</span>';
                if (f.pi_dragon_seal) metaHtml += '<span class="dic-dragon-badge">&#x1F409;</span>';
                const sopCount = f.linked_sop_count || 0;
                const presCount = f.linked_pres_count || 0;
                if (sopCount > 0) metaHtml += `<span class="dic-assoc-chip">${sopCount} SOP</span>`;
                if (presCount > 0) metaHtml += `<span class="dic-assoc-chip">${presCount} PRES</span>`;

                return `<div class="dic-result-item${isActive ? ' active' : ''}" onclick="dicSelectFile('${f.submission_id}')">
                    <div class="dic-result-icon ${typeClass}">${typeLabel}</div>
                    <div class="dic-result-body">
                        <div class="dic-result-title" title="${(f.original_filename || '').replace(/"/g, '&quot;')}">${title}</div>
                        <div class="dic-result-sub">${subtitle}</div>
                        <div class="dic-result-meta">${metaHtml}</div>
                    </div>
                </div>`;
            }).join('');
        }

        // Legacy pack-grouped view for Laboratory Files
        let dicLegacyExpandedPack = null;

        function dicRenderLegacyPacks(container) {
            if (dicFilteredFiles.length === 0) {
                container.innerHTML = '<div class="dic-empty-state"><h3>No legacy files found</h3></div>';
                return;
            }

            // If a pack is expanded, show its files
            if (dicLegacyExpandedPack) {
                const packFiles = dicFilteredFiles.filter(f => f.legacy_pack_id === dicLegacyExpandedPack);
                if (packFiles.length === 0) { dicLegacyExpandedPack = null; }
                else {
                    const p = packFiles[0];
                    container.innerHTML = `<div style="margin-bottom:10px;">
                        <button style="background:none;border:none;cursor:pointer;color:#92400e;font-size:12px;" onclick="dicCollapseLegacyPack()">&larr; Back to packs</button>
                        <div style="margin-top:6px;"><span class="legacy-badge">LEGACY</span> <strong style="color:#78350f;">${escapeHtml(p.legacy_pack_title || 'Untitled Pack')}</strong></div>
                        <div style="font-size:11px;color:#92400e;margin-top:2px;">${p.legacy_pack_context_type !== 'none' ? p.legacy_pack_context_type + ' &middot; ' : ''}Submitted: ${p.legacy_pack_submitted_at ? new Date(p.legacy_pack_submitted_at).toLocaleDateString() : '-'}</div>
                    </div>` + packFiles.map(f => {
                        const isActive = f.submission_id === dicSelectedFileId;
                        const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                        const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');
                        const origDate = f.original_created_at ? new Date(f.original_created_at).toLocaleDateString() : '-';
                        let typeClass = 'data'; let typeLabel = 'DATA';
                        if (f.file_type === 'SOP') { typeClass = 'sop'; typeLabel = 'SOP'; }
                        else if (f.file_type === 'PRESENTATION') { typeClass = 'pres'; typeLabel = 'PRES'; }
                        return `<div class="dic-result-item${isActive ? ' active' : ''}" onclick="dicSelectFile('${f.submission_id}')">
                            <div class="dic-result-icon ${typeClass}">${typeLabel}</div>
                            <div class="dic-result-body">
                                <div class="dic-result-title" title="${(f.original_filename || '').replace(/"/g, '&quot;')}">${escapeHtml(f.original_filename)}</div>
                                <div class="dic-result-sub">Original: ${origDate} &middot; ${dicFormatResearcherName(f.researcher_name)}</div>
                                <div class="dic-result-meta"><span class="dic-badge ${statusClass}">${statusLabel}</span><span class="legacy-badge">LEGACY</span></div>
                            </div>
                        </div>`;
                    }).join('');
                    return;
                }
            }

            // Group by pack_id
            const packs = {};
            const unpackedFiles = [];
            dicFilteredFiles.forEach(f => {
                if (f.legacy_pack_id) {
                    if (!packs[f.legacy_pack_id]) {
                        packs[f.legacy_pack_id] = {
                            title: f.legacy_pack_title, context: f.legacy_pack_context_type,
                            submitted: f.legacy_pack_submitted_at, files: []
                        };
                    }
                    packs[f.legacy_pack_id].files.push(f);
                } else {
                    unpackedFiles.push(f);
                }
            });

            const packList = Object.entries(packs).sort((a, b) => new Date(b[1].submitted || 0) - new Date(a[1].submitted || 0));

            container.innerHTML = packList.map(([packId, p]) => `
                <div class="legacy-pack-card" onclick="dicExpandLegacyPack('${packId}')">
                    <div class="legacy-pack-header">
                        <span class="legacy-badge">LEGACY</span>
                        <strong>${escapeHtml(p.title || 'Untitled Pack')}</strong>
                        <span style="margin-left:auto;font-size:12px;color:#6b7280;">${p.files.length} file(s)</span>
                    </div>
                    <div class="legacy-pack-meta">
                        ${p.context && p.context !== 'none' ? escapeHtml(p.context) + ' &middot; ' : ''}Submitted: ${p.submitted ? new Date(p.submitted).toLocaleDateString() : '-'}
                    </div>
                </div>
            `).join('') + (unpackedFiles.length > 0
                ? '<div style="margin-top:12px;font-size:12px;color:#6b7280;border-top:1px solid #e5e7eb;padding-top:10px;">' + unpackedFiles.length + ' file(s) not in a pack</div>'
                    + unpackedFiles.map(f => {
                        const isActive = f.submission_id === dicSelectedFileId;
                        const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                        const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');
                        let typeClass = 'data'; let typeLabel = 'DATA';
                        if (f.file_type === 'SOP') { typeClass = 'sop'; typeLabel = 'SOP'; }
                        else if (f.file_type === 'PRESENTATION') { typeClass = 'pres'; typeLabel = 'PRES'; }
                        return `<div class="dic-result-item${isActive ? ' active' : ''}" onclick="dicSelectFile('${f.submission_id}')">
                            <div class="dic-result-icon ${typeClass}">${typeLabel}</div>
                            <div class="dic-result-body">
                                <div class="dic-result-title">${escapeHtml(f.original_filename)}</div>
                                <div class="dic-result-meta"><span class="dic-badge ${statusClass}">${statusLabel}</span><span class="legacy-badge">LEGACY</span></div>
                            </div>
                        </div>`;
                    }).join('')
                : '');
        }

        function dicExpandLegacyPack(packId) {
            dicLegacyExpandedPack = packId;
            dicRenderResults();
        }

        function dicCollapseLegacyPack() {
            dicLegacyExpandedPack = null;
            dicRenderResults();
        }

        function dicRenderQuickMetrics(researcherId) {
            const m = dicResearcherMetrics[researcherId];
            const el = document.getElementById('dicQuickMetrics');
            if (!m) { el.style.display = 'none'; return; }
            el.style.display = 'flex';
            const lastUpload = m.last_upload ? new Date(m.last_upload).toLocaleDateString() : 'N/A';
            el.innerHTML = [
                { v: m.data_count || 0, l: 'DATA' },
                { v: m.pres_count || 0, l: 'PRES' },
                { v: m.sop_count || 0, l: 'SOP' },
                { v: m.pending_count || 0, l: 'PENDING' },
                { v: lastUpload, l: 'LAST' }
            ].map(x => `<div class="dic-metric-box"><div class="dic-metric-value">${x.v}</div><div class="dic-metric-label">${x.l}</div></div>`).join('');
        }

        function dicAutoSelectNewest() {
            const first = dicFilteredFiles.find(f => f.file_type === 'DATA') || dicFilteredFiles[0];
            if (first) {
                dicSelectFile(first.submission_id);
            }
        }

        


// === Right panel helpers (single owner of viewer state) ===
        // These ONLY touch viewer-side elements. They NEVER touch #dicResults.
        function dicRightPanelShow(html) {
  try { console.log('[RightPanel] show', (window.dicVisionMode||''), String(html||'').slice(0,80)); } catch(e) {}
            var overlay = document.getElementById('dicVisionOverlay');
            var empty   = document.getElementById('dicViewerEmpty');
            var pdfEl   = document.getElementById('dicViewerPdf');
            var intel   = document.getElementById('dicIntelPanel');
            if (!overlay) return;
            overlay.innerHTML = '<div style="position:sticky;top:0;z-index:99999;background:#111827;color:#fff;padding:6px 10px;border-radius:10px;font-size:12px;font-weight:700;display:inline-block;margin-bottom:10px;">RIGHT PANEL OVERLAY ACTIVE</div>' + (html || '');
            overlay.style.display = 'block';
            if (empty) empty.style.display = 'none';
            if (pdfEl) pdfEl.style.display = 'none';
            if (intel) intel.style.display = 'none';
        }

        function dicRightPanelHide() {
            var overlay = document.getElementById('dicVisionOverlay');
            var empty   = document.getElementById('dicViewerEmpty');
            var pdfEl   = document.getElementById('dicViewerPdf');
            var toolbar = document.getElementById('dicToolbar');
            if (overlay) { overlay.style.display = 'none'; overlay.innerHTML = ''; }
            var hasPdf = pdfEl && pdfEl.src && pdfEl.src !== '' && pdfEl.src !== 'about:blank';
            if (toolbar) toolbar.style.display = '';
            if (hasPdf) {
                if (pdfEl) pdfEl.style.display = 'block';
                if (empty) empty.style.display = 'none';
            } else {
                if (pdfEl) pdfEl.style.display = 'none';
                if (empty) empty.style.display = 'block';
            }
        }


function dicBuildPdfViewerSrc(fileUrl) {
              const pdfjs = '/pdfjs/web/viewer.html';

              // Normalize: avoid double-encoding when callers pass a pre-encoded URL
              try {
                  if (/%3F|%26|%3D/i.test(fileUrl)) {
                      fileUrl = decodeURIComponent(fileUrl);
                  }
              } catch (e) {}

              const fileParam = encodeURIComponent(fileUrl);
              return `${pdfjs}?file=${fileParam}#pagemode=none&zoom=page-width`;
        }

        function dicSelectFile(fileId) {
            // Block right-panel changes when overlay modes are active
            if (dicVisionMode === 'training' || dicVisionMode === 'inventory' || dicVisionMode === 'onetoone') return;

            dicSelectedFileId = fileId;
            const f = dicAllFiles.find(x => x.submission_id === fileId);
            if (!f) return;

            // Update results active state
            document.querySelectorAll('.dic-result-item').forEach(el => {
                el.classList.toggle('active', el.onclick && el.onclick.toString().includes(fileId));
            });
            dicRenderResults();

            // Toolbar
            const toolbar = document.getElementById('dicToolbar');
            const statusLabel = f.status === 'REVISION_NEEDED' ? 'REVISION' : (f.status || '');
            const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
            const dragonClass = f.pi_dragon_seal ? ' sealed' : '';
            let btns = '';
            if (f.status === 'PENDING') {
                btns += `<button class="dic-toolbar-btn approve" onclick="dicApproveFile('${f.submission_id}')">Approve</button>`;
                btns += `<button class="dic-toolbar-btn revise" onclick="dicOpenReviseModal('${f.submission_id}')">Revise</button>`;
            }
            btns += `<button class="dic-toolbar-dragon${dragonClass}" onclick="dicToggleDragonSealFile('${f.submission_id}')" title="Dragon Seal" aria-label="Toggle Dragon Seal">&#x1F409;</button>`;
            btns += `<button class="dic-toolbar-icon dic-toolbar-presentation" onclick="dicPresentationMode()" title="Presentation Mode" aria-label="Presentation Mode"><span class="dic-emoji-icon" aria-hidden="true">🎬</span></button>`;
            btns += `<a class="dic-toolbar-icon" style="background:#ffffff;border:1px solid #e5e7eb;" href="/api/di/download/${f.submission_id}" target="_blank" title="Download" aria-label="Download"><svg viewBox="0 0 20 20" fill="none"><path d="M10 3v10M10 13l-3.5-3.5M10 13l3.5-3.5M4 16h12" stroke="#111827" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg></a>`;
            toolbar.innerHTML = `<span class="dic-viewer-filename" title="${(f.original_filename || '').replace(/"/g, '&quot;')}">${f.original_filename}</span>
                <span class="dic-badge ${statusClass}">${statusLabel}</span>${btns}`;

            // PDF viewer — always route through PDF.js (no native browser PDF rendering)
            document.getElementById('dicViewerEmpty').style.display = 'none';
            const pdfEl = document.getElementById('dicViewerPdf');
            pdfEl.style.display = 'block';
            pdfEl.src = dicBuildPdfViewerSrc(`/api/di/download/${f.submission_id}`);

            // Intel panel
            document.getElementById('dicIntelPanel').style.display = 'block';
            dicLoadAssociations(fileId, f);
        }

        async function dicLoadAssociations(fileId, file) {
            const sopsEl = document.getElementById('dicIntelSops');
            const presEl = document.getElementById('dicIntelPres');
            sopsEl.innerHTML = '';
            presEl.innerHTML = '';

            try {
                const res = await fetch(`/api/di/file-associations/${fileId}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed');
                const data = await res.json();
                dicAssociationsCache[fileId] = data;

                const manualSops = (data.manual || []).filter(m => m.link_type === 'SOP');
                const manualPres = (data.manual || []).filter(m => m.link_type === 'PRESENTATION');
                const heuristicSops = (data.heuristic_sop || []);
                const heuristicPres = (data.heuristic_pres || []);

                const sopTotal = manualSops.length + heuristicSops.length;
                const presTotal = manualPres.length + heuristicPres.length;
                document.getElementById('dicSopLabel').textContent = `SOPs (${manualSops.length})`;
                document.getElementById('dicPresLabel').textContent = `PRES (${manualPres.length})`;

                dicRenderIntelStrip(sopsEl, manualSops, heuristicSops, 'SOP');
                dicRenderIntelStrip(presEl, manualPres, heuristicPres, 'PRESENTATION');
            } catch (err) {
                sopsEl.innerHTML = '<span style="font-size:10px;color:#ef4444;">Error</span>';
                presEl.innerHTML = '<span style="font-size:10px;color:#ef4444;">Error</span>';
            }
        }

        function dicRenderIntelStrip(container, manual, heuristic, type) {
            let html = '';
            const maxItems = 2;
            let count = 0;

            manual.forEach(m => {
                if (count >= maxItems) return;
                const statusClass = (m.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = m.status === 'REVISION_NEEDED' ? 'REV' : (m.status || '').substring(0, 3);
                html += `<span class="dic-intel-chip" onclick="dicSelectFile('${m.target_id}')" title="${(m.original_filename || '').replace(/"/g, '&quot;')}">
                    ${dicTruncate(m.original_filename || '', 30)}
                    <span class="dic-badge ${statusClass}">${statusLabel}</span>
                    <span class="dic-intel-chip-remove" onclick="event.stopPropagation();dicUnlinkFile('${m.id}')">&times;</span>
                </span>`;
                count++;
            });

            heuristic.forEach(h => {
                if (count >= maxItems) return;
                html += `<span class="dic-intel-chip heuristic" onclick="dicQuickLink('${h.submission_id}','${type}')" title="Click to link: ${(h.filename || '').replace(/"/g, '&quot;')}">
                    ${dicTruncate(h.filename || '', 28)}
                    <span class="dic-intel-chip-score">${h.score}pt</span>
                </span>`;
                count++;
            });

            if (count === 0) {
                html = '<span style="font-size:10px;color:#9ca3af;">None</span>';
            }
            container.innerHTML = html;
        }

        function dicTruncate(str, max) {
            return str.length > max ? str.substring(0, max - 1) + '\u2026' : str;
        }

        var _dicPresEscHandler = null;
        var _dicPresFsHandler = null;
        var _dicPresClosing = false;

        function dicPresentationMode() {
          var overlay = document.getElementById('dicPresentationOverlay');

          // Toggle off if already open
          if (overlay && overlay.style.display === 'block') {
            _dicPresClose(false);
            return;
          }

          var viewer = document.getElementById('dicViewerPdf');
          var src = viewer && viewer.src;
          if (!src) return;

          // GLP docs use PDF.js viewer, Papers use native PDF endpoint
          var isGlpPdfjs = src.indexOf('/pdfjs/web/viewer.html') !== -1;

          // Create overlay if needed
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'dicPresentationOverlay';
            overlay.innerHTML = '<button class="dic-pres-close" onclick="dicPresentationMode()" title="Exit (ESC)">\u00D7</button><iframe></iframe>';
            document.body.appendChild(overlay);
          }

          // Mark overlay mode so fullscreenchange only affects GLP docs
          overlay.dataset.glpPdfjs = isGlpPdfjs ? '1' : '0';

          var oIframe = overlay.querySelector('iframe');
          if (!oIframe) { window.open(src, '_blank'); return; }

          oIframe.src = src;
          overlay.style.display = 'block';
          document.body.style.overflow = 'hidden';

          // ESC: for GLP docs, ESC exits fullscreen first, then fullscreenchange closes overlay
          _dicPresEscHandler = function(e) {
            if (e.key !== 'Escape') return;

            if (overlay && overlay.dataset.glpPdfjs === '1') {
              try {
                if (document.fullscreenElement && document.exitFullscreen) {
                  document.exitFullscreen().catch(function(){});
                  return;
                }
                if (document.webkitFullscreenElement && document.webkitExitFullscreen) {
                  document.webkitExitFullscreen();
                  return;
                }
              } catch (err) {}
            }

            // Papers, or not in fullscreen, close overlay directly
            _dicPresClose(true);
          };
          document.addEventListener('keydown', _dicPresEscHandler);

          // When fullscreen exits, close overlay automatically, this makes one ESC return to portal
          _dicPresFsHandler = function() {
            var ov = document.getElementById('dicPresentationOverlay');
            if (!ov) return;
            if (ov.style.display !== 'block') return;
            if (ov.dataset.glpPdfjs !== '1') return;

            var fsEl = document.fullscreenElement || document.webkitFullscreenElement;
            if (!fsEl) {
              _dicPresClose(true);
            }
          };
          document.addEventListener('fullscreenchange', _dicPresFsHandler);
          document.addEventListener('webkitfullscreenchange', _dicPresFsHandler);

          // Premium true fullscreen for GLP docs only
          if (isGlpPdfjs) {
            try {
              if (overlay.requestFullscreen) overlay.requestFullscreen().catch(function(){});
              else if (overlay.webkitRequestFullscreen) overlay.webkitRequestFullscreen();
            } catch (e) {}
          }
        }

        function _dicPresClose(skipFsExit) {
          if (_dicPresClosing) return;
          _dicPresClosing = true;

          try {
            if (!skipFsExit) {
              if (document.fullscreenElement && document.exitFullscreen) {
                document.exitFullscreen().catch(function(){});
              } else if (document.webkitFullscreenElement && document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
              }
            }
          } catch (e) {}

          var overlay = document.getElementById('dicPresentationOverlay');
          if (overlay) {
            overlay.style.display = 'none';
            overlay.dataset.glpPdfjs = '0';
            var oIframe = overlay.querySelector('iframe');
            if (oIframe) oIframe.src = 'about:blank';
          }

          document.body.style.overflow = '';

          if (_dicPresEscHandler) {
            document.removeEventListener('keydown', _dicPresEscHandler);
            _dicPresEscHandler = null;
          }
          if (_dicPresFsHandler) {
            document.removeEventListener('fullscreenchange', _dicPresFsHandler);
            document.removeEventListener('webkitfullscreenchange', _dicPresFsHandler);
            _dicPresFsHandler = null;
          }

          _dicPresClosing = false;
        }

        async function dicToggleDragonSealFile(id) {
            const f = dicAllFiles.find(x => x.submission_id === id);
            if (!f) return;
            const newVal = !f.pi_dragon_seal;
            try {
                const res = await fetch(`/api/di/documents/${id}/dragon-seal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ enabled: newVal })
                });
                const data = await res.json();
                if (data.success) {
                    f.pi_dragon_seal = data.pi_dragon_seal;
                    dicRenderResults();
                    dicSelectFile(id);
                } else {
                    alert(data.error || 'Failed to toggle Dragon Seal');
                }
            } catch (err) {
                alert('Error toggling Dragon Seal');
            }
        }

        async function dicApproveFile(id) {
            if (!confirm('Approve this file?')) return;
            try {
                const res = await fetch(`/api/di/approve-inline/${id}`, {
                    method: 'POST', credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    alert('File approved successfully.');
                    await dicInit();
                    dicSelectFile(id);
                } else {
                    alert(data.error || 'Approval failed');
                }
            } catch (err) {
                alert('Error approving file');
            }
        }

        function dicOpenReviseModal(id) {
            dicReviseFileId = id;
            document.getElementById('dicReviseText').value = '';
            document.getElementById('dicReviseModal').classList.add('active');
        }

        function dicCloseReviseModal() {
            document.getElementById('dicReviseModal').classList.remove('active');
            dicReviseFileId = null;
        }

        async function dicSubmitRevision() {
            const comments = document.getElementById('dicReviseText').value.trim();
            if (!comments) { alert('Please provide revision comments.'); return; }
            if (!dicReviseFileId) return;
            try {
                const res = await fetch(`/api/di/revise-inline/${dicReviseFileId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ comments })
                });
                const data = await res.json();
                if (data.success) {
                    dicCloseReviseModal();
                    alert('Revision requested.');
                    await dicInit();
                } else {
                    alert(data.error || 'Revision failed');
                }
            } catch (err) {
                alert('Error requesting revision');
            }
        }

        async function dicQuickLink(targetId, type) {
            if (!dicSelectedFileId) return;
            try {
                const res = await fetch('/api/di/file-associations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ source_id: dicSelectedFileId, target_id: targetId, link_type: type })
                });
                const data = await res.json();
                if (data.success) {
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to link');
                }
            } catch (err) {
                alert('Error linking file');
            }
        }

        async function dicUnlinkFile(assocId) {
            if (!confirm('Remove this link?')) return;
            try {
                const res = await fetch(`/api/di/file-associations/${assocId}`, {
                    method: 'DELETE', credentials: 'include'
                });
                const data = await res.json();
                if (data.success) {
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to unlink');
                }
            } catch (err) {
                alert('Error unlinking file');
            }
        }

        function dicOpenLinkModal(type) {
            dicLinkModalType = type;
            document.getElementById('dicLinkModalTitle').textContent = type === 'SOP' ? 'Link SOP' : 'Link Presentation';
            document.getElementById('dicLinkSearch').value = '';
            document.getElementById('dicLinkModal').classList.add('active');
            dicFilterLinkCandidates();
        }

        function dicCloseLinkModal() {
            document.getElementById('dicLinkModal').classList.remove('active');
        }

        function dicFilterLinkCandidates() {
            const search = (document.getElementById('dicLinkSearch').value || '').toLowerCase();
            const container = document.getElementById('dicLinkCandidates');
            const cached = dicAssociationsCache[dicSelectedFileId];
            const manualIds = new Set();
            if (cached && cached.manual) {
                cached.manual.filter(m => m.link_type === dicLinkModalType).forEach(m => manualIds.add(m.target_id));
            }

            const candidates = dicAllFiles.filter(f => {
                if (f.file_type !== dicLinkModalType) return false;
                if (f.submission_id === dicSelectedFileId) return false;
                if (search && !(f.original_filename || '').toLowerCase().includes(search)) return false;
                return true;
            });

            if (candidates.length === 0) {
                container.innerHTML = '<div style="font-size:12px;color:#9ca3af;text-align:center;padding:20px;">No candidates found</div>';
                return;
            }

            container.innerHTML = candidates.slice(0, 50).map(f => {
                const linked = manualIds.has(f.submission_id);
                const statusClass = (f.status || '').toLowerCase().replace('_needed', '');
                const statusLabel = f.status === 'REVISION_NEEDED' ? 'REV' : (f.status || '').substring(0, 4);
                return `<div class="dic-modal-item${linked ? ' linked' : ''}" ${linked ? '' : `onclick="dicLinkFromModal('${f.submission_id}')"`}>
                    <span>${f.original_filename}</span>
                    <span class="dic-badge ${statusClass}">${statusLabel}</span>
                    ${linked ? '<span style="font-size:10px;color:#9ca3af;">linked</span>' : ''}
                </div>`;
            }).join('');
        }

        async function dicLinkFromModal(targetId) {
            if (!dicSelectedFileId) return;
            try {
                const res = await fetch('/api/di/file-associations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ source_id: dicSelectedFileId, target_id: targetId, link_type: dicLinkModalType })
                });
                const data = await res.json();
                if (data.success) {
                    dicCloseLinkModal();
                    const f = dicAllFiles.find(x => x.submission_id === dicSelectedFileId);
                    if (f) dicLoadAssociations(dicSelectedFileId, f);
                    dicInit();
                } else {
                    alert(data.error || 'Failed to link');
                }
            } catch (err) {
                alert('Error linking file');
            }
        }

        function dicShowAllMonths() {
            dicMonthsUsed = 60;
            dicInit();
        }

        function dicSwitchScope(scope) {
            dicCurrentScope = scope;
            document.querySelectorAll('.dic-scope-pill').forEach(p => p.classList.toggle('active', p.dataset.scope === scope));
            dicApplyFilters();
        }

        function toggleDicSidebar() {
            const sidebar = document.getElementById('dicSidebar');
            sidebar.classList.toggle('collapsed');
        }

        // =====================================================
        // GROUP DOCUMENTS TAB
        // =====================================================
        async function loadGroupDocuments() {
            const tbody = document.getElementById('groupDocsTableBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/group-documents', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.documents || data.documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#666;padding:20px;">No documents yet</td></tr>';
                    return;
                }

                tbody.innerHTML = data.documents.map(doc => {
                    const typeClass = doc.file_type.toLowerCase();
                    const date = new Date(doc.created_at).toLocaleDateString();
                    const canDownload = doc.can_download !== false;
                    return `
                        <tr>
                            <td>
                                <strong>${escapeHtml(doc.title)}</strong>
                                ${doc.description ? '<br><small style="color:#666;">' + escapeHtml(doc.description) + '</small>' : ''}
                            </td>
                            <td>${escapeHtml(doc.category)}</td>
                            <td><span class="type-badge ${typeClass}">${doc.file_type}</span></td>
                            <td>${canDownload ? '<span style="color:#28a745;">Yes</span>' : '<span style="color:#999;">View only</span>'}</td>
                            <td>${date}</td>
                            <td>
                                <div class="actions">
                                    <button class="btn btn-sm btn-success" onclick="window.location.href='${doc.downloadUrl}'">Download</button>
                                    <button class="btn btn-sm btn-warning" onclick="editGroupDoc('${doc.id}', '${escapeHtml(doc.title)}', '${escapeHtml(doc.category)}', '${escapeHtml(doc.description || '')}', ${canDownload})">Edit</button>
                                    <button class="btn btn-sm btn-danger" onclick="deleteGroupDoc('${doc.id}', '${escapeHtml(doc.title)}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="6" style="color:#dc3545;text-align:center;">Error loading documents</td></tr>';
            }
        }

        // Group document file upload
        const groupDocUploadArea = document.getElementById('groupDocUploadArea');
        const groupDocFileInput = document.getElementById('groupDocFile');
        const groupDocFileName = document.getElementById('groupDocFileName');

        groupDocUploadArea.addEventListener('click', () => groupDocFileInput.click());
        groupDocFileInput.addEventListener('change', () => {
            if (groupDocFileInput.files.length > 0) {
                groupDocFileName.textContent = groupDocFileInput.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            } else {
                groupDocFileName.textContent = '';
                groupDocUploadArea.classList.remove('has-file');
            }
        });

        groupDocUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); groupDocUploadArea.style.borderColor = '#2d5a87'; });
        groupDocUploadArea.addEventListener('dragleave', () => { groupDocUploadArea.style.borderColor = '#ddd'; });
        groupDocUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            groupDocUploadArea.style.borderColor = '#ddd';
            if (e.dataTransfer.files.length > 0) {
                groupDocFileInput.files = e.dataTransfer.files;
                groupDocFileName.textContent = e.dataTransfer.files[0].name;
                groupDocUploadArea.classList.add('has-file');
            }
        });

          // Training Design document file upload
          const trainDocUploadArea = document.getElementById('trainDocUploadArea');
          const trainDocFileInput = document.getElementById('trainDocFile');
          const trainDocFileName = document.getElementById('trainDocFileName');

          if (trainDocUploadArea && trainDocFileInput) {
              trainDocUploadArea.addEventListener('click', () => trainDocFileInput.click());
              trainDocFileInput.addEventListener('change', () => {
                  if (trainDocFileInput.files.length > 0) {
                      if (trainDocFileName) trainDocFileName.textContent = trainDocFileInput.files[0].name;
                      trainDocUploadArea.classList.add('has-file');
                  } else {
                      if (trainDocFileName) trainDocFileName.textContent = '';
                      trainDocUploadArea.classList.remove('has-file');
                  }
              });

              trainDocUploadArea.addEventListener('dragover', (e) => { e.preventDefault(); trainDocUploadArea.style.borderColor = '#2d5a87'; });
              trainDocUploadArea.addEventListener('dragleave', () => { trainDocUploadArea.style.borderColor = '#ddd'; });
              trainDocUploadArea.addEventListener('drop', (e) => {
                  e.preventDefault();
                  trainDocUploadArea.style.borderColor = '#ddd';
                  if (e.dataTransfer.files.length > 0) {
                      trainDocFileInput.files = e.dataTransfer.files;
                      if (trainDocFileName) trainDocFileName.textContent = e.dataTransfer.files[0].name;
                      trainDocUploadArea.classList.add('has-file');
                  }
              });
          }

        document.getElementById('groupDocForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('docTitle').value.trim();
            const category = document.getElementById('docCategory').value;
            const description = document.getElementById('docDescription').value.trim();
            const canDownload = document.getElementById('docCanDownload').checked;
            const file = groupDocFileInput.files[0];

            if (!title || !category || !file) {
                showMessage('groupDocMessage', 'Please fill all required fields', 'error');
                return;
            }

            const submitBtn = document.getElementById('groupDocSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Uploading...';

            const formData = new FormData();
            formData.append('title', title);
            formData.append('category', category);
            formData.append('description', description);
            formData.append('can_download', canDownload);
            formData.append('file', file);

            try {
                const response = await fetch('/api/di/group-documents', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('groupDocMessage', data.error || 'Upload failed', 'error');
                } else {
                    showMessage('groupDocMessage', 'Document uploaded!', 'success');
                    document.getElementById('groupDocForm').reset();
                    groupDocFileName.textContent = '';
                    groupDocUploadArea.classList.remove('has-file');
                    loadGroupDocuments();
                }
            } catch (err) {
                showMessage('groupDocMessage', 'Connection error', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Upload Document';
            }
        });

        async function editGroupDoc(id, title, category, description, canDownload) {
            const newTitle = prompt('Edit title:', title);
            if (newTitle === null) return;

            const newCategory = prompt('Edit category (SOP, Guidelines, Templates, Training, Forms, Other):', category);
            if (newCategory === null) return;

            const newDescription = prompt('Edit description:', description);
            if (newDescription === null) return;

            const newCanDownload = confirm('Allow researchers to download this document?');

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: newTitle,
                        category: newCategory,
                        description: newDescription,
                        can_download: newCanDownload
                    }),
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document updated');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Update failed');
                }
            } catch (err) {
                alert('Error updating document');
            }
        }

        async function deleteGroupDoc(id, title) {
            if (!confirm(`Delete "${title}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`/api/di/group-documents/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('Document deleted');
                    loadGroupDocuments();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Delete failed');
                }
            } catch (err) {
                alert('Error deleting document');
            }
        }

        // =====================================================
        // USER MANAGEMENT TAB
        // =====================================================
        async function loadAllUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div>Loading...</div></td></tr>';

            try {
                const response = await fetch('/api/di/all-members', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.members || data.members.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#666;">No users found</td></tr>';
                    return;
                }

                tbody.innerHTML = data.members.map(u => {
                    const roleClass = u.role === 'pi' ? 'pi' : (u.role === 'supervisor' ? 'supervisor' : 'researcher');
                    const statusClass = u.active ? 'status-active' : 'status-inactive';
                    const canResetPassword = u.active && u.role !== 'pi' && u.last_login;
                    const legacyActive = u.legacy_enabled && u.legacy_expires_at && new Date(u.legacy_expires_at) > new Date();
                    const canLegacy = u.active && u.role !== 'pi';
                    return `
                        <tr>
                            <td>${escapeHtml(u.name || '-')}</td>
                            <td>${escapeHtml(u.institution_email || '-')}</td>
                            <td>${escapeHtml(u.researcher_id)}</td>
                            <td>${escapeHtml(u.affiliation)}</td>
                            <td><span class="role-badge ${roleClass}">${(u.role || 'researcher').toUpperCase()}</span></td>
                            <td><span class="status-badge ${statusClass}">${u.active ? 'Active' : 'Inactive'}</span></td>
                            <td>${u.submission_count || 0}</td>
                            <td>
                                <div class="actions">
                                    ${u.active ?
                                        `<button class="btn btn-sm btn-danger" onclick="deactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Deactivate</button>` :
                                        `<button class="btn btn-sm btn-success" onclick="reactivateUser('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reactivate</button>`
                                    }
                                    ${canResetPassword ?
                                        `<button class="btn btn-sm btn-warning" onclick="resetUserPassword('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}')">Reset Password</button>` : ''
                                    }
                                    ${canLegacy ? (legacyActive
                                        ? `<button class="btn btn-sm" style="background:#f59e0b;color:#78350f;" onclick="toggleLegacy('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}', false)">Legacy ON</button>`
                                        : `<button class="btn btn-sm btn-secondary" onclick="toggleLegacy('${u.researcher_id}', '${escapeHtml(u.name || u.researcher_id)}', true)">Legacy</button>`
                                    ) : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="color:#dc3545;text-align:center;">Error loading users</td></tr>';
            }
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const name = document.getElementById('newUserName').value.trim();
            const email = document.getElementById('newUserEmail').value.trim().toLowerCase();
            const affiliation = document.getElementById('newUserAffiliation').value;
            const role = document.getElementById('newUserRole').value;

            if (!name || !email || !affiliation || !role) {
                showMessage('addUserMessage', 'Please fill all fields', 'error');
                return;
            }

            const addBtn = document.getElementById('addUserBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'Adding...';

            try {
                const response = await fetch('/api/di/members', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, institution_email: email, affiliation, role }),
                    credentials: 'include'
                });

                const data = await response.json();

                if (!response.ok) {
                    showMessage('addUserMessage', data.error || 'Failed to add user', 'error');
                } else {
                    showMessage('addUserMessage', `User added: ${data.researcher_id}`, 'success');
                    document.getElementById('addUserForm').reset();
                    loadAllUsers();
                    populateResearcherDropdown();
                }
            } catch (err) {
                showMessage('addUserMessage', 'Connection error', 'error');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'Add User';
            }
        });

        async function deactivateUser(id, name) {
            // Check for active inventory items before confirming
            let warningMsg = `Deactivate user "${name}"? They will not be able to log in.`;
            try {
                const invResp = await fetch(`/api/di/inventory/check-user/${id}`, { credentials: 'include' });
                if (invResp.ok) {
                    const invData = await invResp.json();
                    if (invData.active_count > 0) {
                        warningMsg += `\n\nWARNING: This user has ${invData.active_count} active inventory item(s). These items will remain assigned but the user will not be able to manage them.`;
                    }
                }
            } catch (e) { /* non-blocking */ }

            if (!confirm(warningMsg)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/deactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User deactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to deactivate user');
                }
            } catch (err) {
                alert('Error deactivating user');
            }
        }

        async function reactivateUser(id, name) {
            if (!confirm(`Reactivate user "${name}"? All their previous data will be restored.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reactivate`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                if (response.ok) {
                    alert('User reactivated');
                    loadAllUsers();
                    populateResearcherDropdown();
                } else {
                    const data = await response.json();
                    alert(data.error || 'Failed to reactivate user');
                }
            } catch (err) {
                alert('Error reactivating user');
            }
        }

        async function toggleLegacy(id, name, enable) {
            const action = enable ? 'enable' : 'disable';
            const msg = enable
                ? `Enable legacy upload for "${name}"?\n\nThey will have 48 hours to upload pre-2026 documents.`
                : `Disable legacy upload for "${name}"?`;
            if (!confirm(msg)) return;
            try {
                const resp = await fetch(`/api/di/members/${id}/legacy-${action}`, {
                    method: 'PUT', credentials: 'include'
                });
                if (resp.ok) {
                    alert(enable ? 'Legacy upload enabled (48h window)' : 'Legacy upload disabled');
                    loadAllUsers();
                } else {
                    const data = await resp.json();
                    alert(data.error || `Failed to ${action} legacy`);
                }
            } catch (err) { alert('Connection error'); }
        }

        async function resetUserPassword(id, name) {
            if (!confirm(`Reset password for "${name}"?\n\nThey will be required to set a new password on their next login.`)) return;

            try {
                const response = await fetch(`/api/di/members/${id}/reset-password`, {
                    method: 'POST',
                    credentials: 'include'
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'Password reset flagged successfully');
                } else {
                    alert(data.error || 'Failed to reset password');
                }
            } catch (err) {
                alert('Error resetting password');
            }
        }

        // =====================================================
        // GLP CONSOLE (PI-only)
        // =====================================================

        const glpcLevelLabels = {
            hatchling: 'GLP initiation phase', fledgling: 'GLP emerging',
            owl: 'GLP in development', eagle: 'GLP consolidated', dragon: 'GLP fully integrated'
        };
        const glpcLevelQualifiers = {
            hatchling: 'Documentation starting', fledgling: 'Building foundations',
            owl: 'Partial implementation', eagle: 'Consistent implementation', dragon: 'Full integration'
        };
        const glpcLevelIcons = {
            hatchling: 'Hatchling', fledgling: 'Fledgling', owl: 'Owl', eagle: 'Eagle-GLP', dragon: 'Dragon-GLP'
        };

        let glpcAllMembers = [];
        let glpcFilteredMembers = [];
        let glpcMemberFilter = 'all';
        let glpcMode = 'individual'; // 'individual' or 'group'
        let glpcSelectedUserId = null;
        let glpcSelectedGroup = 'BOTH';
        let glpcCurrentMgmtCohort = 'LIU';
        let glpcMgmtData = {};
        let glpcMgmtDirty = false;

        // Viewer state
        let glpcWeeks = [];
        let glpcCurrentWeekIdx = 0;
        let glpcViewerEntity = null; // { type: 'individual', userId } or { type: 'group', cohortId }
        let glpcInitDone = false;

        // Snapshot cache for trajectory insights
        let glpcSnapshotCache = {};

        async function glpcInit() {
            if (glpcInitDone) return;
            glpcInitDone = true;

            // Restore trajectory toggle from localStorage
            const trajPref = localStorage.getItem('glpcTrajectoryOn');
            if (trajPref === 'true') {
                document.getElementById('glpcTrajectoryToggle').checked = true;
            }

            // Load all members for sidebar
            try {
                const [liuResp, unavResp, extResp] = await Promise.all([
                    fetch('/api/glp/cohorts/members?cohort_id=LIU', { credentials: 'include' }),
                    fetch('/api/glp/cohorts/members?cohort_id=UNAV', { credentials: 'include' }),
                    fetch('/api/glp/cohorts/members?cohort_id=EXTERNAL', { credentials: 'include' })
                ]);
                const liuData = liuResp.ok ? await liuResp.json() : { members: [] };
                const unavData = unavResp.ok ? await unavResp.json() : { members: [] };
                const extData = extResp.ok ? await extResp.json() : { members: [] };

                glpcAllMembers = [
                    ...(liuData.members || []).map(m => ({ ...m, cohort: 'LIU' })),
                    ...(unavData.members || []).map(m => ({ ...m, cohort: 'UNAV' })),
                    ...(extData.members || []).map(m => ({ ...m, cohort: 'EXTERNAL' }))
                ];
                // De-duplicate by user_id (a user appears in one cohort only)
                const seen = new Set();
                glpcAllMembers = glpcAllMembers.filter(m => {
                    if (seen.has(m.user_id)) return false;
                    seen.add(m.user_id);
                    return true;
                });
                glpcAllMembers.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
            } catch (e) {
                console.warn('[GLP-CONSOLE] Failed to load members:', e);
                glpcAllMembers = [];
            }

            glpcFilterMembers();
            glpcLoadMgmt(glpcCurrentMgmtCohort);

            // Default: group mode, BOTH
            glpcSetMode('group');
        }

        function glpcFormatName(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            if (parts.length < 2) return parts[0];
            return parts[0] + ' ' + parts[parts.length - 1].charAt(0) + '.';
        }

        function glpcGetInitials(name) {
            if (!name) return '?';
            const parts = name.trim().split(/\s+/);
            return parts.map(p => p.charAt(0).toUpperCase()).slice(0, 2).join('');
        }

        function glpcSetMode(mode) {
            glpcMode = mode;
            document.getElementById('glpcModeIndividual').classList.toggle('active', mode === 'individual');
            document.getElementById('glpcModeGroup').classList.toggle('active', mode === 'group');
            document.getElementById('glpcIndividualPanel').style.display = mode === 'individual' ? '' : 'none';
            document.getElementById('glpcGroupPanel').style.display = mode === 'group' ? '' : 'none';

            if (mode === 'group') {
                glpcSelectGroup(glpcSelectedGroup);
            }
        }

        function glpcSetMemberFilter(filter, el) {
            glpcMemberFilter = filter;
            document.querySelectorAll('#glpcFilterChips .glpc-chip').forEach(c => c.classList.remove('active'));
            if (el) el.classList.add('active');
            glpcFilterMembers();
        }

        function glpcFilterMembers() {
            const search = (document.getElementById('glpcMemberSearch')?.value || '').toLowerCase();
            glpcFilteredMembers = glpcAllMembers.filter(m => {
                if (!m.active) return false;
                if (search && !(m.name || '').toLowerCase().includes(search) && !(m.user_id || '').toLowerCase().includes(search)) return false;
                if (glpcMemberFilter === 'researcher' && m.role !== 'researcher') return false;
                if (glpcMemberFilter === 'supervisor' && m.role !== 'supervisor') return false;
                if (glpcMemberFilter === 'LiU' && m.institution !== 'LiU') return false;
                if (glpcMemberFilter === 'UNAV' && m.institution !== 'UNAV') return false;
                return true;
            });
            glpcRenderMemberList();
        }

        function glpcRenderMemberList() {
            const container = document.getElementById('glpcMemberList');
            if (glpcFilteredMembers.length === 0) {
                container.innerHTML = '<div class="glpc-empty">No members found</div>';
                return;
            }
            container.innerHTML = glpcFilteredMembers.map(m => {
                const selected = m.user_id === glpcSelectedUserId ? ' glpc-member-selected' : '';
                const initials = glpcGetInitials(m.name);
                const affColor = m.institution === 'LiU' ? '#1565c0' : '#2e7d32';
                const lastWeek = m.last_iso_week ? `<span class="glpc-member-week">${m.last_iso_week}</span>` : '';
                return `<div class="glpc-member-row${selected}" onclick="glpcSelectMember('${m.user_id}')">
                    <div class="glpc-member-avatar" style="background:${affColor}">${initials}</div>
                    <div class="glpc-member-info">
                        <div class="glpc-member-name">${escapeHtml(glpcFormatName(m.name))}</div>
                        <div class="glpc-member-meta">
                            <span class="glpc-member-badge">${m.institution || '?'}</span>
                            <span class="glpc-member-badge">${m.role || 'researcher'}</span>
                            ${lastWeek}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function glpcSelectMember(userId) {
            glpcSelectedUserId = userId;
            glpcRenderMemberList();

            const member = glpcAllMembers.find(m => m.user_id === userId);
            glpcViewerEntity = { type: 'individual', userId };

            // Show Update Status button
            const actionsEl = document.getElementById('glpcIndividualActions');
            if (actionsEl) actionsEl.style.display = userId ? '' : 'none';

            // Show viewer, hide empty state
            document.getElementById('glpcEmptyState').style.display = 'none';
            document.getElementById('glpcHeaderCard').style.display = '';
            document.getElementById('glpcEvidenceCard').style.display = '';
            document.getElementById('glpcConformityCard').style.display = '';

            // Set header info
            document.getElementById('glpcName').textContent = member ? member.name : userId;
            const roleBadge = document.getElementById('glpcRoleBadge');
            const affBadge = document.getElementById('glpcAffiliationBadge');
            if (roleBadge) roleBadge.textContent = member?.role || 'researcher';
            if (affBadge) affBadge.textContent = member?.institution || '';

            // Load weeks
            try {
                const resp = await fetch(`/api/glp/status/user/${userId}/weeks`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                glpcWeeks = data.weeks || [];
                glpcCurrentWeekIdx = 0;
                glpcSnapshotCache = {};

                if (glpcWeeks.length > 0) {
                    await glpcLoadWeek(glpcWeeks[0].iso_week);
                    glpcUpdateWeekNav();
                } else {
                    glpcShowNoData();
                }
            } catch (e) {
                console.warn('[GLP-CONSOLE] Failed to load weeks for', userId, e);
                glpcShowNoData();
            }
        }

        async function glpcSelectGroup(cohortId) {
            glpcSelectedGroup = cohortId;
            document.getElementById('glpcGroupBoth').classList.toggle('active', cohortId === 'BOTH');
            document.getElementById('glpcGroupLiU').classList.toggle('active', cohortId === 'LIU');
            document.getElementById('glpcGroupUNAV').classList.toggle('active', cohortId === 'UNAV');

            glpcViewerEntity = { type: 'group', cohortId };

            document.getElementById('glpcEmptyState').style.display = 'none';
            document.getElementById('glpcHeaderCard').style.display = '';
            document.getElementById('glpcEvidenceCard').style.display = '';
            document.getElementById('glpcConformityCard').style.display = '';

            const label = cohortId === 'BOTH' ? 'All Members' : cohortId === 'LIU' ? 'LiU Group' : 'UNAV Group';
            document.getElementById('glpcName').textContent = label;
            const roleBadge = document.getElementById('glpcRoleBadge');
            const affBadge = document.getElementById('glpcAffiliationBadge');
            if (roleBadge) roleBadge.textContent = 'Group';
            if (affBadge) affBadge.textContent = cohortId === 'BOTH' ? 'LiU + UNAV' : cohortId;

            // Load group weeks
            try {
                const resp = await fetch(`/api/glp/status/group/weeks?cohort_id=${cohortId}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                glpcWeeks = data.weeks || [];
                glpcCurrentWeekIdx = 0;
                glpcSnapshotCache = {};

                if (glpcWeeks.length > 0) {
                    await glpcLoadGroupWeek(glpcWeeks[0].iso_week);
                    glpcUpdateWeekNav();
                    // Update overview cards
                    const w = glpcWeeks[0];
                    document.getElementById('glpcGroupMembers').textContent = w.member_count || '--';
                } else {
                    glpcShowNoData();
                    document.getElementById('glpcGroupMembers').textContent = '--';
                    document.getElementById('glpcGroupMaturity').textContent = '--';
                    document.getElementById('glpcGroupDelta').textContent = '--';
                }
            } catch (e) {
                console.warn('[GLP-CONSOLE] Failed to load group weeks:', e);
                glpcShowNoData();
            }
        }

        async function glpcLoadWeek(isoWeek) {
            try {
                const userId = glpcViewerEntity.userId;
                const resp = await fetch(`/api/glp/status/user/${userId}/week/${isoWeek}`, { credentials: 'include' });
                if (!resp.ok) return;
                const data = await resp.json();
                if (!data.success) return;

                glpcSnapshotCache[isoWeek] = data.snapshot;

                // Previous week for delta
                let prevSnap = null;
                if (glpcCurrentWeekIdx + 1 < glpcWeeks.length) {
                    const prevWeek = glpcWeeks[glpcCurrentWeekIdx + 1].iso_week;
                    if (glpcSnapshotCache[prevWeek]) {
                        prevSnap = glpcSnapshotCache[prevWeek];
                    } else {
                        try {
                            const prevResp = await fetch(`/api/glp/status/user/${userId}/week/${prevWeek}`, { credentials: 'include' });
                            if (prevResp.ok) {
                                const prevData = await prevResp.json();
                                if (prevData.success) { prevSnap = prevData.snapshot; glpcSnapshotCache[prevWeek] = prevSnap; }
                            }
                        } catch (e) { /* no delta */ }
                    }
                }

                glpcRenderSnapshot(data.snapshot, prevSnap, data.harmony, data.generated_at, isoWeek);
                glpcComputeTrajectory();
            } catch (e) {
                console.warn('[GLP-CONSOLE] loadWeek error:', e);
            }
        }

        async function glpcLoadGroupWeek(isoWeek) {
            try {
                const cohortId = glpcViewerEntity.cohortId;
                const resp = await fetch(`/api/glp/status/group/snapshot?cohort_id=${cohortId}&iso_week=${isoWeek}`, { credentials: 'include' });
                if (!resp.ok) return;
                const data = await resp.json();
                if (!data.success) return;

                glpcSnapshotCache[isoWeek] = data.snapshot;

                // Previous week for delta
                let prevSnap = null;
                if (glpcCurrentWeekIdx + 1 < glpcWeeks.length) {
                    const prevWeek = glpcWeeks[glpcCurrentWeekIdx + 1].iso_week;
                    if (glpcSnapshotCache[prevWeek]) {
                        prevSnap = glpcSnapshotCache[prevWeek];
                    } else {
                        try {
                            const prevResp = await fetch(`/api/glp/status/group/snapshot?cohort_id=${cohortId}&iso_week=${prevWeek}`, { credentials: 'include' });
                            if (prevResp.ok) {
                                const prevData = await prevResp.json();
                                if (prevData.success) { prevSnap = prevData.snapshot; glpcSnapshotCache[prevWeek] = prevSnap; }
                            }
                        } catch (e) { /* no delta */ }
                    }
                }

                glpcRenderSnapshot(data.snapshot, prevSnap, null, data.created_at, isoWeek);

                // Update group overview cards
                document.getElementById('glpcGroupMembers').textContent = data.snapshot.member_count || '--';
                document.getElementById('glpcGroupMaturity').textContent = glpcLevelLabels[data.snapshot.glp_level] || '--';
                if (prevSnap) {
                    const d = (data.snapshot.overall_score || 0) - (prevSnap.overall_score || 0);
                    document.getElementById('glpcGroupDelta').textContent = (d > 0 ? '+' : '') + d;
                    document.getElementById('glpcGroupDelta').style.color = d > 0 ? '#16a34a' : d < 0 ? '#dc2626' : '#6b7280';
                } else {
                    document.getElementById('glpcGroupDelta').textContent = '--';
                }

                glpcComputeTrajectory();
            } catch (e) {
                console.warn('[GLP-CONSOLE] loadGroupWeek error:', e);
            }
        }

        function glpcRenderSnapshot(snap, prevSnap, harmony, generatedAt, isoWeek) {
            // Header maturity
            const levelKey = snap.glp_level || 'owl';
            document.getElementById('glpcStateText').textContent = glpcLevelLabels[levelKey] || levelKey;
            document.getElementById('glpcQualifier').textContent = glpcLevelQualifiers[levelKey] || '';
            const iconName = glpcLevelIcons[levelKey] || 'Owl';
            document.getElementById('glpcMaturityIcon').innerHTML = `<img src="/assets/glp-icons/${iconName}.png" alt="${levelKey}" />`;

            // Timestamp
            const ts = new Date(generatedAt);
            document.getElementById('glpcLastUpdated').textContent = 'Snapshot: ' + isoWeek + ', ' +
                ts.toLocaleDateString('en-SE', { weekday: 'short' }) + ' ' +
                ts.toLocaleTimeString('en-SE', { hour: '2-digit', minute: '2-digit' });

            // Vision table
            glpcSetVT('glpcVTOverall', snap.overall_score, prevSnap?.overall_score);
            glpcSetVT('glpcVTDoc', snap.spheres?.documentation?.score, prevSnap?.spheres?.documentation?.score);
            glpcSetVT('glpcVTTrain', snap.spheres?.training?.score, prevSnap?.spheres?.training?.score);
            glpcSetVT('glpcVTTrace', snap.spheres?.traceability?.score, prevSnap?.spheres?.traceability?.score);
            glpcSetVT('glpcVTData', snap.spheres?.data_integrity?.score, prevSnap?.spheres?.data_integrity?.score);

            // Evidence mini-cards
            const ev = snap.evidence || {};
            document.getElementById('glpcSopApproved').textContent = ev.sops?.approved ?? '--';
            document.getElementById('glpcSopCoverage').textContent = ev.sops ? (ev.sops.approved + ' of ' + (ev.sops.total || 0) + ' approved') : '--';

            const expObj = ev.experiments || ev.data;
            document.getElementById('glpcExpReported').textContent = expObj?.total ?? '--';
            document.getElementById('glpcExpCoverage').textContent = expObj ? ((expObj.linked_to_sops ?? expObj.linked ?? 0) + ' linked to SOPs') : '--';

            document.getElementById('glpcInvTotal').textContent = ev.inventory?.total ?? '--';
            document.getElementById('glpcInvProducts').textContent = ev.inventory?.products ?? '--';
            document.getElementById('glpcInvSamples').textContent = ev.inventory?.samples ?? '--';
            document.getElementById('glpcInvOligos').textContent = ev.inventory?.oligos ?? '--';

            // Harmony Map — use snapshot-embedded harmony (v3 workflow) or separate harmony (v1 compat)
            const h = snap.harmony || null;
            if (h && h.harmony_map) {
                glpcRenderHarmonyFromAI(h.harmony_map);
            } else if (harmony) {
                // v1 compat: separate harmony object with motivation/reflection/goals/actions
                glpcRenderHarmonyFromV1(harmony);
            } else {
                glpcRenderHarmonyPending();
            }

            // GLP Conformity — prefer AI conformity, fall back to boolean-derived
            if (h && h.conformity) {
                glpcRenderConformityFromAI(h.conformity);
            } else {
                glpcRenderConformityFromBooleans(snap);
            }
        }

        function glpcSetVT(id, score, prevScore) {
            const el = document.getElementById(id);
            const deltaEl = document.getElementById(id + 'Delta');
            if (el) el.textContent = score ?? '--';
            if (deltaEl) {
                if (prevScore !== null && prevScore !== undefined && score !== null && score !== undefined) {
                    const d = score - prevScore;
                    deltaEl.textContent = (d > 0 ? '+' : '') + d;
                    deltaEl.className = 'glpVT__delta ' + (d > 0 ? 'glpVT__delta--up' : d < 0 ? 'glpVT__delta--down' : '');
                } else {
                    deltaEl.textContent = '';
                    deltaEl.className = 'glpVT__delta';
                }
            }
        }

        // --- Harmony Map renderers ---

        function glpcRenderHarmonyFromAI(hm) {
            const winsEl = document.getElementById('glpcHarmonyWins');
            const wins = Array.isArray(hm.wins_this_week) ? hm.wins_this_week : [];
            winsEl.innerHTML = wins.length > 0
                ? wins.map(w => `<li class="glpHarmonyPanel__item">${escapeHtml(w)}</li>`).join('')
                : '<li class="glpHarmonyPanel__item">&mdash;</li>';

            const upEl = document.getElementById('glpcHarmonyUpgrade');
            upEl.textContent = hm.best_upgrade_next_week || '\u2014';

            const trEl = document.getElementById('glpcHarmonyTrend');
            trEl.textContent = hm.trend || '\u2014';

            document.getElementById('glpcHarmonyMapWrap').style.display = '';
        }

        function glpcRenderHarmonyFromV1(harmony) {
            const winsEl = document.getElementById('glpcHarmonyWins');
            const items = [harmony.motivation, harmony.reflection].filter(Boolean);
            winsEl.innerHTML = items.length > 0
                ? items.map(w => `<li class="glpHarmonyPanel__item">${escapeHtml(w)}</li>`).join('')
                : '<li class="glpHarmonyPanel__item">&mdash;</li>';

            const upEl = document.getElementById('glpcHarmonyUpgrade');
            upEl.textContent = (harmony.goals && harmony.goals[0]) || '\u2014';

            const trEl = document.getElementById('glpcHarmonyTrend');
            trEl.textContent = (harmony.actions && harmony.actions[0]) || '\u2014';

            document.getElementById('glpcHarmonyMapWrap').style.display = '';
        }

        function glpcRenderHarmonyPending() {
            const winsEl = document.getElementById('glpcHarmonyWins');
            winsEl.innerHTML = '<li class="glpHarmonyPanel__item">Harmony analysis in progress\u2026</li>';

            const upEl = document.getElementById('glpcHarmonyUpgrade');
            upEl.textContent = 'Available after Wednesday 09:00';

            const trEl = document.getElementById('glpcHarmonyTrend');
            trEl.textContent = '';

            document.getElementById('glpcHarmonyMapWrap').style.display = '';
        }

        // --- GLP Conformity renderers ---

        function glpcRenderConformityFromAI(conf) {
            const working = Array.isArray(conf.what_is_working_well) ? conf.what_is_working_well : [];
            const improvement = conf.main_improvement_next_week || '';
            const trend = conf.trend_vs_previous_weeks || '';
            const focus = Array.isArray(conf.focus_for_coming_week) ? conf.focus_for_coming_week : [];

            document.getElementById('glpcConfWorking').innerHTML = working.length > 0
                ? working.map(t => `<li>${escapeHtml(t)}</li>`).join('')
                : '<li>GLP documentation is in its early stages.</li>';
            document.getElementById('glpcConfImprovement').innerHTML = improvement
                ? `<li>${escapeHtml(improvement)}</li>`
                : '<li>Maintain current documentation quality.</li>';
            document.getElementById('glpcConfTrend').textContent = trend || '\u2014';
            document.getElementById('glpcConfFocus').innerHTML = focus.length > 0
                ? focus.map(t => `<li>${escapeHtml(t)}</li>`).join('')
                : '<li>Sustain practices and prepare for next review cycle.</li>';
        }

        function glpcRenderConformityFromBooleans(snap) {
            const c = snap.conformity || {};
            const working = [];
            const improvements = [];
            const focus = [];

            if (c.has_approved_sops) working.push('SOPs are approved and active.');
            if (c.training_sealed) working.push('Training pack is sealed and certified.');
            if (c.all_agreements_confirmed) working.push('All required agreements have been confirmed.');
            if (c.inventory_active) working.push('Inventory tracking is active.');
            if (c.no_open_revisions) working.push('No open revision requests.');
            if (working.length === 0) working.push('GLP documentation is in its early stages.');

            if (c.missing_sop_links) improvements.push('Link data records to approved SOPs.');
            if (c.missing_training) improvements.push('Complete training entries and seek certification.');
            if (c.missing_inventory) improvements.push('Begin tracking inventory items.');
            if (!c.sop_coverage_adequate) improvements.push('Expand SOP coverage (target: 3+ approved).');
            if (!c.data_coverage_adequate) improvements.push('Submit additional data records for review.');
            if (improvements.length === 0) improvements.push('Maintain current documentation quality.');

            if (!c.training_sealed) focus.push('Prioritize completing and sealing the training pack.');
            if (!c.no_open_revisions) focus.push('Address open revision requests before next snapshot.');
            if (!c.recent_activity) focus.push('Resume documented activity to maintain momentum.');
            if (focus.length === 0) focus.push('Sustain practices and prepare for next review cycle.');

            const trendText = c.recent_activity ? 'Active documentation this period.' : 'No recent activity recorded.';

            document.getElementById('glpcConfWorking').innerHTML = working.map(t => `<li>${escapeHtml(t)}</li>`).join('');
            document.getElementById('glpcConfImprovement').innerHTML = improvements.map(t => `<li>${escapeHtml(t)}</li>`).join('');
            document.getElementById('glpcConfTrend').textContent = trendText;
            document.getElementById('glpcConfFocus').innerHTML = focus.map(t => `<li>${escapeHtml(t)}</li>`).join('');
        }

        function glpcShowNoData() {
            document.getElementById('glpcHeaderCard').style.display = '';
            document.getElementById('glpcEvidenceCard').style.display = 'none';
            document.getElementById('glpcConformityCard').style.display = 'none';
            document.getElementById('glpcLastUpdated').textContent = 'No snapshots available';
            document.getElementById('glpcWeekLabel').textContent = '--';
        }

        function glpcNavWeek(delta) {
            const newIdx = glpcCurrentWeekIdx - delta;
            if (newIdx < 0 || newIdx >= glpcWeeks.length) return;
            glpcCurrentWeekIdx = newIdx;
            const isoWeek = glpcWeeks[newIdx].iso_week;
            if (glpcViewerEntity?.type === 'group') {
                glpcLoadGroupWeek(isoWeek);
            } else {
                glpcLoadWeek(isoWeek);
            }
            glpcUpdateWeekNav();
        }

        function glpcUpdateWeekNav() {
            const label = document.getElementById('glpcWeekLabel');
            if (label && glpcWeeks[glpcCurrentWeekIdx]) label.textContent = glpcWeeks[glpcCurrentWeekIdx].iso_week;
            const prev = document.getElementById('glpcWeekPrev');
            const next = document.getElementById('glpcWeekNext');
            if (prev) prev.disabled = (glpcCurrentWeekIdx >= glpcWeeks.length - 1);
            if (next) next.disabled = (glpcCurrentWeekIdx <= 0);
        }

        // --- Group snapshot generation ---
        async function glpcGenerateGroup() {
            const btn = document.getElementById('glpcBtnGenerateGroup');
            btn.disabled = true;
            btn.textContent = 'Generating...';
            try {
                const resp = await fetch('/api/glp/status/generate-group', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ cohort_id: glpcSelectedGroup })
                });
                const data = await resp.json();
                if (data.success) {
                    btn.textContent = 'Generated!';
                    setTimeout(() => { btn.textContent = 'Generate Group Snapshot'; btn.disabled = false; }, 2000);
                    // Reload group view
                    glpcSelectGroup(glpcSelectedGroup);
                } else {
                    btn.textContent = data.error || 'Failed';
                    setTimeout(() => { btn.textContent = 'Generate Group Snapshot'; btn.disabled = false; }, 3000);
                }
            } catch (e) {
                btn.textContent = 'Error';
                setTimeout(() => { btn.textContent = 'Generate Group Snapshot'; btn.disabled = false; }, 3000);
            }
        }

        // --- Individual status preview (no DB/R2 writes) ---
        async function glpcUpdateSelectedProfilePreview() {
            if (!glpcSelectedUserId) return;
            const btn = document.getElementById('glpcBtnUpdateStatus');
            if (!btn) return;
            btn.disabled = true;
            btn.textContent = 'Updating...';

            const isoWeek = (glpcWeeks[glpcCurrentWeekIdx] && glpcWeeks[glpcCurrentWeekIdx].iso_week) || currentIsoWeekClient();

            try {
                const resp = await fetch('/api/glp/status/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ user_id: glpcSelectedUserId, iso_week: isoWeek })
                });
                const data = await resp.json();
                if (!resp.ok || !data.success) throw new Error(data.error || 'Preview failed');

                // Get previous week snapshot for delta comparison
                let prevSnap = null;
                if (glpcCurrentWeekIdx + 1 < glpcWeeks.length) {
                    const prevWeek = glpcWeeks[glpcCurrentWeekIdx + 1].iso_week;
                    prevSnap = glpcSnapshotCache[prevWeek] || null;
                }

                // Render the preview snapshot using the same rendering path
                glpcRenderSnapshot(data.snapshot, prevSnap, data.harmony, data.generated_at, isoWeek);

                btn.textContent = 'Updated!';
                setTimeout(() => { btn.textContent = 'Update Status'; btn.disabled = false; }, 2000);
            } catch (e) {
                console.warn('[GLP-CONSOLE] preview error:', e);
                btn.textContent = 'Error';
                setTimeout(() => { btn.textContent = 'Update Status'; btn.disabled = false; }, 3000);
            }
        }

        // Client-side ISO week helper (fallback if no weeks loaded)
        function currentIsoWeekClient() {
            const now = new Date();
            const d = new Date(Date.UTC(now.getFullYear(), now.getMonth(), now.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getUTCFullYear()}W${String(weekNo).padStart(2, '0')}`;
        }

        // --- Management ---
        async function glpcLoadMgmt(cohortId) {
            glpcCurrentMgmtCohort = cohortId;
            const container = document.getElementById('glpcMgmtList');
            container.innerHTML = '<div class="glpc-empty">Loading...</div>';

            try {
                const resp = await fetch(`/api/glp/cohorts/members?cohort_id=${cohortId}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                glpcMgmtData[cohortId] = data.members || [];
            } catch (e) {
                container.innerHTML = '<div class="glpc-empty">Failed to load</div>';
                return;
            }

            glpcRenderMgmtList();
        }

        function glpcRenderMgmtList() {
            const container = document.getElementById('glpcMgmtList');
            const showInactive = document.getElementById('glpcShowInactive')?.checked || false;
            const members = (glpcMgmtData[glpcCurrentMgmtCohort] || []).filter(m => showInactive || m.active);

            if (members.length === 0) {
                container.innerHTML = '<div class="glpc-empty">No members</div>';
                return;
            }

            container.innerHTML = members.map(m => {
                const checked = m.included ? 'checked' : '';
                const lastWeek = m.last_iso_week || '';
                const inactive = !m.active ? ' glpc-mgmt-inactive' : '';
                return `<div class="glpc-mgmt-row${inactive}">
                    <label class="glpc-mgmt-checkbox">
                        <input type="checkbox" ${checked} data-userid="${m.user_id}" onchange="glpcMgmtChanged()">
                        <span>${escapeHtml(glpcFormatName(m.name))}</span>
                    </label>
                    <span class="glpc-mgmt-meta">${lastWeek}</span>
                </div>`;
            }).join('');

            glpcMgmtDirty = false;
            document.getElementById('glpcApplyBtn').disabled = true;
        }

        function glpcMgmtChanged() {
            glpcMgmtDirty = true;
            document.getElementById('glpcApplyBtn').disabled = false;
            document.getElementById('glpcSavedMsg').textContent = '';
        }

        function glpcSetMgmtTab(cohortId, el) {
            document.querySelectorAll('.glpc-mgmt-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            glpcLoadMgmt(cohortId);
        }

        async function glpcApplyMgmt() {
            const checkboxes = document.querySelectorAll('#glpcMgmtList input[type="checkbox"]');
            const updates = [];
            checkboxes.forEach(cb => {
                updates.push({ user_id: cb.dataset.userid, included: cb.checked });
            });

            try {
                const resp = await fetch('/api/glp/cohorts/members/set', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ cohort_id: glpcCurrentMgmtCohort, updates })
                });
                const data = await resp.json();
                if (data.success) {
                    document.getElementById('glpcSavedMsg').textContent = 'Saved';
                    document.getElementById('glpcApplyBtn').disabled = true;
                    glpcMgmtDirty = false;
                    // Refresh sidebar members
                    glpcInitDone = false;
                    glpcInit();
                }
            } catch (e) {
                document.getElementById('glpcSavedMsg').textContent = 'Error saving';
            }
        }

        // --- Trajectory Insights (PI-only, client-side) ---
        function glpcToggleTrajectory() {
            const on = document.getElementById('glpcTrajectoryToggle').checked;
            document.getElementById('glpcTrajectoryPanel').style.display = on ? '' : 'none';
            localStorage.setItem('glpcTrajectoryOn', on ? 'true' : 'false');
            if (on) glpcComputeTrajectory();
        }

        async function glpcComputeTrajectory() {
            if (!document.getElementById('glpcTrajectoryToggle').checked) return;
            if (glpcWeeks.length < 2) {
                document.getElementById('glpcTrajSlope').textContent = 'Insufficient data';
                document.getElementById('glpcTrajVolatility').textContent = '--';
                document.getElementById('glpcTrajDomains').textContent = '--';
                document.getElementById('glpcTrajSuggestions').innerHTML = '';
                return;
            }

            // Load last N snapshots (up to 6)
            const weekSlice = glpcWeeks.slice(0, Math.min(6, glpcWeeks.length));
            const snaps = [];
            for (const w of weekSlice) {
                if (glpcSnapshotCache[w.iso_week]) {
                    snaps.push(glpcSnapshotCache[w.iso_week]);
                } else {
                    try {
                        let resp;
                        if (glpcViewerEntity?.type === 'group') {
                            resp = await fetch(`/api/glp/status/group/snapshot?cohort_id=${glpcViewerEntity.cohortId}&iso_week=${w.iso_week}`, { credentials: 'include' });
                        } else {
                            resp = await fetch(`/api/glp/status/user/${glpcViewerEntity.userId}/week/${w.iso_week}`, { credentials: 'include' });
                        }
                        if (resp.ok) {
                            const d = await resp.json();
                            if (d.success) {
                                const s = d.snapshot;
                                glpcSnapshotCache[w.iso_week] = s;
                                snaps.push(s);
                            }
                        }
                    } catch (e) { /* skip */ }
                }
            }

            if (snaps.length < 2) {
                document.getElementById('glpcTrajSlope').textContent = 'Insufficient data';
                return;
            }

            // Compute slope: linear trend on overall_score (newest=0, oldest=N)
            const scores = snaps.map(s => s.overall_score || 0);
            const n = scores.length;
            const xMean = (n - 1) / 2;
            const yMean = scores.reduce((a, b) => a + b, 0) / n;
            let num = 0, den = 0;
            for (let i = 0; i < n; i++) {
                num += (i - xMean) * (scores[i] - yMean);
                den += (i - xMean) * (i - xMean);
            }
            const slope = den !== 0 ? num / den : 0;
            // slope < 0 means improving (newest has lower index), but scores[0] is newest
            // Actually: index 0 = newest, so negative slope = declining (scores decreasing from old to new)
            // Let's recalculate: if newest (i=0) has higher score than oldest (i=n-1), slope is negative
            // We want: improving if newest > oldest => slope < 0
            let slopeClass;
            if (slope < -1.5) slopeClass = 'Improving';
            else if (slope > 1.5) slopeClass = 'Declining';
            else slopeClass = 'Stable';

            const slopeEl = document.getElementById('glpcTrajSlope');
            slopeEl.textContent = slopeClass;
            slopeEl.style.color = slopeClass === 'Improving' ? '#16a34a' : slopeClass === 'Declining' ? '#dc2626' : '#6b7280';

            // Volatility: std dev of overall_score
            const variance = scores.reduce((sum, s) => sum + Math.pow(s - yMean, 2), 0) / n;
            const stdDev = Math.sqrt(variance);
            let volatility;
            if (stdDev < 3) volatility = 'Low';
            else if (stdDev < 8) volatility = 'Medium';
            else volatility = 'High';
            document.getElementById('glpcTrajVolatility').textContent = volatility;

            // Domain contribution: find which spheres changed the most this week
            const newest = snaps[0];
            const prev = snaps[1];
            const domains = ['documentation', 'training', 'traceability', 'data_integrity'];
            const deltas = domains.map(d => ({
                name: d.replace('_', ' '),
                delta: (newest.spheres?.[d]?.score || 0) - (prev.spheres?.[d]?.score || 0)
            }));
            deltas.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));
            const top2 = deltas.slice(0, 2).filter(d => d.delta !== 0);
            document.getElementById('glpcTrajDomains').textContent = top2.length > 0
                ? top2.map(d => `${d.name} (${d.delta > 0 ? '+' : ''}${d.delta})`).join(', ')
                : 'No significant changes';

            // Suggestions (max 3)
            const suggestions = [];
            if (slopeClass === 'Declining') suggestions.push('Overall score is trending downward. Review recent changes in documentation and training.');
            if (volatility === 'High') suggestions.push('Score volatility is high. Focus on consistent weekly documentation habits.');
            for (const d of deltas) {
                if (d.delta < -3 && suggestions.length < 3) {
                    suggestions.push(`${d.name.charAt(0).toUpperCase() + d.name.slice(1)} dropped by ${Math.abs(d.delta)} points. Investigate recent gaps.`);
                }
            }
            if (suggestions.length === 0 && slopeClass === 'Improving') suggestions.push('Trajectory is positive. Continue current practices.');
            if (suggestions.length === 0) suggestions.push('Status is stable. Maintain documentation consistency.');

            document.getElementById('glpcTrajSuggestions').innerHTML = suggestions.map(s =>
                `<div class="glpc-trajectory-suggestion">${escapeHtml(s)}</div>`
            ).join('');
        }

        // =====================================================
        // UTILITY FUNCTIONS
        // =====================================================
        function showMessage(elementId, text, type) {
            const el = document.getElementById(elementId);
            el.textContent = text;
            el.className = `message show ${type}`;
            setTimeout(() => el.classList.remove('show'), 5000);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/di/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {}
            window.location.href = 'access.html';
        });

        // =====================================================
        // DELEGATION FUNCTIONS
        // =====================================================
        async function loadDelegationData() {
            try {
                // Load supervisors
                const supRes = await fetch('/api/di/delegation/supervisors', { credentials: 'include' });
                const supData = supRes.ok ? await supRes.json() : { supervisors: [] };
                const supervisorSelect = document.getElementById('supervisorSelect');
                supervisorSelect.innerHTML = '<option value="">Select supervisor...</option>' +
                    supData.supervisors.map(s => `<option value="${s.researcher_id}">${s.name} (${s.researcher_id})</option>`).join('');

                // Load all members for promote/demote and assign
                const memRes = await fetch('/api/di/all-members', { credentials: 'include' });
                const memData = memRes.ok ? await memRes.json() : { members: [] };
                const activeMembers = memData.members.filter(m => m.active);

                // Populate promote select (researchers and supervisors only)
                const promoteSelect = document.getElementById('promoteSelect');
                const promotable = activeMembers.filter(m => m.role === 'researcher' || m.role === 'supervisor');
                promoteSelect.innerHTML = '<option value="">Select a user...</option>' +
                    promotable.map(m => `<option value="${m.researcher_id}" data-role="${m.role}">${m.name} (${m.role.toUpperCase()})</option>`).join('');

                // Populate assign researcher select (non-supervisor, non-PI)
                const assignSelect = document.getElementById('assignResearcherSelect');
                const assignable = activeMembers.filter(m => m.role === 'researcher');
                assignSelect.innerHTML = '<option value="">Select researcher...</option>' +
                    assignable.map(m => `<option value="${m.researcher_id}">${m.name} (${m.researcher_id})</option>`).join('');

                // Load assignments
                const assRes = await fetch('/api/di/delegation/assignments', { credentials: 'include' });
                const assData = assRes.ok ? await assRes.json() : { assignments: [] };
                const tbody = document.getElementById('assignmentsTableBody');
                if (assData.assignments.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#666;">No assignments yet</td></tr>';
                } else {
                    tbody.innerHTML = assData.assignments.map(a => `
                        <tr>
                            <td>${escapeHtml(a.supervisor_name || a.supervisor_id)}</td>
                            <td>${escapeHtml(a.researcher_name)} (${escapeHtml(a.researcher_id)})</td>
                            <td>${new Date(a.assigned_at).toLocaleDateString()}</td>
                            <td><button class="btn btn-sm btn-danger" onclick="removeAssignment('${a.supervisor_id}','${a.researcher_id}')">Remove</button></td>
                        </tr>
                    `).join('');
                }
            } catch (err) {
                console.error('Load delegation data error:', err);
            }
        }

        async function promoteToSupervisor() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to promote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role === 'supervisor') { alert('User is already a supervisor'); return; }
            if (!confirm('Promote this researcher to supervisor?')) return;
            try {
                const res = await fetch('/api/di/delegation/promote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User promoted to supervisor', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function demoteToResearcher() {
            const userId = document.getElementById('promoteSelect').value;
            if (!userId) { alert('Select a user to demote'); return; }
            const opt = document.querySelector(`#promoteSelect option[value="${userId}"]`);
            if (opt && opt.dataset.role !== 'supervisor') { alert('User is not a supervisor'); return; }
            if (!confirm('Demote this supervisor to researcher? All assignments will be removed.')) return;
            try {
                const res = await fetch('/api/di/delegation/demote', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: userId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'User demoted to researcher', 'success');
                    loadDelegationData(); loadAllUsers();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function assignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/assign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher assigned to supervisor', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function unassignResearcher() {
            const supId = document.getElementById('supervisorSelect').value;
            const resId = document.getElementById('assignResearcherSelect').value;
            if (!supId || !resId) { alert('Select both supervisor and researcher'); return; }
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                const data = await res.json();
                if (res.ok) {
                    showMessage('delegationMessage', 'Researcher unassigned', 'success');
                    loadDelegationData();
                } else {
                    showMessage('delegationMessage', data.error || 'Failed', 'error');
                }
            } catch (err) { showMessage('delegationMessage', 'Error: ' + err.message, 'error'); }
        }

        async function removeAssignment(supId, resId) {
            if (!confirm('Remove this assignment?')) return;
            try {
                const res = await fetch('/api/di/delegation/unassign', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ supervisor_id: supId, researcher_id: resId }), credentials: 'include'
                });
                if (res.ok) {
                    showMessage('delegationMessage', 'Assignment removed', 'success');
                    loadDelegationData();
                }
            } catch (err) { console.error(err); }
        }

        // Load delegation data on page load
        loadDelegationData();

        // =====================================================
        // BACKUP & RECOVERY TAB
        // =====================================================
        document.querySelector('[data-tab="backup"]').addEventListener('click', () => {
            loadBackupSnapshots();
            dlReset();
        });

        async function loadBackupSnapshots() {
            const select = document.getElementById('backupSnapshotSelect');
            select.innerHTML = '<option value="">Loading...</option>';
            try {
                const resp = await fetch('/api/di/backup/snapshots', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed to load');
                const data = await resp.json();
                if (!data.snapshots || data.snapshots.length === 0) {
                    select.innerHTML = '<option value="">No snapshots available</option>';
                    return;
                }
                select.innerHTML = '<option value="">Select a recovery point...</option>' +
                    data.snapshots.map(s =>
                        `<option value="${escapeHtml(s.path)}">[${escapeHtml(s.type)}] ${escapeHtml(s.label)}</option>`
                    ).join('');
            } catch (err) {
                select.innerHTML = '<option value="">Error loading snapshots</option>';
                console.error('Load snapshots error:', err);
            }
        }

        function clearBackupPreview() {
            document.getElementById('backupPreviewContainer').style.display = 'none';
            document.getElementById('backupRecoveryResult').style.display = 'none';
            document.getElementById('backupRecoveryProgress').style.display = 'none';
        }

        async function previewBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            if (!snapshot) { alert('Please select a recovery point first.'); return; }

            clearBackupPreview();
            showMessage('backupMessage', 'Loading preview...', 'info');

            try {
                const resp = await fetch('/api/di/backup/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot }),
                    credentials: 'include'
                });
                if (!resp.ok) {
                    const err = await resp.json();
                    throw new Error(err.error || 'Preview failed');
                }
                const data = await resp.json();

                document.getElementById('bkpBackupCount').textContent = data.backupFileCount;
                document.getElementById('bkpR2Count').textContent = data.r2FileCount;
                document.getElementById('bkpDiffCount').textContent = data.estimatedDifference;
                document.getElementById('backupSummaryText').textContent = data.summaryText;

                document.getElementById('backupPreviewContainer').style.display = 'block';
                document.getElementById('backupMessage').className = 'message';
            } catch (err) {
                showMessage('backupMessage', 'Preview error: ' + err.message, 'error');
            }
        }

        async function confirmBackupRecovery() {
            const snapshot = document.getElementById('backupSnapshotSelect').value;
            const mode = document.getElementById('backupRecoveryMode').value;
            if (!snapshot) { alert('No snapshot selected.'); return; }

            const modeLabel = mode === 'add-missing' ? 'ADD MISSING FILES ONLY' : 'FULL RESTORE (overwrites changed files)';
            if (!window.confirm('You are about to perform: ' + modeLabel + ' from snapshot "' + snapshot + '". Continue?')) return;

            if (mode === 'full-restore') {
                if (!window.confirm('FINAL WARNING: Full restore will overwrite files that differ in size. Are you sure?')) return;
            }

            document.getElementById('backupRecoverBtn').disabled = true;
            document.getElementById('backupRecoveryProgress').style.display = 'block';
            document.getElementById('backupRecoveryResult').style.display = 'none';

            try {
                const resp = await fetch('/api/di/backup/recover', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ snapshot, mode, confirm: true }),
                    credentials: 'include'
                });
                const data = await resp.json();
                document.getElementById('backupRecoveryProgress').style.display = 'none';

                const resultEl = document.getElementById('backupRecoveryResult');
                if (data.success) {
                    resultEl.innerHTML =
                        '<div class="message success show" style="display:block;">' +
                        '<strong>Recovery Complete</strong><br>' +
                        'Processed: ' + data.processed + ' | Copied: ' + data.copied +
                        ' | Skipped: ' + data.skipped + ' | Failed: ' + data.failed +
                        (data.failed > 0 ? '<br><span style="color:#dc3545;">Some files failed. Check server logs.</span>' : '') +
                        '</div>';
                } else {
                    resultEl.innerHTML = '<div class="message error show" style="display:block;"><strong>Recovery Failed:</strong> ' + escapeHtml(data.error || 'Unknown error') + '</div>';
                }
                resultEl.style.display = 'block';
            } catch (err) {
                document.getElementById('backupRecoveryProgress').style.display = 'none';
                showMessage('backupMessage', 'Recovery request failed: ' + err.message, 'error');
            } finally {
                document.getElementById('backupRecoverBtn').disabled = false;
            }
        }

        // --- Download (R2 on-demand ZIP) ---
        const dlState = { flow: null, step: 0, researchers: [], selected: [],
            dateFrom: '', dateTo: '', estimate: null, downloadMode: 'single',
            maxBytes: 524288000, cursor: '', partNum: 0 };

        function dlReset() {
            dlState.flow = null; dlState.step = 0; dlState.selected = [];
            dlState.dateFrom = ''; dlState.dateTo = ''; dlState.estimate = null;
            dlState.cursor = ''; dlState.partNum = 0; dlState.downloadMode = 'single';
            document.getElementById('dlButtons').style.display = 'flex';
            document.getElementById('dlFlow').style.display = 'none';
            document.getElementById('dlProgress').style.display = 'none';
            document.getElementById('dlMessage').className = 'message';
            document.getElementById('dlMessage').innerHTML = '';
            document.getElementById('dlStepActions').innerHTML = '';
        }

        async function dlStartFlow(flow) {
            dlReset();
            dlState.flow = flow;
            document.getElementById('dlButtons').style.display = 'none';
            document.getElementById('dlFlow').style.display = 'block';
            const titles = { researcher: 'Download by Researcher', daterange: 'Download by Date Range', full: 'Full Data Download' };
            document.getElementById('dlFlowTitle').textContent = titles[flow];
            if (flow === 'researcher') { dlState.step = 1; await dlShowResearcherStep(); }
            else if (flow === 'daterange') { dlState.step = 1; dlShowDateRangeStep(); }
            else { dlState.step = 1; await dlShowEstimateStep(); }
        }

        async function dlShowResearcherStep() {
            const stepLabel = dlState.flow === 'daterange' ? 'Step 2 \u2014 Select Researchers' : 'Step 1 \u2014 Select Researchers';
            document.getElementById('dlStepLabel').textContent = stepLabel;
            const content = document.getElementById('dlStepContent');
            content.innerHTML = '<div class="loading"><div class="spinner"></div>Loading researchers...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                if (!dlState.researchers.length) {
                    const resp = await fetch('/api/di/backup/download/researchers', { credentials: 'include' });
                    if (!resp.ok) throw new Error((await resp.json()).error || 'Failed');
                    const data = await resp.json();
                    dlState.researchers = data.researchers || [];
                }
                if (dlState.flow === 'daterange' && dlState.selected.length === 0) {
                    dlState.selected = dlState.researchers.map(r => r.id);
                }
                dlRenderResearcherList('');
            } catch (err) {
                content.innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
            }
        }

        function dlRenderResearcherList(filter) {
            const list = dlState.researchers;
            const q = (filter || '').toLowerCase();
            const filtered = q ? list.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : list;
            let html = '<div style="display:flex;gap:8px;margin-bottom:10px;">' +
                '<input type="text" id="dlSearchBox" placeholder="Search researchers..." oninput="dlRenderResearcherList(this.value)" style="flex:1;padding:6px 10px;border:1px solid #ddd;border-radius:6px;" value="' + escapeHtml(filter || '') + '">' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(true)">Select All</button>' +
                '<button class="btn btn-sm btn-secondary" onclick="dlSelectAll(false)">Clear All</button>' +
                '</div>';
            html += '<div style="max-height:280px;overflow-y:auto;border:1px solid #eee;border-radius:6px;padding:4px;">';
            if (filtered.length === 0) {
                html += '<div style="padding:20px;text-align:center;color:#999;">No researchers found</div>';
            } else {
                for (const r of filtered) {
                    const checked = dlState.selected.includes(r.id) ? 'checked' : '';
                    html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:6px;padding:5px 8px;cursor:pointer;border-bottom:1px solid #f5f5f5;">' +
                        '<input type="checkbox" value="' + escapeHtml(r.id) + '" ' + checked + ' onchange="dlToggleResearcher(\'' + escapeHtml(r.id) + '\', this.checked)">' +
                        '<span>' + escapeHtml(r.name) + '</span>' +
                        '<span style="color:#888;font-size:12px;margin-left:auto;">' + escapeHtml(r.affiliation) + ' &middot; ' + r.files + ' files</span>' +
                        '</label>';
                }
            }
            html += '</div>';
            html += '<div style="margin-top:6px;color:#888;font-size:12px;" id="dlSelCount">' + dlState.selected.length + ' of ' + list.length + ' selected</div>';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlResearcherNext()">Next</button>';
        }

        function dlToggleResearcher(id, checked) {
            if (checked && !dlState.selected.includes(id)) dlState.selected.push(id);
            else if (!checked) dlState.selected = dlState.selected.filter(x => x !== id);
            const el = document.getElementById('dlSelCount');
            if (el) el.textContent = dlState.selected.length + ' of ' + dlState.researchers.length + ' selected';
        }

        function dlSelectAll(select) {
            const q = (document.getElementById('dlSearchBox')?.value || '').toLowerCase();
            const visible = q ? dlState.researchers.filter(r => r.name.toLowerCase().includes(q) || r.id.toLowerCase().includes(q)) : dlState.researchers;
            if (select) {
                for (const r of visible) { if (!dlState.selected.includes(r.id)) dlState.selected.push(r.id); }
            } else {
                const ids = new Set(visible.map(r => r.id));
                dlState.selected = dlState.selected.filter(id => !ids.has(id));
            }
            dlRenderResearcherList(document.getElementById('dlSearchBox')?.value || '');
        }

        async function dlResearcherNext() {
            if (dlState.selected.length === 0) { alert('Please select at least one researcher.'); return; }
            await dlShowEstimateStep();
        }

        function dlShowDateRangeStep() {
            document.getElementById('dlStepLabel').textContent = 'Step 1 \u2014 Date Range';
            const today = new Date().toISOString().slice(0, 10);
            const ago30 = new Date(Date.now() - 30 * 86400000).toISOString().slice(0, 10);
            document.getElementById('dlStepContent').innerHTML =
                '<div style="display:flex;gap:15px;flex-wrap:wrap;align-items:end;">' +
                '<div class="form-group" style="margin:0;"><label>From</label>' +
                '<input type="date" id="dlDateFrom" value="' + ago30 + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '<div class="form-group" style="margin:0;"><label>To</label>' +
                '<input type="date" id="dlDateTo" value="' + today + '" style="padding:6px 10px;border:1px solid #ddd;border-radius:6px;"></div>' +
                '</div>';
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlDateRangeNext()">Next</button>';
        }

        async function dlDateRangeNext() {
            const from = document.getElementById('dlDateFrom').value;
            const to = document.getElementById('dlDateTo').value;
            if (!from || !to) { alert('Please select both dates.'); return; }
            if (from > to) { alert('"From" date must be before "To" date.'); return; }
            dlState.dateFrom = from;
            dlState.dateTo = to;
            dlState.step = 2;
            await dlShowResearcherStep();
        }

        async function dlShowEstimateStep() {
            const stepNum = dlState.flow === 'daterange' ? 3 : (dlState.flow === 'researcher' ? 2 : 1);
            document.getElementById('dlStepLabel').textContent = 'Step ' + stepNum + ' \u2014 Estimate & Download';
            document.getElementById('dlStepContent').innerHTML = '<div class="loading"><div class="spinner"></div>Estimating selection...</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                const resp = await fetch('/api/di/backup/download/estimate', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) throw new Error((await resp.json()).error || 'Estimate failed');
                dlState.estimate = await resp.json();
                dlRenderEstimate();
            } catch (err) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message error show" style="display:block;">Error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function dlSetMode(mode) {
            dlState.downloadMode = mode;
            const el = document.getElementById('dlChunkSize');
            if (el) el.style.display = mode === 'multi' ? '' : 'none';
        }

        function dlRenderEstimate() {
            const est = dlState.estimate;
            if (!est || est.fileCount === 0) {
                document.getElementById('dlStepContent').innerHTML = '<div class="message info show" style="display:block;">No files match your selection.</div>';
                document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
                return;
            }
            let html = '<div class="stats-row" style="margin-bottom:15px;">' +
                '<div class="stat-card"><div class="stat-value">' + est.fileCount + '</div><div class="stat-label">Files</div></div>' +
                '<div class="stat-card"><div class="stat-value">' + formatFileSize(est.totalBytes) + '</div><div class="stat-label">Total Size</div></div>' +
                '</div>';
            html += '<div class="form-group"><label>Download Mode</label><div id="dlModeRow" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;">';
            if (est.singleZipAvailable) {
                html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;background:#f0f7ff;">' +
                    '<input type="radio" name="dlMode" value="single" checked onchange="dlSetMode(\'single\')"> Single ZIP download' +
                    (est.recommendedMode === 'single' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                    '</label>';
            }
            html += '<label style="display:flex;flex:1;max-width:360px;align-items:center;gap:8px;padding:8px;cursor:pointer;border:1px solid #ddd;border-radius:6px;margin:0;' +
                (!est.singleZipAvailable ? 'background:#f0f7ff;' : '') + '">' +
                '<input type="radio" name="dlMode" value="multi" ' + (!est.singleZipAvailable ? 'checked' : '') + ' onchange="dlSetMode(\'multi\')"> Multi-file download' +
                (est.recommendedMode === 'multi' ? ' <span style="color:#28a745;font-size:12px;">(Recommended)</span>' : '') +
                '</label>';
            html += '<div id="dlChunkSize" style="' + (est.singleZipAvailable ? 'display:none;' : '') + 'margin-left:28px;margin:0;">' +
                '<label style="font-size:13px;color:#666;">Chunk size: </label>' +
                '<select id="dlChunkSelect" style="padding:4px 8px;border:1px solid #ddd;border-radius:4px;" onchange="dlState.maxBytes=Number(this.value)">' +
                '<option value="262144000">250 MB</option>' +
                '<option value="524288000" selected>500 MB (Recommended)</option>' +
                '<option value="1073741824">1 GB</option>' +
                '</select></div>';
            html += '</div></div>';
            dlState.downloadMode = est.singleZipAvailable ? 'single' : 'multi';
            document.getElementById('dlStepContent').innerHTML = html;
            document.getElementById('dlStepActions').innerHTML = '<button class="btn btn-primary" onclick="dlStartDownload()">Download</button>';
        }

        async function dlStartDownload() {
            if (!dlState.estimate) return;
            dlState.cursor = ''; dlState.partNum = 0;
            document.getElementById('dlStepActions').innerHTML = '';
            await dlDownloadPart(dlState.downloadMode === 'multi');
        }

        async function dlDownloadPart(isMulti) {
            dlState.partNum++;
            const progEl = document.getElementById('dlProgress');
            progEl.style.display = 'block';
            progEl.innerHTML = '<div class="loading"><div class="spinner"></div>Downloading' +
                (isMulti ? ' Part ' + dlState.partNum : '') + '... This may take a while.</div>';
            document.getElementById('dlStepActions').innerHTML = '';
            try {
                const body = { mode: dlState.flow };
                if (dlState.flow === 'researcher') body.researchers = dlState.selected;
                if (dlState.flow === 'daterange') {
                    body.dateFrom = dlState.dateFrom; body.dateTo = dlState.dateTo;
                    if (dlState.selected.length > 0 && dlState.selected.length < dlState.researchers.length) body.researchers = dlState.selected;
                }
                if (isMulti) body.maxBytes = dlState.maxBytes;
                if (dlState.cursor) body.cursor = dlState.cursor;

                const resp = await fetch('/api/di/backup/download/zip', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body), credentials: 'include'
                });
                if (!resp.ok) {
                    let errMsg = 'Download failed';
                    try { errMsg = (await resp.json()).error || errMsg; } catch(e) {}
                    throw new Error(errMsg);
                }
                const nextCursor = resp.headers.get('X-Next-Cursor') || '';
                const fileCount = resp.headers.get('X-File-Count') || '?';
                const blob = await resp.blob();
                const cd = resp.headers.get('Content-Disposition') || '';
                const fnMatch = cd.match(/filename="(.+?)"/);
                const filename = fnMatch ? fnMatch[1] : 'download.zip';
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = filename;
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
                setTimeout(() => URL.revokeObjectURL(url), 120000);

                dlState.cursor = nextCursor;
                if (isMulti && nextCursor) {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Part ' + dlState.partNum + ' downloaded</strong> (' + fileCount + ' files).<br>More data available.</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-primary" onclick="dlDownloadPart(true)">Download Part ' + (dlState.partNum + 1) + '</button>' +
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                } else {
                    progEl.innerHTML = '<div class="message success show" style="display:block;">' +
                        '<strong>Download complete</strong> (' + fileCount + ' files).</div>';
                    document.getElementById('dlStepActions').innerHTML =
                        '<button class="btn btn-secondary" onclick="dlReset()">Done</button>';
                }
            } catch (err) {
                progEl.innerHTML = '<div class="message error show" style="display:block;">Download error: ' + escapeHtml(err.message) + '</div>';
                document.getElementById('dlStepActions').innerHTML =
                    '<button class="btn btn-secondary" onclick="dlReset()">&larr; Back</button>';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 B';
            const units = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + units[i];
        }

        // =====================================================
        // PURCHASE REQUESTS (PI)
        // =====================================================

        async function loadAllPurchaseRequests() {
            const tbody = document.getElementById('prAllTableBody');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                let requests = data.requests || [];

                const statusFilter = document.getElementById('prFilterStatus').value;
                if (statusFilter === 'PENDING_CHANGES') {
                    requests = requests.filter(r => r.has_pending_changes);
                } else if (statusFilter) {
                    requests = requests.filter(r => r.status === statusFilter);
                }

                if (requests.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#999;">No purchase requests found</td></tr>';
                    return;
                }

                const statusColors = { SUBMITTED: '#007bff', APPROVED: '#28a745', DECLINED: '#fd7e14' };
                tbody.innerHTML = requests.map(r => {
                    const items = r.items || [];
                    const itemNames = items.map(i => i.product_name).join(', ');
                    const pendingBadge = r.has_pending_changes ? '<span style="display:inline-block;margin-left:4px;padding:1px 6px;border-radius:8px;font-size:10px;color:#856404;background:#fff3cd;">Pending Changes</span>' : '';
                    return `<tr>
                        <td style="white-space:nowrap;">${new Date(r.created_at).toLocaleDateString()}</td>
                        <td>${escapeHtml(r.requester_name || r.requester_id)}</td>
                        <td>${escapeHtml(r.affiliation)}</td>
                        <td title="${escapeHtml(r.justification)}" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(r.justification)}</td>
                        <td title="${escapeHtml(itemNames)}" style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${items.length} item${items.length>1?'s':''}</td>
                        <td style="white-space:nowrap;font-weight:600;">${Number(r.request_total).toFixed(2)} ${escapeHtml(r.currency)}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[r.status]||'#666'};">${r.status}</span>${pendingBadge}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="showPrDetail('${r.id}')">Review</button></td>
                    </tr>`;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:#dc3545;">Error loading requests</td></tr>';
            }
        }

        let prAllData = [];
        async function showPrDetail(requestId) {
            // Fetch fresh data
            try {
                const resp = await fetch('/api/di/purchases/all', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                prAllData = data.requests || [];
            } catch (err) { return; }

            const req = prAllData.find(r => r.id === requestId);
            if (!req) return;

            document.getElementById('prDetailPanel').style.display = 'block';
            document.getElementById('prDetailTitle').textContent = `Request from ${req.requester_name || req.requester_id} (${req.affiliation})`;
            document.getElementById('prDetailJustification').innerHTML = `<strong>Justification:</strong> ${escapeHtml(req.justification)}`;
            document.getElementById('prDetailTotal').textContent = `${Number(req.request_total).toFixed(2)} ${escapeHtml(req.currency)}`;

            const items = req.items || [];
            const tbody = document.getElementById('prDetailItemsBody');
            tbody.innerHTML = items.map(i => {
                const st = i.item_status || 'Active';
                const orderedLabel = i.ordered_at ? `<span style="color:#28a745;" title="${new Date(i.ordered_at).toLocaleDateString()}">Yes</span>` : '<span style="color:#999;">No</span>';

                // Actions column logic
                let actions = '';
                if (i.ordered_at) {
                    // Read only — ordered
                } else if (st === 'Modification Requested') {
                    actions = `<button class="btn btn-sm btn-success" style="font-size:11px;padding:2px 8px;" onclick="piAcceptItem('${i.id}','${requestId}')">Accept</button>
                               <button class="btn btn-sm" style="font-size:11px;padding:2px 8px;background:#dc3545;color:#fff;" onclick="piRejectItem('${i.id}','${requestId}')">Reject</button>`;
                } else if (st === 'Cancel Requested') {
                    actions = `<button class="btn btn-sm btn-success" style="font-size:11px;padding:2px 8px;" onclick="piAcceptItem('${i.id}','${requestId}')">Accept</button>
                               <button class="btn btn-sm" style="font-size:11px;padding:2px 8px;background:#dc3545;color:#fff;" onclick="piRejectItem('${i.id}','${requestId}')">Reject</button>`;
                } else if (st === 'Cancelled') {
                    // No actions
                } else if (req.status === 'APPROVED') {
                    actions = `<button class="btn btn-sm btn-secondary" onclick="markItemOrdered('${i.id}','${requestId}')">Mark Ordered</button>`;
                }

                // Status label
                let statusTag = '';
                if (st === 'Modification Requested') {
                    statusTag = '<span style="display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;color:#856404;background:#fff3cd;">Modification Requested</span>';
                } else if (st === 'Cancel Requested') {
                    statusTag = '<span style="display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;color:#856404;background:#fff3cd;">Cancel Requested</span>';
                } else if (st === 'Cancelled') {
                    statusTag = '<span style="display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;color:#721c24;background:#f8d7da;">Cancelled</span>';
                } else if (i.modified_by) {
                    statusTag = `<span style="display:inline-block;padding:1px 6px;border-radius:8px;font-size:10px;color:#155724;background:#d4edda;">Modified by PI</span>`;
                    if (i.modified_at) statusTag += `<br><small style="color:#999;">${new Date(i.modified_at).toLocaleDateString()}</small>`;
                }

                // Show proposed values for Modification Requested
                let proposedRow = '';
                if (st === 'Modification Requested') {
                    const pVendor = i.proposed_vendor ? `<strong>Vendor:</strong> ${escapeHtml(i.proposed_vendor)}` : '';
                    const pProduct = i.proposed_product ? `<strong>Product:</strong> ${escapeHtml(i.proposed_product)}` : '';
                    const pQty = i.proposed_qty ? `<strong>Qty:</strong> ${i.proposed_qty}` : '';
                    const pPrice = i.proposed_unit_price ? `<strong>Price:</strong> ${Number(i.proposed_unit_price).toFixed(2)}` : '';
                    const parts = [pVendor, pProduct, pQty, pPrice].filter(Boolean).join(', ');
                    const noteText = i.status_note ? `<br><em>Note: ${escapeHtml(i.status_note)}</em>` : '';
                    proposedRow = `<tr style="background:#fff8e1;"><td colspan="9" style="padding:4px 12px;font-size:11px;color:#856404;">
                        <strong>Proposed changes:</strong> ${parts}${noteText}
                    </td></tr>`;
                } else if (st === 'Cancel Requested') {
                    const noteText = i.status_note ? escapeHtml(i.status_note) : '';
                    proposedRow = `<tr style="background:#fff8e1;"><td colspan="9" style="padding:4px 12px;font-size:11px;color:#856404;">
                        <strong>Cancellation requested:</strong> ${noteText}
                    </td></tr>`;
                }

                return `<tr${st === 'Cancelled' ? ' style="opacity:0.5;"' : ''}>
                    <td>${escapeHtml(i.vendor_company)}</td>
                    <td>${escapeHtml(i.product_name)}</td>
                    <td>${escapeHtml(i.catalog_id)}</td>
                    <td>${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank" style="font-size:11px;">Link</a>' : ''}</td>
                    <td>${i.quantity}</td>
                    <td>${Number(i.unit_price).toFixed(2)}</td>
                    <td style="font-weight:600;">${Number(i.item_total).toFixed(2)}</td>
                    <td>${orderedLabel}${statusTag ? '<br>' + statusTag : ''}</td>
                    <td>${actions}</td>
                </tr>${proposedRow}`;
            }).join('');

            const actionsEl = document.getElementById('prDetailActions');
            if (req.status === 'SUBMITTED') {
                actionsEl.innerHTML = `
                    <button class="btn btn-success" onclick="approvePurchaseRequest('${requestId}')">Approve</button>
                    <button class="btn" style="background:#fd7e14;color:#fff;" onclick="declinePurchaseRequest('${requestId}')">Decline</button>
                `;
            } else if (req.status === 'DECLINED' && req.pi_comment) {
                actionsEl.innerHTML = `<div style="color:#856404;font-size:13px;"><strong>Declined:</strong> ${escapeHtml(req.pi_comment)}</div>`;
            } else {
                actionsEl.innerHTML = '';
            }
        }

        function closePrDetail() {
            document.getElementById('prDetailPanel').style.display = 'none';
        }

        async function approvePurchaseRequest(requestId) {
            if (!confirm('Approve this purchase request?')) return;
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/approve`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request approved.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function declinePurchaseRequest(requestId) {
            const comment = prompt('Enter reason for declining (required):');
            if (comment === null) return;
            if (!comment.trim()) { alert('A comment is required when declining.'); return; }
            try {
                const resp = await fetch(`/api/di/purchases/${requestId}/decline`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pi_comment: comment }),
                    credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                alert('Request declined.');
                closePrDetail();
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function markItemOrdered(itemId, requestId) {
            try {
                const resp = await fetch(`/api/di/purchases/item/${itemId}/mark-ordered`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                showPrDetail(requestId);
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piAcceptItem(itemId, requestId) {
            const note = prompt('Decision note (optional):');
            if (note === null) return;
            try {
                const resp = await fetch(`/api/di/purchase-items/${itemId}/pi-accept`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision_note: note || '' }),
                    credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');
                showPrDetail(requestId);
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectItem(itemId, requestId) {
            const note = prompt('Decision note (required):');
            if (note === null) return;
            if (!note.trim()) { alert('A decision note is required when rejecting.'); return; }
            try {
                const resp = await fetch(`/api/di/purchase-items/${itemId}/pi-reject`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ decision_note: note }),
                    credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');
                showPrDetail(requestId);
                loadAllPurchaseRequests();
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // CONSOLIDATED EMAIL
        // =====================================================

        let consolidatedEmailText = '';

        async function loadConsolidatedEmail(affiliation) {
            const area = document.getElementById('prConsolidatedArea');
            const emptyEl = document.getElementById('prConsolidatedEmpty');
            area.style.display = 'none';
            emptyEl.style.display = 'none';

            try {
                const resp = await fetch(`/api/di/purchases/consolidated?affiliation=${affiliation}`, { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];

                if (items.length === 0) {
                    emptyEl.style.display = 'block';
                    return;
                }

                const subject = `NATLAB purchase request (${affiliation})`;
                let body = `Hi,\n\nPlease find below the products that have been approved and need to be ordered as soon as possible.\n\nThank you,\nBest,\nFrank\n\n`;

                items.forEach(i => {
                    body += `- Vendor: ${i.vendor_company}\n`;
                    body += `  Product name: ${i.product_name}\n`;
                    body += `  Catalog ID: ${i.catalog_id}\n`;
                    body += `  Quantity: ${i.quantity}\n`;
                    body += `  Unit price: ${Number(i.unit_price).toFixed(2)} ${i.currency}\n`;
                    body += `  Item total: ${Number(i.item_total).toFixed(2)} ${i.currency}\n`;
                    body += `  Product link: ${i.product_link}\n`;
                    body += `  Requested by: ${i.requester_name || i.requester_id}\n`;
                    body += `  Request ID: ${i.request_id.substring(0, 8)}\n\n`;
                });

                body += `---\nTotal: ${data.total.toFixed(2)} ${data.currency}`;

                consolidatedEmailText = `Subject: ${subject}\n\n${body}`;
                document.getElementById('prConsolidatedTitle').textContent = subject;
                document.getElementById('prConsolidatedText').textContent = consolidatedEmailText;
                area.style.display = 'block';
            } catch (err) {
                alert('Error loading consolidated data: ' + err.message);
            }
        }

        function copyConsolidatedEmail() {
            navigator.clipboard.writeText(consolidatedEmailText).then(() => {
                const btn = document.querySelector('#prConsolidatedArea .btn-success');
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 2000);
            }).catch(() => {
                // Fallback: select text
                const pre = document.getElementById('prConsolidatedText');
                const range = document.createRange();
                range.selectNodeContents(pre);
                window.getSelection().removeAllRanges();
                window.getSelection().addRange(range);
            });
        }

        // =====================================================
        // PURCHASES & INVENTORY TAB (V2 — CANONICAL MODEL)
        // =====================================================

        // PO Numbers
        let poData = [];
        async function loadPONumbers() {
            const tbody = document.getElementById('poTableBody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';
            try {
                const resp = await fetch('/api/di/inventory-v2/po-numbers', { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                poData = data.items || [];
                renderPOTable(poData);
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#dc3545;">Error loading PO numbers</td></tr>';
            }
        }

        function searchPONumbers() {
            const q = document.getElementById('poSearchInput').value.toLowerCase().trim();
            if (!q) { renderPOTable(poData); return; }
            renderPOTable(poData.filter(i =>
                (i.internal_order_number || '').toLowerCase().includes(q) ||
                (i.product_name || '').toLowerCase().includes(q) ||
                (i.requester_name || '').toLowerCase().includes(q) ||
                (i.requester_id || '').toLowerCase().includes(q)
            ));
        }

        function renderPOTable(items) {
            const tbody = document.getElementById('poTableBody');
            if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:#999;">No PO numbers found</td></tr>'; return; }
            tbody.innerHTML = items.map(i => `<tr>
                <td>${i.product_link ? '<a href="'+escapeHtml(i.product_link)+'" target="_blank">'+escapeHtml(i.product_name)+'</a>' : escapeHtml(i.product_name)}</td>
                <td>${escapeHtml(i.requester_name || i.requester_id)}</td>
                <td>${i.ordered_at ? new Date(i.ordered_at).toLocaleDateString() : '-'}</td>
                <td style="font-weight:600;color:#0c5460;">${escapeHtml(i.internal_order_number)}</td>
                <td>${i.received_at ? '<span style="color:#28a745;">Received</span>' : '<span style="color:#999;">Pending</span>'}</td>
            </tr>`).join('');
        }

        // Inventory Management V2
        async function loadAllInventoryV2() {
            const tbody = document.getElementById('invV2AllTableBody');
            tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;"><div class="loading"><div class="spinner"></div></div></td></tr>';

            const params = new URLSearchParams();
            const type = document.getElementById('invV2FilterType').value;
            const aff = document.getElementById('invV2FilterAffiliation').value;
            const vis = document.getElementById('invV2FilterVisibility').value;
            const status = document.getElementById('invV2FilterStatus').value;
            const source = document.getElementById('invV2FilterSource').value;
            if (type) params.set('item_type', type);
            if (aff) params.set('affiliation', aff);
            if (vis) params.set('visibility_scope', vis);
            if (status) params.set('status', status);
            if (source) params.set('source', source);

            try {
                const resp = await fetch('/api/di/inventory-v2/all?' + params.toString(), { credentials: 'include' });
                if (!resp.ok) throw new Error('Failed');
                const data = await resp.json();
                const items = data.items || [];
                if (items.length === 0) { tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#999;">No inventory items found</td></tr>'; return; }

                const statusColors = { Pending: '#ffc107', Approved: '#28a745', Revision: '#fd7e14', Rejected: '#dc3545', Received: '#17a2b8', ConsumePending: '#fd7e14', TransferPending: '#6f42c1', ApprovedLinked: '#20c997', Consumed: '#6c757d', DeletePending: '#e83e8c', Deleted: '#6c757d' };
                tbody.innerHTML = items.map(i => {
                    let actions = '';
                    if ((i.status === 'Pending' || i.status === 'Revision') && i.source === 'Offline') {
                        // Offline pending: approve-as-new, show duplicates, reject
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveAsNew('${i.id}')" title="Approve as New">&#10003; New</button> `;
                        actions += `<button class="btn btn-sm btn-info" style="color:#fff;" onclick="piShowDuplicates('${i.id}')" title="Show Duplicates">&#128269; Dup</button> `;
                        actions += `<button class="btn btn-sm btn-warning" onclick="piRevisionItem('${i.id}')" title="Revision">&#8635;</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectItem('${i.id}')" title="Reject">&#10007;</button> `;
                    } else if (i.status === 'Pending' || i.status === 'Revision') {
                        // Online pending: existing approve/revision/reject
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveItem('${i.id}')" title="Approve">&#10003;</button> `;
                        actions += `<button class="btn btn-sm btn-warning" onclick="piRevisionItem('${i.id}')" title="Revision">&#8635;</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectItem('${i.id}')" title="Reject">&#10007;</button> `;
                    }
                    if (i.status === 'ConsumePending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveConsume('${i.id}')" title="Approve Consume">&#10003; Consume</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectConsume('${i.id}')" title="Reject Consume">&#10007; Consume</button> `;
                    }
                    if (i.status === 'TransferPending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveTransfer('${i.id}')" title="Approve Transfer">&#10003; Transfer</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectTransfer('${i.id}')" title="Reject Transfer">&#10007; Transfer</button> `;
                    }
                    if (i.status === 'DeletePending') {
                        actions += `<button class="btn btn-sm btn-success" onclick="piApproveDelete('${i.id}')" title="Approve Delete">&#10003; Delete</button> `;
                        actions += `<button class="btn btn-sm btn-danger" onclick="piRejectDelete('${i.id}')" title="Reject Delete">&#10007; Delete</button> `;
                        if (i.delete_reason) actions += `<br><small style="color:#856404;">Reason: ${escapeHtml(i.delete_reason)}${i.delete_reason_detail ? ' — '+escapeHtml(i.delete_reason_detail) : ''}</small>`;
                    }
                    if (i.status === 'Approved' && i.visibility_scope === 'personal') {
                        actions += `<button class="btn btn-sm btn-primary" onclick="piPromoteToGroup('${i.id}')" title="Promote to Group">&#8593; Group</button>`;
                    }
                    if (i.status === 'Approved' && i.visibility_scope === 'group') {
                        actions += `<button class="btn btn-sm btn-secondary" onclick="piDemoteFromGroup('${i.id}')" title="Remove from Group">&#8595; Personal</button>`;
                    }
                    return `<tr>
                        <td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${escapeHtml(i.item_name)}">${escapeHtml(i.item_name)}</td>
                        <td>${escapeHtml(i.item_type)}</td>
                        <td>${escapeHtml(i.item_identifier)}</td>
                        <td>${escapeHtml(i.affiliation)}</td>
                        <td>${escapeHtml(i.created_by_name || i.created_by)}</td>
                        <td>${i.quantity}</td>
                        <td>${escapeHtml(i.quantity_unit)}</td>
                        <td>${escapeHtml(i.storage_temperature)}</td>
                        <td><span style="padding:2px 8px;border-radius:10px;font-size:11px;color:#fff;background:${statusColors[i.status]||'#666'};">${i.status}</span>${i.status_comment ? '<br><small style="color:#856404;">'+escapeHtml(i.status_comment)+'</small>' : ''}</td>
                        <td style="font-size:11px;">${i.visibility_scope === 'group' ? '<strong style="color:#0c5460;">Group</strong>' : 'Personal'}</td>
                        <td style="white-space:nowrap;">${actions}</td>
                    </tr>`;
                }).join('');
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:#dc3545;">Error loading inventory</td></tr>';
            }
        }

        async function piApproveItem(id) {
            if (!confirm('Approve this inventory item?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRevisionItem(id) {
            const comment = prompt('Enter revision comment for the researcher:');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/revision`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectItem(id) {
            const comment = prompt('Enter rejection reason (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piPromoteToGroup(id) {
            if (!confirm('Promote this item to Group Inventory?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/promote-to-group`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piDemoteFromGroup(id) {
            if (!confirm('Remove this item from Group Inventory? It will return to personal scope.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/demote-from-group`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        // ==================== INVENTORY RULES — NEW PI FUNCTIONS ====================

        async function piApproveConsume(id) {
            if (!confirm('Approve consume request? Item will be marked as Consumed.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-consume`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectConsume(id) {
            const comment = prompt('Rejection reason for consume request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-consume`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveTransfer(id) {
            if (!confirm('Approve transfer to Group Inventory?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-transfer`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectTransfer(id) {
            const comment = prompt('Rejection reason for transfer request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-transfer`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveDelete(id) {
            if (!confirm('Approve deletion? Item will be permanently removed from active inventory.')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-delete`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piRejectDelete(id) {
            const comment = prompt('Rejection reason for delete request (required):');
            if (comment === null || !comment.trim()) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/reject-delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment: comment.trim() }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveAsNew(id) {
            if (!confirm('Approve this offline item as a NEW Group Inventory entry?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/approve-as-new`, { method: 'POST', credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piApproveAsDuplicate(itemId, dupId) {
            if (!confirm('Link this item to the selected group inventory record as a duplicate?')) return;
            try {
                const resp = await fetch(`/api/di/inventory-v2/${itemId}/approve-as-duplicate`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ duplicate_of_inventory_id: dupId }), credentials: 'include'
                });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                // Remove the suggestions row
                const sugRow = document.getElementById('dup-suggestions-' + itemId);
                if (sugRow) sugRow.remove();
                loadAllInventoryV2();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function piShowDuplicates(id) {
            // Toggle: if suggestions row already exists, remove it
            const existingRow = document.getElementById('dup-suggestions-' + id);
            if (existingRow) { existingRow.remove(); return; }

            try {
                const resp = await fetch(`/api/di/inventory-v2/${id}/duplicate-suggestions`, { credentials: 'include' });
                if (!resp.ok) { const d = await resp.json(); throw new Error(d.error || 'Failed'); }
                const data = await resp.json();
                const suggestions = data.suggestions || [];

                // Find the row for this item and insert after it
                const tbody = document.getElementById('invV2AllTableBody');
                const rows = tbody.querySelectorAll('tr');
                let targetRow = null;
                for (const row of rows) {
                    if (row.innerHTML.includes(id)) { targetRow = row; break; }
                }
                if (!targetRow) return;

                const sugRow = document.createElement('tr');
                sugRow.id = 'dup-suggestions-' + id;
                sugRow.style.background = '#f8f9fa';

                if (suggestions.length === 0) {
                    sugRow.innerHTML = '<td colspan="11" style="padding:12px;text-align:center;color:#999;font-style:italic;">No duplicate suggestions found in Group Inventory.</td>';
                } else {
                    let html = '<td colspan="11" style="padding:12px;"><strong style="font-size:12px;">Duplicate Suggestions (up to 5):</strong><table style="width:100%;font-size:12px;border-collapse:collapse;margin-top:6px;"><thead><tr style="color:#666;"><th style="padding:4px 8px;text-align:left;">Name</th><th style="padding:4px 8px;text-align:left;">Vendor</th><th style="padding:4px 8px;text-align:left;">Catalog ID</th><th style="padding:4px 8px;text-align:left;">Location</th><th style="padding:4px 8px;text-align:left;">Lot/Batch</th><th style="padding:4px 8px;text-align:left;">Match</th><th style="padding:4px 8px;">Action</th></tr></thead><tbody>';
                    suggestions.forEach(s => {
                        html += `<tr>
                            <td style="padding:4px 8px;">${escapeHtml(s.item_name)}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.vendor_company || '')}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.item_identifier || '')}</td>
                            <td style="padding:4px 8px;background:#fff3cd;font-weight:600;">${escapeHtml(s.storage_location || '')}</td>
                            <td style="padding:4px 8px;">${escapeHtml(s.lot_or_batch_number || '')}</td>
                            <td style="padding:4px 8px;font-size:10px;color:#666;">${escapeHtml(s.match_type)}</td>
                            <td style="padding:4px 8px;text-align:center;"><button class="btn btn-sm btn-primary" onclick="piApproveAsDuplicate('${id}','${s.id}')">Link</button></td>
                        </tr>`;
                    });
                    html += '</tbody></table></td>';
                    sugRow.innerHTML = html;
                }

                targetRow.after(sugRow);
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // TRAINING & APPROVALS
        // =====================================================
        function showTrainingToggle(view) {
            document.getElementById('trainingDesignView').style.display = view === 'design' ? 'block' : 'none';
            document.getElementById('trainingMgmtView').style.display = view === 'management' ? 'block' : 'none';
            document.getElementById('trainingCertsView').style.display = view === 'certifications' ? 'block' : 'none';
            document.getElementById('toggleTrainingDesign').className = 'btn ' + (view === 'design' ? 'btn-primary' : 'btn-secondary');
            document.getElementById('toggleTrainingMgmt').className = 'btn ' + (view === 'management' ? 'btn-primary' : 'btn-secondary');
            document.getElementById('toggleTrainingCerts').className = 'btn ' + (view === 'certifications' ? 'btn-primary' : 'btn-secondary');
            if (view === 'management') { loadPendingTrainingPacks(); loadSealedTrainingPacks(); }
            if (view === 'certifications') { loadPiPendingCerts(); }
        }

        // -- Training Document Upload --
        document.getElementById('trainDocFile').addEventListener('change', function() {
            document.getElementById('trainDocFileName').textContent = this.files[0] ? this.files[0].name : '';
        });

        document.getElementById('trainDocForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const msgEl = document.getElementById('trainDocMessage');
            const btn = document.getElementById('trainDocSubmitBtn');
            const file = document.getElementById('trainDocFile').files[0];
            if (!file) { msgEl.className = 'message error show'; msgEl.textContent = 'Select a PDF file'; return; }

            btn.disabled = true; btn.textContent = 'Uploading...';
            const fd = new FormData();
            fd.append('file', file);
            fd.append('title', document.getElementById('trainDocTitle').value);
            fd.append('category', document.getElementById('trainDocCategory').value);
            fd.append('affiliation', document.getElementById('trainDocAffiliation').value);
            fd.append('requirement_rule', document.getElementById('trainDocRule').value);
            fd.append('condition_key', document.getElementById('trainDocCondKey').value);
            fd.append('condition_note', document.getElementById('trainDocCondNote').value);

            try {
                const resp = await fetch('/api/di/training/documents', { method: 'POST', body: fd, credentials: 'include' });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Upload failed');
                msgEl.className = 'message success show'; msgEl.textContent = 'Document uploaded successfully';
                document.getElementById('trainDocForm').reset();
                document.getElementById('trainDocFileName').textContent = '';
                loadTrainingDocuments();
            } catch (err) {
                msgEl.className = 'message error show'; msgEl.textContent = err.message;
            } finally { btn.disabled = false; btn.textContent = 'Upload Document'; }
        });

        async function loadTrainingDocuments() {
            try {
                const resp = await fetch('/api/di/training/documents', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('trainDocsTableBody');
                if (!data.documents || data.documents.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No training documents yet</td></tr>';
                    return;
                }
                tbody.innerHTML = data.documents.map(d => {
                    const currentV = d.versions ? d.versions.find(v => v.is_current) : null;
                    const statusClass = d.is_active ? 'status-approved' : 'status-inactive';
                    const statusText = d.is_active ? 'Active' : 'Retired';
                    const versionList = d.versions ? d.versions.map(v =>
                        `<span style="font-size:11px;${v.is_current ? 'font-weight:bold;' : 'color:#999;'}">v${v.version}</span>`
                    ).join(' ') : '-';
                    return `<tr>
                        <td>${escapeHtml(d.title)}${d.condition_key ? ' <span style="font-size:10px;color:#666;">(' + escapeHtml(d.condition_key) + ')</span>' : ''}</td>
                        <td>${escapeHtml(d.category)}</td>
                        <td>${escapeHtml(d.affiliation)}</td>
                        <td>${escapeHtml(d.requirement_rule)}</td>
                        <td>${versionList}${currentV ? ' <a href="/api/di/training/document-versions/' + currentV.id + '/view" target="_blank" style="font-size:11px;">View</a>' : ''}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            ${d.is_active
                                ? `<button class="btn btn-sm btn-warning" onclick="retireTrainDoc('${d.id}')">Retire</button>`
                                : `<button class="btn btn-sm btn-success" onclick="activateTrainDoc('${d.id}')">Activate</button>`}
                            <button class="btn btn-sm btn-primary" onclick="uploadNewVersion('${d.id}')">New Version</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (err) { console.error('[TRAINING] load docs error:', err); }
        }

        async function retireTrainDoc(id) {
            if (!confirm('Retire this document? It will no longer appear to researchers.')) return;
            try {
                await fetch(`/api/di/training/documents/${id}/retire`, { method: 'PUT', credentials: 'include' });
                loadTrainingDocuments();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function activateTrainDoc(id) {
            try {
                await fetch(`/api/di/training/documents/${id}/activate`, { method: 'PUT', credentials: 'include' });
                loadTrainingDocuments();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function uploadNewVersion(docId) {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.pdf';
            input.onchange = async () => {
                if (!input.files[0]) return;
                const fd = new FormData();
                fd.append('file', input.files[0]);
                try {
                    const resp = await fetch(`/api/di/training/documents/${docId}/versions`, { method: 'POST', body: fd, credentials: 'include' });
                    const data = await resp.json();
                    if (!resp.ok) throw new Error(data.error || 'Upload failed');
                    alert('Version ' + data.version + ' uploaded');
                    loadTrainingDocuments();
                } catch (err) { alert('Error: ' + err.message); }
            };
            input.click();
        }

        // -- Training Management --
        async function loadPendingTrainingPacks() {
            try {
                const resp = await fetch('/api/di/training/packs/pending', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('pendingPacksTableBody');
                if (!data.packs || data.packs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:#999;">No pending packs</td></tr>';
                    return;
                }
                tbody.innerHTML = data.packs.map(p => `<tr>
                    <td>${escapeHtml(p.researcher_name)}</td>
                    <td>${escapeHtml(p.researcher_affiliation)}</td>
                    <td>v${p.version}</td>
                    <td>${p.agreement_count}</td>
                    <td>${p.entry_count}</td>
                    <td>${new Date(p.updated_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPackDetails('${p.id}')">Review</button>
                        <button class="btn btn-sm btn-success" onclick="sealPack('${p.id}')">Seal</button>
                        <button class="btn btn-sm btn-warning" onclick="revisePack('${p.id}')">Revise</button>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load pending packs error:', err); }
        }

        async function viewPackDetails(packId) {
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}`, { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const area = document.getElementById('packDetailArea');
                area.style.display = 'block';
                document.getElementById('packDetailTitle').textContent = `Pack Details — ${data.pack.researcher_name} v${data.pack.version}`;

                let html = '<h4 style="font-size:13px;color:#333;margin:10px 0 5px;">Agreements</h4>';
                if (data.agreements.length === 0) { html += '<p style="color:#999;font-size:12px;">No agreements</p>'; }
                else {
                    html += '<table class="data-table" style="font-size:12px;"><thead><tr><th>Document</th><th>Version</th><th>Confirmed by</th><th>Date</th></tr></thead><tbody>';
                    data.agreements.forEach(a => {
                        html += `<tr><td>${escapeHtml(a.document_title)}</td><td>v${a.doc_version}</td><td>${escapeHtml(a.confirmed_name)}</td><td>${new Date(a.confirmed_at).toLocaleDateString()}</td></tr>`;
                    });
                    html += '</tbody></table>';
                }

                html += '<h4 style="font-size:13px;color:#333;margin:15px 0 5px;">Training Entries</h4>';
                if (data.entries.length === 0) { html += '<p style="color:#999;font-size:12px;">No entries</p>'; }
                else {
                    html += '<table class="data-table" style="font-size:12px;"><thead><tr><th>Type</th><th>Date</th><th>Supervisor</th><th>Status</th></tr></thead><tbody>';
                    data.entries.forEach(e => {
                        const badgeClass = e.status === 'CERTIFIED' ? 'status-approved' : e.status === 'REJECTED' ? 'status-revision' : 'status-pending';
                        const supText = e.certification_route === 'PI' ? `${escapeHtml(e.supervisor_name || '')} <span style="font-size:10px;color:#856404;">(PI oversight)</span>` : escapeHtml(e.supervisor_name || '');
                        html += `<tr><td>${escapeHtml(e.training_type)}</td><td>${new Date(e.training_date).toLocaleDateString()}</td><td>${supText}</td><td><span class="status-badge ${badgeClass}">${e.status}</span></td></tr>`;
                    });
                    html += '</tbody></table>';
                }
                document.getElementById('packDetailContent').innerHTML = html;
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function sealPack(packId) {
            if (!confirm('Seal this training pack? This action is permanent and will generate a certificate.')) return;
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}/seal`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Seal failed');
                alert('Pack sealed. Verification: ' + data.verification_code);
                loadPendingTrainingPacks();
                loadSealedTrainingPacks();
                document.getElementById('packDetailArea').style.display = 'none';
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function revisePack(packId) {
            const comments = prompt('Enter revision comments:');
            if (!comments) return;
            try {
                const resp = await fetch(`/api/di/training/packs/${packId}/revise`, {
                    method: 'POST', credentials: 'include',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comments })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Revision request failed');
                alert('Revision requested');
                loadPendingTrainingPacks();
            } catch (err) { alert('Error: ' + err.message); }
        }

        async function loadSealedTrainingPacks() {
            try {
                const resp = await fetch('/api/di/training/sealed-overview', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('sealedPacksTableBody');
                if (!data.packs || data.packs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="3" style="text-align:center;color:#999;">No sealed packs yet</td></tr>';
                    return;
                }
                tbody.innerHTML = data.packs.map(p => `<tr>
                    <td>${escapeHtml(p.researcher_name)}</td>
                    <td><span class="status-badge status-approved">SEALED</span> ${new Date(p.sealed_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewPackDetails('${p.id}')">View</button>
                        <a href="/api/di/training/certificate/${p.id}" class="btn btn-sm btn-secondary" style="text-decoration:none;">Download</a>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load sealed packs error:', err); }
        }

        // -- PI Certifications (PI-route entries) --
        async function loadPiPendingCerts() {
            try {
                const resp = await fetch('/api/di/training/pi-pending-certifications', { credentials: 'include' });
                if (resp.status === 501) return;
                const data = await resp.json();
                if (!data.success) return;
                const tbody = document.getElementById('piCertsTableBody');
                if (!data.entries || data.entries.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#999;">No pending PI certifications</td></tr>';
                    return;
                }
                tbody.innerHTML = data.entries.map(e => `<tr>
                    <td>${escapeHtml(e.trainee_name)}</td>
                    <td>${escapeHtml(e.training_type)}</td>
                    <td>${new Date(e.training_date).toLocaleDateString()}</td>
                    <td>${escapeHtml(e.other_supervisor_name || '')} ${e.other_supervisor_email ? '(' + escapeHtml(e.other_supervisor_email) + ')' : ''}</td>
                    <td style="font-size:11px;color:#666;">${escapeHtml(e.notes || '-')}</td>
                    <td>
                        <button class="btn btn-sm btn-success" onclick="piCertifyEntry('${e.id}')">Certify</button>
                    </td>
                </tr>`).join('');
            } catch (err) { console.error('[TRAINING] load PI pending certs:', err); }
        }

        async function piCertifyEntry(entryId) {
            if (!confirm('Certify this training entry under PI oversight?')) return;
            try {
                const resp = await fetch(`/api/di/training/entries/${entryId}/pi-certify`, { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json' } });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');
                loadPiPendingCerts();
            } catch (err) { alert('Error: ' + err.message); }
        }

        // =====================================================
        // INTERNAL DOCUMENTS TAB
        // =====================================================
        let intdocTreeData = null;
        const intdocSlugLabels = { papers: 'Papers', projects: 'Projects', grants: 'Grants', collaborators: 'Collaborators', other: 'Other' };

        function intdocInit() {
            intdocLoadTree();
        }

        async function intdocLoadTree() {
            const container = document.getElementById('intdocTree');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            document.getElementById('intdocFilePanel').style.display = 'none';

            try {
                const resp = await fetch('/api/internal-docs/tree', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Failed');

                intdocTreeData = data.tree;
                intdocRenderTree();
            } catch (err) {
                container.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading document tree</p>';
            }
        }

        function intdocRenderTree() {
            const tree = intdocTreeData;
            if (!tree) return;
            let html = '';

            for (const [slug, label] of Object.entries(intdocSlugLabels)) {
                const cat = tree[slug] || { count: 0, folders: [] };

                if (slug === 'papers') {
                    html += `<div class="tree-item tree-folder" style="cursor:pointer" onclick="intdocShowFiles('papers')">
                        <span class="icon">&#128196;</span>
                        <span>${label} (${cat.count} files)</span>
                    </div>`;
                } else {
                    html += `<div class="tree-item tree-folder" onclick="toggleFolder(this)" style="cursor:pointer">
                        <span class="icon">&#128193;</span>
                        <span>${label} (${cat.count} files)</span>
                    </div>`;
                    html += '<div class="tree-children">';

                    if (cat.folders && cat.folders.length > 0) {
                        cat.folders.forEach(f => {
                            const eName = encodeURIComponent(f.name);
                            html += `<div style="padding:4px 20px;display:flex;align-items:center;gap:8px;font-size:13px;">
                                <span class="icon" style="cursor:pointer" onclick="intdocShowFiles('${slug}', decodeURIComponent('${eName}'))">&#128194;</span>
                                <span style="cursor:pointer;flex:1;" onclick="intdocShowFiles('${slug}', decodeURIComponent('${eName}'))">${escapeHtml(f.name)} (${f.count})</span>
                                <button style="font-size:10px;padding:2px 6px;color:#dc3545;background:none;border:1px solid #dc3545;border-radius:3px;cursor:pointer;" onclick="intdocDeleteFolder('${slug}', decodeURIComponent('${eName}'))">Delete</button>
                            </div>`;
                        });
                    } else {
                        html += '<div style="padding:5px 20px;color:#999;font-size:12px;">No folders yet</div>';
                    }

                    html += `<div style="padding:5px 20px;display:flex;gap:4px;align-items:center;">
                        <input type="text" placeholder="New folder" style="padding:3px 6px;border:1px solid #ddd;border-radius:3px;font-size:11px;width:120px;" id="newFolder_${slug}">
                        <button class="btn btn-sm" style="font-size:10px;padding:2px 8px;" onclick="intdocCreateFolder('${slug}')">Create</button>
                    </div>`;
                    html += '</div>';
                }
            }

            document.getElementById('intdocTree').innerHTML = html;
        }

        async function intdocShowFiles(category, folder) {
            const panel = document.getElementById('intdocFilePanel');
            const title = document.getElementById('intdocFilePanelTitle');
            const list = document.getElementById('intdocFilePanelList');

            title.textContent = folder ? `${intdocSlugLabels[category]}: ${folder}` : intdocSlugLabels[category];
            list.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';
            panel.style.display = '';

            try {
                let url = `/api/internal-docs/list?category=${category}`;
                if (folder) url += `&folder=${encodeURIComponent(folder)}`;

                const resp = await fetch(url, { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Failed');

                if (data.files.length === 0) {
                    list.innerHTML = '<div style="color:#999;font-size:12px;padding:10px;">No files</div>';
                    return;
                }

                let html = '';
                data.files.forEach(file => {
                    const openUrl = '/api/internal-docs/open?key=' + encodeURIComponent(file.key);
                    const eKey = encodeURIComponent(file.key);
                    const eFolder = folder ? encodeURIComponent(folder) : '';
                    const size = intdocFormatSize(file.size);
                    const date = file.last_modified ? new Date(file.last_modified).toLocaleDateString() : '';

                    html += `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid #f0f0f0;font-size:12px;">
                        <span>&#128196;</span>
                        <span style="flex:1;">${escapeHtml(file.name)}</span>
                        <span style="color:#999;">${size}</span>
                        <span style="color:#999;">${date}</span>
                        <button class="btn-view" style="padding:2px 8px;font-size:11px;" onclick="window.open('${openUrl}#pagemode=none&zoom=page-width', '_blank')">Open</button>
                        <button style="padding:2px 8px;font-size:11px;background:#dc3545;color:white;border:none;border-radius:3px;cursor:pointer;" onclick="intdocDeleteFile('${eKey}', '${category}', '${eFolder}')">Delete</button>
                    </div>`;
                });

                list.innerHTML = html;
            } catch (err) {
                list.innerHTML = '<p style="color:#dc3545;font-size:12px;">Error loading files</p>';
            }
        }

        function intdocFormatSize(bytes) {
            if (!bytes) return '';
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function intdocCategoryChanged() {
            const cat = document.getElementById('intdocCategory').value;
            const folderGroup = document.getElementById('intdocFolderGroup');
            if (cat === 'papers') {
                folderGroup.style.display = 'none';
            } else {
                folderGroup.style.display = '';
                intdocPopulateFolderSelect(cat);
            }
        }

        function intdocPopulateFolderSelect(category) {
            const select = document.getElementById('intdocFolderSelect');
            select.innerHTML = '<option value="">Select folder...</option>';
            if (intdocTreeData && intdocTreeData[category] && intdocTreeData[category].folders) {
                intdocTreeData[category].folders.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.name;
                    opt.textContent = f.name;
                    select.appendChild(opt);
                });
            }
        }

        async function intdocUpload() {
            const cat = document.getElementById('intdocCategory').value;
            const folderSelect = document.getElementById('intdocFolderSelect');
            const newFolderInput = document.getElementById('intdocNewFolder');
            const filesInput = document.getElementById('intdocFiles');
            const btn = document.getElementById('intdocUploadBtn');

            let folder = '';
            if (cat !== 'papers') {
                folder = newFolderInput.value.trim() || folderSelect.value;
                if (!folder) {
                    intdocMsg('Please select or enter a folder name', 'error');
                    return;
                }
            }

            if (!filesInput.files || filesInput.files.length === 0) {
                intdocMsg('Please select at least one PDF file', 'error');
                return;
            }

            for (const file of filesInput.files) {
                if (!file.name.toLowerCase().endsWith('.pdf')) {
                    intdocMsg(`"${file.name}" is not a PDF file`, 'error');
                    return;
                }
            }

            btn.disabled = true;
            btn.textContent = 'Uploading...';

            try {
                const formData = new FormData();
                formData.append('category', cat);
                if (folder) formData.append('folder', folder);
                for (const file of filesInput.files) {
                    formData.append('files', file);
                }

                const resp = await fetch('/api/internal-docs/upload', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await resp.json();

                if (!resp.ok) {
                    intdocMsg(data.error || 'Upload failed', 'error');
                } else {
                    intdocMsg(`${data.uploaded.length} file(s) uploaded successfully`, 'success');
                    filesInput.value = '';
                    newFolderInput.value = '';
                    intdocLoadTree();
                }
            } catch (err) {
                intdocMsg('Connection error', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Upload';
            }
        }

        function intdocMsg(text, type) {
            const msg = document.getElementById('intdocUploadMsg');
            msg.style.display = '';
            msg.textContent = text;
            msg.style.color = type === 'error' ? '#721c24' : '#155724';
            msg.style.background = type === 'error' ? '#f8d7da' : '#d4edda';
            setTimeout(() => { msg.style.display = 'none'; }, 5000);
        }

        async function intdocDeleteFile(encodedKey, category, encodedFolder) {
            if (!confirm('Move this file to trash?')) return;

            try {
                const resp = await fetch('/api/internal-docs/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ key: decodeURIComponent(encodedKey) }),
                    credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');

                intdocLoadTree();
                const folder = encodedFolder ? decodeURIComponent(encodedFolder) : undefined;
                intdocShowFiles(category, folder);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function intdocCreateFolder(slug) {
            const input = document.getElementById('newFolder_' + slug);
            const name = (input.value || '').trim();
            if (!name) { alert('Enter a folder name'); return; }

            try {
                const resp = await fetch('/api/internal-docs/create-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: slug, folder: name }),
                    credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');

                input.value = '';
                intdocLoadTree();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function intdocDeleteFolder(slug, folder) {
            try {
                let resp = await fetch('/api/internal-docs/delete-folder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category: slug, folder }),
                    credentials: 'include'
                });
                let data = await resp.json();

                if (resp.status === 409 && data.requires_force) {
                    if (!confirm(`Folder "${folder}" contains ${data.file_count} file(s). Move all to trash and delete folder?`)) return;
                    resp = await fetch('/api/internal-docs/delete-folder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ category: slug, folder, force: true }),
                        credentials: 'include'
                    });
                    data = await resp.json();
                }

                if (!resp.ok) throw new Error(data.error || 'Failed');

                document.getElementById('intdocFilePanel').style.display = 'none';
                intdocLoadTree();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        function intdocToggleTrash() {
            const panel = document.getElementById('intdocTrashPanel');
            if (panel.style.display === 'none') {
                panel.style.display = '';
                intdocLoadTrash();
            } else {
                panel.style.display = 'none';
            }
        }

        async function intdocLoadTrash() {
            const list = document.getElementById('intdocTrashList');
            list.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            try {
                const resp = await fetch('/api/internal-docs/trash', { credentials: 'include' });
                const data = await resp.json();
                if (!data.success) throw new Error(data.error || 'Failed');

                if (data.items.length === 0) {
                    list.innerHTML = '<div style="color:#999;font-size:12px;padding:10px;">Trash is empty</div>';
                    return;
                }

                let html = '';
                data.items.forEach(item => {
                    const date = item.deleted_at ? new Date(item.deleted_at).toLocaleDateString() : '';
                    const eTK = encodeURIComponent(item.trash_key);
                    const eOK = encodeURIComponent(item.original_key);
                    html += `<div style="display:flex;align-items:center;gap:8px;padding:4px 0;border-bottom:1px solid #f0f0f0;font-size:11px;">
                        <span>&#128196;</span>
                        <span style="flex:1;" title="${escapeHtml(item.original_key)}">${escapeHtml(item.name)}</span>
                        <span style="color:#999;">${date}</span>
                        <button style="padding:2px 8px;font-size:10px;background:#28a745;color:white;border:none;border-radius:3px;cursor:pointer;" onclick="intdocRestore('${eTK}', '${eOK}')">Restore</button>
                    </div>`;
                });

                list.innerHTML = html;
            } catch (err) {
                list.innerHTML = '<p style="color:#dc3545;font-size:12px;">Error loading trash</p>';
            }
        }

        async function intdocRestore(encodedTrashKey, encodedOriginalKey) {
            try {
                const resp = await fetch('/api/internal-docs/restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        trash_key: decodeURIComponent(encodedTrashKey),
                        original_key: decodeURIComponent(encodedOriginalKey)
                    }),
                    credentials: 'include'
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Failed');

                intdocLoadTrash();
                intdocLoadTree();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }
        // Init InternalDocs dropdown (PI-only) after page scripts load
        try { setTimeout(() => { try { dicInitInternalDocs(); } catch (e) {} }, 0); } catch (e) {}
    </script>
</body>
</html>
