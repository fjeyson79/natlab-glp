<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supervisor Dashboard: NATLAB GLP Portal</title>

<script>
  (function () {
    var KEY = "natlab_supervisor_dashboard_cachebust_v1";
    if (!sessionStorage.getItem(KEY)) {
      sessionStorage.setItem(KEY, "1");
      var url = new URL(window.location.href);
      url.searchParams.set("v", "ba1b974");
      window.location.replace(url.toString());
    }
  })();
</script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: Arial, sans-serif;
            background: #f0f2f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #1a365d 0%, #2d5a87 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { font-size: 20px; }
        .header-info { display: flex; align-items: center; gap: 20px; }
        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
        }
        .supervisor-badge {
            background: #17a2b8;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }
        .logout-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .logout-btn:hover { background: rgba(255,255,255,0.3); }

        /* Section Navigation */
        .section-nav {
            display: flex;
            gap: 0;
            padding: 0 20px;
            max-width: 1400px;
            margin: 20px auto 0;
        }
        .section-nav button {
            padding: 10px 24px;
            font-size: 14px;
            font-weight: bold;
            border: 1px solid #ddd;
            border-bottom: none;
            background: #e9ecef;
            color: #666;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }
        .section-nav button.active {
            background: white;
            color: #1a365d;
            border-color: #ddd;
            position: relative;
            z-index: 1;
        }
        .section-nav button:hover:not(.active) {
            background: #f0f2f5;
        }
        .section-content { display: none; }
        .section-content.active { display: block; }

        .main-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 0 20px 20px;
            max-width: 1400px;
            margin: 0 auto;
            min-height: calc(100vh - 130px);
        }
        .main-container.full-width {
            grid-template-columns: 1fr;
        }

        .panel {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .panel.accent { border-top: 3px solid #17a2b8; }
        .panel-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header.accent-header {
            background: linear-gradient(135deg, #e3f6f9 0%, #f0fafb 100%);
        }
        .panel-header h2 {
            font-size: 16px;
            color: #1a365d;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .panel-header .icon { font-size: 20px; }
        .panel-content {
            padding: 20px;
            flex: 1;
            overflow-y: auto;
        }

        /* Researcher List */
        .researcher-list { list-style: none; }
        .researcher-item {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .researcher-item:hover { background: #f0f2f5; }
        .researcher-item.active { background: #e3f2fd; border-left: 3px solid #17a2b8; }
        .researcher-item:last-child { border-bottom: none; }
        .researcher-name { font-weight: bold; color: #333; }
        .researcher-email { font-size: 12px; color: #666; }
        .researcher-files { font-size: 11px; color: #17a2b8; }

        /* File Tree Styles */
        .file-tree { font-size: 13px; }
        .tree-item {
            padding: 8px 10px;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tree-item:hover { background: #f0f2f5; }
        .tree-item .icon { font-size: 16px; }
        .tree-folder { font-weight: bold; color: #1a365d; }
        .tree-file { color: #333; padding-left: 20px; }
        .tree-children { margin-left: 20px; border-left: 1px solid #e0e0e0; }
        .tree-children.collapsed { display: none; }

        .file-actions {
            margin-left: auto;
            display: flex;
            gap: 5px;
        }
        .file-actions button {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-view { background: #007bff; color: white; }
        .btn-download { background: #28a745; color: white; }
        .btn-verify { background: #6f42c1; color: white; }

        .file-status {
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .status-APPROVED { background: #d4edda; color: #155724; }
        .status-PENDING { background: #fff3cd; color: #856404; }
        .status-REVISION_NEEDED { background: #f8d7da; color: #721c24; }

        .folder-submitted { color: #856404; }
        .folder-approved { color: #155724; }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        .empty-state .icon { font-size: 48px; margin-bottom: 15px; opacity: 0.5; }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #17a2b8;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-bar {
            display: flex;
            gap: 15px;
            padding: 10px 15px;
            background: #e3f2fd;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 12px;
        }
        .stat-item { display: flex; align-items: center; gap: 5px; }
        .stat-value { font-weight: bold; color: #1a365d; }

        .selected-researcher-info {
            background: #17a2b8;
            color: white;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .selected-researcher-info strong { display: block; font-size: 14px; }
        .selected-researcher-info span { font-size: 12px; opacity: 0.9; }

        /* Message */
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 13px;
            display: none;
        }
        .message.show { display: block; }
        .message.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        /* Inventory tables */
        .inv-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }
        .inv-table th {
            background: #f8f9fa;
            padding: 8px 10px;
            text-align: left;
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            border-bottom: 2px solid #e0e0e0;
            white-space: nowrap;
        }
        .inv-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
        }
        .inv-table tr:hover { background: #fafafa; }

        .status-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        .status-badge.Pending { background: #fff3cd; color: #856404; }
        .status-badge.Approved { background: #d4edda; color: #155724; }
        .status-badge.Revision { background: #f8d7da; color: #721c24; }
        .status-badge.Rejected { background: #f5c6cb; color: #721c24; }

        /* Sub-tabs */
        .sub-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        .sub-tab {
            padding: 8px 18px;
            font-size: 13px;
            border: none;
            background: none;
            cursor: pointer;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        .sub-tab.active {
            color: #17a2b8;
            border-bottom-color: #17a2b8;
            font-weight: bold;
        }
        .sub-tab:hover:not(.active) { color: #333; }

        /* Offline entry form */
        .off-form { margin-top: 15px; }
        .off-row { display: flex; gap: 12px; margin-bottom: 10px; flex-wrap: wrap; }
        .off-field { flex: 1; min-width: 180px; }
        .off-label { display: block; font-size: 11px; color: #666; margin-bottom: 3px; font-weight: bold; text-transform: uppercase; }
        .off-input {
            width: 100%;
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .off-input:focus { border-color: #17a2b8; outline: none; }

        .btn-sm {
            padding: 4px 10px;
            font-size: 11px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        .btn-primary { background: #17a2b8; color: white; }
        .btn-primary:hover { background: #138496; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }

        .inv-actions { display: flex; gap: 4px; flex-wrap: wrap; }

        /* Type selector */
        .type-selector {
            display: flex;
            gap: 0;
            margin-bottom: 15px;
        }
        .type-selector button {
            padding: 8px 20px;
            font-size: 13px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            color: #666;
        }
        .type-selector button:first-child { border-radius: 4px 0 0 4px; }
        .type-selector button:last-child { border-radius: 0 4px 4px 0; }
        .type-selector button.active {
            background: #17a2b8;
            color: white;
            border-color: #17a2b8;
        }
        .type-selector button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Group Documents Styles */
        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .doc-card {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            transition: box-shadow 0.2s;
        }
        .doc-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .doc-card-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }
        .doc-icon {
            font-size: 24px;
        }
        .doc-title {
            font-weight: bold;
            color: #333;
            font-size: 14px;
            margin-bottom: 3px;
        }
        .doc-category {
            font-size: 11px;
            color: #666;
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
        }
        .doc-description {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
            line-height: 1.4;
        }
        .doc-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .doc-filename {
            font-size: 11px;
            color: #999;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .doc-download-btn {
            padding: 6px 12px;
            background: #2d5a87;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }
        .doc-download-btn:hover {
            background: #1a365d;
        }
        .category-filter {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        .category-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .category-btn:hover {
            border-color: #2d5a87;
            color: #2d5a87;
        }
        .category-btn.active {
            background: #2d5a87;
            color: white;
            border-color: #2d5a87;
        }
        .upload-link-btn {
            display: inline-block;
            padding: 10px 20px;
            background: #2d5a87;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        .upload-link-btn:hover {
            background: #1a365d;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(45,90,135,0.3);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .main-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>NATLAB GLP Data Integrity Portal</h1>
        <div class="header-info">
            <span class="supervisor-badge">SUPERVISOR</span>
            <span class="user-badge" id="userName">Loading...</span>
            <button class="logout-btn" id="logoutBtn">Logout</button>
        </div>
    </div>

    <!-- Section Navigation -->
    <div class="section-nav">
        <button class="active" onclick="switchSection('files')">Files &amp; Documents</button>
        <button onclick="switchSection('supervision')">Supervision</button>
        <button onclick="switchSection('inventory')">Purchases &amp; Inventory</button>
    </div>

    <!-- ==================== SECTION: FILES & DOCUMENTS ==================== -->
    <div id="section-files" class="section-content active">
        <div class="main-container">
            <!-- My Files Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128193;</span> My Files</h2>
                    <button onclick="loadMyFiles()" style="padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #ddd;border-radius:4px;background:white;">Refresh</button>
                </div>
                <div class="panel-content">
                    <a href="upload.html" class="upload-link-btn">&#8593; Go to Upload</a>
                    <div id="myFilesStatsBar" class="stats-bar" style="display:none;">
                        <div class="stat-item">
                            <span>Under Review:</span>
                            <span class="stat-value" style="color:#856404;" id="myStatPending">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Approved:</span>
                            <span class="stat-value" style="color:#28a745;" id="myStatApproved">0</span>
                        </div>
                        <div class="stat-item">
                            <span>Revision Needed:</span>
                            <span class="stat-value" style="color:#dc3545;" id="myStatRevision">0</span>
                        </div>
                    </div>
                    <div id="myFileTree" class="file-tree">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Group Documents Panel (Full Width) -->
            <div class="panel" style="grid-column: 1 / -1;">
                <div class="panel-header">
                    <h2><span class="icon">&#128218;</span> Group Documents</h2>
                    <button onclick="loadGroupDocuments()" style="padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #ddd;border-radius:4px;background:white;">Refresh</button>
                </div>
                <div class="panel-content">
                    <div id="categoryFilter" class="category-filter" style="display:none;"></div>
                    <div id="groupDocsContainer">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION: SUPERVISION ==================== -->
    <div id="section-supervision" class="section-content">
        <div class="main-container">
            <!-- Left Panel: Assigned Researchers -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128101;</span> My Researchers</h2>
                    <button onclick="loadSupervisionResearchers()" style="padding:5px 10px;font-size:12px;cursor:pointer;border:1px solid #ddd;border-radius:4px;background:white;">Refresh</button>
                </div>
                <div class="panel-content" style="padding:0;">
                    <ul id="supervisionResearcherList" class="researcher-list">
                        <li class="loading"><div class="spinner"></div>Loading...</li>
                    </ul>
                </div>
            </div>

            <!-- Right Panel: Supervision Views -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#128269;</span> Supervision</h2>
                </div>
                <div class="panel-content">
                    <div class="message info show" id="supSelectPrompt">
                        Select a researcher from the list to view their files and inventory.<br>
                        <small>All views are read-only for supervision purposes.</small>
                    </div>
                    <div id="supSelectedResearcherInfo" class="selected-researcher-info" style="display:none;">
                        <strong id="supSelectedResearcherName"></strong>
                        <span id="supSelectedResearcherEmail"></span>
                    </div>

                    <!-- Sub-tabs for Files / My Inventory -->
                    <div id="supSubTabs" class="sub-tabs" style="display:none;">
                        <button class="sub-tab active" onclick="switchSupervisionView('files')">Files</button>
                        <button class="sub-tab" onclick="switchSupervisionView('inventory')">My Inventory</button>
                    </div>

                    <!-- Files View -->
                    <div id="supFilesView" style="display:none;">
                        <div id="supStatsBar" class="stats-bar" style="display:none;">
                            <div class="stat-item">
                                <span>Under Review:</span>
                                <span class="stat-value" style="color:#856404;" id="supStatPending">0</span>
                            </div>
                            <div class="stat-item">
                                <span>Approved:</span>
                                <span class="stat-value" style="color:#28a745;" id="supStatApproved">0</span>
                            </div>
                        </div>
                        <div id="supFileTree" class="file-tree"></div>
                    </div>

                    <!-- My Inventory View -->
                    <div id="supInventoryView" style="display:none;">
                        <div class="sub-tabs">
                            <button class="sub-tab active" onclick="switchSupInvType('product')">Products</button>
                            <button class="sub-tab" onclick="switchSupInvType('sample')">Samples</button>
                            <button class="sub-tab" onclick="switchSupInvType('oligo')">Oligos</button>
                        </div>
                        <div id="supInvTableBody">
                            <div class="loading"><div class="spinner"></div>Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== SECTION: PURCHASES & INVENTORY ==================== -->
    <div id="section-inventory" class="section-content">
        <div class="main-container full-width">

            <!-- My Inventory (accent) -->
            <div class="panel accent">
                <div class="panel-header accent-header">
                    <h2><span class="icon">&#128230;</span> My Inventory</h2>
                </div>
                <div class="panel-content">
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchMyInvType('product')">Products</button>
                        <button class="sub-tab" onclick="switchMyInvType('sample')">Samples</button>
                        <button class="sub-tab" onclick="switchMyInvType('oligo')">Oligos</button>
                    </div>
                    <div id="myInvTable">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

            <!-- Add Offline Item -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#10133;</span> Add Offline Item</h2>
                </div>
                <div class="panel-content">
                    <div class="type-selector">
                        <button class="active" onclick="switchOfflineType('product')">Product</button>
                        <button onclick="switchOfflineType('sample')">Sample</button>
                        <button disabled title="Coming soon">Oligo</button>
                    </div>

                    <!-- Product Form -->
                    <div id="offProductForm" class="off-form">
                        <div class="off-row">
                            <div class="off-field"><label class="off-label">Product Name *</label><input class="off-input" id="offProdName"></div>
                            <div class="off-field"><label class="off-label">Catalog / Item ID *</label><input class="off-input" id="offProdCatalog"></div>
                        </div>
                        <div class="off-row">
                            <div class="off-field"><label class="off-label">Vendor / Company</label><input class="off-input" id="offProdVendor"></div>
                            <div class="off-field"><label class="off-label">Product Link</label><input class="off-input" id="offProdLink" placeholder="https://..."></div>
                        </div>
                        <div class="off-row">
                            <div class="off-field" style="max-width:120px"><label class="off-label">Quantity *</label><input class="off-input" id="offProdQty" type="number" min="0" step="0.01" value="1"></div>
                            <div class="off-field" style="max-width:140px">
                                <label class="off-label">Unit *</label>
                                <select class="off-input" id="offProdUnit">
                                    <option>each</option><option>bottle</option><option>box</option><option>pack</option>
                                    <option>mL</option><option>uL</option><option>mg</option><option>g</option>
                                    <option>vial</option><option>tube</option><option>slides</option><option>other</option>
                                </select>
                            </div>
                            <div class="off-field"><label class="off-label">Storage Location *</label><input class="off-input" id="offProdLocation" placeholder="e.g. Shelf A3"></div>
                            <div class="off-field" style="max-width:140px">
                                <label class="off-label">Temperature *</label>
                                <select class="off-input" id="offProdTemp">
                                    <option>RT</option><option>4C</option><option>-20C</option><option>-80C</option><option>LN2</option>
                                </select>
                            </div>
                        </div>
                        <div class="off-row">
                            <div class="off-field"><label class="off-label">Lot / Batch Number</label><input class="off-input" id="offProdLot"></div>
                            <div class="off-field" style="max-width:160px"><label class="off-label">Expiry Date</label><input class="off-input" id="offProdExpiry" type="date"></div>
                            <div class="off-field" style="max-width:160px"><label class="off-label">Opened Date</label><input class="off-input" id="offProdOpened" type="date"></div>
                        </div>
                        <div class="off-row">
                            <div class="off-field"><label class="off-label">Notes</label><textarea class="off-input" id="offProdNotes" rows="2"></textarea></div>
                        </div>
                        <button class="btn-sm btn-primary" onclick="submitOfflineProduct()" style="padding:8px 20px;font-size:13px;">Submit Product</button>
                    </div>

                    <!-- Sample Form -->
                    <div id="offSampleForm" class="off-form" style="display:none;">
                        <div class="off-row">
                            <div class="off-field"><label class="off-label">Sample Name *</label><input class="off-input" id="offSampName"></div>
                            <div class="off-field"><label class="off-label">Sample ID *</label><input class="off-input" id="offSampId"></div>
                        </div>
                        <div class="off-row">
                            <div class="off-field">
                                <label class="off-label">Sample Origin *</label>
                                <select class="off-input" id="offSampOrigin">
                                    <option value="">-- Select --</option>
                                    <option>Internal</option><option>External Collaboration</option><option>Commercial</option><option>Patient-derived</option><option>Other</option>
                                </select>
                            </div>
                            <div class="off-field">
                                <label class="off-label">Provider / Collaborator *</label>
                                <select class="off-input" id="offSampProvider" onchange="toggleProviderDetail()">
                                    <option value="">-- Select --</option>
                                    <option>LiU</option><option>UNAV</option><option>External</option>
                                </select>
                            </div>
                            <div class="off-field" id="providerDetailField" style="display:none;">
                                <label class="off-label">Provider Detail</label>
                                <input class="off-input" id="offSampProviderDetail" placeholder="Institution or person name">
                            </div>
                        </div>
                        <div class="off-row">
                            <div class="off-field" style="max-width:120px"><label class="off-label">Quantity *</label><input class="off-input" id="offSampQty" type="number" min="0" step="0.01" value="1"></div>
                            <div class="off-field" style="max-width:140px">
                                <label class="off-label">Unit *</label>
                                <select class="off-input" id="offSampUnit">
                                    <option>each</option><option>vial</option><option>tube</option><option>mL</option>
                                    <option>uL</option><option>mg</option><option>g</option><option>slides</option><option>other</option>
                                </select>
                            </div>
                            <div class="off-field"><label class="off-label">Storage Location *</label><input class="off-input" id="offSampLocation" placeholder="e.g. Freezer B2"></div>
                            <div class="off-field" style="max-width:140px">
                                <label class="off-label">Temperature *</label>
                                <select class="off-input" id="offSampTemp">
                                    <option>RT</option><option>4C</option><option>-20C</option><option>-80C</option><option>LN2</option>
                                </select>
                            </div>
                        </div>
                        <div class="off-row">
                            <div class="off-field">
                                <label class="off-label">Sample Status</label>
                                <select class="off-input" id="offSampStatus">
                                    <option value="">-- Select --</option>
                                    <option>Available</option><option>In use</option><option>Depleted</option><option>Contaminated</option>
                                </select>
                            </div>
                            <div class="off-field"><label class="off-label">Notes</label><textarea class="off-input" id="offSampNotes" rows="2"></textarea></div>
                        </div>
                        <button class="btn-sm btn-primary" onclick="submitOfflineSample()" style="padding:8px 20px;font-size:13px;">Submit Sample</button>
                    </div>
                </div>
            </div>

            <!-- Group Inventory (read-only) -->
            <div class="panel">
                <div class="panel-header">
                    <h2><span class="icon">&#127760;</span> Group Inventory</h2>
                </div>
                <div class="panel-content">
                    <div class="sub-tabs">
                        <button class="sub-tab active" onclick="switchGrpInvType('product')">Products</button>
                        <button class="sub-tab" onclick="switchGrpInvType('sample')">Samples</button>
                        <button class="sub-tab" onclick="switchGrpInvType('oligo')">Oligos</button>
                    </div>
                    <div id="grpInvTable">
                        <div class="loading"><div class="spinner"></div>Loading...</div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let currentUser = null;
        let currentMyInvType = 'product';
        let currentGrpInvType = 'product';
        let currentSupInvType = 'product';
        let supResearchers = [];

        // Supervision-specific state
        let selectedSupResearcherId = null;
        let selectedSupResearcherName = '';
        let selectedSupResearcherEmail = '';
        let currentSupervisionView = 'files'; // 'files' or 'inventory'

        // Files & Documents state
        let allGroupDocs = [];
        let currentCategory = 'all';

        // Check authentication and supervisor role
        async function checkAuth() {
            try {
                const response = await fetch('/api/di/me', { credentials: 'include' });
                if (response.status === 401) { window.location.href = 'access.html'; return; }
                const data = await response.json();
                currentUser = data.user || data;

                // Check if user is supervisor
                const role = (currentUser.role || "").toLowerCase();
                if (role !== "supervisor") {
                    if (role === 'pi') window.location.href = 'pi-dashboard.html';
                    else window.location.href = 'upload.html';
                    return;
                }

                document.getElementById('userName').textContent = currentUser.researcher_id;
            } catch (err) {
                window.location.href = 'access.html';
            }
        }

        checkAuth();

        // ==================== SECTION NAVIGATION ====================

        function switchSection(section) {
            document.querySelectorAll('.section-nav button').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.section-content').forEach(s => s.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('section-' + section).classList.add('active');

            if (section === 'files') {
              loadMyFiles();
              loadGroupDocuments();
            }

            if (section === 'files') {
                loadMyFiles();
                loadGroupDocuments();
            } else if (section === 'inventory') {
                loadMyInventoryV2(currentMyInvType);
                loadGroupInventoryV2(currentGrpInvType);
            } else if (section === 'supervision') {
                loadSupervisionResearchers();
            }
        }

        // ==================== FILES & DOCUMENTS SECTION ====================

        // Load My Files
        async function loadMyFiles() {
            const treeContainer = document.getElementById('myFileTree');
            const statsBar = document.getElementById('myFilesStatsBar');

            treeContainer.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';

            try {
                const response = await fetch('/api/di/my-files', { credentials: 'include' });
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || data.error || 'Failed to load files');
                }

                // Update stats
                document.getElementById('myStatPending').textContent = data.pendingCount || 0;
                document.getElementById('myStatApproved').textContent = data.approvedCount || 0;
                document.getElementById('myStatRevision').textContent = data.revisionCount || 0;
                statsBar.style.display = 'flex';

                if (data.totalFiles === 0) {
                    treeContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">&#128196;</div>
                            <p>No files uploaded yet</p>
                            <p style="font-size:12px;margin-top:10px;">Upload your documents using the Upload link above</p>
                        </div>
                    `;
                    return;
                }

                // Build content with optional revision notice
                let content = '';
                if (data.revisionCount > 0) {
                    content += `
                        <div style="background:#fff3cd;border:1px solid #ffc107;padding:10px 15px;border-radius:6px;margin-bottom:15px;font-size:12px;">
                            <strong style="color:#856404;">&#9888; ${data.revisionCount} file(s) need revision</strong>
                            <p style="margin:5px 0 0 0;color:#856404;">Please re-upload the revised documents.</p>
                        </div>
                    `;
                }

                content += renderTree(data.tree);
                treeContainer.innerHTML = content;

            } catch (err) {
                console.error('Error loading files:', err);
                treeContainer.innerHTML = `<p style="color:#dc3545;text-align:center;">Error loading files: ${err.message || 'Unknown error'}</p>`;
            }
        }

        // Load Group Documents
        async function loadGroupDocuments() {
            const container = document.getElementById('groupDocsContainer');
            const filterContainer = document.getElementById('categoryFilter');

            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading group documents...</div>';

            try {
                const response = await fetch('/api/di/group-documents', { credentials: 'include' });

                if (!response.ok) throw new Error('Failed to load documents');
                const data = await response.json();

                allGroupDocs = data.documents || [];

                if (allGroupDocs.length === 0) {
                    filterContainer.style.display = 'none';
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">&#128218;</div>
                            <p>No group documents available</p>
                            <p style="font-size:12px;margin-top:10px;">Your PI will upload shared documents here</p>
                        </div>
                    `;
                    return;
                }

                // Build category filter buttons
                const categories = [...new Set(allGroupDocs.map(d => d.category))].sort();
                filterContainer.innerHTML = `
                    <button class="category-btn ${currentCategory === 'all' ? 'active' : ''}" onclick="filterByCategory('all')">All (${allGroupDocs.length})</button>
                    ${categories.map(cat => {
                        const count = allGroupDocs.filter(d => d.category === cat).length;
                        return `<button class="category-btn ${currentCategory === cat ? 'active' : ''}" onclick="filterByCategory('${cat}')">${cat} (${count})</button>`;
                    }).join('')}
                `;
                filterContainer.style.display = 'flex';

                renderGroupDocuments();

            } catch (err) {
                console.error('Error loading group documents:', err);
                container.innerHTML = '<p style="color:#dc3545;text-align:center;">Error loading group documents</p>';
            }
        }

        function filterByCategory(category) {
            currentCategory = category;

            // Update active button
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().startsWith(category.toLowerCase()) ||
                    (category === 'all' && btn.textContent.startsWith('All'))) {
                    btn.classList.add('active');
                }
            });

            renderGroupDocuments();
        }

        function renderGroupDocuments() {
            const container = document.getElementById('groupDocsContainer');
            const filteredDocs = currentCategory === 'all'
                ? allGroupDocs
                : allGroupDocs.filter(d => d.category === currentCategory);

            if (filteredDocs.length === 0) {
                container.innerHTML = '<p style="color:#666;text-align:center;padding:20px;">No documents in this category</p>';
                return;
            }

            container.innerHTML = `
                <div class="doc-grid">
                    ${filteredDocs.map(doc => renderDocCard(doc)).join('')}
                </div>
            `;
        }

        function renderDocCard(doc) {
            const iconClass = doc.file_type.toLowerCase();
            const icons = {
                'pdf': '&#128196;',
                'excel': '&#128202;',
                'word': '&#128196;',
                'powerpoint': '&#128200;'
            };
            const icon = icons[iconClass] || '&#128196;';
            const canDownload = doc.can_download !== false;

            return `
                <div class="doc-card">
                    <div class="doc-card-header">
                        <span class="doc-icon ${iconClass}">${icon}</span>
                        <div>
                            <div class="doc-title">${escapeHtml(doc.title)}</div>
                            <span class="doc-category">${escapeHtml(doc.category)}</span>
                        </div>
                    </div>
                    ${doc.description ? `<div class="doc-description">${escapeHtml(doc.description)}</div>` : ''}
                    <div class="doc-meta">
                        <span class="doc-filename" title="${escapeHtml(doc.filename)}">${escapeHtml(doc.filename)}</span>
                        ${canDownload ?
                            `<button class="doc-download-btn" onclick="downloadGroupDoc('${doc.downloadUrl}')">
                                &#8595; Download
                            </button>` :
                            '<span style="font-size:11px;color:#999;">View only</span>'}
                    </div>
                </div>
            `;
        }

        function downloadGroupDoc(url) {
            window.location.href = url;
        }

        function verifyDocument(code) {
            window.open(`/api/di/verify/${code}`, '_blank');
        }

        // ==================== SUPERVISION SECTION ====================

        // Load assigned researchers for supervision
        async function loadSupervisionResearchers() {
            const list = document.getElementById('supervisionResearcherList');
            list.innerHTML = '<li class="loading"><div class="spinner"></div>Loading...</li>';

            try {
                const response = await fetch('/api/di/supervision/researchers', { credentials: 'include' });
                if (!response.ok) throw new Error('Failed to load');
                const data = await response.json();

                if (!data.researchers || data.researchers.length === 0) {
                    list.innerHTML = `
                        <li class="empty-state" style="padding:40px 20px;">
                            <div class="icon">&#128101;</div>
                            <p>No researchers assigned</p>
                            <p style="font-size:12px;margin-top:10px;">Contact your PI to assign researchers to you</p>
                        </li>
                    `;
                    return;
                }

                supResearchers = data.researchers;

                list.innerHTML = data.researchers.map(r => `
                    <li class="researcher-item ${selectedSupResearcherId === r.researcher_id ? 'active' : ''}"
                        onclick="selectSupervisionResearcher('${r.researcher_id}', '${escapeHtml(r.name)}', '${escapeHtml(r.institution_email)}')">
                        <div>
                            <div class="researcher-name">${escapeHtml(r.name)}</div>
                            <div class="researcher-email">${escapeHtml(r.institution_email)}</div>
                        </div>
                        <div class="researcher-files">${r.file_count || 0} files</div>
                    </li>
                `).join('');
            } catch (err) {
                list.innerHTML = '<li style="color:#dc3545;padding:20px;text-align:center;">Error loading researchers</li>';
            }
        }

        // Select a researcher in supervision section
        async function selectSupervisionResearcher(researcherId, name, email) {
            selectedSupResearcherId = researcherId;
            selectedSupResearcherName = name;
            selectedSupResearcherEmail = email;

            document.querySelectorAll('#supervisionResearcherList .researcher-item').forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('supSelectPrompt').style.display = 'none';
            document.getElementById('supSelectedResearcherInfo').style.display = 'block';
            document.getElementById('supSelectedResearcherName').textContent = name;
            document.getElementById('supSelectedResearcherEmail').textContent = email;
            document.getElementById('supSubTabs').style.display = 'flex';

            // Default to files view
            currentSupervisionView = 'files';
            document.querySelectorAll('#supSubTabs .sub-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('#supSubTabs .sub-tab')[0].classList.add('active');

            switchSupervisionView('files');
        }

        // Switch between Files and My Inventory views in supervision
        function switchSupervisionView(view) {
            currentSupervisionView = view;

            document.querySelectorAll('#supSubTabs .sub-tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');

            document.getElementById('supFilesView').style.display = view === 'files' ? 'block' : 'none';
            document.getElementById('supInventoryView').style.display = view === 'inventory' ? 'block' : 'none';

            if (view === 'files') {
                loadSupervisionFiles();
            } else if (view === 'inventory') {
                currentSupInvType = 'product';
                document.querySelectorAll('#supInventoryView .sub-tabs .sub-tab').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('#supInventoryView .sub-tabs .sub-tab')[0].classList.add('active');
                loadSupInvItems();
            }
        }

        // Load files for selected researcher
        async function loadSupervisionFiles() {
            const fileTree = document.getElementById('supFileTree');
            const statsBar = document.getElementById('supStatsBar');
            fileTree.innerHTML = '<div class="loading"><div class="spinner"></div>Loading files...</div>';
            statsBar.style.display = 'none';

            try {
                const response = await fetch(`/api/di/supervision/researchers/${selectedSupResearcherId}/files`, { credentials: 'include' });
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to load files');
                }
                const data = await response.json();

                document.getElementById('supStatPending').textContent = data.pendingCount || 0;
                document.getElementById('supStatApproved').textContent = data.approvedCount || 0;
                statsBar.style.display = 'flex';

                if (data.totalFiles === 0) {
                    fileTree.innerHTML = `
                        <div class="empty-state">
                            <div class="icon">&#128196;</div>
                            <p>No files uploaded yet</p>
                        </div>
                    `;
                    return;
                }

                fileTree.innerHTML = renderTree(data.tree);
            } catch (err) {
                fileTree.innerHTML = `<p style="color:#dc3545;text-align:center;">${err.message}</p>`;
            }
        }

        // Render file tree (read-only)
        function renderTree(node, level = 0) {
            if (node.type === 'file') {
                const statusClass = 'status-' + (node.status || 'PENDING');
                const isApproved = node.status === 'APPROVED';
                const signedBadge = isApproved && node.signedAt ? `<span style="background:#28a745;color:white;padding:1px 6px;border-radius:8px;font-size:9px;margin-left:5px;">SIGNED</span>` : '';
                const verifyBtn = isApproved && node.verificationCode ? `<button class="btn-verify" onclick="verifyDocument('${node.verificationCode}')" title="Verify signature">Verify</button>` : '';
                const hasFile = node.r2ObjectKey || node.viewUrl;

                return `
                    <div class="tree-item tree-file" style="padding-left:${level * 20}px">
                        <span class="icon">${isApproved ? '&#9989;' : '&#128196;'}</span>
                        <span>${escapeHtml(node.name)}</span>
                        <span class="file-status ${statusClass}">${node.status || 'PENDING'}</span>
                        ${signedBadge}
                        <div class="file-actions">
                            ${hasFile ? `
                                <button class="btn-view" onclick="window.open('${node.viewUrl}', '_blank')">View</button>
                                <button class="btn-download" onclick="window.location.href='${node.downloadUrl}'">Download</button>
                            ` : '<span style="color:#999;font-size:11px;">File removed</span>'}
                            ${verifyBtn}
                        </div>
                    </div>
                `;
            }

            const isSubmitted = node.name.includes('Submitted');
            const isApproved = node.name.includes('Approved');
            const folderClass = isSubmitted ? 'folder-submitted' : (isApproved ? 'folder-approved' : '');
            const childrenHtml = node.children ? node.children.map(child => renderTree(child, level + 1)).join('') : '';

            return `
                <div class="tree-item tree-folder ${folderClass}" style="padding-left:${level * 20}px" onclick="toggleFolder(this)">
                    <span class="icon">${isApproved ? '&#9989;' : (isSubmitted ? '&#128203;' : '&#128193;')}</span>
                    <span>${escapeHtml(node.name)}</span>
                </div>
                <div class="tree-children">
                    ${childrenHtml || '<div style="padding:10px 10px 10px 30px;color:#999;font-size:12px;">No files</div>'}
                </div>
            `;
        }

        function toggleFolder(element) {
            const children = element.nextElementSibling;
            if (children && children.classList.contains('tree-children')) {
                children.classList.toggle('collapsed');
            }
        }

        // ==================== SUPERVISED RESEARCHER INVENTORY ====================

        function switchSupInvType(type) {
            currentSupInvType = type;
            document.querySelectorAll('#supInventoryView .sub-tabs .sub-tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadSupInvItems();
        }

        async function loadSupInvItems() {
            const container = document.getElementById('supInvTableBody');
            if (!container) return;
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            if (currentSupInvType === 'oligo') {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#129516;</div><p>Oligo inventory coming soon</p></div>';
                return;
            }

            try {
                const res = await fetch(`/api/di/inventory-v2/supervision/${selectedSupResearcherId}/inventory?item_type=${currentSupInvType}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">&#128230;</div><p>No ${currentSupInvType}s found</p></div>`;
                    return;
                }

                if (currentSupInvType === 'product') {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>Vendor</th><th>ID</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Status</th><th>Visibility</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr>
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.vendor_company||'')}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td><span class="status-badge ${it.status}">${it.status}</span></td>
                        <td>${it.visibility_scope}</td>
                    </tr>`).join('')}</tbody></table>`;
                } else {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>ID</th><th>Origin</th><th>Provider</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Status</th><th>Visibility</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr>
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${escapeHtml(it.sample_origin||'')}</td>
                        <td>${escapeHtml(it.provider_or_collaborator||'')}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td><span class="status-badge ${it.status}">${it.status}</span></td>
                        <td>${it.visibility_scope}</td>
                    </tr>`).join('')}</tbody></table>`;
                }
            } catch (err) {
                container.innerHTML = `<p style="color:#dc3545;text-align:center;">${err.message}</p>`;
            }
        }

        // ==================== MY INVENTORY ====================

        function switchMyInvType(type) {
            currentMyInvType = type;
            document.querySelectorAll('#section-inventory .panel.accent .sub-tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadMyInventoryV2(type);
        }

        async function loadMyInventoryV2(itemType) {
            const container = document.getElementById('myInvTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            if (itemType === 'oligo') {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#129516;</div><p>Oligo inventory coming soon</p></div>';
                return;
            }

            try {
                const res = await fetch(`/api/di/inventory-v2/my-items?item_type=${itemType}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">&#128230;</div><p>No ${itemType}s in your inventory</p></div>`;
                    return;
                }

                if (itemType === 'product') {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>Vendor</th><th>ID</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Status</th><th>Actions</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr id="inv-row-${it.id}">
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.vendor_company||'')}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td><span class="status-badge ${it.status}">${it.status}</span></td>
                        <td class="inv-actions">
                            <button class="btn-sm btn-primary" onclick="editInvItem('${it.id}')">Edit</button>
                            ${it.status !== 'Rejected' ? `<button class="btn-sm btn-warning" onclick="markInvFinished('${it.id}')">Finished</button>` : ''}
                        </td>
                    </tr>`).join('')}</tbody></table>`;
                } else {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>ID</th><th>Origin</th><th>Provider</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Status</th><th>Actions</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr id="inv-row-${it.id}">
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${escapeHtml(it.sample_origin||'')}</td>
                        <td>${escapeHtml(it.provider_or_collaborator||'')}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td><span class="status-badge ${it.status}">${it.status}</span></td>
                        <td class="inv-actions">
                            <button class="btn-sm btn-primary" onclick="editInvItem('${it.id}')">Edit</button>
                            ${it.status !== 'Rejected' ? `<button class="btn-sm btn-warning" onclick="markInvFinished('${it.id}')">Finished</button>` : ''}
                        </td>
                    </tr>`).join('')}</tbody></table>`;
                }
            } catch (err) {
                container.innerHTML = `<p style="color:#dc3545;text-align:center;">${err.message}</p>`;
            }
        }

        async function editInvItem(id) {
            const newQty = prompt('New quantity:');
            if (newQty === null) return;
            const qty = parseFloat(newQty);
            if (isNaN(qty) || qty < 0) { alert('Invalid quantity'); return; }

            try {
                const res = await fetch(`/api/di/inventory-v2/${id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ quantity: qty })
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Failed'); }
                loadMyInventoryV2(currentMyInvType);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function markInvFinished(id) {
            if (!confirm('Mark this item as finished?')) return;
            try {
                const res = await fetch(`/api/di/inventory-v2/${id}/mark-finished`, {
                    method: 'PUT',
                    credentials: 'include'
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Failed'); }
                loadMyInventoryV2(currentMyInvType);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ==================== ADD OFFLINE ITEM ====================

        function switchOfflineType(type) {
            document.querySelectorAll('.type-selector button').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            document.getElementById('offProductForm').style.display = type === 'product' ? 'block' : 'none';
            document.getElementById('offSampleForm').style.display = type === 'sample' ? 'block' : 'none';
        }

        function toggleProviderDetail() {
            const val = document.getElementById('offSampProvider').value;
            document.getElementById('providerDetailField').style.display = val === 'External' ? 'block' : 'none';
        }

        async function submitOfflineProduct() {
            const name = document.getElementById('offProdName').value.trim();
            const identifier = document.getElementById('offProdCatalog').value.trim();
            const location = document.getElementById('offProdLocation').value.trim();
            if (!name || !identifier || !location) { alert('Please fill required fields (Name, Catalog ID, Storage Location)'); return; }

            const body = {
                item_type: 'product',
                item_name: name,
                item_identifier: identifier,
                vendor_company: document.getElementById('offProdVendor').value.trim() || null,
                product_link: document.getElementById('offProdLink').value.trim() || null,
                quantity: parseFloat(document.getElementById('offProdQty').value) || 1,
                quantity_unit: document.getElementById('offProdUnit').value,
                storage_location: location,
                storage_temperature: document.getElementById('offProdTemp').value,
                lot_or_batch_number: document.getElementById('offProdLot').value.trim() || null,
                expiry_date: document.getElementById('offProdExpiry').value || null,
                opened_date: document.getElementById('offProdOpened').value || null,
                notes: document.getElementById('offProdNotes').value.trim() || null
            };

            try {
                const res = await fetch('/api/di/inventory-v2/offline-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Failed'); }
                alert('Product submitted for PI review');
                // Clear form
                ['offProdName','offProdCatalog','offProdVendor','offProdLink','offProdLot','offProdNotes'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('offProdQty').value = '1';
                document.getElementById('offProdExpiry').value = '';
                document.getElementById('offProdOpened').value = '';
                loadMyInventoryV2(currentMyInvType);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        async function submitOfflineSample() {
            const name = document.getElementById('offSampName').value.trim();
            const identifier = document.getElementById('offSampId').value.trim();
            const origin = document.getElementById('offSampOrigin').value;
            const provider = document.getElementById('offSampProvider').value;
            const location = document.getElementById('offSampLocation').value.trim();
            if (!name || !identifier || !origin || !provider || !location) { alert('Please fill required fields'); return; }

            const body = {
                item_type: 'sample',
                item_name: name,
                item_identifier: identifier,
                sample_origin: origin,
                provider_or_collaborator: provider,
                provider_detail: document.getElementById('offSampProviderDetail').value.trim() || null,
                quantity: parseFloat(document.getElementById('offSampQty').value) || 1,
                quantity_unit: document.getElementById('offSampUnit').value,
                storage_location: location,
                storage_temperature: document.getElementById('offSampTemp').value,
                sample_status: document.getElementById('offSampStatus').value || null,
                notes: document.getElementById('offSampNotes').value.trim() || null
            };

            try {
                const res = await fetch('/api/di/inventory-v2/offline-entry', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });
                if (!res.ok) { const e = await res.json(); throw new Error(e.error || 'Failed'); }
                alert('Sample submitted for PI review');
                ['offSampName','offSampId','offSampProviderDetail','offSampNotes'].forEach(id => document.getElementById(id).value = '');
                document.getElementById('offSampQty').value = '1';
                document.getElementById('offSampOrigin').value = '';
                document.getElementById('offSampProvider').value = '';
                document.getElementById('offSampStatus').value = '';
                document.getElementById('providerDetailField').style.display = 'none';
                loadMyInventoryV2(currentMyInvType);
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // ==================== GROUP INVENTORY ====================

        function switchGrpInvType(type) {
            currentGrpInvType = type;
            const panel = document.querySelector('#section-inventory .panel:last-child');
            panel.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            loadGroupInventoryV2(type);
        }

        async function loadGroupInventoryV2(itemType) {
            const container = document.getElementById('grpInvTable');
            container.innerHTML = '<div class="loading"><div class="spinner"></div>Loading...</div>';

            if (itemType === 'oligo') {
                container.innerHTML = '<div class="empty-state"><div class="icon">&#129516;</div><p>Oligo inventory coming soon</p></div>';
                return;
            }

            try {
                const res = await fetch(`/api/di/inventory-v2/group-items?item_type=${itemType}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Failed to load');
                const data = await res.json();

                if (!data.items || data.items.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="icon">&#127760;</div><p>No ${itemType}s in group inventory</p></div>`;
                    return;
                }

                if (itemType === 'product') {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>Vendor</th><th>ID</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Owner</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr>
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.vendor_company||'')}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td>${escapeHtml(it.created_by)}</td>
                    </tr>`).join('')}</tbody></table>`;
                } else {
                    container.innerHTML = `<table class="inv-table"><thead><tr>
                        <th>Name</th><th>ID</th><th>Origin</th><th>Provider</th><th>Qty</th><th>Unit</th><th>Storage</th><th>Location</th><th>Owner</th>
                    </tr></thead><tbody>${data.items.map(it => `<tr>
                        <td>${escapeHtml(it.item_name)}</td>
                        <td>${escapeHtml(it.item_identifier)}</td>
                        <td>${escapeHtml(it.sample_origin||'')}</td>
                        <td>${escapeHtml(it.provider_or_collaborator||'')}</td>
                        <td>${it.quantity}</td>
                        <td>${escapeHtml(it.quantity_unit)}</td>
                        <td>${it.storage_temperature}</td>
                        <td>${escapeHtml(it.storage_location)}</td>
                        <td>${escapeHtml(it.created_by)}</td>
                    </tr>`).join('')}</tbody></table>`;
                }
            } catch (err) {
                container.innerHTML = `<p style="color:#dc3545;text-align:center;">${err.message}</p>`;
            }
        }

        // ==================== UTILITIES ====================

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await fetch('/api/di/logout', { method: 'POST', credentials: 'include' });
            } catch (err) {}
            window.location.href = 'access.html';
        });
    </script>
</body>
</html>
