<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GLP Vision, Training Mirror</title>
  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --accent:#2d5a87;
      --warn:#f59e0b;
      --ok:#16a34a;
      --bad:#dc2626;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    body.embed .wrap{max-width:none;padding:16px;}
    .top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--border);border-radius:14px;background:linear-gradient(180deg,#f2f4f8,#eceef3);
    }
    body.embed .top{display:none;}
    .title{font-weight:800;font-size:18px;line-height:1.2;}
    .sub{margin-top:4px;color:var(--muted);font-size:12px;}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      font-size:11px;font-weight:800;letter-spacing:.02em;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;
    }
    .pill.ok{border-color:#bbf7d0;background:#f0fdf4;color:#14532d;}
    .pill.warn{border-color:#fde68a;background:#fffbeb;color:#7c2d12;}
    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 1px 0 rgba(15,23,42,.04);
      padding:14px 14px;
    }
    .micro{font-size:11px;font-weight:900;letter-spacing:.08em;color:#64748b;}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:10px;}
    .meta{font-size:12px;color:#4b5563;}
    .mini{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:0;
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:#fff;
    }
    .mini .cell{padding:12px 10px;border-right:1px solid var(--border);text-align:center;}
    .mini .cell:last-child{border-right:0;}
    .mini .k{font-size:10px;font-weight:900;letter-spacing:.1em;color:#64748b;}
    .mini .v{margin-top:6px;font-size:28px;font-weight:900;}
    .list{margin-top:10px;border-top:1px solid #f1f5f9;}
    .item{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px solid #f1f5f9;}
    .item:last-child{border-bottom:0;}
    .badge{
      display:inline-flex;align-items:center;
      font-size:10px;font-weight:900;
      padding:3px 8px;border-radius:999px;border:1px solid var(--border);background:#fff;color:#334155;
      white-space:nowrap;
    }
    .badge.pending{border-color:#fde68a;background:#fffbeb;color:#7c2d12;}
    .badge.revision{border-color:#fecaca;background:#fef2f2;color:#7f1d1d;}
    .badge.ok{border-color:#bbf7d0;background:#f0fdf4;color:#14532d;}
    .muted{color:var(--muted);}
    .loading{padding:22px;text-align:center;color:var(--muted);font-size:13px;}
    .err{border-color:#fecaca;background:#fef2f2;}
    .err .micro{color:#7f1d1d;}
    a{color:var(--accent);text-decoration:none;font-weight:700;}
    a:hover{text-decoration:underline;}
    @media (min-width: 980px){
      .grid{grid-template-columns: 1fr 1fr;}
      .span2{grid-column: 1 / span 2;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <div class="title">Training, Mirror View</div>
        <div class="sub">Read only, researcher scoped, for PI 1 to 1 review</div>
      </div>
      <div class="pill" id="statusPill">Loading</div>
    </div>

    <div id="root" class="grid">
      <div class="loading">Loading…</div>
    </div>
  </div>

  <script>
    function q(name){
      try { return new URL(window.location.href).searchParams.get(name) || ''; }
      catch(e){ return ''; }
    }
    function esc(s){
      return String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }
    function fmtDate(v){
      if (!v) return '—';
      try { return new Date(v).toLocaleDateString('en-SE'); }
      catch(e){ return '—'; }
    }

    (function init(){
      const embed = q('embed') === '1';
      if (embed) document.body.classList.add('embed');

      const user = q('user').trim();
      if (!user){
        document.getElementById('root').innerHTML =
          '<div class="card err span2"><div class="micro">ERROR</div><div class="meta">Missing user parameter, expected ?user=JB</div></div>';
        return;
      }

      load(user);
    })();

    async function load(user){
      const root = document.getElementById('root');
      const pill = document.getElementById('statusPill');
      try{
        const resp = await fetch('/api/di/vision/training/' + encodeURIComponent(user), { credentials:'include' });
        const d = await resp.json();
        if (!d || !d.success){
          const msg = esc((d && (d.message || d.error)) || 'Failed to load training mirror');
          root.innerHTML = '<div class="card err span2"><div class="micro">ERROR</div><div class="meta">' + msg + '</div></div>';
          pill.textContent = 'ERROR';
          pill.className = 'pill';
          return;
        }

        const s = d.status || {};
        const data = d.data || {};
        const aq = data.action_queue || { seal_training_packs:[], certifications_pending:[], agreements_missing_or_expired:[] };
        const rec = data.record || { sealed_training_packs:[], certifications_approved:[], agreements_signed:[] };

        const ok = (s.overall === 'ok');
        pill.textContent = ok ? 'OK' : 'NEEDS ATTENTION';
        pill.className = ok ? 'pill ok' : 'pill warn';

        let html = '';

        html += '<div class="card span2">';
        html += '<div class="micro">TRAINING OVERVIEW</div>';
        html += '<div class="row">';
        html += '<div class="meta"><b>' + esc(user) + '</b>, last sealed: <b>' + fmtDate(s.last_sealed_at) + '</b>, next expiry: <b>' + fmtDate(s.next_expiry_at) + '</b></div>';
        html += '<div class="badge ' + (ok ? 'ok' : 'pending') + '">' + (ok ? 'OK' : 'NEEDS ATTENTION') + '</div>';
        html += '</div>';
        if (Array.isArray(s.reasons) && s.reasons.length){
          html += '<div class="meta muted" style="margin-top:8px;">' + s.reasons.map(esc).join(' , ') + '</div>';
        }
        const counts = s.counts || {};
        html += '<div class="mini">';
        html += '<div class="cell"><div class="k">SEAL PENDING</div><div class="v">' + (counts.seal_pending ?? 0) + '</div></div>';
        html += '<div class="cell"><div class="k">CERT PENDING</div><div class="v">' + (counts.cert_pending ?? 0) + '</div></div>';
        html += '<div class="cell"><div class="k">AGREEMENTS MISSING</div><div class="v">' + (counts.agreements_missing_or_expired ?? 0) + '</div></div>';
        html += '</div>';
        html += '</div>';

        html += '<div class="card">';
        html += '<div class="micro">ACTION QUEUE</div>';

        html += '<div class="list">';
        if (aq.seal_training_packs && aq.seal_training_packs.length){
          html += '<div class="item"><div><b>Packs pending seal</b></div><div class="badge pending">PENDING</div></div>';
          aq.seal_training_packs.forEach(p => {
            html += '<div class="item"><div>' + esc(p.title || 'Training pack') + '</div><div class="muted">' + fmtDate(p.submitted_at) + '</div></div>';
          });
        }
        if (aq.certifications_pending && aq.certifications_pending.length){
          html += '<div class="item"><div><b>Certifications pending</b></div><div class="badge pending">PENDING</div></div>';
          aq.certifications_pending.forEach(c => {
            html += '<div class="item"><div>' + esc(c.pack_title || 'Pack') + '</div><div class="muted">' + esc(c.requested_by || '') + ' , ' + fmtDate(c.requested_at) + '</div></div>';
          });
        }
        if (aq.agreements_missing_or_expired && aq.agreements_missing_or_expired.length){
          html += '<div class="item"><div><b>Agreements missing or expired</b></div><div class="badge revision">ACTION</div></div>';
          aq.agreements_missing_or_expired.forEach(a => {
            const st = String(a.status || '').toLowerCase();
            const cls = (st === 'expired') ? 'revision' : 'pending';
            html += '<div class="item"><div>' + esc(a.agreement_type || 'Agreement') + '</div><div class="badge ' + cls + '">' + esc((a.status || 'missing').toUpperCase()) + '</div></div>';
          });
        }
        if (
          (!aq.seal_training_packs || !aq.seal_training_packs.length) &&
          (!aq.certifications_pending || !aq.certifications_pending.length) &&
          (!aq.agreements_missing_or_expired || !aq.agreements_missing_or_expired.length)
        ){
          html += '<div class="item"><div class="muted">No pending items</div><div class="badge ok">OK</div></div>';
        }
        html += '</div>';
        html += '</div>';

        html += '<div class="card">';
        html += '<div class="micro">RECORD</div>';
        html += '<div class="list">';

        if (rec.sealed_training_packs && rec.sealed_training_packs.length){
          html += '<div class="item"><div><b>Sealed packs</b></div><div class="badge ok">SEALED</div></div>';
          rec.sealed_training_packs.forEach(p => {
            html += '<div class="item"><div>' + esc(p.title || 'Pack') + '</div><div class="muted">' + fmtDate(p.sealed_at) + ' , ' + esc(p.sealed_by || '') + '</div></div>';
          });
        }
        if (rec.certifications_approved && rec.certifications_approved.length){
          html += '<div class="item"><div><b>Certifications approved</b></div><div class="badge ok">APPROVED</div></div>';
          rec.certifications_approved.forEach(c => {
            html += '<div class="item"><div>' + esc(c.pack_title || 'Pack') + '</div><div class="muted">' + fmtDate(c.approved_at) + ' , ' + esc(c.approved_by || '') + '</div></div>';
          });
        }
        if (rec.agreements_signed && rec.agreements_signed.length){
          html += '<div class="item"><div><b>Agreements signed</b></div><div class="badge ok">SIGNED</div></div>';
          rec.agreements_signed.forEach(a => {
            html += '<div class="item"><div>' + esc(a.agreement_type || 'Agreement') + ' <span class="muted">' + esc(a.version || '') + '</span></div><div class="muted">' + fmtDate(a.signed_at) + '</div></div>';
          });
        }
        if (
          (!rec.sealed_training_packs || !rec.sealed_training_packs.length) &&
          (!rec.certifications_approved || !rec.certifications_approved.length) &&
          (!rec.agreements_signed || !rec.agreements_signed.length)
        ){
          html += '<div class="item"><div class="muted">No records found</div><div class="badge">—</div></div>';
        }

        html += '</div>';
        html += '</div>';

        root.innerHTML = html;
      } catch(err){
        const root = document.getElementById('root');
        root.innerHTML = '<div class="card err span2"><div class="micro">ERROR</div><div class="meta">Failed to load training mirror</div></div>';
      }
    }
  </script>
</body>
</html>
